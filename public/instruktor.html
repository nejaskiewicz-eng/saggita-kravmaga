<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Panel Instruktora â€” Krav Maga Saggita</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f0f10;--surface:#18181b;--surface2:#232328;--surface3:#2c2c33;
  --border:#2e2e38;--border2:#3a3a48;
  --text:#e8e8f0;--muted:#8888a0;--muted2:#6060780;
  --red:#c42000;--red-l:#e03010;--red-bg:rgba(196,32,0,.12);--red-bdr:rgba(196,32,0,.3);
  --green:#16a34a;--green-bg:rgba(22,163,74,.12);--green-bdr:rgba(22,163,74,.3);
  --yellow:#ca8a04;--yellow-bg:rgba(202,138,4,.12);
  --blue:#2563eb;--blue-bg:rgba(37,99,235,.12);
  --radius:8px;--shadow:0 4px 24px rgba(0,0,0,.4);
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-size:14px}
a{color:inherit;text-decoration:none}
button{cursor:pointer;font-family:inherit}
input,select,textarea{font-family:inherit;font-size:14px}

/* â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:radial-gradient(ellipse 600px 400px at 50% 40%,rgba(196,32,0,.08),transparent 70%)}
.login-box{background:var(--surface);border:1px solid var(--border2);border-radius:12px;padding:40px 44px;width:100%;max-width:380px;box-shadow:var(--shadow)}
.login-logo{text-align:center;margin-bottom:28px}
.login-logo .brand{font-size:22px;font-weight:800;letter-spacing:.08em;text-transform:uppercase;color:#fff}
.login-logo .brand span{color:var(--red)}
.login-logo small{display:block;color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.12em;margin-top:4px}
.login-field{margin-bottom:14px}
.login-field label{display:block;color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px}
.login-field input{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:6px;padding:10px 12px;color:var(--text);outline:none}
.login-field input:focus{border-color:var(--red)}
.login-btn{width:100%;margin-top:8px;padding:12px;background:var(--red);border:none;border-radius:6px;color:#fff;font-weight:700;font-size:15px;letter-spacing:.06em;text-transform:uppercase;transition:background .15s}
.login-btn:hover{background:var(--red-l)}
.login-err{margin-top:10px;padding:9px 12px;background:var(--red-bg);border:1px solid var(--red-bdr);border-radius:5px;color:#ff6b4a;font-size:12px;font-weight:600;text-align:center;display:none}
.login-err.show{display:block}

/* â”€â”€ APP LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app{display:none;height:100vh;overflow:hidden;flex-direction:row}
#app.visible{display:flex}

/* Sidebar */
#sidebar{width:220px;min-width:220px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto}
.sb-header{padding:20px 16px 16px;border-bottom:1px solid var(--border)}
.sb-brand{font-size:13px;font-weight:800;letter-spacing:.08em;text-transform:uppercase;color:#fff}
.sb-brand span{color:var(--red)}
.sb-user{margin-top:8px;font-size:12px;color:var(--muted)}
.sb-user strong{display:block;color:var(--text);font-size:13px;margin-bottom:1px}
.sb-nav{padding:12px 8px;flex:1}
.nav-section{font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);padding:8px 8px 4px}
.nav-item{display:flex;align-items:center;gap:8px;padding:9px 10px;border-radius:6px;color:var(--muted);cursor:pointer;margin-bottom:2px;transition:all .15s}
.nav-item:hover{background:var(--surface2);color:var(--text)}
.nav-item.active{background:var(--red-bg);color:#ff7c60;border:1px solid var(--red-bdr)}
.nav-item .ico{font-size:15px;width:18px;text-align:center}
.sb-footer{padding:12px 8px;border-top:1px solid var(--border)}
.logout-btn{width:100%;padding:8px 12px;background:transparent;border:1px solid var(--border2);border-radius:6px;color:var(--muted);font-size:12px;transition:all .15s}
.logout-btn:hover{border-color:var(--red-bdr);color:#ff7c60}

/* Main content */
#main{flex:1;overflow-y:auto;display:flex;flex-direction:column}
#page-header{padding:20px 24px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
#page-title{font-size:20px;font-weight:700}
#page-sub{font-size:12px;color:var(--muted);margin-top:3px}
#page-body{flex:1;padding:24px;overflow-y:auto}

/* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stat-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px}
.stat-card .sc-lbl{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:6px}
.stat-card .sc-val{font-size:26px;font-weight:800;color:var(--text)}
.stat-card.green{border-color:var(--green-bdr);background:var(--green-bg)}
.stat-card.red{border-color:var(--red-bdr);background:var(--red-bg)}
.stat-card.blue{border-color:rgba(37,99,235,.3);background:var(--blue-bg)}

/* â”€â”€ GROUP CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.group-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.group-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;cursor:pointer;transition:all .15s}
.group-card:hover{border-color:var(--red-bdr);background:var(--surface2)}
.gc-loc{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--red);margin-bottom:4px}
.gc-name{font-size:16px;font-weight:700;margin-bottom:8px}
.gc-meta{display:flex;gap:12px;margin-bottom:10px}
.gc-meta span{font-size:12px;color:var(--muted)}
.gc-meta strong{color:var(--text)}
.gc-sched{font-size:12px;color:var(--muted);line-height:1.8;margin-bottom:12px;border-top:1px solid var(--border);padding-top:10px}
.gc-sched .day{color:var(--text);font-weight:600}
.gc-btns{display:flex;gap:8px}
.btn{padding:7px 14px;border-radius:5px;font-size:12px;font-weight:600;border:none;transition:all .15s}
.btn-red{background:var(--red);color:#fff}
.btn-red:hover{background:var(--red-l)}
.btn-outline{background:transparent;border:1px solid var(--border2);color:var(--text)}
.btn-outline:hover{border-color:var(--red-bdr);color:#ff7c60}
.btn-green{background:var(--green);color:#fff}
.btn-green:hover{background:#15803d}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-danger{background:transparent;border:1px solid rgba(196,32,0,.4);color:#ff7c60}
.btn-danger:hover{background:var(--red-bg)}

/* â”€â”€ CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cal-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.cal-nav{display:flex;gap:6px}
.cal-nav button{padding:6px 12px;background:var(--surface2);border:1px solid var(--border2);border-radius:5px;color:var(--text);font-size:13px}
.cal-nav button:hover{border-color:var(--red-bdr);color:#ff7c60}
.cal-month-label{font-size:18px;font-weight:700}
.cal-filter{margin-left:auto;display:flex;gap:8px;align-items:center}
.cal-filter select{background:var(--surface2);border:1px solid var(--border2);border-radius:5px;padding:6px 10px;color:var(--text);outline:none}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-dh{text-align:center;font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);padding:8px 0}
.cal-cell{min-height:80px;background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:6px;transition:all .15s;position:relative}
.cal-cell.other-month{background:var(--bg);opacity:.4}
.cal-cell.today{border-color:var(--red-bdr)}
.cal-cell.has-session{background:var(--surface2);border-color:var(--green-bdr)}
.cal-cell.clickable{cursor:pointer}
.cal-cell.clickable:hover{border-color:var(--red-bdr);background:var(--surface2)}
.cal-date{font-size:12px;font-weight:600;margin-bottom:4px}
.cal-today-dot{display:inline-block;width:6px;height:6px;background:var(--red);border-radius:50%;margin-left:4px;vertical-align:middle}
.cal-pill{display:block;background:var(--green-bg);border:1px solid var(--green-bdr);border-radius:3px;padding:2px 5px;font-size:10px;color:#4ade80;margin-bottom:2px;cursor:pointer}
.cal-pill:hover{background:rgba(22,163,74,.25)}
.cal-sched-dot{display:block;background:var(--red-bg);border:1px solid var(--red-bdr);border-radius:3px;padding:2px 5px;font-size:10px;color:#ff7c60;margin-bottom:2px;cursor:pointer}
.cal-sched-dot:hover{background:rgba(196,32,0,.25)}

/* â”€â”€ SESSIONS TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th{text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);padding:10px 12px;border-bottom:1px solid var(--border)}
td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle}
tr:hover td{background:var(--surface2)}
.badge{display:inline-block;padding:2px 8px;border-radius:3px;font-size:11px;font-weight:600}
.badge-green{background:var(--green-bg);color:#4ade80;border:1px solid var(--green-bdr)}
.badge-red{background:var(--red-bg);color:#ff7c60;border:1px solid var(--red-bdr)}
.badge-gray{background:var(--surface3);color:var(--muted);border:1px solid var(--border)}
.badge-blue{background:var(--blue-bg);color:#93c5fd;border:1px solid rgba(37,99,235,.3)}

/* â”€â”€ ATTENDANCE LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.att-list{display:flex;flex-direction:column;gap:2px;max-height:60vh;overflow-y:auto}
.att-row{display:flex;align-items:center;gap:12px;padding:9px 12px;background:var(--surface);border:1px solid var(--border);border-radius:6px;transition:all .15s}
.att-row:hover{background:var(--surface2)}
.att-name{flex:1;font-weight:600}
.att-info{font-size:11px;color:var(--muted);flex:1}
.att-pay{font-size:11px;color:var(--muted)}
.att-pay.late{color:#fca5a5}
.att-check{width:22px;height:22px;border-radius:4px;border:2px solid var(--border2);background:var(--surface2);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;flex-shrink:0}
.att-check:hover{border-color:var(--green-bdr)}
.att-check.checked{background:var(--green);border-color:var(--green)}

/* â”€â”€ STUDENT PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.profile-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.info-block{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.info-block h4{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:12px}
.info-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px}
.info-row:last-child{border-bottom:none}
.info-row .lbl{color:var(--muted)}
.info-row .val{font-weight:600;text-align:right}
.payment-row{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:6px;margin-bottom:4px}
.payment-row .amt{font-weight:700;font-size:15px;min-width:60px}
.payment-row .dt{color:var(--muted);font-size:12px;flex:1}
.payment-row .note{color:var(--muted);font-size:11px;flex:1;text-align:right}

/* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:flex;align-items:center;justify-content:center;padding:20px}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:10px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow)}
.modal-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:16px;font-weight:700}
.modal-close{background:none;border:none;color:var(--muted);font-size:20px;padding:0 4px;cursor:pointer}
.modal-close:hover{color:var(--text)}
.modal-body{padding:20px}
.modal-footer{padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
.form-field{margin-bottom:14px}
.form-field label{display:block;font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);margin-bottom:5px}
.form-field input,.form-field select,.form-field textarea{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:5px;padding:9px 11px;color:var(--text);outline:none}
.form-field input:focus,.form-field select:focus{border-color:var(--red)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* â”€â”€ TOOLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar{display:flex;gap:8px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
.toolbar input,.toolbar select{background:var(--surface2);border:1px solid var(--border2);border-radius:5px;padding:7px 10px;color:var(--text);outline:none}
.toolbar input:focus,.toolbar select:focus{border-color:var(--red)}
.toolbar input[type=search]{flex:1;min-width:200px}

/* â”€â”€ BREADCRUMB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.breadcrumb{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);margin-bottom:16px}
.breadcrumb a{cursor:pointer;color:var(--muted)}
.breadcrumb a:hover{color:var(--text)}
.breadcrumb .sep{color:var(--border2)}

/* â”€â”€ MISC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty{text-align:center;padding:40px;color:var(--muted);font-size:14px}
.loading{text-align:center;padding:40px;color:var(--muted)}
.section-title{font-size:15px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.back-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px;padding:0;display:flex;align-items:center;gap:4px}
.back-btn:hover{color:var(--text)}
.tag{display:inline-block;padding:2px 8px;border-radius:3px;font-size:11px}
.tag-active{background:var(--green-bg);color:#4ade80;border:1px solid var(--green-bdr)}
.tag-inactive{background:var(--surface3);color:var(--muted);border:1px solid var(--border)}
.divider{height:1px;background:var(--border);margin:16px 0}
.text-muted{color:var(--muted)}
.text-sm{font-size:12px}
.mt-16{margin-top:16px}
.scroll-hint{font-size:11px;color:var(--muted);margin-bottom:8px}

@media(max-width:640px){
  #sidebar{display:none}
  .profile-grid{grid-template-columns:1fr}
  .form-row{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">
      <div class="brand">KRAV MAGA <span>SAGGITA</span></div>
      <small>Panel Instruktora</small>
    </div>
    <div class="login-field">
      <label>Login</label>
      <input id="li-user" type="text" autocomplete="username" placeholder="login">
    </div>
    <div class="login-field">
      <label>HasÅ‚o</label>
      <input id="li-pass" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <button class="login-btn" onclick="doLogin()">Zaloguj siÄ™</button>
    <div id="li-err" class="login-err"></div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- Sidebar -->
  <aside id="sidebar">
    <div class="sb-header">
      <div class="sb-brand">KM <span>SAGGITA</span></div>
      <div class="sb-user">
        <strong id="sb-name">â€”</strong>
        <span>Instruktor</span>
      </div>
    </div>
    <nav class="sb-nav">
      <div class="nav-section">Nawigacja</div>
      <div class="nav-item active" id="nav-dashboard" onclick="goPage('dashboard')"><span class="ico">âŠ</span> Dashboard</div>
      <div class="nav-item" id="nav-groups" onclick="goPage('groups')"><span class="ico">â—ˆ</span> Grupy & Kursanci</div>
      <div class="nav-item" id="nav-calendar" onclick="goPage('calendar')"><span class="ico">âŠ¡</span> Kalendarz zajÄ™Ä‡</div>
      <div class="nav-item" id="nav-sessions" onclick="goPage('sessions')"><span class="ico">â˜‘</span> Sesje & ObecnoÅ›ci</div>
      <div class="nav-item" id="nav-payments" onclick="goPage('payments')"><span class="ico">â‚¿</span> PÅ‚atnoÅ›ci</div>
    </nav>
    <div class="sb-footer">
      <button class="logout-btn" onclick="doLogout()">Wyloguj siÄ™</button>
    </div>
  </aside>

  <!-- Main -->
  <main id="main">
    <div id="page-header">
      <div id="page-title">Dashboard</div>
      <div id="page-sub"></div>
    </div>
    <div id="page-body">
      <div class="loading">Åadowanie...</div>
    </div>
  </main>
</div>

<!-- MODAL -->
<div id="modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-header">
      <div id="modal-title" class="modal-title"></div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div id="modal-body" class="modal-body"></div>
    <div id="modal-footer" class="modal-footer"></div>
  </div>
</div>

<script>
'use strict';

/* â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const $ = id => document.getElementById(id);
const escH = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
function todayISO(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function dateISO(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function fmtDate(iso){if(!iso)return'â€”';const[y,m,d]=iso.split('-');return`${d}.${m}.${y}`}
function fmtMoney(v){return v?Number(v).toFixed(0)+' zÅ‚':'â€”'}
function dayName(n){return['Pn','Wt','Åšr','Cz','Pt','Sb','Nd'][n]||'?'}
function dayFull(n){return['PoniedziaÅ‚ek','Wtorek','Åšroda','Czwartek','PiÄ…tek','Sobota','Niedziela'][n]||'?'}
function monthName(n){return['StyczeÅ„','Luty','Marzec','KwiecieÅ„','Maj','Czerwiec','Lipiec','SierpieÅ„','WrzesieÅ„','PaÅºdziernik','Listopad','GrudzieÅ„'][n]}
function weeksAgo(iso){if(!iso)return null;const d=Math.floor((new Date()-new Date(iso))/86400000);return d}

/* â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const S = {
  token:null, inst:null,
  groups:[], sessions:[], payments:[],
  curPage:'dashboard',
  // sub-state
  calYear:new Date().getFullYear(), calMonth:new Date().getMonth(),
  calGroupId:null,
  sessFilterGroup:'', sessFrom:'2025-09-01',
  studFilterGroup:'',
  // current views
  curGroupId:null, curGroupStudents:[],
  curSessionId:null, curSessionData:null,
  curStudentId:null, curStudentData:null,
};
const SEASON='2025-09-01';

/* â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function api(url, method='GET', body=null){
  const h={'Content-Type':'application/json'};
  if(S.token)h['Authorization']='Bearer '+S.token;
  const opts={method,headers:h};
  if(body)opts.body=JSON.stringify(body);
  const r=await fetch(url,opts);
  if(!r.ok){
    let msg='BÅ‚Ä…d '+r.status;
    try{const d=await r.json();msg=d.error||msg;}catch(e){}
    throw new Error(msg);
  }
  const ct=r.headers.get('content-type')||'';
  if(ct.includes('json'))return r.json();
  return {};
}

/* â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function doLogin(){
  const u=$('li-user').value.trim(), p=$('li-pass').value;
  const err=$('li-err');
  err.classList.remove('show');
  if(!u||!p){err.textContent='Podaj login i hasÅ‚o.';err.classList.add('show');return;}
  try{
    const d=await api('/api/instructor/login','POST',{username:u,password:p});
    S.token=d.token; S.inst=d.instructor;
    localStorage.setItem('inst_token',S.token);
    localStorage.setItem('inst_data',JSON.stringify(S.inst));
    $('sb-name').textContent=(d.instructor.first_name||'')+' '+(d.instructor.last_name||'');
    $('login-screen').style.display='none';
    $('app').classList.add('visible');
    await loadAll();
  }catch(e){err.textContent=e.message;err.classList.add('show');}
}

function doLogout(){
  S.token=null; S.inst=null; S.groups=[]; S.sessions=[]; S.payments=[];
  localStorage.removeItem('inst_token'); localStorage.removeItem('inst_data');
  $('app').classList.remove('visible');
  $('login-screen').style.display='flex';
}

/* â”€â”€ LOAD ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadAll(){
  try{
    const d=await api('/api/instructor/groups');
    S.groups=d.rows||[];
  }catch(e){console.error('[loadAll groups]',e);}
  renderPage('dashboard');
}

/* â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function goPage(name){
  document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
  const nav=$('nav-'+name);
  if(nav)nav.classList.add('active');
  S.curPage=name;
  // reset sub-state when going to top-level page
  if(name==='groups'){S.curGroupId=null;S.curStudentId=null;}
  if(name==='sessions'){S.curSessionId=null;}
  renderPage(name);
}
function renderPage(name){
  const titles={
    dashboard:'Dashboard',
    groups:'Grupy & Kursanci',
    calendar:'Kalendarz zajÄ™Ä‡',
    sessions:'Sesje & ObecnoÅ›ci',
    payments:'PÅ‚atnoÅ›ci'
  };
  $('page-title').textContent=titles[name]||name;
  $('page-sub').textContent='';
  switch(name){
    case 'dashboard': renderDashboard(); break;
    case 'groups':
      if(S.curStudentId) renderStudentProfile();
      else if(S.curGroupId) renderGroupStudents();
      else renderGroups();
      break;
    case 'calendar': renderCalendar(); break;
    case 'sessions':
      if(S.curSessionId) renderAttendance();
      else renderSessions();
      break;
    case 'payments': renderPayments(); break;
  }
}

/* â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderDashboard(){
  const body=$('page-body');
  const totalStudents=S.groups.reduce((s,g)=>s+(g.student_count||0),0);
  const todayDow=new Date().getDay(); // 0=Sun
  // Convert to Mon=0 format used in schedules
  const todayDow0 = todayDow===0 ? 6 : todayDow-1;
  const todayGroups=S.groups.filter(g=>(g.schedules||[]).some(s=>Number(s.day_of_week)===todayDow0));

  body.innerHTML=`
    <div class="stat-row">
      <div class="stat-card blue"><div class="sc-lbl">Twoje grupy</div><div class="sc-val">${S.groups.length}</div></div>
      <div class="stat-card green"><div class="sc-lbl">Aktywni kursanci</div><div class="sc-val">${totalStudents}</div></div>
      <div class="stat-card"><div class="sc-lbl">Sezon od</div><div class="sc-val" style="font-size:18px">01.09.2025</div></div>
    </div>
    ${todayGroups.length?`
    <div class="section-title">ğŸƒ Dzisiaj masz zajÄ™cia</div>
    <div class="group-grid" style="margin-bottom:24px">
      ${todayGroups.map(g=>renderGroupCard(g,true)).join('')}
    </div>`:''}
    <div class="section-title">Wszystkie Twoje grupy</div>
    <div class="group-grid">${S.groups.map(g=>renderGroupCard(g,false)).join('')}</div>
  `;
}

function renderGroupCard(g, compact=false){
  const scheds=(g.schedules||[]).map(s=>`<span class="day">${s.day_name||dayFull(s.day_of_week)}</span> ${s.time_label||''}`).join(' &nbsp;Â·&nbsp; ');
  return`<div class="group-card" onclick="openGroup(${g.id})">
    <div class="gc-loc">${escH(g.location_city||'')} â€” ${escH(g.location_name||'')}</div>
    <div class="gc-name">${escH(g.name)}</div>
    <div class="gc-meta">
      <span>ğŸ‘¥ <strong>${g.student_count||0}</strong> kursantÃ³w</span>
      ${g.age_range?`<span>ğŸ‚ <strong>${escH(g.age_range)}</strong></span>`:''}
    </div>
    ${scheds?`<div class="gc-sched">${scheds||'Brak grafiku'}</div>`:'<div class="gc-sched text-muted">Brak grafiku</div>'}
    <div class="gc-btns">
      <button class="btn btn-red btn-sm" onclick="event.stopPropagation();openGroup(${g.id})">Kursanci</button>
      <button class="btn btn-outline btn-sm" onclick="event.stopPropagation();openCalForGroup(${g.id})">Kalendarz</button>
    </div>
  </div>`;
}

/* â”€â”€ GROUPS & STUDENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderGroups(){
  $('page-title').textContent='Grupy & Kursanci';
  $('page-body').innerHTML=`<div class="group-grid">${S.groups.map(g=>renderGroupCard(g,false)).join('')||'<div class="empty">Brak przypisanych grup.</div>'}</div>`;
}

async function openGroup(gid){
  S.curGroupId=gid;
  S.curStudentId=null;
  $('page-body').innerHTML='<div class="loading">Åadowanie kursantÃ³w...</div>';
  try{
    const d=await api(`/api/instructor/groups/${gid}/students`);
    S.curGroupStudents=d.rows||[];
    renderGroupStudents();
  }catch(e){$('page-body').innerHTML=`<div class="empty">BÅ‚Ä…d: ${escH(e.message)}</div>`;}
}

function renderGroupStudents(){
  const g=S.groups.find(x=>x.id==S.curGroupId)||{};
  $('page-title').textContent=escH(g.name||'Kursanci');
  $('page-sub').textContent=escH((g.location_city||'')+(g.location_name?' â€” '+g.location_name:''));
  const students=S.curGroupStudents;

  const scheds=(g.schedules||[]).map(s=>`${s.day_name||dayFull(s.day_of_week)} ${s.time_label||''}`).join(', ');

  $('page-body').innerHTML=`
    <div class="breadcrumb">
      <a onclick="goPage('groups')">Grupy</a><span class="sep">â€º</span>
      <span>${escH(g.name||'')}</span>
    </div>
    <div class="info-block" style="margin-bottom:16px">
      <div class="info-row"><span class="lbl">Lokalizacja</span><span class="val">${escH(g.location_city||'')} / ${escH(g.location_name||'')}</span></div>
      ${g.category?`<div class="info-row"><span class="lbl">Kategoria</span><span class="val">${escH(g.category)}</span></div>`:''}
      ${g.age_range?`<div class="info-row"><span class="lbl">Wiek</span><span class="val">${escH(g.age_range)}</span></div>`:''}
      ${scheds?`<div class="info-row"><span class="lbl">Grafik</span><span class="val">${escH(scheds)}</span></div>`:''}
    </div>
    <div class="toolbar">
      <input type="search" placeholder="Szukaj kursanta..." id="stud-search" oninput="filterStudents()" style="max-width:260px">
      <button class="btn btn-red btn-sm" onclick="openAddStudent(${g.id})">+ Dodaj kursanta</button>
    </div>
    <div id="students-list">
    ${students.length===0?'<div class="empty">Brak kursantÃ³w w tej grupie.</div>':
      `<div class="table-wrap"><table>
        <thead><tr>
          <th>Nazwisko, ImiÄ™</th>
          <th>Wiek</th>
          <th>Kontakt</th>
          <th>Ostatnia wpÅ‚ata</th>
          <th>ObecnoÅ›ci</th>
          <th>WpÅ‚acono (sezon)</th>
          <th></th>
        </tr></thead>
        <tbody id="students-tbody">
          ${students.map(s=>renderStudentRow(s)).join('')}
        </tbody>
      </table></div>`
    }
    </div>
  `;
}

function renderStudentRow(s){
  const wp=weeksAgo(s.last_payment);
  const payClass=wp===null?'':wp>28?'late':'';
  const active=s.is_active!==false;
  return`<tr>
    <td>
      <a href="#" onclick="event.preventDefault();openStudent(${s.id})" style="font-weight:600;color:var(--text)">${escH(s.last_name)}, ${escH(s.first_name)}</a>
      ${!active?'<span class="badge badge-gray" style="margin-left:6px">nieaktywny</span>':''}
    </td>
    <td>${s.birth_year||'â€”'}</td>
    <td class="text-muted text-sm">${s.phone?escH(s.phone):'â€”'}</td>
    <td class="att-pay ${payClass}">${s.last_payment?fmtDate(s.last_payment):'â€”'}</td>
    <td>${s.att_season||0}</td>
    <td>${s.paid_season?Number(s.paid_season).toFixed(0)+' zÅ‚':'â€”'}</td>
    <td>
      <button class="btn btn-outline btn-sm" onclick="openStudent(${s.id})">Kartoteka</button>
    </td>
  </tr>`;
}

function filterStudents(){
  const q=$('stud-search').value.toLowerCase();
  const tbody=$('students-tbody');
  if(!tbody)return;
  tbody.querySelectorAll('tr').forEach(tr=>{
    const name=tr.cells[0]?tr.cells[0].textContent.toLowerCase():'';
    tr.style.display=name.includes(q)?'':'none';
  });
}

/* â”€â”€ STUDENT PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function openStudent(sid){
  S.curStudentId=sid;
  $('page-body').innerHTML='<div class="loading">Åadowanie...</div>';
  try{
    const [s,{rows:pays},{rows:att}]=await Promise.all([
      api(`/api/instructor/students/${sid}`),
      api(`/api/instructor/students/${sid}/payments`),
      api(`/api/instructor/students/${sid}/attendance`)
    ]);
    S.curStudentData={...s,payments:pays,attendance:att};
    renderStudentProfile();
  }catch(e){$('page-body').innerHTML=`<div class="empty">BÅ‚Ä…d: ${escH(e.message)}</div>`;}
}

function renderStudentProfile(){
  const s=S.curStudentData;
  const g=S.groups.find(x=>x.id==S.curGroupId)||{};
  $('page-title').textContent=`${escH(s.last_name)}, ${escH(s.first_name)}`;
  $('page-sub').textContent='Kartoteka kursanta';

  const grpList=(s.groups||[]).map(gg=>`<span class="badge ${gg.active?'badge-green':'badge-gray'}">${escH(gg.name)} (${escH(gg.city||'')})</span>`).join(' ');
  const pays=s.payments||[];
  const att=s.attendance||[];
  const attPres=att.filter(a=>a.present).length;

  $('page-body').innerHTML=`
    <div class="breadcrumb">
      <a onclick="goPage('groups')">Grupy</a><span class="sep">â€º</span>
      <a onclick="renderGroupStudents()">${escH(g.name||'Kursanci')}</a><span class="sep">â€º</span>
      <span>${escH(s.first_name)} ${escH(s.last_name)}</span>
    </div>

    <div class="profile-grid">
      <div class="info-block">
        <h4>Dane osobowe</h4>
        <div class="info-row"><span class="lbl">ImiÄ™ i nazwisko</span><span class="val">${escH(s.first_name)} ${escH(s.last_name)}</span></div>
        <div class="info-row"><span class="lbl">Rok urodzenia</span><span class="val">${s.birth_year||'â€”'}</span></div>
        <div class="info-row"><span class="lbl">Telefon</span><span class="val">${s.phone?escH(s.phone):'â€”'}</span></div>
        <div class="info-row"><span class="lbl">E-mail</span><span class="val">${s.email?escH(s.email):'â€”'}</span></div>
        <div class="info-row"><span class="lbl">Status</span><span class="val">${s.is_active!==false?'<span class="tag tag-active">Aktywny</span>':'<span class="tag tag-inactive">Nieaktywny</span>'}</span></div>
      </div>
      <div class="info-block">
        <h4>Grupy</h4>
        <div style="margin-bottom:12px">${grpList||'â€”'}</div>
        <div class="info-row"><span class="lbl">WpÅ‚acono (sezon)</span><span class="val">${pays.reduce((s,p)=>s+Number(p.amount||0),0).toFixed(0)} zÅ‚</span></div>
        <div class="info-row"><span class="lbl">Ostatnia wpÅ‚ata</span><span class="val">${pays[0]?fmtDate(pays[0].paid_at):'â€”'}</span></div>
        <div class="info-row"><span class="lbl">ObecnoÅ›ci (sezon)</span><span class="val">${attPres} / ${att.length}</span></div>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:20px">
      <button class="btn btn-outline btn-sm" onclick="openEditStudent()">âœï¸ Edytuj dane</button>
      <button class="btn btn-danger btn-sm" onclick="confirmDeleteStudent(${s.id})">ğŸ—‘ UsuÅ„</button>
    </div>

    <div class="section-title">ğŸ’° PÅ‚atnoÅ›ci <button class="btn btn-green btn-sm" style="margin-left:auto" onclick="openAddPayment(${s.id})">+ Dodaj wpÅ‚atÄ™</button></div>
    <div id="payments-list" style="margin-bottom:20px">
      ${pays.length===0?'<div class="empty">Brak wpÅ‚at.</div>':
        pays.map(p=>`
          <div class="payment-row">
            <div class="amt">${fmtMoney(p.amount)}</div>
            <div class="dt">ğŸ“… ${fmtDate(p.paid_at)}</div>
            <div class="note">${p.note?escH(p.note):''}</div>
            <button class="btn btn-danger btn-sm" onclick="deletePayment(${s.id},${p.id})">âœ•</button>
          </div>`).join('')
      }
    </div>

    <div class="section-title">ğŸ“‹ Historia obecnoÅ›ci</div>
    ${att.length===0?'<div class="empty">Brak zapisanych obecnoÅ›ci.</div>':
      `<div class="table-wrap"><table>
        <thead><tr><th>Data</th><th>Grupa</th><th>Lokalizacja</th><th>ObecnoÅ›Ä‡</th></tr></thead>
        <tbody>
          ${att.slice(0,50).map(a=>`<tr>
            <td>${fmtDate(a.session_date)}</td>
            <td>${escH(a.group_name||'')}</td>
            <td>${escH(a.city||'')}</td>
            <td>${a.present?'<span class="badge badge-green">âœ“ Obecny</span>':'<span class="badge badge-red">âœ— Nieobecny</span>'}</td>
          </tr>`).join('')}
        </tbody>
      </table></div>`
    }
  `;
}

/* â”€â”€ CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openCalForGroup(gid){
  S.calGroupId=gid;
  goPage('calendar');
}

function renderCalendar(){
  $('page-title').textContent='Kalendarz zajÄ™Ä‡';
  const y=S.calYear, m=S.calMonth;

  // Generate schedule dates for this month
  const groupOpts=S.groups.map(g=>`<option value="${g.id}" ${S.calGroupId==g.id?'selected':''}>${escH(g.location_city)} â€” ${escH(g.name)}</option>`).join('');

  $('page-body').innerHTML=`
    <div class="cal-header">
      <div class="cal-nav">
        <button onclick="calNav(-1)">â—€</button>
        <button onclick="calNav(1)">â–¶</button>
      </div>
      <div class="cal-month-label">${monthName(m)} ${y}</div>
      <div class="cal-filter">
        <select onchange="S.calGroupId=this.value?Number(this.value):null;renderCalendar()">
          <option value="">Wszystkie grupy</option>
          ${groupOpts}
        </select>
        <button class="btn btn-outline btn-sm" onclick="S.calYear=new Date().getFullYear();S.calMonth=new Date().getMonth();renderCalendar()">DziÅ›</button>
      </div>
    </div>
    <div class="cal-grid" id="cal-grid">
      ${['Pon','Wt','Åšr','Czw','Pt','Sob','Ndz'].map(d=>`<div class="cal-dh">${d}</div>`).join('')}
    </div>
    <div class="mt-16 text-muted text-sm">
      <span style="display:inline-block;width:12px;height:12px;background:var(--green-bg);border:1px solid var(--green-bdr);border-radius:2px;margin-right:4px"></span>Sesja istnieje &nbsp;
      <span style="display:inline-block;width:12px;height:12px;background:var(--red-bg);border:1px solid var(--red-bdr);border-radius:2px;margin-right:4px"></span>Zaplanowany termin (bez sesji)
    </div>
  `;

  // Fetch sessions for this month then render
  const from=`${y}-${String(m+1).padStart(2,'0')}-01`;
  const lastDay=new Date(y,m+1,0).getDate();
  const to=`${y}-${String(m+1).padStart(2,'0')}-${lastDay}`;
  api(`/api/instructor/sessions?from=${from}&to=${to}${S.calGroupId?'&group_id='+S.calGroupId:''}`)
    .then(d=>renderCalGrid(y,m,d.rows||[]))
    .catch(()=>renderCalGrid(y,m,[]));
}

function calNav(dir){
  S.calMonth+=dir;
  if(S.calMonth<0){S.calMonth=11;S.calYear--;}
  if(S.calMonth>11){S.calMonth=0;S.calYear++;}
  renderCalendar();
}

function renderCalGrid(y,m,sessions){
  const grid=$('cal-grid');
  if(!grid)return;
  // Remove old cells (keep headers)
  const headers=Array.from(grid.querySelectorAll('.cal-dh'));
  grid.innerHTML='';
  headers.forEach(h=>grid.appendChild(h));

  const today=todayISO();
  const firstDay=new Date(y,m,1).getDay(); // 0=Sun
  const startOffset=(firstDay===0?6:firstDay-1); // Mon=0
  const daysInMonth=new Date(y,m+1,0).getDate();
  const prevDays=new Date(y,m,0).getDate();

  // Build session map: date â†’ session info
  const sessMap={};
  sessions.forEach(s=>{
    const k=s.session_date;
    if(!sessMap[k])sessMap[k]=[];
    sessMap[k].push(s);
  });

  // Build scheduled dates based on group schedules
  const groups=S.calGroupId?S.groups.filter(g=>g.id==S.calGroupId):S.groups;
  const schedDays=new Set();
  const schedMap={}; // ISO date â†’ group info
  groups.forEach(g=>{
    (g.schedules||[]).forEach(sch=>{
      const dow=Number(sch.day_of_week); // 0=Mon
      for(let d=1;d<=daysInMonth;d++){
        const date=new Date(y,m,d);
        const dayOfWeek=date.getDay()===0?6:date.getDay()-1;
        if(dayOfWeek===dow){
          const iso=dateISO(date);
          schedDays.add(iso);
          if(!schedMap[iso])schedMap[iso]=[];
          schedMap[iso].push({group:g,sched:sch});
        }
      }
    });
  });

  // Fill prev month padding
  for(let i=0;i<startOffset;i++){
    const cell=document.createElement('div');
    cell.className='cal-cell other-month';
    cell.innerHTML=`<div class="cal-date">${prevDays-startOffset+i+1}</div>`;
    grid.appendChild(cell);
  }

  for(let d=1;d<=daysInMonth;d++){
    const iso=dateISO(new Date(y,m,d));
    const hasSess=!!sessMap[iso];
    const hasSched=schedDays.has(iso);
    const isToday=iso===today;
    const cell=document.createElement('div');
    const cls=['cal-cell'];
    if(isToday)cls.push('today');
    if(hasSess)cls.push('has-session');
    if(hasSched||hasSess)cls.push('clickable');
    cell.className=cls.join(' ');

    let inner=`<div class="cal-date">${d}${isToday?'<span class="cal-today-dot"></span>':''}</div>`;

    if(hasSess){
      sessMap[iso].forEach(s=>{
        inner+=`<span class="cal-pill" onclick="openSessionFromCal(${s.session_id},${s.group_id})">
          âœ“ ${escH(s.group_name.substring(0,12))} (${s.present_count||0})
        </span>`;
      });
    }

    if(hasSched&&!hasSess){
      (schedMap[iso]||[]).forEach(({group:g,sched:sch})=>{
        inner+=`<span class="cal-sched-dot" onclick="createSessionFromCal(${g.id},'${iso}')">
          + ${escH(g.name.substring(0,12))}
        </span>`;
      });
    }

    cell.innerHTML=inner;
    grid.appendChild(cell);
  }

  // Fill next month
  const total=startOffset+daysInMonth;
  const remaining=(7-total%7)%7;
  for(let i=1;i<=remaining;i++){
    const cell=document.createElement('div');
    cell.className='cal-cell other-month';
    cell.innerHTML=`<div class="cal-date">${i}</div>`;
    grid.appendChild(cell);
  }
}

async function createSessionFromCal(groupId, dateISO){
  if(!confirm(`OtworzyÄ‡ sesjÄ™ treningowÄ… dla tej grupy w dniu ${fmtDate(dateISO)}?`))return;
  try{
    const d=await api('/api/instructor/sessions','POST',{group_id:groupId,session_date:dateISO});
    renderCalendar();
    // Go to attendance
    S.curSessionId=d.id;
    S.curSessionData={session_id:d.id,group_id:groupId,session_date:dateISO};
    S.curPage='sessions';
    $('nav-sessions').click();
  }catch(e){alert('BÅ‚Ä…d: '+e.message);}
}

function openSessionFromCal(sessionId, groupId){
  S.curSessionId=sessionId;
  S.curSessionData={session_id:sessionId,group_id:groupId};
  goPage('sessions');
}

/* â”€â”€ SESSIONS LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function renderSessions(){
  $('page-body').innerHTML='<div class="loading">Åadowanie sesji...</div>';
  const gid=S.sessFilterGroup;
  let url=`/api/instructor/sessions?from=${S.sessFrom}`;
  if(gid)url+=`&group_id=${gid}`;
  try{
    const d=await api(url);
    S.sessions=d.rows||[];
  }catch(e){S.sessions=[];}

  const groupOpts=S.groups.map(g=>`<option value="${g.id}" ${S.sessFilterGroup==g.id?'selected':''}>${escH(g.location_city)} â€” ${escH(g.name)}</option>`).join('');

  $('page-body').innerHTML=`
    <div class="toolbar">
      <select onchange="S.sessFilterGroup=this.value;renderSessions()">
        <option value="">Wszystkie grupy</option>
        ${groupOpts}
      </select>
      <input type="date" value="${S.sessFrom}" onchange="S.sessFrom=this.value;renderSessions()" title="Od daty">
      <button class="btn btn-red btn-sm" onclick="openCreateSession()">+ Nowa sesja</button>
    </div>
    ${S.sessions.length===0?'<div class="empty">Brak sesji. UtwÃ³rz pierwszÄ… lub wybierz termin w kalendarzu.</div>':
      `<div class="table-wrap"><table>
        <thead><tr>
          <th>Data</th><th>Grupa</th><th>Lokalizacja</th><th>Oznaczeni</th><th>Obecni</th><th></th>
        </tr></thead>
        <tbody>
          ${S.sessions.map(s=>`<tr>
            <td><strong>${fmtDate(s.session_date)}</strong></td>
            <td>${escH(s.group_name||'')}</td>
            <td>${escH(s.location_city||'')} ${s.location_name?'/ '+escH(s.location_name):''}</td>
            <td>${s.total_marked||0}</td>
            <td>${s.present_count||0 ?`<span class="badge badge-green">${s.present_count}</span>`:
              s.total_marked>0?'<span class="badge badge-red">0</span>':'<span class="badge badge-gray">â€”</span>'}</td>
            <td><button class="btn btn-outline btn-sm" onclick="openSessionById(${s.session_id},${s.group_id},'${s.session_date}','${escH(s.group_name||'')}')">ObecnoÅ›ci</button></td>
          </tr>`).join('')}
        </tbody>
      </table></div>`
    }
  `;
}

function openSessionById(sessionId, groupId, date, name){
  S.curSessionId=sessionId;
  S.curSessionData={session_id:sessionId,group_id:groupId,session_date:date,group_name:name};
  renderAttendance();
}

async function renderAttendance(){
  const sess=S.curSessionData||{};
  $('page-title').textContent='ObecnoÅ›ci';
  $('page-sub').textContent=`${escH(sess.group_name||'')} Â· ${fmtDate(sess.session_date||'')}`;
  $('page-body').innerHTML='<div class="loading">Åadowanie listy...</div>';
  try{
    const d=await api(`/api/instructor/sessions/${sess.session_id}/attendance?group_id=${sess.group_id}`);
    const students=d.rows||[];
    const pres=students.filter(s=>s.present).length;

    $('page-body').innerHTML=`
      <div class="breadcrumb">
        <a onclick="S.curSessionId=null;renderSessions()">Sesje</a><span class="sep">â€º</span>
        <span>${escH(sess.group_name||'')} â€“ ${fmtDate(sess.session_date||'')}</span>
      </div>
      <div class="stat-row" style="margin-bottom:16px">
        <div class="stat-card green"><div class="sc-lbl">Obecnych</div><div class="sc-val">${pres}</div></div>
        <div class="stat-card"><div class="sc-lbl">Wszystkich</div><div class="sc-val">${students.length}</div></div>
      </div>
      <div class="toolbar">
        <button class="btn btn-green btn-sm" onclick="markAll(true)">âœ“ Zaznacz wszystkich</button>
        <button class="btn btn-outline btn-sm" onclick="markAll(false)">âœ— Odznacz wszystkich</button>
      </div>
      <div class="scroll-hint">${students.length} kursantÃ³w â€” kliknij checkbox, aby zaznaczyÄ‡ obecnoÅ›Ä‡</div>
      <div class="att-list" id="att-list">
        ${students.map(s=>`
          <div class="att-row" id="att-${s.student_id}">
            <div class="att-check ${s.present?'checked':''}" id="chk-${s.student_id}" onclick="toggleAtt(${sess.session_id},${s.student_id},this)">
              ${s.present?'âœ“':''}
            </div>
            <div class="att-name">${escH(s.last_name)}, ${escH(s.first_name)}</div>
            <div class="att-pay ${weeksAgo(s.last_payment)>28?'late':''}">
              WpÅ‚ata: ${s.last_payment?fmtDate(s.last_payment):'â€”'}
            </div>
          </div>`).join('')}
      </div>
    `;
  }catch(e){$('page-body').innerHTML=`<div class="empty">BÅ‚Ä…d: ${escH(e.message)}</div>`;}
}

async function toggleAtt(sessionId, studentId, el){
  const wasChecked=el.classList.contains('checked');
  const nowPresent=!wasChecked;
  el.classList.toggle('checked',nowPresent);
  el.textContent=nowPresent?'âœ“':'';
  try{
    await api(`/api/instructor/sessions/${sessionId}/attendance`,'POST',{student_id:studentId,present:nowPresent});
  }catch(e){
    // Revert on error
    el.classList.toggle('checked',wasChecked);
    el.textContent=wasChecked?'âœ“':'';
    alert('BÅ‚Ä…d zapisu: '+e.message);
  }
}

async function markAll(present){
  const sess=S.curSessionData;
  const checkboxes=document.querySelectorAll('.att-check');
  for(const el of checkboxes){
    const sid=Number(el.id.replace('chk-',''));
    el.classList.toggle('checked',present);
    el.textContent=present?'âœ“':'';
    await api(`/api/instructor/sessions/${sess.session_id}/attendance`,'POST',{student_id:sid,present}).catch(()=>{});
  }
}

/* â”€â”€ PAYMENTS PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function renderPayments(){
  $('page-body').innerHTML='<div class="loading">Åadowanie pÅ‚atnoÅ›ci...</div>';
  try{
    const d=await api('/api/instructor/payments');
    S.payments=d.rows||[];
  }catch(e){S.payments=[];}

  const total=S.payments.reduce((s,p)=>s+Number(p.amount||0),0);

  $('page-body').innerHTML=`
    <div class="stat-row" style="margin-bottom:16px">
      <div class="stat-card green"><div class="sc-lbl">WpÅ‚aty w sezonie</div><div class="sc-val">${total.toFixed(0)} zÅ‚</div></div>
      <div class="stat-card"><div class="sc-lbl">Liczba wpÅ‚at</div><div class="sc-val">${S.payments.length}</div></div>
    </div>
    <div class="toolbar">
      <input type="search" placeholder="Szukaj po nazwisku..." id="pay-search" oninput="filterPayments()">
    </div>
    ${S.payments.length===0?'<div class="empty">Brak pÅ‚atnoÅ›ci w sezonie.</div>':
      `<div class="table-wrap"><table>
        <thead><tr>
          <th>Data</th><th>Kursant</th><th>Grupa</th><th>Kwota</th><th>Uwaga</th>
        </tr></thead>
        <tbody id="pay-tbody">
          ${S.payments.map(p=>`<tr>
            <td>${fmtDate(p.paid_at)}</td>
            <td><a href="#" onclick="event.preventDefault();openStudent(${p.student_id})" style="color:var(--text)">${escH(p.last_name||'')}, ${escH(p.first_name||'')}</a></td>
            <td class="text-muted text-sm">${escH(p.location_city||'')} â€” ${escH(p.group_name||'')}</td>
            <td><strong>${fmtMoney(p.amount)}</strong></td>
            <td class="text-muted text-sm">${p.note?escH(p.note):''}</td>
          </tr>`).join('')}
        </tbody>
      </table></div>`
    }
  `;
}

function filterPayments(){
  const q=$('pay-search').value.toLowerCase();
  const tbody=$('pay-tbody');
  if(!tbody)return;
  tbody.querySelectorAll('tr').forEach(tr=>{
    const name=tr.cells[1]?tr.cells[1].textContent.toLowerCase():'';
    tr.style.display=name.includes(q)?'':'none';
  });
}

/* â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openModal(title, bodyHTML, footerHTML=''){
  $('modal-title').textContent=title;
  $('modal-body').innerHTML=bodyHTML;
  $('modal-footer').innerHTML=footerHTML;
  $('modal').style.display='flex';
}
function closeModal(){$('modal').style.display='none';}

function openCreateSession(){
  const gOpts=S.groups.map(g=>`<option value="${g.id}">${escH(g.location_city)} â€” ${escH(g.name)}</option>`).join('');
  openModal('Nowa sesja treningowa',`
    <div class="form-field"><label>Grupa</label><select id="m-gid">${gOpts}</select></div>
    <div class="form-field"><label>Data</label><input type="date" id="m-dt" value="${todayISO()}"></div>
  `,`<button class="btn btn-outline" onclick="closeModal()">Anuluj</button>
     <button class="btn btn-red" onclick="doCreateSession()">UtwÃ³rz sesjÄ™</button>`);
}

async function doCreateSession(){
  const gid=$('m-gid').value, dt=$('m-dt').value;
  if(!gid||!dt)return;
  try{
    const d=await api('/api/instructor/sessions','POST',{group_id:gid,session_date:dt});
    closeModal();
    const g=S.groups.find(x=>x.id==gid)||{};
    openSessionById(d.id,Number(gid),dt,g.name||'');
  }catch(e){alert('BÅ‚Ä…d: '+e.message);}
}

function openAddStudent(groupId){
  const gOpts=S.groups.map(g=>`<option value="${g.id}" ${g.id==groupId?'selected':''}>${escH(g.location_city)} â€” ${escH(g.name)}</option>`).join('');
  openModal('Dodaj kursanta',`
    <div class="form-row">
      <div class="form-field"><label>ImiÄ™ *</label><input id="a-fn" placeholder="ImiÄ™"></div>
      <div class="form-field"><label>Nazwisko *</label><input id="a-ln" placeholder="Nazwisko"></div>
    </div>
    <div class="form-row">
      <div class="form-field"><label>Telefon</label><input id="a-ph" placeholder="+48..."></div>
      <div class="form-field"><label>E-mail</label><input id="a-em" type="email" placeholder=""></div>
    </div>
    <div class="form-row">
      <div class="form-field"><label>Rok urodzenia</label><input id="a-by" type="number" min="1950" max="2020"></div>
      <div class="form-field"><label>Przypisz do grupy</label><select id="a-gp">${gOpts}</select></div>
    </div>
  `,`<button class="btn btn-outline" onclick="closeModal()">Anuluj</button>
     <button class="btn btn-red" onclick="doAddStudent()">Dodaj</button>`);
}

async function doAddStudent(){
  const fn=$('a-fn').value.trim(), ln=$('a-ln').value.trim();
  if(!fn||!ln){alert('ImiÄ™ i nazwisko sÄ… wymagane.');return;}
  try{
    await api('/api/instructor/students','POST',{
      first_name:fn, last_name:ln,
      phone:$('a-ph').value.trim()||null,
      email:$('a-em').value.trim()||null,
      birth_year:$('a-by').value||null,
      group_id:$('a-gp').value||null
    });
    closeModal();
    openGroup(S.curGroupId);
  }catch(e){alert('BÅ‚Ä…d: '+e.message);}
}

function openEditStudent(){
  const s=S.curStudentData;
  openModal(`Edytuj: ${s.first_name} ${s.last_name}`,`
    <div class="form-row">
      <div class="form-field"><label>ImiÄ™ *</label><input id="e-fn" value="${escH(s.first_name||'')}"></div>
      <div class="form-field"><label>Nazwisko *</label><input id="e-ln" value="${escH(s.last_name||'')}"></div>
    </div>
    <div class="form-row">
      <div class="form-field"><label>Telefon</label><input id="e-ph" value="${escH(s.phone||'')}"></div>
      <div class="form-field"><label>E-mail</label><input id="e-em" value="${escH(s.email||'')}"></div>
    </div>
    <div class="form-field"><label>Rok urodzenia</label><input id="e-by" type="number" value="${s.birth_year||''}"></div>
  `,`<button class="btn btn-outline" onclick="closeModal()">Anuluj</button>
     <button class="btn btn-red" onclick="doEditStudent(${s.id})">Zapisz</button>`);
}

async function doEditStudent(id){
  const fn=$('e-fn').value.trim(), ln=$('e-ln').value.trim();
  if(!fn||!ln){alert('ImiÄ™ i nazwisko sÄ… wymagane.');return;}
  try{
    await api(`/api/instructor/students/${id}`,'PATCH',{
      first_name:fn, last_name:ln,
      phone:$('e-ph').value.trim()||null,
      email:$('e-em').value.trim()||null,
      birth_year:$('e-by').value||null
    });
    closeModal();
    openStudent(id);
  }catch(e){alert('BÅ‚Ä…d: '+e.message);}
}

async function confirmDeleteStudent(id){
  if(!confirm('UsunÄ…Ä‡ tego kursanta? JeÅ›li ma historiÄ™ (pÅ‚atnoÅ›ci/obecnoÅ›ci), zostanie oznaczony jako nieaktywny.'))return;
  try{
    const d=await api(`/api/instructor/students/${id}`,'DELETE');
    if(d.soft)alert('Kursant ma historiÄ™ â€” oznaczony jako nieaktywny.');
    S.curStudentId=null;
    openGroup(S.curGroupId);
  }catch(e){alert('BÅ‚Ä…d: '+e.message);}
}

function openAddPayment(studentId){
  openModal('Dodaj wpÅ‚atÄ™',`
    <div class="form-row">
      <div class="form-field"><label>Kwota (zÅ‚) *</label><input id="p-am" type="number" min="1" placeholder="np. 150"></div>
      <div class="form-field"><label>Data</label><input id="p-dt" type="date" value="${todayISO()}"></div>
    </div>
    <div class="form-field"><label>Uwaga</label><input id="p-nt" placeholder="opcjonalnie"></div>
  `,`<button class="btn btn-outline" onclick="closeModal()">Anuluj</button>
     <button class="btn btn-green" onclick="doAddPayment(${studentId})">Zapisz wpÅ‚atÄ™</button>`);
}

async function doAddPayment(studentId){
  const amt=$('p-am').value;
  if(!amt){alert('Podaj kwotÄ™.');return;}
  try{
    await api(`/api/instructor/students/${studentId}/payments`,'POST',{
      amount:parseFloat(amt), date:$('p-dt').value, note:$('p-nt').value.trim()||null
    });
    closeModal();
    openStudent(studentId);
  }catch(e){alert('BÅ‚Ä…d: '+e.message);}
}

async function deletePayment(studentId, payId){
  if(!confirm('UsunÄ…Ä‡ tÄ™ wpÅ‚atÄ™?'))return;
  try{
    await api(`/api/instructor/students/${studentId}/payments?pid=${payId}`,'DELETE');
    openStudent(studentId);
  }catch(e){alert('BÅ‚Ä…d: '+e.message);}
}

/* â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(function init(){
  const tok=localStorage.getItem('inst_token');
  const inst=localStorage.getItem('inst_data');
  if(tok&&inst){
    try{
      S.token=tok;
      S.inst=JSON.parse(inst);
      $('sb-name').textContent=(S.inst.first_name||'')+' '+(S.inst.last_name||'');
      $('login-screen').style.display='none';
      $('app').classList.add('visible');
      loadAll();
    }catch(e){
      localStorage.removeItem('inst_token');
      localStorage.removeItem('inst_data');
    }
  }
})();
</script>
</body>
</html>
