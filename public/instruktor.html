<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Panel Instruktora — Krav Maga Saggita</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0b0b0d;
  --bg2:#111115;
  --panel:#16161c;
  --panel2:#1e1e26;
  --line:#252530;
  --line2:#2e2e3e;
  --text:#dddde8;
  --dim:#7777a0;
  --dim2:#4a4a6a;
  --accent:#c8230a;
  --accent2:#e53015;
  --asoft:rgba(200,35,10,.15);
  --aborder:rgba(200,35,10,.35);
  --green:#1a9952;
  --gsoft:rgba(26,153,82,.15);
  --gborder:rgba(26,153,82,.35);
  --yellow:#b08000;
  --ysoft:rgba(176,128,0,.15);
  --yborder:rgba(176,128,0,.35);
  --blue:#1a60c8;
  --bsoft:rgba(26,96,200,.12);
  --sbw:210px;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'SF Pro Text',-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;font-size:13px;line-height:1.5}
button{cursor:pointer;font-family:inherit;font-size:13px}
input,select,textarea{font-family:inherit;font-size:13px}
a{color:inherit;text-decoration:none}

/* ─── LOGIN ─────────────────────────────────────────────────── */
#pg-login{display:flex;height:100vh;align-items:center;justify-content:center;background:var(--bg)}
#pg-login::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 500px 350px at 50% 35%,rgba(200,35,10,.07),transparent 65%);pointer-events:none}
.lbox{position:relative;background:var(--panel);border:1px solid var(--line2);width:340px;padding:36px 32px 32px}
.lbrand{font-size:18px;font-weight:900;letter-spacing:.12em;text-transform:uppercase;color:#fff;margin-bottom:4px}
.lbrand span{color:var(--accent)}
.lsub{font-size:10px;letter-spacing:.18em;text-transform:uppercase;color:var(--dim);margin-bottom:28px}
.lf label{display:block;font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--dim);margin-bottom:5px}
.lf input{width:100%;background:var(--bg2);border:1px solid var(--line2);padding:9px 11px;color:var(--text);outline:none;margin-bottom:12px}
.lf input:focus{border-color:var(--accent)}
.lbtn{width:100%;padding:11px;background:var(--accent);border:none;color:#fff;font-weight:700;font-size:13px;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;margin-top:4px;transition:background .15s}
.lbtn:hover{background:var(--accent2)}
.lerr{margin-top:10px;padding:8px 10px;background:var(--asoft);border:1px solid var(--aborder);color:#ff7a5a;font-size:11px;font-weight:600;display:none}
.lerr.show{display:block}

/* ─── APP ────────────────────────────────────────────────────── */
#app{display:none;height:100vh;flex-direction:row}
#app.on{display:flex}

/* Sidebar */
#sb{width:var(--sbw);min-width:var(--sbw);background:var(--panel);border-right:1px solid var(--line);display:flex;flex-direction:column}
.sb-top{padding:18px 16px 14px;border-bottom:1px solid var(--line)}
.sb-brand{font-size:14px;font-weight:900;letter-spacing:.1em;text-transform:uppercase;color:#fff}
.sb-brand em{color:var(--accent);font-style:normal}
.sb-who{margin-top:6px}
.sb-who strong{display:block;font-size:12px;font-weight:700;color:var(--text)}
.sb-who span{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.08em}
.sb-nav{padding:10px 8px;flex:1}
.sb-sec{font-size:9px;text-transform:uppercase;letter-spacing:.14em;color:var(--dim2);padding:8px 8px 4px;margin-top:4px}
.ni{display:flex;align-items:center;gap:9px;padding:8px 10px;color:var(--dim);cursor:pointer;font-size:12px;font-weight:500;transition:all .12s;border-left:2px solid transparent;margin-bottom:1px}
.ni:hover{color:var(--text);background:var(--panel2)}
.ni.on{color:var(--text);border-left-color:var(--accent);background:var(--asoft)}
.ni-ico{font-size:13px;width:16px;text-align:center;flex-shrink:0}
.sb-bot{padding:10px 8px;border-top:1px solid var(--line)}
.lout{width:100%;padding:7px 10px;background:transparent;border:1px solid var(--line2);color:var(--dim);font-size:11px;text-transform:uppercase;letter-spacing:.08em;transition:all .12s}
.lout:hover{border-color:var(--aborder);color:var(--accent)}

/* Main */
#main{flex:1;overflow:hidden;display:flex;flex-direction:column}
.ph{padding:16px 22px 12px;border-bottom:1px solid var(--line);flex-shrink:0;display:flex;align-items:flex-end;gap:12px}
.ph-title{font-size:17px;font-weight:800;letter-spacing:-.01em;flex:1}
.ph-sub{font-size:11px;color:var(--dim);margin-bottom:1px}
#pb{flex:1;overflow-y:auto;padding:20px 22px}

/* ─── COMPONENTS ─────────────────────────────────────────────── */
.stats{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap}
.sc{background:var(--panel);border:1px solid var(--line);padding:13px 16px;min-width:130px}
.sc-l{font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);margin-bottom:5px}
.sc-v{font-size:22px;font-weight:900;color:var(--text)}
.sc.g{border-color:var(--gborder);background:var(--gsoft)}
.sc.r{border-color:var(--aborder);background:var(--asoft)}
.sc.b{border-color:rgba(26,96,200,.3);background:var(--bsoft)}
.sc.y{border-color:var(--yborder);background:var(--ysoft)}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 13px;border:none;font-weight:600;font-size:12px;letter-spacing:.03em;cursor:pointer;transition:all .12s;white-space:nowrap}
.btn-r{background:var(--accent);color:#fff}.btn-r:hover{background:var(--accent2)}
.btn-g{background:var(--green);color:#fff}.btn-g:hover{filter:brightness(1.1)}
.btn-o{background:transparent;border:1px solid var(--line2);color:var(--text)}.btn-o:hover{border-color:var(--line2);background:var(--panel2)}
.btn-ghost{background:transparent;border:1px solid var(--aborder);color:var(--accent)}.btn-ghost:hover{background:var(--asoft)}
.btn-sm{padding:5px 9px;font-size:11px}
.btn-xs{padding:3px 7px;font-size:10px}

/* Table */
.tw{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th{text-align:left;font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);padding:8px 12px;border-bottom:1px solid var(--line);font-weight:600}
td{padding:9px 12px;border-bottom:1px solid var(--line);font-size:12px;vertical-align:middle}
tr:hover td{background:var(--panel2)}
.td-main{font-weight:600;color:var(--text)}
.td-dim{color:var(--dim)}

/* Badges */
.bx{display:inline-block;padding:2px 7px;font-size:10px;font-weight:700;letter-spacing:.04em}
.bx-g{background:var(--gsoft);color:#3dd68c;border:1px solid var(--gborder)}
.bx-r{background:var(--asoft);color:#ff6b4a;border:1px solid var(--aborder)}
.bx-d{background:var(--panel2);color:var(--dim);border:1px solid var(--line)}
.eg-row{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:var(--panel2)}
.bx-y{background:var(--ysoft);color:#e6a817;border:1px solid var(--yborder)}
.bx-b{background:var(--bsoft);color:#6ba3f5;border:1px solid rgba(26,96,200,.3)}

/* Toolbar */
.bar{display:flex;gap:8px;align-items:center;margin-bottom:14px;flex-wrap:wrap}
.bar input,.bar select{background:var(--panel);border:1px solid var(--line2);padding:7px 10px;color:var(--text);outline:none}
.bar input:focus,.bar select:focus{border-color:var(--accent)}
.bar input[type=search]{flex:1;min-width:180px;max-width:260px}
.sep{flex:1}

/* Breadcrumb */
.bc{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--dim);margin-bottom:14px}
.bc a{cursor:pointer;color:var(--dim)}.bc a:hover{color:var(--text)}
.bc-sep{color:var(--dim2)}

/* Group cards */
.gcards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.gc{background:var(--panel);border:1px solid var(--line);padding:16px;cursor:pointer;transition:all .12s;border-top:3px solid var(--accent)}
.gc:hover{border-color:var(--aborder);background:var(--panel2)}
.gc-city{font-size:9px;text-transform:uppercase;letter-spacing:.12em;color:var(--accent);margin-bottom:4px}
.gc-name{font-size:15px;font-weight:800;margin-bottom:10px;line-height:1.2}
.gc-meta{display:flex;gap:14px;font-size:11px;color:var(--dim);margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--line)}
.gc-sched{font-size:11px;color:var(--dim);line-height:1.9;margin-bottom:12px}
.gc-sched strong{color:var(--text)}
.gc-foot{display:flex;gap:6px}

/* Info blocks */
.ib{background:var(--panel);border:1px solid var(--line);padding:14px 16px;margin-bottom:12px}
.ib h4{font-size:9px;text-transform:uppercase;letter-spacing:.12em;color:var(--dim);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--line)}
.ir{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--line);font-size:12px}
.ir:last-child{border:none}
.ir-l{color:var(--dim)}
.ir-v{font-weight:700}
.pg2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Calendar */
.cal-head{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.cal-title{font-size:16px;font-weight:900;letter-spacing:-.01em;flex:1}
.cal-nav button{padding:5px 10px;background:var(--panel);border:1px solid var(--line2);color:var(--text);font-size:12px}
.cal-nav button:hover{border-color:var(--accent);color:var(--accent)}
.cal-filt select{background:var(--panel);border:1px solid var(--line2);padding:6px 10px;color:var(--text);outline:none}
.cgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--line)}
.cgh{background:var(--bg);text-align:center;font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);padding:7px 0}
.cgc{background:var(--panel);min-height:72px;padding:5px 6px;position:relative}
.cgc.other{background:var(--bg);opacity:.4}
.cgc.today{background:var(--panel2)}
.cgc.today .cgc-d{color:var(--accent);font-weight:900}
.cgc.clickable{cursor:pointer}
.cgc.clickable:hover{background:var(--panel2)}
.cgc-d{font-size:11px;font-weight:700;margin-bottom:3px}
.cpill{display:block;padding:2px 5px;font-size:9px;font-weight:700;margin-bottom:2px;cursor:pointer;text-overflow:ellipsis;overflow:hidden;white-space:nowrap}
.cpill-s{background:var(--gsoft);color:#3dd68c;border-left:2px solid var(--green)}
.cpill-s:hover{background:rgba(26,153,82,.25)}
.cpill-f{background:rgba(176,128,0,.15);color:#e6a817;border-left:2px solid #b08000}
.cpill-f:hover{background:rgba(176,128,0,.25)}
.cpill-f{background:var(--ysoft);color:#e6a817;border-left:2px solid var(--yellow)}
.cpill-f:hover{background:rgba(176,128,0,.25)}
.cpill-p{background:var(--asoft);color:#ff6b4a;border-left:2px solid var(--accent)}
.cpill-p:hover{background:rgba(200,35,10,.25)}
.cal-legend{display:flex;gap:14px;margin-top:12px;font-size:10px;color:var(--dim)}
.cal-legend span{display:inline-flex;align-items:center;gap:5px}
.cal-legend em{display:inline-block;width:10px;height:10px;font-style:normal}

/* Attendance */
.att-list{display:flex;flex-direction:column;gap:1px;max-height:calc(100vh - 280px);overflow-y:auto}
.att-row{display:grid;grid-template-columns:36px 1fr auto auto;align-items:center;gap:10px;padding:8px 12px;background:var(--panel);border-left:2px solid transparent;transition:all .1s}
.att-row:hover{background:var(--panel2)}
.att-row.present{border-left-color:var(--green);background:var(--gsoft)}
.att-row.absent{border-left-color:transparent}
.att-chk{width:24px;height:24px;border:2px solid var(--line2);background:var(--bg2);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .12s;font-size:13px;font-weight:900;flex-shrink:0}
.att-chk:hover{border-color:var(--green)}
.att-chk.on{background:var(--green);border-color:var(--green);color:#fff}
.att-name{font-weight:600;font-size:13px}
.att-pay{font-size:11px;color:var(--dim);text-align:right}
.att-pay.late{color:#ff6b4a;font-weight:600}

/* Payment rows */
.prow{display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--panel);border-bottom:1px solid var(--line)}
.prow:hover{background:var(--panel2)}
.prow-amt{font-weight:800;font-size:14px;min-width:55px}
.prow-dt{font-size:11px;color:var(--dim);width:80px}
.prow-name{flex:1;font-size:12px}
.prow-note{flex:1;font-size:11px;color:var(--dim);text-align:right}

/* Modal */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px}
.md{background:var(--panel);border:1px solid var(--line2);width:100%;max-width:440px;max-height:90vh;overflow-y:auto}
.md-h{padding:15px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
.md-title{font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:.04em}
.md-x{background:none;border:none;color:var(--dim);font-size:18px;cursor:pointer;padding:0 2px}.md-x:hover{color:var(--text)}
.md-b{padding:18px}
.md-f{padding:12px 18px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:8px}
.ff{margin-bottom:13px}
.ff label{display:block;font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);margin-bottom:5px}
.ff input,.ff select{width:100%;background:var(--bg2);border:1px solid var(--line2);padding:9px 10px;color:var(--text);outline:none}
.ff input:focus,.ff select:focus{border-color:var(--accent)}
.ff2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* Misc */
.empty{text-align:center;padding:40px 20px;color:var(--dim);font-size:13px}
.loading{text-align:center;padding:40px;color:var(--dim)}
.divider{height:1px;background:var(--line);margin:14px 0}
.section-hd{font-size:10px;text-transform:uppercase;letter-spacing:.12em;color:var(--dim);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}

/* ─── MOBILE NAV ──────────────────────────────────────────────── */
#mob-bar{display:none;position:fixed;top:0;left:0;right:0;z-index:500;background:var(--panel);border-bottom:1px solid var(--line);height:52px;align-items:center;padding:0 12px;gap:10px}
#mob-bar .mb-brand{font-size:13px;font-weight:900;letter-spacing:.1em;text-transform:uppercase;color:#fff;flex:1}
#mob-bar .mb-brand em{color:var(--accent);font-style:normal}
#ham{background:none;border:1px solid var(--line2);color:var(--text);width:38px;height:38px;font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;font-family:inherit}
#sb-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:998}

/* ─── BOTTOM NAV (mobile) ─────────────────────────────────────── */
#bot-nav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:500;background:var(--panel);border-top:1px solid var(--line);height:58px;align-items:center;justify-content:space-around}
.bn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;padding:6px 4px;cursor:pointer;color:var(--dim);font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;border:none;background:none;font-family:inherit}
.bn.on{color:var(--accent)}
.bn-ico{font-size:18px;line-height:1}

@media(max-width:700px){
  #sb{display:none}
  #mob-bar{display:flex}
  #bot-nav{display:flex}
  #app.on{flex-direction:column;padding-top:52px;padding-bottom:58px}
  #main{min-height:0}
  #pb{padding:14px 12px}
  .ph{padding:10px 12px 8px}
  .ph-title{font-size:15px}

  /* Stats — 2 cols */
  .stats{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .sc{min-width:0;padding:10px 12px}
  .sc-v{font-size:20px}

  /* Group cards — single col */
  .gcards{grid-template-columns:1fr}

  /* Tables → card layout */
  .tw{overflow-x:unset}
  .tw table,.tw thead,.tw tbody,.tw th,.tw td,.tw tr{display:block}
  .tw thead tr{display:none}
  .tw tbody tr{background:var(--panel);border:1px solid var(--line);margin-bottom:8px;padding:10px 12px}
  .tw tbody tr:hover td{background:transparent}
  .tw td{padding:4px 0;font-size:12px;border:none;display:flex;justify-content:space-between;align-items:center;gap:8px;min-height:28px}
  .tw td::before{content:attr(data-label);font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);flex-shrink:0;min-width:90px}
  .tw td:last-child{justify-content:flex-end;padding-top:10px;margin-top:6px;border-top:1px solid var(--line)}
  .tw td:last-child::before{display:none}

  .pg2{grid-template-columns:1fr}
  .ff2{grid-template-columns:1fr}

  /* Attendance */
  .att-row{grid-template-columns:40px 1fr;grid-template-rows:auto auto;gap:6px 10px;padding:10px 12px}
  .att-pay{grid-column:2;font-size:11px}
  .att-chk{width:34px;height:34px;font-size:16px;grid-row:1/3;align-self:center}

  /* Calendar */
  .cal-head{flex-wrap:wrap;gap:6px}
  .cal-title{font-size:14px;min-width:100%;order:-1}
  .cal-filt{width:100%}
  .cal-filt select{width:100%}
  .cgc{min-height:50px;padding:3px 2px}
  .cgc-d{font-size:10px}
  .cpill{font-size:8px;padding:1px 3px}
  .cal-legend{flex-direction:column;gap:5px;font-size:10px}

  /* Toolbar */
  .bar{flex-direction:column;align-items:stretch}
  .bar input,.bar select{max-width:none;width:100%}
  .sep{display:none}
  .bar .btn{width:100%;justify-content:center}

  /* Modal */
  .mo{padding:8px}
  .md{max-width:100%;max-height:95vh}

  .bc{font-size:10px;flex-wrap:wrap}
  .prow{flex-wrap:wrap;gap:4px}
  #ph-act .btn{font-size:11px;padding:6px 10px}
}

@media(max-width:380px){
  .cgh{font-size:8px;padding:5px 0}
  .cgc{min-height:42px}
  .cpill{display:none}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="pg-login">
  <div class="lbox">
    <div class="lbrand">KRAV MAGA <em>SAGGITA</em></div>
    <div class="lsub">Panel Instruktora</div>
    <div class="lf">
      <label>Login</label>
      <input id="li-u" type="text" autocomplete="username" placeholder="login">
      <label>Hasło</label>
      <input id="li-p" type="password" autocomplete="current-password" placeholder="••••••" onkeydown="if(event.key==='Enter')login()">
      <button class="lbtn" onclick="login()">Zaloguj się</button>
      <div id="li-e" class="lerr"></div>
    </div>
  </div>
</div>

<!-- MOBILE TOP BAR -->
<div id="mob-bar" style="display:none">
  <button id="ham" onclick="toggleSb()">☰</button>
  <div class="mb-brand">KM <em>SAGGITA</em></div>
  <button class="btn btn-ghost btn-xs" onclick="logout()">Wyloguj</button>
</div>
<div id="sb-overlay" onclick="closeSb()"></div>

<!-- MOBILE BOTTOM NAV -->
<div id="bot-nav" style="display:none">
  <button class="bn on" id="bn-dash"   onclick="go('dash')" ><span class="bn-ico">▣</span>Główna</button>
  <button class="bn"    id="bn-groups" onclick="go('groups')"><span class="bn-ico">◈</span>Grupy</button>
  <button class="bn"    id="bn-cal"    onclick="go('cal')"   ><span class="bn-ico">⊡</span>Kalendarz</button>
  <button class="bn"    id="bn-sess"   onclick="go('sess')"  ><span class="bn-ico">☑</span>Sesje</button>
  <button class="bn"    id="bn-pays"   onclick="go('pays')"  ><span class="bn-ico">₴</span>Płatności</button>
</div>

<!-- APP -->
<div id="app">
  <aside id="sb">
    <div class="sb-top">
      <div class="sb-brand">KM <em>SAGGITA</em></div>
      <div class="sb-who">
        <strong id="sb-name">—</strong>
        <span>Instruktor</span>
      </div>
    </div>
    <nav class="sb-nav">
      <div class="sb-sec">Panel</div>
      <div class="ni on" id="ni-dash"   onclick="go('dash')"><span class="ni-ico">▣</span>Dashboard</div>
      <div class="ni"    id="ni-groups" onclick="go('groups')"><span class="ni-ico">◈</span>Grupy & Kursanci</div>
      <div class="ni"    id="ni-cal"    onclick="go('cal')"><span class="ni-ico">⊡</span>Kalendarz zajęć</div>
      <div class="ni"    id="ni-sess"   onclick="go('sess')"><span class="ni-ico">☑</span>Sesje & Obecności</div>
      <div class="ni"    id="ni-pays"   onclick="go('pays')"><span class="ni-ico">₴</span>Płatności</div>
    </nav>
    <div class="sb-bot">
      <button class="lout" onclick="logout()">Wyloguj</button>
    </div>
  </aside>
  <main id="main">
    <div class="ph"><div><div id="ph-t" class="ph-title">Dashboard</div><div id="ph-s" class="ph-sub"></div></div><div id="ph-act"></div></div>
    <div id="pb"><div class="loading">Ładowanie...</div></div>
  </main>
</div>

<!-- MODAL -->
<div id="mo" class="mo" style="display:none" onclick="if(event.target===this)closeMo()">
  <div class="md">
    <div class="md-h"><div id="mo-t" class="md-title"></div><button class="md-x" onclick="closeMo()">✕</button></div>
    <div id="mo-b" class="md-b"></div>
    <div id="mo-f" class="md-f"></div>
  </div>
</div>

<script>
'use strict';
const $ = id => document.getElementById(id);
const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

// ── DATE FIX ─────────────────────────────────────────────────
// Handles both "2025-09-30" and "2025-09-30T00:00:00.000Z"
function fd(v) {
  if(!v) return '—';
  const s = String(v).substring(0, 10); // always take YYYY-MM-DD part
  if(!s.match(/^\d{4}-\d{2}-\d{2}$/)) return String(v);
  const [y,m,d] = s.split('-');
  return `${d}.${m}.${y}`;
}
function toISO(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function todayISO() { return toISO(new Date()); }
function normISO(v) { return String(v||'').substring(0,10); } // normalize any date value to YYYY-MM-DD
function daysAgo(v) { if(!v)return null; return Math.floor((Date.now()-new Date(normISO(v)))/86400000); }
const MONTHS = ['Styczeń','Luty','Marzec','Kwiecień','Maj','Czerwiec','Lipiec','Sierpień','Wrzesień','Październik','Listopad','Grudzień'];
const DAYS_SHORT = ['Pon','Wt','Śr','Czw','Pt','Sob','Ndz'];
const DAYS_FULL = ['Poniedziałek','Wtorek','Środa','Czwartek','Piątek','Sobota','Niedziela'];
const SEASON = '2025-09-01';

// ── STATE ─────────────────────────────────────────────────────
const S = {
  token:null, inst:null,
  groups:[], sessions:[], payments:[],
  page:'dash',
  calY: new Date().getFullYear(), calM: new Date().getMonth(), calGid: null,
  sessGid:'', sessFrom: SEASON,
  grpId:null, grpStudents:[],
  sessId:null, sessData:null,
  studId:null, studData:null,
};

// ── API ───────────────────────────────────────────────────────
async function api(url, method='GET', body=null) {
  const h = {'Content-Type':'application/json'};
  if(S.token) h['Authorization'] = 'Bearer '+S.token;
  const r = await fetch(url, {method, headers:h, body:body?JSON.stringify(body):null});
  if(!r.ok) {
    let msg = 'Błąd '+r.status;
    try{ const d=await r.json(); msg=d.error||msg; }catch(e){}
    throw new Error(msg);
  }
  const ct = r.headers.get('content-type')||'';
  return ct.includes('json') ? r.json() : {};
}

// ── AUTH ──────────────────────────────────────────────────────
async function login() {
  const u=$('li-u').value.trim(), p=$('li-p').value;
  const err=$('li-e'); err.classList.remove('show');
  if(!u||!p){err.textContent='Podaj login i hasło.';err.classList.add('show');return;}
  try {
    const d = await api('/api/instructor/login','POST',{username:u,password:p});
    setAuth(d.token, d.instructor);
    $('pg-login').style.display='none';
    $('app').classList.add('on');
    await loadAll();
  } catch(e) { err.textContent=e.message; err.classList.add('show'); }
}
function setAuth(tok, inst) {
  S.token=tok; S.inst=inst;
  localStorage.setItem('it',tok);
  localStorage.setItem('ii',JSON.stringify(inst));
  $('sb-name').textContent=(inst.first_name||'')+' '+(inst.last_name||'');
  showMobileBars(true);
}
function logout() {
  S.token=null; S.inst=null;
  localStorage.removeItem('it'); localStorage.removeItem('ii');
  $('app').classList.remove('on');
  $('pg-login').style.display='flex';
  showMobileBars(false);
}
function showMobileBars(show) {
  const d = show ? 'flex' : 'none';
  $('mob-bar').style.display = d;
  $('bot-nav').style.display = d;
}
function toggleSb() {
  const sb = $('sb'), ov = $('sb-overlay');
  const open = sb.style.display === 'flex';
  if(open) { sb.style.display='none'; ov.style.display='none'; }
  else {
    sb.style.cssText='display:flex;position:fixed;top:0;bottom:0;left:0;z-index:999;width:220px';
    ov.style.display='block';
  }
}
function closeSb() {
  $('sb').style.cssText='';
  $('sb-overlay').style.display='none';
}

// ── LOAD ──────────────────────────────────────────────────────
async function loadAll() {
  try { const d=await api('/api/instructor/groups'); S.groups=d.rows||[]; }
  catch(e) { console.error(e); }
  render('dash');
}

// ── NAVIGATION ────────────────────────────────────────────────
function go(page) {
  document.querySelectorAll('.ni').forEach(el=>el.classList.remove('on'));
  document.querySelectorAll('.bn').forEach(el=>el.classList.remove('on'));
  const n=$('ni-'+page); if(n)n.classList.add('on');
  const bn=$('bn-'+page); if(bn)bn.classList.add('on');
  S.page=page;
  if(page==='groups'){S.grpId=null;S.studId=null;}
  closeSb();
  render(page);
}
function render(page) {
  const titles={dash:'Dashboard',groups:'Grupy & Kursanci',cal:'Kalendarz zajęć',sess:'Sesje & Obecności',pays:'Płatności'};
  $('ph-t').textContent=titles[page]||page;
  $('ph-s').textContent='';
  $('ph-act').innerHTML='';
  switch(page) {
    case 'dash':   renderDash();   break;
    case 'groups':
      if(S.studId)     renderStud();
      else if(S.grpId) renderGrpStudents();
      else             renderGroups();
      break;
    case 'cal':    renderCal();    break;
    case 'sess':
      if(S.sessId) renderAtt();
      else         renderSess();
      break;
    case 'pays':   renderPays();   break;
  }
}

// ── DASHBOARD ─────────────────────────────────────────────────
function renderDash() {
  const total = S.groups.reduce((s,g)=>s+(g.student_count||0),0);
  const todayDow = new Date().getDay(); // 0=Sun
  const tdow0 = todayDow===0?6:todayDow-1; // 0=Mon
  const todayGs = S.groups.filter(g=>(g.schedules||[]).some(s=>Number(s.day_of_week)===tdow0+1)); // DB: 1=Mon ISO

  $('pb').innerHTML = `
    <div class="stats">
      <div class="sc b"><div class="sc-l">Twoje grupy</div><div class="sc-v">${S.groups.length}</div></div>
      <div class="sc g"><div class="sc-l">Kursanci łącznie</div><div class="sc-v">${total}</div></div>
      <div class="sc y"><div class="sc-l">Sezon od</div><div class="sc-v" style="font-size:15px">01.09.2025</div></div>
    </div>
    ${todayGs.length ? `<div class="section-hd">DZISIAJ MASZ ZAJĘCIA</div>
    <div class="gcards" style="margin-bottom:20px">${todayGs.map(gcardHTML).join('')}</div>` : ''}
    <div class="section-hd">WSZYSTKIE GRUPY</div>
    <div class="gcards">${S.groups.map(gcardHTML).join('') || '<div class="empty">Brak przypisanych grup.</div>'}</div>`;
}

function gcardHTML(g) {
  const _seen1=new Set();
  const sch=(g.schedules||[]).filter(s=>{const k=`${s.day_of_week}|${(s.time_label||String(s.time_start||'')).slice(0,5)}`;return _seen1.has(k)?false:(_seen1.add(k),true);}).map(s=>`<strong>${s.day_name||DAYS_FULL[s.day_of_week]}</strong>&nbsp;${s.time_label||''}`).join('<br>');
  return `<div class="gc" onclick="openGrp(${g.id})">
    <div class="gc-city">${esc(g.location_city||'')} / ${esc(g.location_name||'')}</div>
    <div class="gc-name">${esc(g.name)}</div>
    <div class="gc-meta">
      <span>Kursantów: <strong style="color:var(--text)">${g.student_count||0}</strong></span>
      ${g.age_range?`<span>Wiek: <strong style="color:var(--text)">${esc(g.age_range)}</strong></span>`:''}
    </div>
    <div class="gc-sched">${sch||'<span style="color:var(--dim2)">Brak grafiku</span>'}</div>
    <div class="gc-foot">
      <button class="btn btn-r btn-sm" onclick="event.stopPropagation();openGrp(${g.id})">Kursanci</button>
      <button class="btn btn-o btn-sm" onclick="event.stopPropagation();openCalGrp(${g.id})">Kalendarz</button>
    </div>
  </div>`;
}

// ── GROUPS ────────────────────────────────────────────────────
function renderGroups() {
  $('pb').innerHTML = `<div class="gcards">${S.groups.map(gcardHTML).join('')||'<div class="empty">Brak grup.</div>'}</div>`;
}

async function openGrp(gid) {
  S.grpId=gid; S.studId=null;
  $('pb').innerHTML='<div class="loading">Ładowanie kursantów...</div>';
  try {
    const d = await api(`/api/instructor/groups/${gid}/students`);
    S.grpStudents = d.rows||[];
    renderGrpStudents();
  } catch(e) { $('pb').innerHTML=`<div class="empty">Błąd: ${esc(e.message)}</div>`; }
}

function renderGrpStudents() {
  const g = S.groups.find(x=>x.id==S.grpId)||{};
  $('ph-t').textContent = esc(g.name||'Kursanci');
  $('ph-s').textContent = `${esc(g.location_city||'')} — ${esc(g.location_name||'')}`;

  const _seen2=new Set();
  const sch=(g.schedules||[]).filter(s=>{const k=`${s.day_of_week}|${(s.time_label||String(s.time_start||'')).slice(0,5)}`;return _seen2.has(k)?false:(_seen2.add(k),true);}).map(s=>`${s.day_name||DAYS_FULL[s.day_of_week]} ${s.time_label||''}`).join(', ');
  const st = S.grpStudents;

  $('pb').innerHTML = `
    <div class="bc"><a onclick="go('groups')">Grupy</a><span class="bc-sep">›</span><span>${esc(g.name||'')}</span></div>
    ${sch?`<div class="ib" style="margin-bottom:12px"><div class="ir"><span class="ir-l">Grafik</span><span class="ir-v">${esc(sch)}</span></div></div>`:''}
    <div class="bar">
      <input type="search" placeholder="Szukaj po nazwisku..." id="ss" oninput="filterStud()">
      <div class="sep"></div>
      <button class="btn btn-r btn-sm" onclick="moAddStud(${g.id})">+ Dodaj kursanta</button>
    </div>
    ${st.length===0?'<div class="empty">Brak kursantów w tej grupie.</div>':`
    <div class="tw"><table>
      <thead><tr>
        <th>Nazwisko, Imię</th>
        <th>Ur.</th>
        <th>Telefon</th>
        <th>Ostatnia wpłata</th>
        <th>Obecności</th>
        <th>Sezon (zł)</th>
        <th></th>
      </tr></thead>
      <tbody id="stb">${st.map(studRowHTML).join('')}</tbody>
    </table></div>`}`;
}

function studRowHTML(s) {
  const days = daysAgo(s.last_payment);
  const payClass = days===null?'':(days>35?'bx bx-r':'bx bx-g');
  const payLabel = s.last_payment ? fd(s.last_payment) : '—';
  const active = s.is_active!==false;
  return `<tr>
    <td data-label="Nazwisko, Imię" class="td-main">
      <a href="#" onclick="event.preventDefault();openStud(${s.id})" style="color:var(--text);font-weight:700">${esc(s.last_name)}, ${esc(s.first_name)}</a>
      ${!active?'<span class="bx bx-d" style="margin-left:6px">nieaktywny</span>':''}
    </td>
    <td data-label="Ur."class="td-dim">${s.birth_year||'—'}</td>
    <td data-label="Telefon" class="td-dim">${s.phone?esc(s.phone):'—'}</td>
    <td data-label="Ost. wpłata">${s.last_payment?`<span class="${payClass}">${payLabel}</span>`:payLabel}</td>
    <td data-label="Obecności">${s.att_season||0}</td>
    <td data-label="Sezon (zł)">${s.paid_season?Number(s.paid_season).toFixed(0)+' zł':'—'}</td>
    <td><button class="btn btn-o btn-xs" onclick="openStud(${s.id})">Kartoteka →</button></td>
  </tr>`;
}

function filterStud() {
  const q = ($('ss')||{value:''}).value.toLowerCase();
  const tb = $('stb'); if(!tb)return;
  tb.querySelectorAll('tr').forEach(tr=>{
    const t = tr.cells[0]?tr.cells[0].textContent.toLowerCase():'';
    tr.style.display = t.includes(q)?'':'none';
  });
}

// ── STUDENT PROFILE ───────────────────────────────────────────
async function openStud(sid) {
  S.studId=sid;
  $('pb').innerHTML='<div class="loading">Ładowanie...</div>';
  try {
    const [s, {rows:pays}, {rows:att}] = await Promise.all([
      api(`/api/instructor/students/${sid}`),
      api(`/api/instructor/students/${sid}/payments`),
      api(`/api/instructor/students/${sid}/attendance`),
    ]);
    S.studData={...s,payments:pays,attendance:att};
    renderStud();
  } catch(e){ $('pb').innerHTML=`<div class="empty">Błąd: ${esc(e.message)}</div>`; }
}

function renderStud() {
  const s=S.studData, g=S.groups.find(x=>x.id==S.grpId)||{};
  $('ph-t').textContent=`${esc(s.last_name)}, ${esc(s.first_name)}`;
  $('ph-s').textContent='Kartoteka kursanta';

  const pays=s.payments||[];
  const att=s.attendance||[];
  const attPres=att.filter(a=>a.present).length;
  const totalPaid=pays.reduce((s,p)=>s+Number(p.amount||0),0);
  const grps=(s.groups||[]).map(gg=>`<span class="bx ${gg.active?'bx-g':'bx-d'}">${esc(gg.name)}</span>`).join(' ');

  $('pb').innerHTML=`
    <div class="bc">
      <a onclick="go('groups')">Grupy</a><span class="bc-sep">›</span>
      <a onclick="renderGrpStudents()">${esc(g.name||'Kursanci')}</a><span class="bc-sep">›</span>
      <span>${esc(s.first_name)} ${esc(s.last_name)}</span>
    </div>
    <div class="pg2">
      <div class="ib">
        <h4>Dane osobowe</h4>
        <div class="ir"><span class="ir-l">Imię i nazwisko</span><span class="ir-v">${esc(s.first_name)} ${esc(s.last_name)}</span></div>
        <div class="ir"><span class="ir-l">Rok urodzenia</span><span class="ir-v">${s.birth_year||'—'}</span></div>
        <div class="ir"><span class="ir-l">Telefon</span><span class="ir-v">${s.phone?esc(s.phone):'—'}</span></div>
        <div class="ir"><span class="ir-l">E-mail</span><span class="ir-v">${s.email?esc(s.email):'—'}</span></div>
        <div class="ir"><span class="ir-l">Status</span><span class="ir-v">${s.is_active!==false?'<span class="bx bx-g">Aktywny</span>':'<span class="bx bx-d">Nieaktywny</span>'}</span></div>
      </div>
      <div class="ib">
        <h4>Podsumowanie</h4>
        <div class="ir"><span class="ir-l">Grupy</span><span class="ir-v">${grps||'—'}</span></div>
        <div class="ir"><span class="ir-l">Wpłacono (sezon)</span><span class="ir-v">${totalPaid.toFixed(0)} zł</span></div>
        <div class="ir"><span class="ir-l">Ostatnia wpłata</span><span class="ir-v">${pays[0]?fd(pays[0].paid_at):'—'}</span></div>
        <div class="ir"><span class="ir-l">Obecności w sezonie</span><span class="ir-v">${attPres} / ${att.length}</span></div>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:18px">
      <button class="btn btn-o btn-sm" onclick="moEditStud()">Edytuj dane</button>
      <button class="btn btn-ghost btn-sm" onclick="doDelStud(${s.id})">Usuń kursanta</button>
    </div>
    <div class="section-hd">PŁATNOŚCI <button class="btn btn-g btn-xs" onclick="moAddPay(${s.id})">+ Dodaj wpłatę</button></div>
    <div style="margin-bottom:18px">
      ${pays.length===0?'<div class="empty" style="padding:16px">Brak wpłat.</div>':
        pays.map(p=>`<div class="prow">
          <div class="prow-dt">${fd(p.paid_at)}</div>
          <div class="prow-amt">${Number(p.amount||0).toFixed(0)} zł</div>
          <div class="prow-note">${p.note?esc(p.note):''}</div>
          <button class="btn btn-ghost btn-xs" onclick="doDelPay(${s.id},${p.id})">✕</button>
        </div>`).join('')}
    </div>
    <div class="section-hd">HISTORIA OBECNOŚCI</div>
    ${att.length===0?'<div class="empty" style="padding:16px">Brak zapisanych obecności.</div>':`
    <div class="tw"><table>
      <thead><tr><th>Data</th><th>Grupa</th><th>Lokalizacja</th><th>Obecność</th></tr></thead>
      <tbody>
        ${att.slice(0,60).map(a=>`<tr>
          <td data-label="Data">${fd(a.session_date)}</td>
          <td data-label="Grupa">${esc(a.group_name||'')}</td>
          <td data-label="Lokalizacja">${esc(a.city||'')}</td>
          <td data-label="Obecność">${a.present?'<span class="bx bx-g">✓ Obecny</span>':'<span class="bx bx-r">✗ Nieobecny</span>'}</td>
        </tr>`).join('')}
      </tbody>
    </table></div>`}`;
}

// ── CALENDAR ──────────────────────────────────────────────────
function openCalGrp(gid) { S.calGid=gid; go('cal'); }

function renderCal() {
  const {calY:y,calM:m} = S;
  const gOpts = S.groups.map(g=>`<option value="${g.id}" ${S.calGid==g.id?'selected':''}>${esc(g.location_city)} — ${esc(g.name)}</option>`).join('');

  $('pb').innerHTML=`
    <div class="cal-head">
      <div class="cal-nav">
        <button onclick="calNav(-1)">◀</button>
        <button onclick="calNav(1)">▶</button>
      </div>
      <div class="cal-title">${MONTHS[m]} ${y}</div>
      <div class="cal-filt">
        <select onchange="S.calGid=this.value?Number(this.value):null;renderCal()">
          <option value="">Wszystkie grupy</option>
          ${gOpts}
        </select>
      </div>
      <button class="btn btn-o btn-sm" onclick="S.calY=new Date().getFullYear();S.calM=new Date().getMonth();renderCal()">Dziś</button>
    </div>
    <div class="cgrid" id="cgrid">${DAYS_SHORT.map(d=>`<div class="cgh">${d}</div>`).join('')}</div>
    <div class="cal-legend">
      <span><em style="background:var(--gsoft);border-left:2px solid var(--green)"></em>Sesja istnieje (kliknij → obecności)</span>
      <span><em style="background:var(--asoft);border-left:2px solid var(--accent)"></em>Zaplanowane zajęcia (kliknij → utwórz sesję)</span>
    </div>`;

  const from=`${y}-${String(m+1).padStart(2,'0')}-01`;
  const lastD=new Date(y,m+1,0).getDate();
  const to=`${y}-${String(m+1).padStart(2,'0')}-${String(lastD).padStart(2,'0')}`;
  const url=`/api/instructor/sessions?from=${from}&to=${to}${S.calGid?'&group_id='+S.calGid:''}`;
  api(url).then(d=>fillCalGrid(y,m,d.rows||[])).catch(()=>fillCalGrid(y,m,[]));
}

function calNav(dir) {
  S.calM+=dir;
  if(S.calM<0){S.calM=11;S.calY--;}
  if(S.calM>11){S.calM=0;S.calY++;}
  renderCal();
}

function fillCalGrid(y,m,sessions) {
  const grid=$('cgrid'); if(!grid)return;
  // remove cells (keep 7 headers)
  while(grid.children.length>7) grid.removeChild(grid.lastChild);

  const today=todayISO();
  const firstDow=new Date(y,m,1).getDay(); // 0=Sun
  const offset=firstDow===0?6:firstDow-1; // Mon=0
  const daysInM=new Date(y,m+1,0).getDate();
  const prevDays=new Date(y,m,0).getDate();

  // Build session map: normalized "YYYY-MM-DD" → sessions[]
  const smap={};
  sessions.forEach(s=>{
    const k=normISO(s.session_date);
    if(!smap[k])smap[k]=[];
    smap[k].push(s);
  });

  // Build scheduled days map from group schedules
  const groups = S.calGid ? S.groups.filter(g=>g.id==S.calGid) : S.groups;
  const schedMap={}; // "YYYY-MM-DD" → [{group, sched}]
  groups.forEach(g=>{
    const seenDow=new Set();
    (g.schedules||[]).filter(s=>{const k=`${s.day_of_week}|${(s.time_label||String(s.time_start||'')).slice(0,5)}`;if(seenDow.has(k))return false;seenDow.add(k);return true;}).forEach(sch=>{
      const dow=Number(sch.day_of_week);
      for(let d=1;d<=daysInM;d++){
        const date=new Date(y,m,d);
        const wd=date.getDay()===0?6:date.getDay()-1;
        if(wd===dow-1){  // DB: 1=Mon ISO; wd: 0=Mon JS
          const iso=toISO(date);
          if(!schedMap[iso])schedMap[iso]=[];
          schedMap[iso].push({group:g,sched:sch});
        }
      }
    });
  });

  // Prev month padding
  for(let i=0;i<offset;i++){
    const c=document.createElement('div');
    c.className='cgc other';
    c.innerHTML=`<div class="cgc-d">${prevDays-offset+i+1}</div>`;
    grid.appendChild(c);
  }

  for(let d=1;d<=daysInM;d++){
    const iso=toISO(new Date(y,m,d));
    const hasSess=!!smap[iso];
    const hasSched=!!schedMap[iso]&&!hasSess;
    const isToday=iso===today;
    const c=document.createElement('div');
    const cls=['cgc'];
    if(isToday)cls.push('today');
    if(hasSess||hasSched)cls.push('clickable');
    c.className=cls.join(' ');

    let html=`<div class="cgc-d">${d}</div>`;
    if(hasSess) {
      smap[iso].forEach(s=>{
        const isFuture=normISO(s.session_date)>todayISO();
        const gname=(s.group_name||"").replace("2025/2026","25/26").replace(" - ","—");
        const pillCls=isFuture?"cpill-f":"cpill-s";
        const pillIco=isFuture?"⏳":"✓";
        html+=`<span class="cpill ${pillCls}" onclick="openSessFromCal(${s.session_id},${s.group_id},'${normISO(s.session_date)}','${esc(s.group_name||'')}')">${pillIco} ${esc(gname)} (${s.present_count||0}/${s.total_marked||0})</span>`;
      });
    }
    if(hasSched) {
      schedMap[iso].forEach(({group:g,sched:sch})=>{
        const gname=g.name.replace('2025/2026','25/26').replace(' - ','—');
        html+=`<span class="cpill cpill-f" onclick="createSess(${g.id},'${iso}')">+ ${esc(gname)} ${sch.time_label||''}</span>`;
      });
    }
    c.innerHTML=html;
    grid.appendChild(c);
  }

  // Next month padding
  const total=offset+daysInM;
  const rem=(7-total%7)%7;
  for(let i=1;i<=rem;i++){
    const c=document.createElement('div');
    c.className='cgc other';
    c.innerHTML=`<div class="cgc-d">${i}</div>`;
    grid.appendChild(c);
  }
}

async function createSess(gid, date) {
  if(!confirm(`Otworzyć sesję treningową:\n${S.groups.find(x=>x.id==gid)?.name||''}\n${fd(date)}?`))return;
  try {
    const d=await api('/api/instructor/sessions','POST',{group_id:gid,session_date:date});
    openSessFromCal(d.id,gid,date,S.groups.find(x=>x.id==gid)?.name||'');
  } catch(e){ alert('Błąd: '+e.message); }
}

function openSessFromCal(sessId,gid,date,name){
  S.sessId=sessId;
  S.sessData={session_id:sessId,group_id:gid,session_date:date,group_name:name};
  document.querySelectorAll(".ni").forEach(el=>el.classList.remove("on"));
  const n=document.getElementById("ni-sess"); if(n)n.classList.add("on");
  S.page="sess";
  renderAtt();
}

// ── SESSIONS ──────────────────────────────────────────────────
async function renderSess() {
  $('pb').innerHTML='<div class="loading">Ładowanie sesji...</div>';
  const url=`/api/instructor/sessions?from=${S.sessFrom}${S.sessGid?'&group_id='+S.sessGid:''}`;
  try{ const d=await api(url); S.sessions=d.rows||[]; }catch(e){ S.sessions=[]; }

  const gOpts=S.groups.map(g=>`<option value="${g.id}" ${S.sessGid==g.id?'selected':''}>${esc(g.location_city)} — ${esc(g.name)}</option>`).join('');

  $('pb').innerHTML=`
    <div class="bar">
      <select onchange="S.sessGid=this.value;renderSess()">
        <option value="">Wszystkie grupy</option>${gOpts}
      </select>
      <input type="date" value="${S.sessFrom}" onchange="S.sessFrom=this.value;renderSess()" title="Pokaż od daty">
      <div class="sep"></div>
      <button class="btn btn-r btn-sm" onclick="moCreateSess()">+ Nowa sesja</button>
    </div>
    ${S.sessions.length===0?'<div class="empty">Brak sesji dla wybranych filtrów.</div>':`
    <div class="tw"><table>
      <thead><tr>
        <th>Data</th><th>Dzień</th><th>Grupa</th><th>Lokalizacja</th><th>Oznaczonych</th><th>Obecnych</th><th></th>
      </tr></thead>
      <tbody>
        ${S.sessions.map(s=>{
          const dt=normISO(s.session_date);
          const dow=new Date(dt).getDay(); // 0=Sun
          const dow0=dow===0?6:dow-1;
          const dayLbl=DAYS_SHORT[dow0]||'?';
          const pct=s.total_marked>0?Math.round(s.present_count/s.total_marked*100):0;
          return`<tr>
            <td data-label="Data" class="td-main">${fd(dt)}</td>
            <td data-label="Dzień" class="td-dim">${dayLbl}</td>
            <td data-label="Grupa">${esc(s.group_name||'')}</td>
            <td data-label="Lokalizacja" class="td-dim">${esc(s.location_city||'')}${s.location_name?' / '+esc(s.location_name):''}</td>
            <td data-label="Oznaczonych">${s.total_marked||0}</td>
            <td data-label="Obecnych">${s.total_marked>0?`<span class="bx ${s.present_count>0?'bx-g':'bx-r'}">${s.present_count||0} (${pct}%)</span>`:'<span class="bx bx-d">—</span>'}</td>
            <td><button class="btn btn-o btn-xs" onclick="openSessById(${s.session_id},${s.group_id},'${dt}','${esc(s.group_name||'')}')">Obecności →</button></td>
          </tr>`;
        }).join('')}
      </tbody>
    </table></div>`}`;
}

function openSessById(sid,gid,date,name){
  S.sessId=sid;
  S.sessData={session_id:sid,group_id:gid,session_date:date,group_name:name};
  renderAtt();
}

// ── ATTENDANCE ────────────────────────────────────────────────
async function renderAtt() {
  const sess=S.sessData||{};
  const dateStr=fd(sess.session_date);
  $('ph-t').textContent='Sprawdzanie obecności';
  $('ph-s').textContent=`${esc(sess.group_name||'')} · ${dateStr}`;
  $('pb').innerHTML='<div class="loading">Ładowanie listy...</div>';

  try {
    const d=await api(`/api/instructor/sessions/${sess.session_id}/attendance?group_id=${sess.group_id}`);
    const st=(d.rows||[]).sort((a,b)=>{
      const da=a.last_payment?new Date(normISO(a.last_payment)):new Date(0);
      const db=b.last_payment?new Date(normISO(b.last_payment)):new Date(0);
      return db-da;
    });
    const pres=st.filter(s=>s.present).length;

    $('pb').innerHTML=`
      <div class="bc">
        <a onclick="S.sessId=null;renderSess()">Sesje</a><span class="bc-sep">›</span>
        <span>${esc(sess.group_name||'')} — ${dateStr}</span>
      </div>
      <div class="stats" style="margin-bottom:14px">
        <div class="sc g"><div class="sc-l">Obecnych</div><div class="sc-v">${pres}</div></div>
        <div class="sc"><div class="sc-l">Na liście</div><div class="sc-v">${st.length}</div></div>
        <div class="sc b"><div class="sc-l">Frekwencja</div><div class="sc-v">${st.length?Math.round(pres/st.length*100):0}%</div></div>
      </div>
      <div class="bar" style="margin-bottom:10px">
        <button class="btn btn-g btn-sm" onclick="markAll(true)">✓ Wszyscy obecni</button>
        <button class="btn btn-o btn-sm" onclick="markAll(false)">✗ Odznacz wszystkich</button>
        <div class="sep"></div>
        <span style="font-size:11px;color:var(--dim)">${st.length} kursantów — kliknij kwadrat, aby zaznaczyć</span>
      </div>
      <div class="att-list" id="attlist">
        ${st.map(s=>`
          <div class="att-row ${s.present?'present':'absent'}" id="atr-${s.student_id}">
            <div class="att-chk ${s.present?'on':''}" id="chk-${s.student_id}" onclick="toggleAtt(${sess.session_id},${s.student_id},this)">${s.present?'✓':''}</div>
            <div class="att-name">${esc(s.last_name)}, ${esc(s.first_name)}</div>
            <div class="att-pay ${daysAgo(s.last_payment)>35?'late':''}">Wpłata: ${fd(s.last_payment)}</div>
          </div>`).join('')}
      </div>`;
  } catch(e){ $('pb').innerHTML=`<div class="empty">Błąd: ${esc(e.message)}</div>`; }
}

async function toggleAtt(sessId, studId, el) {
  const wasOn=el.classList.contains('on');
  const now=!wasOn;
  el.classList.toggle('on',now);
  el.textContent=now?'✓':'';
  const row=$(`atr-${studId}`);
  if(row){row.classList.toggle('present',now);row.classList.toggle('absent',!now);}
  try{ await api(`/api/instructor/sessions/${sessId}/attendance`,'POST',{student_id:studId,present:now}); }
  catch(e){
    el.classList.toggle('on',wasOn);el.textContent=wasOn?'✓':'';
    if(row){row.classList.toggle('present',wasOn);row.classList.toggle('absent',!wasOn);}
    alert('Błąd zapisu: '+e.message);
  }
}

async function markAll(present) {
  const sess=S.sessData;
  for(const el of document.querySelectorAll('.att-chk')) {
    const sid=Number(el.id.replace('chk-',''));
    el.classList.toggle('on',present); el.textContent=present?'✓':'';
    const row=$(`atr-${sid}`);
    if(row){row.classList.toggle('present',present);row.classList.toggle('absent',!present);}
    await api(`/api/instructor/sessions/${sess.session_id}/attendance`,'POST',{student_id:sid,present}).catch(()=>{});
  }
}

// ── PAYMENTS ──────────────────────────────────────────────────
async function renderPays() {
  $('pb').innerHTML='<div class="loading">Ładowanie płatności...</div>';
  try{ const d=await api('/api/instructor/payments'); S.payments=d.rows||[]; }catch(e){ S.payments=[]; }
  const total=S.payments.reduce((s,p)=>s+Number(p.amount||0),0);

  $('pb').innerHTML=`
    <div class="stats">
      <div class="sc g"><div class="sc-l">Wpłaty w sezonie</div><div class="sc-v">${total.toFixed(0)} zł</div></div>
      <div class="sc b"><div class="sc-l">Liczba wpisów</div><div class="sc-v">${S.payments.length}</div></div>
    </div>
    <div class="bar">
      <input type="search" placeholder="Szukaj po nazwisku..." id="psrch" oninput="filterPay()">
    </div>
    ${S.payments.length===0?'<div class="empty">Brak płatności w sezonie.</div>':`
    <div class="tw"><table>
      <thead><tr><th>Data</th><th>Kursant</th><th>Grupa</th><th>Kwota</th><th>Uwaga</th></tr></thead>
      <tbody id="ptb">
        ${S.payments.map(p=>`<tr>
          <td data-label="Data" class="td-dim">${fd(p.paid_at)}</td>
          <td data-label="Kursant" class="td-main"><a href="#" onclick="event.preventDefault();openStud(${p.student_id})" style="color:var(--text)">${esc(p.last_name||'')}, ${esc(p.first_name||'')}</a></td>
          <td data-label="Grupa" class="td-dim">${esc(p.location_city||'')} — ${esc(p.group_name||'')}</td>
          <td data-label="Kwota"><strong>${Number(p.amount||0).toFixed(0)} zł</strong></td>
          <td data-label="Uwaga" class="td-dim">${p.note?esc(p.note):''}</td>
        </tr>`).join('')}
      </tbody>
    </table></div>`}`;
}

function filterPay() {
  const q=($('psrch')||{value:''}).value.toLowerCase();
  const tb=$('ptb'); if(!tb)return;
  tb.querySelectorAll('tr').forEach(tr=>{
    const t=tr.cells[1]?tr.cells[1].textContent.toLowerCase():'';
    tr.style.display=t.includes(q)?'':'none';
  });
}

// ── MODALS ────────────────────────────────────────────────────
function showMo(title,bodyHTML,footHTML=''){
  $('mo-t').textContent=title;
  $('mo-b').innerHTML=bodyHTML;
  $('mo-f').innerHTML=footHTML;
  $('mo').style.display='flex';
}
function closeMo(){$('mo').style.display='none';}

function moCreateSess(){
  const opts=S.groups.map(g=>`<option value="${g.id}">${esc(g.location_city)} — ${esc(g.name)}</option>`).join('');
  showMo('NOWA SESJA TRENINGOWA',`
    <div class="ff"><label>Grupa</label><select id="m-gid">${opts}</select></div>
    <div class="ff"><label>Data</label><input type="date" id="m-dt" value="${todayISO()}"></div>`,
    `<button class="btn btn-o" onclick="closeMo()">Anuluj</button>
     <button class="btn btn-r" onclick="doCreateSess()">Utwórz</button>`);
}
async function doCreateSess(){
  const gid=$('m-gid').value,dt=$('m-dt').value;
  if(!gid||!dt)return;
  try{
    const d=await api('/api/instructor/sessions','POST',{group_id:gid,session_date:dt});
    closeMo();
    openSessById(d.id,Number(gid),dt,S.groups.find(x=>x.id==gid)?.name||'');
  }catch(e){alert('Błąd: '+e.message);}
}

function moAddStud(gid){
  const opts=S.groups.map(g=>`<option value="${g.id}" ${g.id==gid?'selected':''}>${esc(g.location_city)} — ${esc(g.name)}</option>`).join('');
  showMo('DODAJ KURSANTA',`
    <div class="ff2">
      <div class="ff"><label>Imię *</label><input id="a-fn"></div>
      <div class="ff"><label>Nazwisko *</label><input id="a-ln"></div>
    </div>
    <div class="ff2">
      <div class="ff"><label>Telefon</label><input id="a-ph"></div>
      <div class="ff"><label>E-mail</label><input id="a-em" type="email"></div>
    </div>
    <div class="ff2">
      <div class="ff"><label>Rok urodzenia</label><input id="a-by" type="number" min="1950" max="2020"></div>
      <div class="ff"><label>Przypisz do grupy</label><select id="a-gp">${opts}</select></div>
    </div>`,
    `<button class="btn btn-o" onclick="closeMo()">Anuluj</button>
     <button class="btn btn-r" onclick="doAddStud()">Dodaj</button>`);
}
async function doAddStud(){
  const fn=$('a-fn').value.trim(),ln=$('a-ln').value.trim();
  if(!fn||!ln){alert('Imię i nazwisko są wymagane.');return;}
  try{
    await api('/api/instructor/students','POST',{
      first_name:fn,last_name:ln,
      phone:$('a-ph').value.trim()||null,
      email:$('a-em').value.trim()||null,
      birth_year:$('a-by').value||null,
      group_id:$('a-gp').value||null
    });
    closeMo();
    openGrp(S.grpId);
  }catch(e){alert('Błąd: '+e.message);}
}

async function moEditStud(){
  const s=S.studData;
  // Pobierz grupy instruktora z info czy kursant jest w każdej
  let grpRows=[];
  try{ const d=await api(`/api/instructor/students/${s.id}/groups`); grpRows=d.rows||[]; }
  catch(e){ console.warn('Błąd ładowania grup:',e); }
  S._editGrpRows = grpRows;

  // Grupy w których kursant jest aktywny
  const activeGrps = grpRows.filter(g=>g.student_active);
  // Lista grup do wyboru przy przeniesieniu
  const grpOpts = grpRows.map(g=>`<option value="${g.id}">${esc(g.location_city)} — ${esc(g.name)}</option>`).join('');

  // Sekcja grup — każda aktywna z przyciskiem przenieś + usuń
  const grpRows_html = activeGrps.length===0
    ? `<div style="color:var(--dim);font-size:.85rem;padding:6px 0">Kursant nie jest przypisany do żadnej grupy.</div>`
    : activeGrps.map(g=>`
      <div class="eg-row" id="egr-${g.id}">
        <span class="bx bx-g" style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(g.location_city)} — ${esc(g.name)}</span>
        <button class="btn btn-xs btn-o" onclick="moMoveStud(${s.id},${g.id},'${esc(g.name)}')">Przenieś →</button>
        <button class="btn btn-xs btn-ghost" onclick="doRemoveFromGroup(${s.id},${g.id},this)" title="Usuń z grupy">✕</button>
      </div>`).join('');

  // Dodaj do dodatkowej grupy (nie wychodząc z aktualnej)
  const addableGrps = grpRows.filter(g=>!g.student_active);
  const addOpts = addableGrps.map(g=>`<option value="${g.id}">${esc(g.location_city)} — ${esc(g.name)}</option>`).join('');

  showMo('EDYTUJ KURSANTA',`
    <div class="ff2">
      <div class="ff"><label>Imię *</label><input id="e-fn" value="${esc(s.first_name||'')}"></div>
      <div class="ff"><label>Nazwisko *</label><input id="e-ln" value="${esc(s.last_name||'')}"></div>
    </div>
    <div class="ff2">
      <div class="ff"><label>Telefon</label><input id="e-ph" value="${esc(s.phone||'')}"></div>
      <div class="ff"><label>E-mail</label><input id="e-em" value="${esc(s.email||'')}"></div>
    </div>
    <div class="ff"><label>Rok urodzenia</label><input id="e-by" type="number" value="${s.birth_year||''}"></div>
    <div style="margin-top:18px;border-top:1px solid var(--brd);padding-top:14px">
      <div class="section-hd" style="margin-bottom:10px">GRUPY KURSANTA</div>
      <div id="eg-list" style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px">
        ${grpRows_html}
      </div>
      ${addableGrps.length>0?`
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <select id="e-add-gp" style="flex:1;min-width:150px">
          <option value="">— dodaj do grupy —</option>
          ${addOpts}
        </select>
        <button class="btn btn-g btn-sm" onclick="doAddToGroup(${s.id})">+ Dodaj</button>
      </div>`:''}
    </div>`,
    `<button class="btn btn-o" onclick="closeMo()">Anuluj</button>
     <button class="btn btn-r" onclick="doEditStud(${s.id})">Zapisz dane</button>`);
}

// Przenieś kursanta do innej grupy (modal w modalu)
function moMoveStud(sid, fromGid, fromName){
  // Pobierz grupy do których można przenieść (wszystkie instruktora oprócz aktualnej)
  const availGroups = (S._editGrpRows||[]).filter(g=>g.id!==fromGid);
  if(!availGroups.length){alert('Brak innych grup do których można przenieść.');return;}
  const opts = availGroups.map(g=>`<option value="${g.id}">${esc(g.location_city)} — ${esc(g.name)}</option>`).join('');
  showMo('PRZENIEŚ DO INNEJ GRUPY',`
    <p style="margin:0 0 14px;color:var(--dim)">Kursant zostanie <strong>usunięty z: ${esc(fromName)}</strong> i dodany do wybranej grupy.</p>
    <div class="ff"><label>Przenieś do grupy</label>
      <select id="mv-gp">${opts}</select>
    </div>`,
    `<button class="btn btn-o" onclick="moEditStud()">← Wróć</button>
     <button class="btn btn-r" onclick="doMoveStud(${sid},${fromGid})">Przenieś</button>`);
}

async function doMoveStud(sid, fromGid){
  const toGid = $('mv-gp').value;
  if(!toGid){alert('Wybierz grupę docelową.');return;}
  try{
    await api(`/api/instructor/students/${sid}/groups`,'POST',{
      group_id:Number(toGid), action:'move', from_group_id:fromGid
    });
    closeMo();
    // Odśwież listę — wróć do grupy z której przenosiliśmy lub do kursanta
    if(S.grpId===fromGid){ openGrp(Number(toGid)); }
    else { openStud(sid); }
  }catch(e){alert('Błąd: '+e.message);}
}

async function doRemoveFromGroup(sid, gid, btn){
  if(!confirm('Usunąć kursanta z tej grupy?'))return;
  try{
    await api(`/api/instructor/students/${sid}/groups`,'POST',{
      group_id:gid, action:'remove'
    });
    // Usuń wiersz z UI bez zamykania modala
    const row=document.getElementById('egr-'+gid);
    if(row) row.remove();
  }catch(e){alert('Błąd: '+e.message);}
}

async function doAddToGroup(sid){
  const gid=$('e-add-gp').value;
  if(!gid){alert('Wybierz grupę.');return;}
  try{
    await api(`/api/instructor/students/${sid}/groups`,'POST',{
      group_id:Number(gid), action:'add'
    });
    closeMo();
    openStud(sid);
  }catch(e){alert('Błąd: '+e.message);}
}

async function doEditStud(id){
  const fn=$('e-fn').value.trim(),ln=$('e-ln').value.trim();
  if(!fn||!ln){alert('Imię i nazwisko są wymagane.');return;}
  try{
    await api(`/api/instructor/students/${id}`,'PATCH',{
      first_name:fn,last_name:ln,
      phone:$('e-ph').value.trim()||null,
      email:$('e-em').value.trim()||null,
      birth_year:$('e-by').value||null
    });
    closeMo();
    openStud(id);
  }catch(e){alert('Błąd: '+e.message);}
}

async function doDelStud(id){
  if(!confirm('Usunąć kursanta? Jeśli ma płatności lub obecności — zostanie oznaczony jako nieaktywny.'))return;
  try{
    const d=await api(`/api/instructor/students/${id}`,'DELETE');
    if(d.soft)alert('Kursant ma historię — oznaczony jako nieaktywny.');
    S.studId=null;
    openGrp(S.grpId);
  }catch(e){alert('Błąd: '+e.message);}
}

function moAddPay(sid){
  showMo('DODAJ WPŁATĘ',`
    <div class="ff2">
      <div class="ff"><label>Kwota (zł) *</label><input id="p-am" type="number" min="1" placeholder="np. 220"></div>
      <div class="ff"><label>Data</label><input id="p-dt" type="date" value="${todayISO()}"></div>
    </div>
    <div class="ff"><label>Uwaga</label><input id="p-nt" placeholder="opcjonalnie"></div>`,
    `<button class="btn btn-o" onclick="closeMo()">Anuluj</button>
     <button class="btn btn-g" onclick="doAddPay(${sid})">Zapisz wpłatę</button>`);
}
async function doAddPay(sid){
  const amt=$('p-am').value;
  if(!amt){alert('Podaj kwotę.');return;}
  try{
    await api(`/api/instructor/students/${sid}/payments`,'POST',{
      amount:parseFloat(amt),date:$('p-dt').value,note:$('p-nt').value.trim()||null
    });
    closeMo();
    openStud(sid);
  }catch(e){alert('Błąd: '+e.message);}
}

async function doDelPay(sid,pid){
  if(!confirm('Usunąć tę wpłatę?'))return;
  try{ await api(`/api/instructor/students/${sid}/payments?pid=${pid}`,'DELETE'); openStud(sid); }
  catch(e){ alert('Błąd: '+e.message); }
}

// ── INIT ──────────────────────────────────────────────────────
(function init(){
  const tok=localStorage.getItem('it'), ii=localStorage.getItem('ii');
  if(tok&&ii){
    try{
      setAuth(tok,JSON.parse(ii));
      $('pg-login').style.display='none';
      $('app').classList.add('on');
      loadAll();
    }catch(e){localStorage.removeItem('it');localStorage.removeItem('ii');}
  }
})();
</script>
</body>
</html>
