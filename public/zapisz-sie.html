<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zapisz siÄ™ â€” Krav Maga Saggita</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:#141414;color:#fff;font-family:'Open Sans',sans-serif;min-height:100vh}
a{text-decoration:none;color:inherit}

:root{
  --accent:#B21900;
  --accent-rgb:178,25,0;

  --bg:#141414;
  --surface:rgba(255,255,255,0.03);
  --surface2:rgba(0,0,0,0.30);
  --border:rgba(255,255,255,0.12);
  --border-strong:rgba(255,255,255,0.18);

  --text:rgba(255,255,255,0.88);
  --muted:rgba(255,255,255,0.56);
  --muted2:rgba(255,255,255,0.42);

  --glow:0 12px 60px rgba(var(--accent-rgb),0.14);
  --shadow:0 30px 100px rgba(0,0,0,0.55);
}

/* â”€â”€ SUBTLE BACKGROUND TEXTURE â”€â”€ */
body::before{
  content:'';
  position:fixed; inset:0;
  pointer-events:none;
  background:
    radial-gradient(700px 420px at 18% 10%, rgba(var(--accent-rgb),0.10), transparent 60%),
    radial-gradient(640px 420px at 82% 18%, rgba(255,255,255,0.06), transparent 62%),
    radial-gradient(560px 420px at 60% 92%, rgba(var(--accent-rgb),0.06), transparent 62%),
    linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55));
  opacity:.95;
  z-index:-1;
}

/* â”€â”€ WRAP â”€â”€ */
.wrap{width:min(1200px,94vw);margin:0 auto;}

/* â”€â”€ PAGE HEADER â”€â”€ */
.pg-header{
  padding:56px 0 32px;
  border-bottom:1px solid var(--border);
  position:relative;
  overflow:hidden;
}
.pg-header::after{
  content:'';
  position:absolute; left:0; right:0; bottom:-1px; height:2px;
  background:linear-gradient(90deg, transparent, rgba(var(--accent-rgb),0.9), transparent);
  opacity:.45;
}
.pg-header__kicker{
  font-weight:800;font-size:.68rem;letter-spacing:.18em;text-transform:uppercase;
  color:rgba(255,255,255,0.78);
  display:inline-flex;align-items:center;gap:10px;
}
.pg-header__kicker::before{
  content:'';width:6px;height:6px;border-radius:50%;
  background:var(--accent);
  box-shadow:0 0 14px rgba(var(--accent-rgb),0.65);
}
.pg-header__h1{
  margin-top:14px;
  font-family:'Montserrat',sans-serif;font-weight:700;
  font-size:clamp(2rem,5vw,3.4rem);
  line-height:.95;letter-spacing:-.02em;text-transform:uppercase;
  transform:skewX(-2deg);
}
.pg-header__h1 em{font-style:normal;color:var(--accent);}
.pg-header__sub{
  margin-top:14px;font-weight:700;font-size:.95rem;
  color:var(--muted);max-width:720px;
}

/* â”€â”€ LOCATION TABS â”€â”€ */
.loc-tabs{
  display:flex;gap:10px;margin:34px 0 24px;
  flex-wrap:wrap;
  align-items:center;
}
.loc-tab{
  padding:12px 18px;
  font-family:'Montserrat',sans-serif;font-weight:700;font-size:.78rem;
  letter-spacing:.14em;text-transform:uppercase;
  background:rgba(255,255,255,0.02);
  border:1px solid var(--border);
  color:rgba(255,255,255,0.70);
  cursor:pointer;
  transition:transform 180ms ease, border-color 180ms ease, background 180ms ease, color 180ms ease;
}
.loc-tab:hover{
  transform:translateY(-1px);
  border-color:rgba(var(--accent-rgb),0.55);
  background:rgba(var(--accent-rgb),0.08);
  color:#fff;
}
.loc-tab.active{
  border-color:rgba(var(--accent-rgb),0.80);
  background:rgba(var(--accent-rgb),0.12);
  color:#fff;
  box-shadow:var(--glow);
}

/* â”€â”€ PANELS â”€â”€ */
.loc-panel{display:none;}
.loc-panel.active{display:block;}
.sched-grid{display:grid;gap:16px;margin-bottom:46px;}

/* â”€â”€ GROUP CARD â”€â”€ */
.group-card{
  border:1px solid var(--border);
  background:var(--surface);
  overflow:hidden;
  box-shadow:var(--shadow);
}
.group-card__head{
  padding:16px 18px;
  display:flex;align-items:flex-end;justify-content:space-between;gap:12px;
  flex-wrap:wrap;
  background:rgba(0,0,0,0.18);
  border-bottom:1px solid rgba(255,255,255,0.08);
  position:relative;
}
.group-card__head::after{
  content:'';
  position:absolute; left:0; right:0; top:0; height:2px;
  background:linear-gradient(90deg, rgba(var(--accent-rgb),0.75), transparent 65%);
  opacity:.9;
}
.group-card__name{
  font-family:'Montserrat',sans-serif;font-weight:700;
  font-size:clamp(1rem,2vw,1.2rem);
  text-transform:uppercase;
  letter-spacing:-.01em;
}
.group-card__meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}

.badge{
  font-weight:800;font-size:.62rem;letter-spacing:.14em;text-transform:uppercase;
  padding:4px 10px;border:1px solid;
  background:rgba(0,0,0,0.20);
}
.badge--accent{color:rgba(255,255,255,0.92);border-color:rgba(var(--accent-rgb),0.55);}
.badge--white{color:rgba(255,255,255,0.72);border-color:rgba(255,255,255,0.18);}
.badge--warn{color:#e8a500;border-color:rgba(232,165,0,0.45);}
.badge--closed{color:#888;border-color:rgba(255,255,255,0.12);background:rgba(0,0,0,0.28);}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SLOTS SHELL (background & accents)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

.group-card__slots{
  position:relative;
  padding:18px 18px 22px;
  background:rgba(0,0,0,0.18);
  overflow:hidden;
}

/* delikatne â€œÅ¼ycieâ€ w tle */
.group-card__slots::before{
  content:'';
  position:absolute; inset:0;
  background:
    radial-gradient(420px 220px at 12% 30%, rgba(var(--accent-rgb),0.08), transparent 60%),
    radial-gradient(520px 260px at 82% 40%, rgba(255,255,255,0.06), transparent 65%),
    linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
  background-size:auto, auto, 70px 1px;
  opacity:.35;
  pointer-events:none;
}

/* cienki akcent na gÃ³rze sekcji */
.group-card__slots::after{
  content:'';
  position:absolute; left:0; right:0; top:0; height:2px;
  background:linear-gradient(90deg, rgba(var(--accent-rgb),0.85), transparent 70%);
  opacity:.9;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   WEEKLY CALENDAR (WOW)
   Desktop: columns = days (tylko uÅ¼yte)
   Mobile: stacked day sections
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

.weekcal{
  position:relative;
  padding:0;
}

.weekcal::before{
  content:'';
  position:absolute; inset:0;
  background:
    radial-gradient(420px 220px at 12% 30%, rgba(var(--accent-rgb),0.10), transparent 60%),
    radial-gradient(520px 260px at 82% 40%, rgba(255,255,255,0.06), transparent 65%),
    linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px),
    linear-gradient(0deg, rgba(255,255,255,0.05) 1px, transparent 1px);
  background-size:auto, auto, 80px 1px, 1px 64px;
  opacity:.18;
  pointer-events:none;
}

.weekcal__grid{
  position:relative;
  display:grid;
  gap:12px;
  align-items:stretch;
}

/* desktop: kolumny dni */
@media(min-width:860px){
  .weekcal__grid{
    grid-template-columns:repeat(var(--days, 3), 1fr);
  }
}

.weekcal__day{
  border:1px solid rgba(255,255,255,0.10);
  background:rgba(0,0,0,0.22);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-height:120px;
}

.weekcal__dayHead{
  padding:12px 12px;
  border-bottom:1px solid rgba(255,255,255,0.08);
  background:rgba(0,0,0,0.26);
  font-family:'Montserrat',sans-serif;
  font-weight:700;
  font-size:.72rem;
  letter-spacing:.16em;
  text-transform:uppercase;
  color:rgba(255,255,255,0.88);
  position:relative;
}

.weekcal__dayHead::after{
  content:'';
  position:absolute; left:0; right:0; bottom:0; height:2px;
  background:linear-gradient(90deg, rgba(var(--accent-rgb),0.75), transparent 70%);
  opacity:.65;
}

.weekcal__dayBody{
  padding:12px 12px 14px;
  display:flex;
  flex-direction:column;
  gap:10px;
  flex:1;
}

.weekcal__slot{
  position:relative;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(0,0,0,0.28);
  padding:12px 12px 12px 12px;
  cursor:pointer;
  transition:transform 180ms ease, border-color 180ms ease, background 180ms ease;
  overflow:hidden;
}

.weekcal__slot::before{
  content:'';
  position:absolute; inset:-50px -70px auto auto;
  width:190px; height:190px;
  background:linear-gradient(135deg, rgba(var(--accent-rgb),0.22), transparent 65%);
  transform:rotate(10deg);
  opacity:.55;
}

.weekcal__slot:hover{
  transform:translateY(-2px);
  border-color:rgba(var(--accent-rgb),0.55);
  background:rgba(var(--accent-rgb),0.06);
}

.weekcal__slot.selected{
  border-color:rgba(var(--accent-rgb),0.85);
  background:rgba(var(--accent-rgb),0.10);
  box-shadow:0 12px 60px rgba(var(--accent-rgb),0.14);
}

.weekcal__time{
  font-weight:800;
  font-size:1.06rem;
  color:#fff;
}
.weekcal__time em{font-style:normal;color:var(--accent);}

.weekcal__addr{
  margin-top:8px;
  font-weight:700;
  font-size:.74rem;
  color:var(--muted);
  line-height:1.35;
  max-width:34ch;
}

.weekcal__btn{
  margin-top:10px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:.62rem;
  letter-spacing:.14em;
  text-transform:uppercase;
  color:rgba(255,255,255,0.88);
  border:1px solid rgba(255,255,255,0.18);
  padding:8px 10px;
  background:rgba(0,0,0,0.24);
  transition:background 180ms ease, border-color 180ms ease, color 180ms ease;
  width:max-content;
  white-space:nowrap;
}
.weekcal__slot:hover .weekcal__btn{
  border-color:rgba(var(--accent-rgb),0.65);
  background:rgba(var(--accent-rgb),0.12);
  color:#fff;
}
.weekcal__slot.selected .weekcal__btn{
  border-color:rgba(var(--accent-rgb),0.90);
  background:rgba(var(--accent-rgb),0.18);
  color:#fff;
}

.weekcal__slot.weekcal__slot--closed{
  cursor:default;
  opacity:.55;
}
.weekcal__slot.weekcal__slot--closed:hover{
  transform:none;
  border-color:rgba(255,255,255,0.12);
  background:rgba(0,0,0,0.28);
}

/* mobile: dzieÅ„ jako sekcja, sloty pod spodem (grid sam siÄ™ ukÅ‚ada) */
@media(max-width:859px){
  .weekcal__grid{grid-template-columns:1fr;}
}

/* VIP info */
.vip-info{
  padding:20px 18px;
  font-weight:700;font-size:.90rem;line-height:1.70;
  color:rgba(255,255,255,0.70);
}
.vip-info strong{color:#fff;}

/* â”€â”€ FORM SECTION â”€â”€ */
.form-section{
  background:rgba(255,255,255,0.025);
  border:1px solid var(--border);
  position:relative;
  padding:34px 28px 38px;
  margin-bottom:60px;
  display:none;
  box-shadow:var(--shadow);
}
.form-section::before{
  content:'';
  position:absolute; left:0; right:0; top:0; height:2px;
  background:linear-gradient(90deg, rgba(var(--accent-rgb),0.90), transparent 70%);
  opacity:.95;
}
.form-section.visible{display:block;}

.form-section__title{
  font-family:'Montserrat',sans-serif;font-weight:700;
  font-size:1.35rem;text-transform:uppercase;letter-spacing:-.01em;
  margin-bottom:6px;
}
.form-section__sub{font-weight:700;font-size:.84rem;color:var(--muted);margin-bottom:24px;}

.selected-slot-info{
  background:rgba(0,0,0,0.30);
  border:1px solid rgba(255,255,255,0.14);
  padding:12px 16px;margin-bottom:22px;
  display:flex;align-items:center;gap:14px;flex-wrap:wrap;
}
.selected-slot-info__label{font-weight:800;font-size:.66rem;letter-spacing:.16em;text-transform:uppercase;color:rgba(255,255,255,0.70);}
.selected-slot-info__val{font-weight:800;font-size:.92rem;color:#fff;}

.form-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
@media(max-width:600px){.form-grid{grid-template-columns:1fr;}}

.form-field{display:flex;flex-direction:column;gap:6px;}
.form-field--full{grid-column:1/-1;}
.form-label{
  font-weight:800;font-size:.66rem;letter-spacing:.16em;text-transform:uppercase;
  color:rgba(255,255,255,0.70);
}
.form-label span{color:var(--accent);}
.form-input,.form-select,.form-textarea{
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.15);
  color:#fff;
  font-family:'Open Sans',sans-serif;
  font-weight:700;font-size:.92rem;
  padding:11px 14px;
  outline:none;
  transition:border-color 180ms ease, background 180ms ease;
  -webkit-appearance:none;
}
.form-input::placeholder{color:rgba(255,255,255,0.25);}
.form-input:focus,.form-select:focus,.form-textarea:focus{
  border-color:rgba(var(--accent-rgb),0.70);
  background:rgba(var(--accent-rgb),0.06);
}
.form-select option{background:#141414;color:#fff;}
.form-textarea{resize:vertical;min-height:80px;}

.form-divider{
  grid-column:1/-1;
  border:none;border-top:1px solid var(--border);
  margin:8px 0;
}
.form-section-label{
  grid-column:1/-1;
  font-family:'Montserrat',sans-serif;font-weight:700;
  font-size:.72rem;letter-spacing:.16em;text-transform:uppercase;
  color:rgba(255,255,255,0.86);
  margin-top:2px;
}

/* Price cards */
.price-options{
  grid-column:1/-1;
  display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:10px;margin-top:4px;
}
.price-card{
  border:1px solid var(--border);
  padding:14px 14px;
  cursor:pointer;
  transition:border-color 180ms ease, background 180ms ease, transform 180ms ease;
  position:relative;
  background:rgba(0,0,0,0.22);
}
.price-card:hover{
  border-color:rgba(var(--accent-rgb),0.50);
  background:rgba(var(--accent-rgb),0.06);
  transform:translateY(-1px);
}
.price-card.selected{
  border-color:rgba(var(--accent-rgb),0.85);
  background:rgba(var(--accent-rgb),0.10);
  box-shadow:var(--glow);
}
.price-card input{position:absolute;opacity:0;pointer-events:none;}
.price-card__name{font-weight:800;font-size:.78rem;color:#fff;margin-bottom:4px;}
.price-card__price{font-family:'Montserrat',sans-serif;font-weight:700;font-size:1.35rem;color:#fff;}
.price-card__price em{font-style:normal;color:var(--accent);}
.price-card__extra{font-weight:700;font-size:.68rem;color:var(--muted);margin-top:2px;}

/* Consents */
.consent-item{
  grid-column:1/-1;
  display:flex;gap:12px;align-items:flex-start;
  font-weight:700;font-size:.82rem;line-height:1.60;
  color:rgba(255,255,255,0.74);
  cursor:pointer;
}
.consent-item input[type=checkbox]{
  width:18px;height:18px;flex-shrink:0;
  accent-color:var(--accent);cursor:pointer;margin-top:2px;
}

/* Submit */
.form-actions{
  grid-column:1/-1;
  display:flex;align-items:center;gap:14px;margin-top:10px;flex-wrap:wrap;
}
.btn-submit{
  background:linear-gradient(180deg, rgba(var(--accent-rgb),0.95), rgba(82,10,0,0.92));
  color:#fff;border:none;
  font-family:'Open Sans',sans-serif;font-weight:800;
  font-size:.82rem;letter-spacing:.08em;text-transform:uppercase;
  padding:14px 28px;cursor:pointer;
  transition:filter 180ms ease, transform 180ms ease;
  box-shadow:var(--glow);
}
.btn-submit:hover{filter:brightness(1.08);transform:translateY(-2px);}
.btn-submit:disabled{opacity:.50;cursor:not-allowed;transform:none;filter:none;}
.form-note{font-weight:700;font-size:.76rem;color:var(--muted);}

/* Error / info */
.form-msg{
  grid-column:1/-1;
  padding:12px 16px;
  font-weight:800;font-size:.82rem;
  display:none;
}
.form-msg.error{background:rgba(var(--accent-rgb),0.12);border:1px solid rgba(var(--accent-rgb),0.40);color:#ffb0b0;display:block;}
.form-msg.info{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.16);color:rgba(255,255,255,0.84);display:block;}

/* â”€â”€ CONFIRMATION â”€â”€ */
.confirm-box{
  max-width:720px;margin:60px auto;
  border:1px solid rgba(255,255,255,0.14);
  background:rgba(0,0,0,0.30);
  padding:40px 34px;
  display:none;
  box-shadow:var(--shadow);
  position:relative;
}
.confirm-box::before{
  content:'';
  position:absolute; left:0; right:0; top:0; height:2px;
  background:linear-gradient(90deg, rgba(var(--accent-rgb),0.90), transparent 70%);
  opacity:.95;
}
.confirm-box.visible{display:block;}
.confirm-box__icon{font-size:3rem;margin-bottom:18px;}
.confirm-box__h2{
  font-family:'Montserrat',sans-serif;font-weight:700;
  font-size:1.8rem;text-transform:uppercase;margin-bottom:10px;
}
.confirm-box__h2 em{font-style:normal;color:var(--accent);}
.confirm-box__text{font-weight:700;font-size:.92rem;line-height:1.70;color:rgba(255,255,255,0.72);margin-bottom:22px;}
.confirm-box__transfer{
  background:rgba(0,0,0,0.34);
  border:1px solid rgba(255,255,255,0.12);
  padding:20px 20px;
  font-size:.90rem;
  line-height:2;
}
.confirm-box__transfer .lbl{font-weight:800;font-size:.64rem;letter-spacing:.16em;text-transform:uppercase;color:rgba(255,255,255,0.72);}
.confirm-box__transfer .val{font-weight:800;color:#fff;}
.confirm-box__ref{
  display:inline-block;
  font-family:'Montserrat',sans-serif;font-weight:700;font-size:1.5rem;
  color:#fff;letter-spacing:.10em;
  margin:14px 0 4px;
}
.confirm-box__note{
  margin-top:18px;font-weight:700;font-size:.78rem;
  color:rgba(255,255,255,0.45);line-height:1.65;
}

/* â”€â”€ CONFIRM ACTIONS â”€â”€ */
.confirm-actions{
  margin-top:18px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
.btn-confirm{
  border:none;
  cursor:pointer;
  font-family:'Open Sans',sans-serif;
  font-weight:800;
  font-size:.80rem;
  letter-spacing:.06em;
  text-transform:uppercase;
  padding:12px 18px;
  transition:transform 200ms ease, filter 200ms ease, border-color 200ms ease, background 200ms ease;
}
.btn-confirm:hover{transform:translateY(-2px);filter:brightness(1.08);}
.btn-confirm:disabled{opacity:.55;cursor:not-allowed;transform:none;filter:none;}
.btn-confirm--primary{
  background:linear-gradient(180deg,rgba(178,25,0,0.98),rgba(80,8,0,0.95));
  color:#fff;
  box-shadow:0 10px 48px rgba(178,25,0,0.22);
}
.btn-confirm--ghost{
  background:transparent;
  color:rgba(255,255,255,0.90);
  border:1px solid rgba(255,255,255,0.22);
}
.btn-confirm--ghost:hover{
  border-color:rgba(178,25,0,0.65);
  background:rgba(178,25,0,0.06);
}
.confirm-hint{
  font-weight:600;
  font-size:.78rem;
  color:rgba(255,255,255,0.55);
}

/* â”€â”€ SPINNER â”€â”€ */
.spinner{display:none;width:22px;height:22px;border:2px solid rgba(255,255,255,0.20);border-top-color:#fff;border-radius:50%;animation:spin 600ms linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ LOADING STATE â”€â”€ */
.loading-overlay{
  padding:60px;text-align:center;
  font-weight:800;font-size:.88rem;color:var(--muted);
}
</style>
</head>

<body>

<header class="pg-header">
  <div class="wrap">
    <div class="pg-header__kicker">Krav Maga Saggita</div>
    <h1 class="pg-header__h1">ZAPISZ SIÄ˜<em> NA ZAJÄ˜CIA</em></h1>
    <p class="pg-header__sub">Wybierz lokalizacjÄ™, termin i grupÄ™ â€” formularz uzupeÅ‚ni siÄ™ automatycznie.</p>
  </div>
</header>

<main class="wrap">

  <nav class="loc-tabs" id="locTabs" aria-label="Lokalizacje" role="tablist"></nav>

  <div id="locPanels">
    <div class="loading-overlay">Åadowanie grafikuâ€¦</div>
  </div>

  <section class="form-section" id="formSection" aria-live="polite">
    <div class="form-section__title">Formularz zapisu</div>
    <p class="form-section__sub">Pola oznaczone <span style="color:var(--accent)">*</span> sÄ… wymagane.</p>

    <div class="selected-slot-info" id="slotInfo" aria-live="polite">
      <div>
        <div class="selected-slot-info__label">Wybrany termin</div>
        <div class="selected-slot-info__val" id="slotInfoText">â€”</div>
      </div>
    </div>

    <form id="regForm" novalidate>
      <div class="form-grid">

        <div class="form-section-label">Dane osobowe</div>

        <div class="form-field">
          <label class="form-label" for="f_first">ImiÄ™ <span>*</span></label>
          <input class="form-input" type="text" id="f_first" name="first_name" autocomplete="given-name" required>
        </div>
        <div class="form-field">
          <label class="form-label" for="f_last">Nazwisko <span>*</span></label>
          <input class="form-input" type="text" id="f_last" name="last_name" autocomplete="family-name" required>
        </div>
        <div class="form-field">
          <label class="form-label" for="f_email">Adres e-mail <span>*</span></label>
          <input class="form-input" type="email" id="f_email" name="email" autocomplete="email" required>
        </div>
        <div class="form-field">
          <label class="form-label" for="f_phone">Telefon <span>*</span></label>
          <input class="form-input" type="tel" id="f_phone" name="phone" autocomplete="tel" placeholder="+48 xxx xxx xxx">
        </div>
        <div class="form-field">
          <label class="form-label" for="f_birth">Rok urodzenia</label>
          <input class="form-input" type="number" id="f_birth" name="birth_year" min="1950" max="2022" placeholder="np. 1990">
        </div>
        <div class="form-field">
          <label class="form-label" for="f_new">Czy to TwÃ³j pierwszy sezon?</label>
          <select class="form-select" id="f_new" name="is_new">
            <option value="true">Tak â€” jestem nowy/a</option>
            <option value="false">Nie â€” kontynuujÄ™ treningi</option>
          </select>
        </div>

        <hr class="form-divider">

        <div class="form-section-label">Wybierz karnet</div>
        <div class="price-options" id="priceOptions"></div>

        <hr class="form-divider">

        <div class="form-section-label">SzczegÃ³Å‚y</div>

        <div class="form-field">
          <label class="form-label" for="f_date">Preferowana data startu</label>
          <input class="form-input" type="date" id="f_date" name="start_date">
        </div>
        <div class="form-field">
          <label class="form-label" for="f_pay">Metoda pÅ‚atnoÅ›ci</label>
          <select class="form-select" id="f_pay" name="payment_method">
            <option value="transfer">Przelew bankowy</option>
            <option value="cash">GotÃ³wka (na miejscu)</option>
          </select>
        </div>

        <div class="form-field form-field--full" id="preferredTimeField" style="display:none">
          <label class="form-label" for="f_ptime">Preferowany termin zajÄ™Ä‡ (WaÅ‚brzych VIP)</label>
          <input class="form-input" type="text" id="f_ptime" name="preferred_time" placeholder="np. wtorek 18:00 lub elastyczny">
        </div>

        <hr class="form-divider">

        <div class="form-section-label">Zgody</div>

        <label class="consent-item">
          <input type="checkbox" id="f_consent_data" required>
          <span>WyraÅ¼am zgodÄ™ na przetwarzanie moich danych osobowych przez AkademiÄ™ Obrony Saggita w celu realizacji zapisu na zajÄ™cia i obsÅ‚ugi pÅ‚atnoÅ›ci. <span style="color:var(--accent)">*</span></span>
        </label>

        <label class="consent-item">
          <input type="checkbox" id="f_consent_rules" required>
          <span>ZapoznaÅ‚em/am siÄ™ z regulaminem zajÄ™Ä‡ i akceptujÄ™ jego warunki. <span style="color:var(--accent)">*</span></span>
        </label>

        <div class="form-msg" id="formMsg"></div>

        <div class="form-actions">
          <button type="submit" class="btn-submit" id="submitBtn">
            <span id="submitLabel">WyÅ›lij zapis â†’</span>
            <span class="spinner" id="submitSpinner"></span>
          </button>
          <span class="form-note">Zapis nie jest potwierdzeniem miejsca. Potwierdzenie wysyÅ‚amy po weryfikacji.</span>
        </div>

      </div>
    </form>
  </section>

  <div class="confirm-box" id="confirmBox">
    <div class="confirm-box__icon">âœ“</div>
    <h2 class="confirm-box__h2">Zapis<em> przyjÄ™ty</em></h2>
    <p class="confirm-box__text" id="confirmText">DziÄ™kujemy za zapis! Skontaktujemy siÄ™ w celu potwierdzenia miejsca.</p>
    <div class="confirm-box__ref" id="confirmRef"></div>

    <div class="confirm-box__transfer" id="confirmTransfer" style="display:none"></div>

    <div class="confirm-actions" id="confirmActions" style="display:none">
      <button type="button" class="btn-confirm btn-confirm--primary" id="btnPayOnline">
        ZapÅ‚aÄ‡ online â†’
      </button>

      <button type="button" class="btn-confirm btn-confirm--ghost" id="btnPayDoc">
        Pobierz dokument pÅ‚atniczy
      </button>

      <div class="confirm-hint" id="confirmHint">
        Wybierz sposÃ³b finalizacji. MoÅ¼esz teÅ¼ wrÃ³ciÄ‡ pÃ³Åºniej â€” kod zostaje ten sam.
      </div>
    </div>

    <p class="confirm-box__note">
      Zachowaj powyÅ¼szy kod â€” przyda Ci siÄ™ do sprawdzenia statusu zapisu oraz jako tytuÅ‚ przelewu.<br>
      W razie pytaÅ„: <strong>biuro@akademiaobrony.pl</strong> Â· <strong>510 930 460</strong>
    </p>
  </div>

</main>

<script>
const API = '/api';

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allData = [];
let allPrices = [];
let selectedGroup = null;
let selectedSchedule = null;
let selectedLocation = null;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  try {
    const [sched, prices] = await Promise.all([
      fetch(`${API}/schedule`).then(r => r.json()),
      fetch(`${API}/prices`).then(r => r.json()),
    ]);
    allData = sched;
    allPrices = prices;
    buildTabs();
    buildPanels();
  } catch(e) {
    document.getElementById('locPanels').innerHTML =
      '<div class="loading-overlay" style="color:#ffb0b0">BÅ‚Ä…d Å‚adowania grafiku. SprÃ³buj odÅ›wieÅ¼yÄ‡ stronÄ™.</div>';
  }
}

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTabs() {
  const nav = document.getElementById('locTabs');
  nav.innerHTML = '';
  allData.forEach((loc, i) => {
    const btn = document.createElement('button');
    btn.className = 'loc-tab' + (i === 0 ? ' active' : '');
    btn.textContent = loc.city;
    btn.setAttribute('role','tab');
    btn.setAttribute('aria-selected', i === 0 ? 'true' : 'false');
    btn.addEventListener('click', () => switchTab(loc.id));
    nav.appendChild(btn);
  });
}

function switchTab(locId) {
  document.querySelectorAll('.loc-tab').forEach((btn, i) => {
    const active = allData[i]?.id === locId;
    btn.classList.toggle('active', active);
    btn.setAttribute('aria-selected', active ? 'true' : 'false');
  });
  document.querySelectorAll('.loc-panel').forEach(p => {
    p.classList.toggle('active', p.dataset.locId == locId);
  });
}

// â”€â”€ Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPanels() {
  const container = document.getElementById('locPanels');
  container.innerHTML = '';

  allData.forEach((loc, locIdx) => {
    const panel = document.createElement('div');
    panel.className = 'loc-panel' + (locIdx === 0 ? ' active' : '');
    panel.dataset.locId = loc.id;

    if (!loc.groups || !loc.groups.length) {
      panel.innerHTML = '<p style="color:var(--muted);padding:24px 0;font-weight:700">Brak grup dla tej lokalizacji.</p>';
      container.appendChild(panel);
      return;
    }

    const grid = document.createElement('div');
    grid.className = 'sched-grid';

    loc.groups.forEach(group => {
      const isVIP    = group.category === 'vip';
      const isClosed = group.notes && group.notes.toLowerCase().includes('zamkniÄ™ty');
      const isFull   = group.available <= 0 && !isClosed;

      const card = document.createElement('div');
      card.className = 'group-card';

      // Head
      const head = document.createElement('div');
      head.className = 'group-card__head';

      const nameEl = document.createElement('div');
      nameEl.className = 'group-card__name';
      nameEl.textContent = group.name;
      head.appendChild(nameEl);

      const meta = document.createElement('div');
      meta.className = 'group-card__meta';

      if (group.age_range) {
        const b = document.createElement('span');
        b.className = 'badge badge--white';
        b.textContent = group.age_range;
        meta.appendChild(b);
      }

      if (isClosed) {
        const b = document.createElement('span');
        b.className = 'badge badge--closed';
        b.textContent = 'NabÃ³r zamkniÄ™ty';
        meta.appendChild(b);
      } else if (isFull) {
        const b = document.createElement('span');
        b.className = 'badge badge--warn';
        b.textContent = 'Lista rezerwowa';
        meta.appendChild(b);
      } else if (group.available <= 3) {
        const b = document.createElement('span');
        b.className = 'badge badge--warn';
        b.textContent = `Ostatnie ${group.available} miejsc`;
        meta.appendChild(b);
      } else {
        const b = document.createElement('span');
        b.className = 'badge badge--accent';
        b.textContent = `${group.available} wolnych miejsc`;
        meta.appendChild(b);
      }

      head.appendChild(meta);
      card.appendChild(head);

      // Slots shell
      const slotsShell = document.createElement('div');
      slotsShell.className = 'group-card__slots';

      if (isVIP) {
        const info = document.createElement('div');
        info.className = 'vip-info';
        info.innerHTML = `<strong>${group.notes || 'ZajÄ™cia indywidualne.'}</strong><br>Skontaktuj siÄ™ z nami, aby ustaliÄ‡ termin:<br>ğŸ“ 510 930 460 &nbsp;Â·&nbsp; âœ‰ biuro@akademiaobrony.pl<br><br>MoÅ¼esz teÅ¼ zapisaÄ‡ siÄ™ na listÄ™ rezerwowÄ… â€” podaj preferowany termin.`;
        slotsShell.appendChild(info);

        const vipBtn = document.createElement('div');
        vipBtn.style.cssText = 'padding:0 18px 18px';
        vipBtn.innerHTML = `
          <button class="btn-submit" style="padding:12px 18px;font-size:.78rem;letter-spacing:.10em" onclick="selectSlot(${loc.id},'${loc.city}',${group.id},'${group.name}',null,null,null,true)">
            Zapisz siÄ™ na listÄ™ rezerwowÄ… â†’
          </button>`;
        slotsShell.appendChild(vipBtn);

      } else if (group.schedules && group.schedules.length) {

        // â”€â”€ WEEKLY CALENDAR (instead of timeline) â”€â”€
        const weekcal = document.createElement('div');
        weekcal.className = 'weekcal';

        const calGrid = document.createElement('div');
        calGrid.className = 'weekcal__grid';

        // mapowanie PL -> klucz dnia
        const dayMap = {
          'poniedziaÅ‚ek':'pon','pon':'pon',
          'wtorek':'wto','wto':'wto',
          'Å›roda':'Å›ro','sroda':'Å›ro','Å›r':'Å›ro','sro':'Å›ro',
          'czwartek':'czw','czw':'czw',
          'piÄ…tek':'piÄ…','piatek':'piÄ…','pt':'piÄ…',
          'sobota':'sob','sob':'sob',
          'niedziela':'nie','nd':'nie','nie':'nie'
        };
        const dayLabel = { pon:'PON', wto:'WTO', Å›ro:'ÅšRO', czw:'CZW', piÄ…:'PIÄ„', sob:'SOB', nie:'NIE' };
        const dayOrder = ['pon','wto','Å›ro','czw','piÄ…','sob','nie'];

        // grupowanie terminÃ³w po dniu
        const buckets = {};
        (group.schedules || []).forEach(s => {
          const raw = (s.day_name || '').toLowerCase().trim();
          const key = dayMap[raw] || raw.slice(0,3) || 'â€”';
          if(!buckets[key]) buckets[key] = [];
          buckets[key].push(s);
        });

        // tylko dni, ktÃ³re faktycznie majÄ… terminy
        const usedDays = dayOrder.filter(d => buckets[d]?.length).concat(
          Object.keys(buckets).filter(d => !dayOrder.includes(d))
        );

        calGrid.style.setProperty('--days', String(Math.max(1, usedDays.length)));

        usedDays.forEach(dayKey => {
          const dayCol = document.createElement('div');
          dayCol.className = 'weekcal__day';

          const head = document.createElement('div');
          head.className = 'weekcal__dayHead';
          head.textContent = (dayLabel[dayKey] || (dayKey || 'DzieÅ„').toUpperCase());

          const body = document.createElement('div');
          body.className = 'weekcal__dayBody';

          // sortowanie po godzinie
          const sorted = (buckets[dayKey] || []).slice().sort((a,b)=>{
            const ta = (a.time_label || '').match(/\d{1,2}:\d{2}/)?.[0] || '';
            const tb = (b.time_label || '').match(/\d{1,2}:\d{2}/)?.[0] || '';
            return ta.localeCompare(tb);
          });

          sorted.forEach(sched => {
            const slot = document.createElement('div');
            slot.className = 'weekcal__slot' + (isClosed ? ' weekcal__slot--closed' : '');
            slot.setAttribute('role', isClosed ? 'presentation' : 'button');
            if (!isClosed) slot.setAttribute('tabindex','0');

            const time = sched.time_label || 'Termin do ustalenia';

            slot.innerHTML = `
              <div class="weekcal__time"><em>${time}</em></div>
              ${sched.address ? `<div class="weekcal__addr">${sched.address}</div>` : ''}
              <div class="weekcal__btn">${isClosed ? 'ZamkniÄ™ty' : (isFull ? 'Lista rez.' : 'ZapisujÄ™ siÄ™')}</div>
            `;

            if (!isClosed) {
              const handler = (ev) => {
                window._lastSlotEl = ev.currentTarget;

                // zaznaczenie tylko jednego slotu w kalendarzu
                document.querySelectorAll('.weekcal__slot.selected').forEach(x => x.classList.remove('selected'));
                ev.currentTarget.classList.add('selected');

                selectSlot(
                  loc.id, loc.city, group.id, group.name,
                  sched.id, sched.day_name, sched.time_label,
                  isFull
                );
              };
              slot.addEventListener('click', handler);
              slot.addEventListener('keydown', e => { if(e.key === 'Enter' || e.key === ' ') handler(e); });
            }

            body.appendChild(slot);
          });

          dayCol.appendChild(head);
          dayCol.appendChild(body);
          calGrid.appendChild(dayCol);
        });

        weekcal.appendChild(calGrid);
        slotsShell.appendChild(weekcal);

      } else {
        slotsShell.innerHTML = `<div class="vip-info"><strong>Brak dostÄ™pnych terminÃ³w.</strong><br>Skontaktuj siÄ™ z nami, a dopasujemy grupÄ™.</div>`;
      }

      card.appendChild(slotsShell);
      grid.appendChild(card);
    });

    panel.appendChild(grid);
    container.appendChild(panel);
  });
}

// â”€â”€ Select slot â†’ reveal form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectSlot(locId, cityName, groupId, groupName, schedId, dayName, timeLabel, isWaitlist) {
  // usuÅ„ zaznaczenie zarÃ³wno ze starego .slot jak i nowego .weekcal__slot
  document.querySelectorAll('.slot.selected, .weekcal__slot.selected').forEach(s => s.classList.remove('selected'));
  if (window._lastSlotEl) window._lastSlotEl.classList.add('selected');

  selectedGroup = groupId;
  selectedSchedule = schedId;
  selectedLocation = locId;

  const isVIP = schedId === null;
  const waitlistFlag = isWaitlist || false;

  const infoText = isVIP
    ? `${cityName} Â· ${groupName} (lista rezerwowa)`
    : `${cityName} Â· ${groupName} Â· ${dayName}, ${timeLabel}${waitlistFlag ? ' (lista rezerwowa)' : ''}`;
  document.getElementById('slotInfoText').textContent = infoText;

  document.getElementById('preferredTimeField').style.display = isVIP ? 'block' : 'none';

  const group = allData.flatMap(l => l.groups).find(g => g.id === groupId);
  buildPriceOptions(group?.category || 'adults');

  const section = document.getElementById('formSection');
  section.classList.add('visible');
  section.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// â”€â”€ Price options â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPriceOptions(category) {
  const container = document.getElementById('priceOptions');
  container.innerHTML = '';

  const isNew = document.getElementById('f_new')?.value !== 'false';

  const cats = category === 'kids'
    ? ['kids']
    : category === 'vip'
    ? ['adults', 'discount']
    : ['adults', 'discount', 'service'];

  const relevant = allPrices.filter(p => cats.includes(p.category));
  if (!relevant.length) {
    container.innerHTML = '<p style="color:var(--muted);font-size:.82rem;font-weight:700">Brak planÃ³w cennikowych dla tej grupy.</p>';
    return;
  }

  relevant.forEach((plan, i) => {
    const total = parseFloat(plan.price) + (isNew ? parseFloat(plan.signup_fee || 0) : 0);
    const monthLabel = plan.months ? `${plan.months} mies.` : 'jednorazowo';

    const card = document.createElement('label');
    card.className = 'price-card';

    const input = document.createElement('input');
    input.type = 'radio';
    input.name = 'price_plan';
    input.value = plan.id;
    if (i === 0) { input.checked = true; card.classList.add('selected'); }

    card.innerHTML = `
      <div class="price-card__name">${plan.name.replace(' â€” ', '<br>')}</div>
      <div class="price-card__price"><em>${total.toFixed(0)}</em> zÅ‚</div>
      <div class="price-card__extra">${monthLabel}${isNew && plan.signup_fee > 0 ? ` (w tym ${plan.signup_fee} zÅ‚ wpisowe)` : ''}${plan.description ? '<br>' + plan.description : ''}</div>
    `;
    card.prepend(input);
    card.addEventListener('click', () => {
      document.querySelectorAll('.price-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
    });
    container.appendChild(card);
  });
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('f_new')?.addEventListener('change', () => {
    if (selectedGroup !== null) {
      const group = allData.flatMap(l => l.groups).find(g => g.id === selectedGroup);
      buildPriceOptions(group?.category || 'adults');
    }
  });
});

// â”€â”€ Form submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('regForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const msg = document.getElementById('formMsg');
  const btn = document.getElementById('submitBtn');
  const spinner = document.getElementById('submitSpinner');
  const label = document.getElementById('submitLabel');

  msg.className = 'form-msg';
  msg.textContent = '';

  if (!selectedGroup) {
    showMsg('Wybierz termin zajÄ™Ä‡ z grafiku powyÅ¼ej.', 'error'); return;
  }

  const first = document.getElementById('f_first').value.trim();
  const last  = document.getElementById('f_last').value.trim();
  const email = document.getElementById('f_email').value.trim();
  const phone = document.getElementById('f_phone').value.trim();
  if (!first || !last) { showMsg('Wpisz imiÄ™ i nazwisko.', 'error'); return; }
  if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showMsg('Podaj prawidÅ‚owy adres e-mail.', 'error'); return; }
  if (!phone) { showMsg('Podaj numer telefonu.', 'error'); return; }
  if (!document.getElementById('f_consent_data').checked) { showMsg('Wymagana zgoda na przetwarzanie danych.', 'error'); return; }
  if (!document.getElementById('f_consent_rules').checked) { showMsg('Wymagana akceptacja regulaminu.', 'error'); return; }

  const selectedPrice = document.querySelector('input[name=price_plan]:checked');

  btn.disabled = true;
  spinner.style.display = 'inline-block';
  label.textContent = 'WysyÅ‚amâ€¦';

  try {
    const body = {
      first_name: first,
      last_name: last,
      email,
      phone,
      birth_year: document.getElementById('f_birth').value ? parseInt(document.getElementById('f_birth').value) : null,
      is_new: document.getElementById('f_new').value !== 'false',
      group_id: selectedGroup,
      schedule_id: selectedSchedule,
      price_plan_id: selectedPrice ? parseInt(selectedPrice.value) : null,
      start_date: document.getElementById('f_date').value || null,
      payment_method: document.getElementById('f_pay').value,
      preferred_time: document.getElementById('f_ptime').value.trim() || null,
      consent_data: document.getElementById('f_consent_data').checked,
      consent_rules: document.getElementById('f_consent_rules').checked,
    };

    const res = await fetch(`${API}/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });

    const data = await res.json();
    if (!res.ok) { showMsg(data.error || 'BÅ‚Ä…d zapisu. SprÃ³buj ponownie.', 'error'); return; }

    showConfirmation(data, first, last);

  } catch(err) {
    showMsg('BÅ‚Ä…d poÅ‚Ä…czenia. SprawdÅº internet i sprÃ³buj ponownie.', 'error');
  } finally {
    btn.disabled = false;
    spinner.style.display = 'none';
    label.textContent = 'WyÅ›lij zapis â†’';
  }
});

function showMsg(text, type) {
  const msg = document.getElementById('formMsg');
  msg.textContent = text;
  msg.className = 'form-msg ' + type;
  msg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function showConfirmation(data, first, last) {
  document.getElementById('formSection').style.display = 'none';

  const box = document.getElementById('confirmBox');
  const isWaitlist = data.is_waitlist;

  document.getElementById('confirmText').textContent = isWaitlist
    ? `TwÃ³j zapis na listÄ™ rezerwowÄ… zostaÅ‚ przyjÄ™ty, ${first}. Skontaktujemy siÄ™, gdy pojawi siÄ™ wolne miejsce.`
    : `DziÄ™kujemy za zapis, ${first}! Twoje zgÅ‚oszenie zostaÅ‚o przyjÄ™te. Skontaktujemy siÄ™, aby potwierdziÄ‡ miejsce w grupie.`;

  document.getElementById('confirmRef').textContent = data.payment_ref;

  // pokaÅ¼ akcje
  const btnWrap = document.getElementById('confirmActions');
  if (btnWrap) btnWrap.style.display = 'flex';

  // zapamiÄ™taj ref (dla backendu/pdf)
  window.__regRef = data.payment_ref;
  window.__regEmail = data.email || document.getElementById('f_email')?.value?.trim() || null;

  // podepnij akcje
  const btnPayOnline = document.getElementById('btnPayOnline');
  const btnPayDoc = document.getElementById('btnPayDoc');

  if (btnPayOnline) {
    btnPayOnline.onclick = async () => {
      await finalizeAction('pay_online');
      alert('PÅ‚atnoÅ›Ä‡ online bÄ™dzie podpiÄ™ta w kolejnym kroku. Na razie to placeholder ğŸ™‚');
    };
  }

  if (btnPayDoc) {
    btnPayDoc.onclick = async () => {
      await finalizeAction('download_doc', true);
    };
  }

  // dane przelewu
  if (!isWaitlist && data.total_amount) {
    const div = document.getElementById('confirmTransfer');
    div.innerHTML = `
      <div><span class="lbl">Kwota do wpÅ‚aty</span><br><span class="val" style="font-size:1.4rem;font-weight:800;color:#fff">${parseFloat(data.total_amount).toFixed(2)} zÅ‚</span></div>
      <br>
      <div><span class="lbl">Numer konta</span><br><span class="val">${data.bank_account}</span></div>
      <div><span class="lbl">Odbiorca</span><br><span class="val">${data.bank_name}</span></div>
      <div><span class="lbl">TytuÅ‚ przelewu</span><br><span class="val">${data.transfer_title}</span></div>
      <br>
      <small style="color:var(--muted)">Przelew wyÅ›lij najpÃ³Åºniej do ostatniego dnia poprzedzajÄ…cego miesiÄ…c rozliczeniowy.</small>
    `;
    div.style.display = 'block';
  }

  box.classList.add('visible');
  box.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

async function finalizeAction(action, downloadDoc=false){
  if(!window.__regRef) return;

  const btnPay = document.getElementById('btnPayOnline');
  const btnDoc = document.getElementById('btnPayDoc');
  if(btnPay) btnPay.disabled = true;
  if(btnDoc) btnDoc.disabled = true;

  try{
    // backend: rejestruje akcjÄ™ + wysyÅ‚a mail
    const res = await fetch(`${API}/registration/action`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        payment_ref: window.__regRef,
        action
      })
    });

    const data = await res.json();
    if(!res.ok) throw new Error(data.error || 'BÅ‚Ä…d akcji.');

    // pobranie PDF
    if(downloadDoc){
      await downloadPaymentDoc(window.__regRef);
    }
  }catch(e){
    alert(e.message || 'CoÅ› poszÅ‚o nie tak. SprÃ³buj ponownie.');
  }finally{
    if(btnPay) btnPay.disabled = false;
    if(btnDoc) btnDoc.disabled = false;
  }
}

async function downloadPaymentDoc(paymentRef){
  const res = await fetch(`${API}/payment-document?payment_ref=${encodeURIComponent(paymentRef)}`, {
    method:'GET'
  });

  if(!res.ok){
    let err = 'Nie udaÅ‚o siÄ™ pobraÄ‡ dokumentu.';
    try{
      const j = await res.json();
      err = j.error || err;
    }catch(_){}
    throw new Error(err);
  }

  const blob = await res.blob();
  const url = window.URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = `dokument-platniczy-${paymentRef}.pdf`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  window.URL.revokeObjectURL(url);
}

init();
</script>
</body>
</html>
