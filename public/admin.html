<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Panel Admina ‚Äî Krav Maga Saggita</title>
<style>
.link{color:var(--bright);text-decoration:underline;text-underline-offset:3px}
.link:hover{opacity:.85}

@import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800&family=Barlow:wght@400;500;600&display=swap');
:root{
  --bg:#0f0b0b;--surface:#1c1414;--surface2:#241c1c;--surface3:#2c2222;
  --border:#3a2828;--border2:#4a3232;
  --red:#c42000;--red-l:#e83000;--red-bg:rgba(196,32,0,.12);--red-bdr:rgba(196,32,0,.35);
  --orange:#e8a500;--or-bg:rgba(232,165,0,.12);--or-bdr:rgba(232,165,0,.35);
  --green:#2ecc71;--gr-bg:rgba(46,204,113,.1);--gr-bdr:rgba(46,204,113,.3);
  --blue:#4a9fe8;--bl-bg:rgba(74,159,232,.1);--bl-bdr:rgba(74,159,232,.3);
  --text:#e8dada;--dim:#9a8080;--muted:#6a5555;--bright:#fff;
  --sw:215px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Barlow',sans-serif;font-size:14px;line-height:1.5}
#app{display:flex;height:100vh;overflow:hidden}
#sidebar{width:var(--sw);min-width:var(--sw);background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column}
#sidebar-logo{padding:20px 16px 16px;border-bottom:1px solid var(--border)}
#sidebar-logo h1{font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:19px;letter-spacing:.03em;color:var(--bright);line-height:1.1;text-transform:uppercase}
#sidebar-logo h1 em{color:var(--red-l);font-style:normal}
#sidebar-logo small{color:var(--muted);font-size:10px;text-transform:uppercase;letter-spacing:.1em}
nav{flex:1;padding:8px;overflow-y:auto}
nav a{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:5px;color:var(--dim);font-weight:500;font-size:13px;transition:all .15s;cursor:pointer;margin-bottom:1px;text-decoration:none}
nav a:hover{color:var(--bright);background:var(--surface2)}
nav a.active{color:var(--bright);background:var(--red-bg);border-left:2px solid var(--red-l);padding-left:8px}
.nd{width:4px;height:4px;border-radius:50%;background:var(--border2);flex-shrink:0;transition:background .15s}
nav a:hover .nd{background:var(--dim)}
nav a.active .nd{background:var(--red-l)}
.sl{font-size:10px;font-weight:700;letter-spacing:.12em;color:var(--red);padding:14px 10px 4px;text-transform:uppercase;opacity:.7}
#sf{padding:12px;border-top:1px solid var(--border)}
.ui{font-size:11px;color:var(--muted);margin-bottom:8px}
.ui strong{display:block;color:var(--text);font-size:13px}
#btn-logout{width:100%;padding:7px;background:transparent;border:1px solid var(--border2);border-radius:4px;color:var(--dim);cursor:pointer;font-size:12px;font-family:'Barlow',sans-serif;transition:all .15s}
#btn-logout:hover{border-color:var(--red);color:var(--red);background:var(--red-bg)}
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}
#topbar{height:50px;min-height:50px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;gap:16px}
#topbar h2{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:800;color:var(--bright);text-transform:uppercase;letter-spacing:.05em;flex:1}
#api-status{font-size:11px;padding:4px 12px;border-radius:4px;font-weight:700;text-transform:uppercase;letter-spacing:.06em}
#api-status.ok{background:var(--gr-bg);color:var(--green);border:1px solid var(--gr-bdr)}
#api-status.err{background:var(--red-bg);color:var(--red-l);border:1px solid var(--red-bdr)}
#content{flex:1;overflow-y:auto;padding:24px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:28px}
.sc{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:18px 20px;position:relative;overflow:hidden}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--border2)}
.sc.accent::before{background:var(--red-l)}.sc.green::before{background:var(--green)}.sc.orange::before{background:var(--orange)}
.sc .label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);margin-bottom:8px}
.sc .value{font-family:'Barlow Condensed',sans-serif;font-size:42px;font-weight:800;line-height:1;color:var(--bright)}
.sc.accent .value{color:var(--red-l)}.sc.green .value{color:var(--green)}.sc.orange .value{color:var(--orange)}
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.sh h3{font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:700;color:var(--bright);text-transform:uppercase;letter-spacing:.05em;border-left:3px solid var(--red);padding-left:10px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:5px;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;border:none;font-family:'Barlow',sans-serif;text-transform:uppercase;letter-spacing:.05em;line-height:1}
.btn-primary{background:var(--red);color:#fff}.btn-primary:hover{background:var(--red-l)}
.btn-secondary{background:var(--surface2);border:1px solid var(--border2);color:var(--text)}.btn-secondary:hover{border-color:var(--red);color:var(--bright)}
.btn-sm{padding:5px 10px;font-size:11px}
.bi{padding:5px 10px;background:var(--surface3);border:1px solid var(--border2);border-radius:4px;color:var(--dim);cursor:pointer;transition:all .15s;font-size:11px;font-family:'Barlow',sans-serif;font-weight:600;text-transform:uppercase;letter-spacing:.04em;line-height:1.4}
.bi:hover{color:var(--bright);background:var(--surface2)}.bi.del:hover{border-color:var(--red);color:var(--red);background:var(--red-bg)}
.fb{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:12px}
.fb input,.fb select{background:var(--surface2);border:1px solid var(--border2);border-radius:4px;color:var(--text);padding:7px 10px;font-size:13px;font-family:'Barlow',sans-serif;outline:none;transition:border-color .15s}
.fb input:focus,.fb select:focus{border-color:var(--red)}.fb input[type=text]{min-width:220px}.fb select{min-width:150px}
.tw{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden}
table{width:100%;border-collapse:collapse}
thead th{background:var(--surface2);padding:11px 14px;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);white-space:nowrap;border-bottom:2px solid var(--border2)}
tbody tr{border-top:1px solid var(--border);transition:background .1s}
tbody tr:hover{background:var(--surface2)}
tbody td{padding:11px 14px;font-size:13px;vertical-align:middle;color:var(--text)}
.tda{display:flex;gap:5px;flex-wrap:wrap}
.badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;line-height:1.4}
.bg{background:var(--gr-bg);color:var(--green);border:1px solid var(--gr-bdr)}
.br{background:var(--red-bg);color:#ff6b4a;border:1px solid var(--red-bdr)}
.bo{background:var(--or-bg);color:var(--orange);border:1px solid var(--or-bdr)}
.bx{background:var(--surface3);color:var(--dim);border:1px solid var(--border2)}
.bb{background:var(--bl-bg);color:var(--blue);border:1px solid var(--bl-bdr)}
.cb{width:80px;height:5px;background:var(--surface3);border-radius:3px;display:inline-block;vertical-align:middle;margin-right:7px}
.cf{height:100%;background:var(--green);border-radius:3px}.cf.w{background:var(--orange)}.cf.f{background:var(--red-l)}
.ct{font-size:12px;color:var(--dim)}
.pag{display:flex;align-items:center;gap:10px;margin-top:16px;justify-content:center}
.pag button{background:var(--surface2);border:1px solid var(--border2);color:var(--dim);padding:7px 16px;border-radius:5px;cursor:pointer;font-size:12px;font-family:'Barlow',sans-serif;font-weight:600;text-transform:uppercase;letter-spacing:.05em;transition:all .15s}
.pag button:hover:not(:disabled){border-color:var(--red);color:var(--bright)}.pag button:disabled{opacity:.3;cursor:not-allowed}
.pag .pi{font-size:12px;color:var(--dim)}
.mo{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(3px)}
.md{background:var(--surface);border:1px solid var(--border2);border-radius:10px;width:100%;max-width:720px;max-height:92vh;overflow-y:auto;box-shadow:0 32px 80px rgba(0,0,0,.7)}
.mh{padding:18px 22px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1}
.mh h3{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:var(--bright);text-transform:uppercase;letter-spacing:.05em}
.mb{padding:22px}.mf{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;background:var(--surface2);position:sticky;bottom:0}
.kart-header{background:var(--surface2);border:1px solid var(--border2);border-radius:8px;padding:18px 20px;margin-bottom:20px;display:flex;align-items:center;gap:16px}
.kart-avatar{width:52px;height:52px;border-radius:50%;background:var(--red-bg);border:2px solid var(--red-bdr);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:22px;color:var(--red-l);flex-shrink:0}
.kart-name{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--bright);text-transform:uppercase}
.kart-meta{font-size:12px;color:var(--dim);margin-top:3px}
.kart-badges{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.ksec{border-top:1px solid var(--border);margin-top:18px;padding-top:16px}
.ksec-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--red);margin-bottom:12px}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fg .full{grid-column:1 / -1}
.ff{display:flex;flex-direction:column;gap:6px}
.ff label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--dim)}
.ff input,.ff select,.ff textarea{background:var(--surface2);border:1px solid var(--border2);border-radius:5px;color:var(--bright);padding:9px 11px;font-size:13px;font-family:'Barlow',sans-serif;outline:none;transition:all .15s;width:100%}
.ff input:focus,.ff select:focus,.ff textarea:focus{border-color:var(--red);box-shadow:0 0 0 2px var(--red-bg)}
.ff textarea{resize:vertical;min-height:70px}
select option{background:#1c1414}
.ff .view-val{font-size:14px;color:var(--bright);font-weight:500;padding:4px 0;border-bottom:1px solid var(--border);min-height:28px}
#login-screen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9000}
.lb{background:var(--surface);border:1px solid var(--border2);border-radius:10px;padding:40px;width:360px;box-shadow:0 40px 100px rgba(0,0,0,.8)}
.lb .logo{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;color:var(--bright);text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px}
.lb .logo em{color:var(--red-l);font-style:normal}
.lb p{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.1em;margin-bottom:28px}
.lb label{display:block;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);margin-bottom:6px}
.lb input{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:5px;color:var(--bright);padding:11px 13px;font-size:14px;font-family:'Barlow',sans-serif;outline:none;transition:all .15s;margin-bottom:14px}
.lb input:focus{border-color:var(--red);box-shadow:0 0 0 2px var(--red-bg)}
#login-btn{width:100%;padding:12px;background:var(--red);border:none;border-radius:5px;color:#fff;font-weight:700;font-size:15px;font-family:'Barlow Condensed',sans-serif;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;margin-top:4px;transition:background .15s}
#login-btn:hover{background:var(--red-l)}
#login-error{color:#ff6b4a;font-size:12px;margin-top:10px;display:none}
#toasts{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 18px;border-radius:6px;font-size:13px;font-weight:600;box-shadow:0 8px 32px rgba(0,0,0,.5);max-width:320px;animation:si .2s ease}
.toast.success{background:var(--green);color:#000}.toast.error{background:var(--red-l);color:#fff}.toast.info{background:var(--surface2);border:1px solid var(--border2);color:var(--text)}
@keyframes si{from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1}}
.loader{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--dim);gap:12px;font-size:13px}
.spinner{width:20px;height:20px;border:2px solid var(--border2);border-top-color:var(--red-l);border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.empty{padding:60px;text-align:center;color:var(--dim)}.empty strong{display:block;font-size:16px;color:var(--text);margin-bottom:8px}
.ib{background:var(--surface2);border-left:3px solid var(--red);border-radius:0 5px 5px 0;padding:10px 14px;font-size:12px;color:var(--dim);margin-bottom:16px;line-height:1.6}
.ib strong{color:var(--bright)}
.bulk-actions{display:flex;gap:10px;margin-bottom:14px;align-items:center}
.chk{width:18px;height:18px;cursor:pointer}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE / RESPONSYWNO≈öƒÜ (panel admina)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#btn-menu{display:none; min-width:44px; min-height:44px; justify-content:center; font-size:18px}
#sb-overlay{display:none}
.tw{overflow-x:auto; -webkit-overflow-scrolling:touch}

/* Bottom navigation (mobile only) */
#bot-nav-admin{
  display:none; position:fixed; bottom:0; left:0; right:0; z-index:1400;
  background:var(--surface); border-top:1px solid var(--border);
  height:58px; align-items:center; justify-content:space-around;
}
.bna{
  flex:1; display:flex; flex-direction:column; align-items:center;
  justify-content:center; gap:2px; padding:6px 2px; cursor:pointer;
  color:var(--dim); font-size:9px; font-weight:700; text-transform:uppercase;
  letter-spacing:.05em; border:none; background:none;
  font-family:'Barlow',sans-serif; transition:color .15s;
}
.bna.active{color:var(--red-l)}
.bna-ico{font-size:17px; line-height:1}

/* ‚îÄ‚îÄ 980px breakpoint ‚îÄ‚îÄ */
@media (max-width: 980px){
  :root{--sw:280px}
  #content{padding:16px}
  #topbar{padding:0 14px}
  #btn-menu{display:inline-flex}
  #sidebar{
    position:fixed; top:0; left:0; bottom:0;
    z-index:2000;
    transform:translateX(-105%);
    transition:transform .22s ease;
    box-shadow: 0 30px 90px rgba(0,0,0,.75);
  }
  body.sb-open #sidebar{transform:translateX(0)}
  #sb-overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,.65);
    z-index:1500;
    opacity:0; pointer-events:none;
    transition:opacity .22s ease;
    display:block;
  }
  body.sb-open #sb-overlay{opacity:1; pointer-events:auto}
  #main{width:100%}
  .stats-grid{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
  .fb{gap:10px}
  .fb input[type=text], .fb select{min-width:0; width:100%}
  .fb input, .fb select, .fb button{flex:1 1 160px}
  .fg{grid-template-columns:1fr}
  .lb{width:min(92vw,360px); padding:28px}
  #toasts{left:16px; right:16px; bottom:16px}
  .toast{max-width:none}
  .md{max-width:96vw}
  .mh{padding:14px 16px}
  .mb{padding:16px}
  .mf{padding:12px 16px}
  .btn{padding:10px 14px}
  .btn-sm{padding:8px 12px}
  .bi{padding:8px 12px}
  thead th{padding:10px 12px}
  tbody td{padding:10px 12px}
}

/* ‚îÄ‚îÄ 700px breakpoint ‚Äî full mobile ‚îÄ‚îÄ */
@media (max-width: 700px){
  #app{padding-bottom:58px}
  #bot-nav-admin{display:flex}
  #topbar h2{font-size:17px}
  .sc .value{font-size:32px}
  .sc{padding:14px 16px}
  .stats-grid{grid-template-columns:1fr 1fr}

  /* Tables ‚Üí card layout */
  .tw{overflow-x:unset}
  .tw table, .tw thead, .tw tbody, .tw th, .tw td, .tw tr{display:block}
  .tw thead tr{display:none}
  .tw tbody tr{
    background:var(--surface); border:1px solid var(--border);
    border-radius:8px; margin-bottom:10px; padding:12px 14px;
    position:relative;
  }
  .tw tbody tr:hover{background:var(--surface)}
  .tw td{
    padding:5px 0; font-size:13px; border:none;
    display:flex; justify-content:space-between; align-items:center;
    gap:8px; min-height:30px;
  }
  .tw td::before{
    content:attr(data-label); font-size:10px; font-weight:700;
    text-transform:uppercase; letter-spacing:.08em; color:var(--dim);
    flex-shrink:0; min-width:90px;
  }
  .tw td:last-child{
    justify-content:stretch; padding-top:10px; margin-top:6px;
    border-top:1px solid var(--border);
  }
  .tw td:last-child::before{display:none}
  .tda{flex-wrap:wrap; gap:4px}
  .tda .bi{flex:1; justify-content:center; min-height:38px}

  /* Filters */
  .fb{flex-direction:column; align-items:stretch; gap:8px}
  .fb input,.fb select,.fb button{width:100%; min-width:0}

  /* Bulk actions */
  .bulk-actions{flex-direction:column; align-items:stretch}
  .bulk-actions .btn{width:100%; justify-content:center}

  /* Buttons larger for touch */
  .btn,.bi{min-height:44px}
  .btn{padding:12px 14px}
  .btn-sm{padding:10px 12px; font-size:12px}
  .bi{padding:10px 12px; font-size:12px}

  /* Modal full screen */
  .md{max-width:100%; border-radius:0; max-height:100vh}
  .mf{flex-direction:column; align-items:stretch}
  .mf .btn{width:100%; justify-content:center}
  .mh{padding:14px 16px}

  /* Karta kursanta */
  .kart-header{flex-direction:column; align-items:flex-start; gap:10px}
  .fg{grid-template-columns:1fr}
  .fg .full{grid-column:1}

  /* Pagination */
  .pag{flex-wrap:wrap}
  .pag button{flex:1; min-height:44px}
}

@media (max-width: 420px){
  #topbar h2{font-size:15px}
  #content{padding:12px}
  .sc .value{font-size:28px}
  #toasts{right:auto; left:50%; transform:translateX(-50%); bottom:70px; width:min(92vw,420px)}
  .toast{max-width:100%}
}

@media (max-width: 860px){
  .fb{flex-direction:column; align-items:stretch; gap:10px}
  .fb input,.fb select,.fb button{width:100%; min-width:0}
  .bulk-actions{flex-direction:column; align-items:stretch}
  .bulk-actions .btn{width:100%}
  .btn,.bi{min-height:44px}
  .btn{padding:12px 14px}
  .btn-sm{padding:10px 12px;font-size:12px}
  .bi{padding:10px 12px;font-size:12px}
  .tda{flex-direction:column; align-items:stretch}
  .tda .bi{width:100%; justify-content:center}
  .chk{width:20px;height:20px}
  thead th{padding:10px 12px}
  tbody td{padding:10px 12px}
  .mf{flex-direction:column; align-items:stretch}
  .mf .btn{width:100%; justify-content:center}
}


/* ‚îÄ‚îÄ Grupy ‚Äî lista checkbox√≥w ‚îÄ‚îÄ */
.grp-chk-list{
  display:grid;grid-template-columns:1fr 1fr;gap:1px;
  max-height:180px;overflow-y:auto;
  border:1px solid var(--line2);background:var(--line2);
  margin-top:4px;
}
.grp-chk-item{
  display:flex;align-items:center;gap:8px;
  padding:7px 10px;background:var(--bg2);
  cursor:pointer;transition:background .1s;
  font-size:12px;
}
.grp-chk-item:hover{background:var(--panel2);}
.grp-chk-item input[type=checkbox]{
  width:14px;height:14px;
  accent-color:var(--accent);
  cursor:pointer;flex-shrink:0;
}
.grp-chk-city{
  font-size:9px;letter-spacing:.08em;text-transform:uppercase;
  color:var(--dim);margin-left:auto;
}
</style>
</head>
<body>

<div id="login-screen">
  <div class="lb">
    <div class="logo">Krav Maga <em>Saggita</em></div>
    <p>Panel Administratora</p>
    <label>Login</label>
    <input type="text" id="l-user" placeholder="username" autocomplete="username"/>
    <label>Has≈Ço</label>
    <input type="password" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
    <button id="login-btn">Zaloguj siƒô</button>
    <div id="login-error"></div>
  </div>
</div>

<div id="app" style="display:none">
  <aside id="sidebar">
    <div id="sidebar-logo">
      <h1>Krav Maga <em>Saggita</em></h1>
      <small>Panel Admina</small>
    </div>
    <nav>
      <a data-view="dashboard" class="active"><span class="nd"></span> Dashboard</a>
      <div class="sl">Kursanci</div>
      <a data-view="unified-students"><span class="nd"></span> Baza kursant√≥w</a>
      <a data-view="web-registrations"><span class="nd"></span> Zapisy ze strony</a>
      <a data-view="legacy-history"><span class="nd"></span> Archiwum CSV</a>
      <div class="sl">Organizacja</div>
      <a data-view="groups"><span class="nd"></span> Grupy</a>
      <a data-view="schedules"><span class="nd"></span> Grafik zajƒôƒá</a>
      <a data-view="locations"><span class="nd"></span> Lokalizacje</a>
      <a data-view="plans"><span class="nd"></span> Cennik</a>
      <a data-view="instructors"><span class="nd"></span> Instruktorzy</a>
      <div class="sl">Export</div>
      <a id="btn-export"><span class="nd"></span> Pobierz CSV</a>
    </nav>
    <div id="sf">
      <div class="ui"><small>Zalogowany jako</small><strong id="admin-username">‚Äî</strong></div>
      <button id="btn-logout">Wyloguj</button>
    </div>
  </aside>
  <div id="sb-overlay" onclick="toggleSidebar(false)"></div>

  <!-- MOBILE BOTTOM NAV -->
  <nav id="bot-nav-admin">
    <button class="bna active" data-view="dashboard"         onclick="switchBotNav('dashboard')">        <span class="bna-ico">‚ñ£</span>Dashboard</button>
    <button class="bna"        data-view="unified-students"  onclick="switchBotNav('unified-students')"> <span class="bna-ico">‚óà</span>Kursanci</button>
    <button class="bna"        data-view="web-registrations" onclick="switchBotNav('web-registrations')"><span class="bna-ico">‚úâ</span>Zapisy</button>
    <button class="bna"        data-view="groups"            onclick="switchBotNav('groups')">           <span class="bna-ico">‚¨°</span>Grupy</button>
    <button class="bna"        data-view="more"              onclick="toggleSidebar()">                  <span class="bna-ico">‚â°</span>Wiƒôcej</button>
  </nav>

  <main id="main">
    <div id="topbar">
      <button id="btn-menu" class="bi" type="button" aria-label="Menu" onclick="toggleSidebar()">‚ò∞</button>
      <h2 id="page-title">Dashboard</h2>
      <span id="api-status" class="ok">API OK</span>
    </div>
    <div id="content"></div>
  </main>
</div>

<div id="toasts"></div>

<script>
const API = '/api/admin-api';
let TOKEN = localStorage.getItem('km_token') || '';
let CV='dashboard', ro=0;
const RL = 30;

const DAYS=['Niedziela','Poniedzia≈Çek','Wtorek','≈öroda','Czwartek','PiƒÖtek','Sobota'];

const PS={
  paid:'Op≈Çacony', unpaid:'Nieop≈Çacony', pending:'OczekujƒÖcy',
  partial:'Czƒô≈õciowy', waived:'Zwolniony'
};
const RS={new:'Nowy',confirmed:'Potwierdzony',cancelled:'Anulowany',completed:'Zako≈Ñczony'};

function isMobile(){
  return window.matchMedia && window.matchMedia('(max-width: 980px)').matches;
}
function toggleSidebar(force){
  const open = document.body.classList.contains('sb-open');
  const next = (typeof force === 'boolean') ? force : !open;
  if(!isMobile()){
    document.body.classList.remove('sb-open');
    return;
  }
  document.body.classList.toggle('sb-open', next);
}
window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape') toggleSidebar(false);
});
window.addEventListener('resize', ()=>{
  if(!isMobile()) toggleSidebar(false);
});

function arrRows(x){
  if(!x) return [];
  if(Array.isArray(x)) return x;
  if(Array.isArray(x.rows)) return x.rows;
  if(Array.isArray(x.data)) return x.data;
  return [];
}
function setAS(ok){
  const e=document.getElementById('api-status');
  e.textContent = ok ? 'API OK' : 'API ERROR';
  e.className = ok ? 'ok' : 'err';
}
function toast(msg,type='success',ms=3500){
  const e=document.createElement('div');
  e.className=`toast ${type}`;
  e.textContent=msg;
  document.getElementById('toasts').appendChild(e);
  setTimeout(()=>e.remove(),ms);
}
function closeModal(){document.getElementById('modal-overlay')?.remove();}
function showModal(title,body,footer){
  closeModal();
  const ov=document.createElement('div'); ov.className='mo'; ov.id='modal-overlay';
  ov.innerHTML = `
    <div class="md">
      <div class="mh">
        <h3>${title}</h3>
        <button class="bi" onclick="closeModal()">‚úï Zamknij</button>
      </div>
      <div class="mb">${body}</div>
      ${footer ? `<div class="mf">${footer}</div>` : ''}
    </div>`;
  ov.addEventListener('click',e=>{ if(e.target===ov) closeModal(); });
  document.body.appendChild(ov);
}
function fd(v){if(!v)return'‚Äî';try{return new Date(v).toLocaleDateString('pl-PL',{day:'2-digit',month:'2-digit',year:'numeric'});}catch{return v;}}
function fdt(v){if(!v)return'‚Äî';try{return new Date(v).toLocaleString('pl-PL',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});}catch{return v;}}
function pb(s){const m={paid:'bg',unpaid:'br',pending:'bo',partial:'bo',waived:'bx'};return `<span class="badge ${m[s]||'bx'}">${PS[s]||s||'‚Äî'}</span>`;}
function sb(s){const m={confirmed:'bg',new:'bo',cancelled:'br',completed:'bx'};return `<span class="badge ${m[s]||'bx'}">${RS[s]||s||'‚Äî'}</span>`;}
function capB(r,m){const p=m?Math.min(100,Math.round(r/m*100)):0;const c=p>=100?'f':p>=80?'w':'';return `<span class="cb"><span class="cf ${c}" style="width:${p}%"></span></span><span class="ct">${r}/${m||'?'}</span>`;}
function initials(fn,ln){return ((fn||'?')[0]+(ln||'?')[0]).toUpperCase();}

async function aF(path,opts={}){
  const h={'Content-Type':'application/json'};
  if(TOKEN) h['Authorization'] = `Bearer ${TOKEN}`;

  const url = API + (path.startsWith('/') ? path : '/' + path);

  try{
    const r = await fetch(url,{headers:h,...opts});
    const d = await r.json().catch(()=>({error:'B≈ÇƒÖd odpowiedzi serwera'}));
    if(!r.ok) throw new Error(d.error || `B≈ÇƒÖd HTTP ${r.status}`);
    setAS(true);
    return d;
  }catch(e){
    setAS(false);
    throw e;
  }
}

async function deleteReg(id){
  if(!confirm('Na pewno usunƒÖƒá ten zapis? Operacja jest nieodwracalna!')) return;
  try{
    await aF(`/registrations/${id}`,{method:'DELETE'});
    toast('Zapis usuniƒôty','success');
    if(CV==='dashboard') loadDash();
    if(CV==='web-registrations') fetchR('web');
    if(CV==='participants') fetchR('admin');
  }catch(e){
    toast('B≈ÇƒÖd: '+e.message,'error');
  }
}

async function bulkDeleteReg(){
  const checked = Array.from(document.querySelectorAll('.reg-check:checked')).map(c=>parseInt(c.value));
  if(!checked.length){ toast('Zaznacz co najmniej jeden zapis','error'); return; }
  if(!confirm(`UsunƒÖƒá ${checked.length} zaznaczonych zapis√≥w? Nie mo≈ºna cofnƒÖƒá!`)) return;
  
  let ok=0, fail=0;
  for(const id of checked){
    try{
      await aF(`/registrations/${id}`,{method:'DELETE'});
      ok++;
    }catch{
      fail++;
    }
  }
  
  toast(`Usuniƒôto: ${ok}, b≈Çƒôd√≥w: ${fail}`, fail?'error':'success');
  
  if(CV==='dashboard') loadDash();
  if(CV==='web-registrations') fetchR('web');
  if(CV==='participants') fetchR('admin');
}

function toggleAllChecks(source){
  const all = document.getElementById('check-all-'+source);
  const boxes = document.querySelectorAll('.reg-check-'+source);
  boxes.forEach(b => b.checked = all.checked);
}

function showLogin(){
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('app').style.display='none';
}
function showApp(){
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='flex';
  try{
    const u = JSON.parse(atob(TOKEN.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));
    document.getElementById('admin-username').textContent = u.username || '‚Äî';
  }catch{}
  navigate('dashboard');
}
async function checkLogin(){
  if(!TOKEN) return showLogin();
  try{ await aF('/stats'); showApp();
  // auto-przej≈õcie z link√≥w z dashboardu (klik w lokalizacje)
  try{
    if(location.hash==='#students'){
      navigate('unified-students');
    }
  }catch(e){}
 }catch{ showLogin(); }
}

document.getElementById('login-btn').addEventListener('click',async()=>{
  const u=document.getElementById('l-user').value.trim();
  const p=document.getElementById('l-pass').value;
  const e=document.getElementById('login-error'); e.style.display='none';
  if(!u||!p){ e.textContent='Podaj login i has≈Ço.'; e.style.display='block'; return; }
  try{
    const d=await aF('/login',{method:'POST',body:JSON.stringify({username:u,password:p})});
    TOKEN=d.token;
    localStorage.setItem('km_token',TOKEN);
    showApp();
  }catch(err){
    e.textContent=err.message;
    e.style.display='block';
  }
});
document.getElementById('l-pass').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('login-btn').click();});
document.getElementById('btn-logout').addEventListener('click',()=>{
  TOKEN='';
  localStorage.removeItem('km_token');
  showLogin();
});

function navigate(view){
  CV=view;
  toggleSidebar(false);
  document.querySelectorAll('nav a[data-view]').forEach(a=>a.classList.toggle('active',a.dataset.view===view));
  
  const titles={
    dashboard:'Dashboard',
    'web-registrations':'Zapisy ze strony',
    participants:'Baza kursant√≥w',
    'add-participant':'Dodaj kursanta',
    groups:'Grupy',
    schedules:'Grafik zajƒôƒá',
    locations:'Lokalizacje',
    plans:'Cennik',
    'unified-students': 'Baza kursant√≥w',
    'legacy-history': 'Archiwum CSV',
    'instructors': 'Instruktorzy'
  };
  document.getElementById('page-title').textContent=titles[view]||view;
  document.getElementById('content').innerHTML='<div class="loader"><div class="spinner"></div> ≈Åadowanie‚Ä¶</div>';

  const fns={
    dashboard:loadDash,
    'web-registrations':()=>loadReg('web'),
    participants:()=>loadReg('admin'),
    'add-participant':loadAdd,
    groups:loadGroups,
    schedules:loadSchedules,
    locations:loadLocations,
    plans:loadPlans,
    'unified-students': loadUnifiedStudents,
    'legacy-history': loadHistory,
    'instructors': loadInstructors
  };
  (fns[view]||(()=>document.getElementById('content').innerHTML=''))();
}
document.querySelectorAll('nav a[data-view]').forEach(a=>a.addEventListener('click',()=>navigate(a.dataset.view)));

document.getElementById('btn-export').addEventListener('click', async ()=>{
  try{
    const url = API + '/export';
    const r = await fetch(url, { headers: TOKEN ? { 'Authorization': `Bearer ${TOKEN}` } : {} });
    if(!r.ok){
      const t = await r.text().catch(()=> '');
      throw new Error(t || `B≈ÇƒÖd pobierania CSV (${r.status})`);
    }
    const blob = await r.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `saggita-export-${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    toast('CSV pobrane','success');
  }catch(e){
    toast('B≈ÇƒÖd CSV: '+e.message,'error');
  }
});


function openStudentsByCity(city, season){
  try{
    // Ustawiamy filtry w URL (admin.html trzyma stan w querystring)
    const u = new URL(location.href);
    u.hash = '#students';
    if(city) u.searchParams.set('city', city);
    else u.searchParams.delete('city');
    if(season) u.searchParams.set('season', season);
    else u.searchParams.delete('season');
    u.searchParams.set('page','1');
    history.pushState({},'',u.toString());
    // przej≈õcie do widoku kursant√≥w + reload
    navigate('unified-students');
  }catch(e){
    console.error(e);
    toast('Nie uda≈Ço siƒô otworzyƒá listy kursant√≥w','error');
  }
}

async function loadDash(){
  const c=document.getElementById('content');
  try{
    const d=await aF('/stats');
    c.innerHTML = `
      <div class="stats-grid">
        <div class="sc accent"><div class="label">Wszystkie zapisy</div><div class="value">${d.total||0}</div></div>
        <div class="sc green"><div class="label">Op≈Çaceni</div><div class="value">${d.paid||0}</div></div>
        <div class="sc orange"><div class="label">OczekujƒÖcy</div><div class="value">${d.pending||0}</div></div>
        <div class="sc"><div class="label">Lista rezerwowa</div><div class="value">${d.waitlist||0}</div></div>
      </div>

      <div class="sh"><h3>Ob≈Ço≈ºenie lokalizacji</h3></div>
      <div class="tw" style="margin-bottom:28px"><table>
        <thead><tr><th>Miasto</th><th>≈ÅƒÖcznie</th><th>Op≈Çaceni</th><th>OczekujƒÖcy</th><th>Rezerwowa</th></tr></thead>
        <tbody>
          ${arrRows(d.byLoc).map(l=>`
            <tr>
              <td><strong style="color:var(--bright)">${l.city||'‚Äî'}</strong></td>
              <td><a href="#" class="link" onclick="openStudentsByCity('${l.city||''}', '2025');return false;"><strong>${l.total||0}</strong></a></td>
              <td>${pb('paid')} <a href="#" class="link" onclick="openStudentsByCity('${l.city||''}', '2025');return false;"><strong>${l.paid||0}</strong></a></td>
              <td><a href="#" class="link" onclick="openStudentsByCity('${l.city||''}', '2025');return false;">${l.pending||0}</a></td>
              <td><a href="#" class="link" onclick="openStudentsByCity('${l.city||''}', '2025');return false;">${l.waitlist||0}</a></td>
            </tr>
          `).join('')}
        </tbody>
      </table></div>

      <div class="sh"><h3>Ob≈Ço≈ºenie grup</h3></div>
      <div class="tw" style="margin-bottom:28px"><table>
        <thead><tr><th>Miasto</th><th>Grupa</th><th>Ob≈Ço≈ºenie</th><th></th></tr></thead>
        <tbody>
          ${arrRows(d.byGroup).map(g=>`
            <tr>
              <td>${g.city||'‚Äî'}</td>
              <td><strong style="color:var(--bright)">${g.name||'‚Äî'}</strong></td>
              <td>${capB(g.registered||0,g.max_capacity||0)}</td>
              <td><button class="bi" onclick="navigate('groups')">Zobacz</button></td>
            </tr>
          `).join('')}
        </tbody>
      </table></div>

      <div class="sh"><h3>Ostatnie zapisy</h3></div>
      <div class="bulk-actions"><button class="btn btn-secondary btn-sm" onclick="bulkDeleteReg()">üóë Usu≈Ñ zaznaczone</button></div>
      <div class="tw"><table>
        <thead><tr><th><input type="checkbox" class="chk" id="check-all-dash" onchange="toggleAllChecks('dash')"></th><th>Kursant</th><th>Miasto</th><th>Grupa</th><th>Status</th><th>P≈Çatno≈õƒá</th><th>Data</th><th></th></tr></thead>
        <tbody>
          ${arrRows(d.recent).map(r=>`
            <tr>
              <td><input type="checkbox" class="chk reg-check reg-check-dash" value="${r.id}"></td>
              <td><strong style="color:var(--bright)">${(r.name||`${r.first_name||''} ${r.last_name||''}`.trim())||'‚Äî'}</strong></td>
              <td>${r.city||'‚Äî'}</td>
              <td>${r.group_name||'‚Äî'}</td>
              <td>${sb(r.status)}</td>
              <td>${pb(r.payment_status)}</td>
              <td style="color:var(--dim);font-size:12px">${fdt(r.created_at)}</td>
              <td class="tda">
                <button class="bi" onclick="openKartoteka(${r.id},'view')">Kartoteka</button>
                <button class="bi" onclick="openKartoteka(${r.id},'edit')">Edytuj</button>
                <button class="bi del" onclick="deleteReg(${r.id})">Usu≈Ñ</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table></div>
    `;
  }catch(e){
    c.innerHTML = `<div class="empty"><strong>B≈ÇƒÖd ≈Çadowania</strong>${e.message}</div>`;
  }
}

async function loadReg(source){
  ro=0;
  renderRegShell(source);
  await fetchR(source);
}
function renderRegShell(source){
  const c=document.getElementById('content');
  c.innerHTML = `
    <div class="sh"><h3>${source==='web'?'Zapisy ze strony':'Baza kursant√≥w'}</h3></div>

    <div class="fb">
      <input id="r-q" type="text" placeholder="Szukaj: imiƒô, nazwisko, email, tel‚Ä¶" />
      <select id="r-st">
        <option value="">Status: wszystkie</option>
        <option value="new">Nowy</option>
        <option value="confirmed">Potwierdzony</option>
        <option value="cancelled">Anulowany</option>
        <option value="completed">Zako≈Ñczony</option>
      </select>
      <select id="r-ps">
        <option value="">P≈Çatno≈õƒá: wszystkie</option>
        <option value="unpaid">Nieop≈Çacony</option>
        <option value="pending">OczekujƒÖcy</option>
        <option value="paid">Op≈Çacony</option>
        <option value="partial">Czƒô≈õciowy</option>
        <option value="waived">Zwolniony</option>
      </select>
      <button class="btn btn-secondary btn-sm" id="r-apply">Filtruj</button>
      <button class="btn btn-secondary btn-sm" id="r-clear">Wyczy≈õƒá</button>
    </div>

    <div class="bulk-actions"><button class="btn btn-secondary btn-sm" onclick="bulkDeleteReg()">üóë Usu≈Ñ zaznaczone</button></div>

    <div class="tw">
      <table>
        <thead>
          <tr>
            <th><input type="checkbox" class="chk" id="check-all-reg" onchange="toggleAllChecks('reg')"></th>
            <th>Kursant</th><th>Miasto</th><th>Grupa</th><th>Status</th><th>P≈Çatno≈õƒá</th><th>≈πr√≥d≈Ço</th><th>Data</th><th></th>
          </tr>
        </thead>
        <tbody id="r-body">
          <tr><td colspan="8"><div class="loader"><div class="spinner"></div> ≈Åadowanie‚Ä¶</div></td></tr>
        </tbody>
      </table>
    </div>

    <div class="pag">
      <button id="r-prev" disabled>Wstecz</button>
      <div class="pi" id="r-pi">‚Äî</div>
      <button id="r-next" disabled>Dalej</button>
    </div>
  `;

  document.getElementById('r-apply').addEventListener('click', async ()=>{
    ro=0; await fetchR(source);
  });
  document.getElementById('r-clear').addEventListener('click', async ()=>{
    document.getElementById('r-q').value='';
    document.getElementById('r-st').value='';
    document.getElementById('r-ps').value='';
    ro=0; await fetchR(source);
  });
  document.getElementById('r-prev').addEventListener('click', async ()=>{
    ro=Math.max(0, ro-RL);
    await fetchR(source);
  });
  document.getElementById('r-next').addEventListener('click', async ()=>{
    ro=ro+RL;
    await fetchR(source);
  });
}

async function fetchR(source){
  const bodyEl=document.getElementById('r-body');
  const pi=document.getElementById('r-pi');
  const prev=document.getElementById('r-prev');
  const next=document.getElementById('r-next');

  bodyEl.innerHTML = `<tr><td colspan="8"><div class="loader"><div class="spinner"></div> ≈Åadowanie‚Ä¶</div></td></tr>`;

  try{
    const q = document.getElementById('r-q')?.value.trim() || '';
    const st = document.getElementById('r-st')?.value || '';
    const ps = document.getElementById('r-ps')?.value || '';

    const qs = new URLSearchParams();
    qs.set('limit', String(RL));
    qs.set('offset', String(ro));
    qs.set('source', source);
    if(q) qs.set('q', q);
    if(st) qs.set('status', st);
    if(ps) qs.set('payment_status', ps);

    const d = await aF(`/registrations?${qs.toString()}&_=${Date.now()}`);

    const rows = arrRows(d);
    const total = d.total ?? d.count ?? (Array.isArray(d)? d.length : rows.length);

    if(!rows.length){
      bodyEl.innerHTML = `<tr><td colspan="8"><div class="empty"><strong>Brak wynik√≥w</strong>Zmieniƒá filtry lub wyszukiwanie.</div></td></tr>`;
      pi.textContent = `0 / ${total||0}`;
      prev.disabled = ro<=0;
      next.disabled = true;
      return;
    }

    bodyEl.innerHTML = rows.map(r=>`
      <tr>
        <td><input type="checkbox" class="chk reg-check reg-check-reg" value="${r.id}"></td>
        <td>
          <strong style="color:var(--bright)">${(r.first_name||'')+' '+(r.last_name||'')}</strong>
          <div style="color:var(--dim);font-size:12px">${r.email||'‚Äî'} ¬∑ ${r.phone||'‚Äî'}</div>
        </td>
        <td>${r.city||r.location_city||'‚Äî'}</td>
        <td>${r.group_name||'‚Äî'}</td>
        <td>${sb(r.status)}</td>
        <td>${pb(r.payment_status)}</td>
        <td><span class="badge ${r.source==='admin'?'bb':'bx'}">${r.source==='admin'?'Admin':'WWW'}</span></td>
        <td style="color:var(--dim);font-size:12px">${fdt(r.created_at)}</td>
        <td class="tda">
          <button class="bi" onclick="openKartoteka(${r.id},'view')">Kartoteka</button>
          <button class="bi" onclick="openKartoteka(${r.id},'edit')">Edytuj</button>
          <button class="bi del" onclick="deleteReg(${r.id})">Usu≈Ñ</button>
        </td>
      </tr>
    `).join('');

    const shownFrom = Math.min(total|| (ro+rows.length), ro+1);
    const shownTo = ro+rows.length;
    pi.textContent = `${shownFrom}-${shownTo} / ${total||shownTo}`;

    prev.disabled = ro<=0;
    next.disabled = total ? (shownTo>=total) : (rows.length<RL);

  }catch(e){
    bodyEl.innerHTML = `<tr><td colspan="8"><div class="empty"><strong>B≈ÇƒÖd</strong>${e.message}</div></td></tr>`;
    pi.textContent = `‚Äî`;
    prev.disabled = true;
    next.disabled = true;
  }
}

async function loadAdd(){
  const c=document.getElementById('content');

  c.innerHTML = `
    <div class="sh"><h3>Dodaj kursanta</h3></div>
    <div class="ib">
      <strong>To jest zapis z poziomu admina.</strong><br>
      Po zapisaniu kursant trafi do bazy i mo≈ºesz od razu otworzyƒá kartotekƒô.
    </div>

    <div class="tw" style="padding:18px">
      <div class="fg">
        <div class="ff"><label>Imiƒô *</label><input id="a-fn" type="text" placeholder="np. Jan"></div>
        <div class="ff"><label>Nazwisko *</label><input id="a-ln" type="text" placeholder="np. Kowalski"></div>

        <div class="ff"><label>Email</label><input id="a-em" type="email" placeholder="np. jan@email.pl"></div>
        <div class="ff"><label>Telefon</label><input id="a-ph" type="text" placeholder="np. 600 000 000"></div>

        <div class="ff"><label>Rok urodzenia</label><input id="a-by" type="number" placeholder="np. 1992"></div>
        <div class="ff">
          <label>Typ kursanta</label>
          <select id="a-in">
            <option value="true">Nowy</option>
            <option value="false">Kontynuacja</option>
          </select>
        </div>

        <div class="ff full">
          <label>Lokalizacja *</label>
          <select id="a-loc"><option value="">≈Åadowanie‚Ä¶</option></select>
        </div>

        <div class="ff full">
          <label>Grupa *</label>
          <select id="a-gr"><option value="">Najpierw wybierz lokalizacjƒô</option></select>
        </div>

        <div class="ff full">
          <label>Termin z grafiku</label>
          <select id="a-sc"><option value="">‚Äî opcjonalnie ‚Äî</option></select>
        </div>

        <div class="ff full">
          <label>Karnet</label>
          <select id="a-pl"><option value="">≈Åadowanie‚Ä¶</option></select>
        </div>

        <div class="ff"><label>Data startu</label><input id="a-sd" type="date"></div>

        <div class="ff">
          <label>Status zapisu</label>
          <select id="a-st">
            <option value="new">Nowy</option>
            <option value="confirmed">Potwierdzony</option>
            <option value="cancelled">Anulowany</option>
            <option value="completed">Zako≈Ñczony</option>
          </select>
        </div>

        <div class="ff">
          <label>Status p≈Çatno≈õci</label>
          <select id="a-ps">
            <option value="unpaid">Nieop≈Çacony</option>
            <option value="pending">OczekujƒÖcy</option>
            <option value="paid">Op≈Çacony</option>
            <option value="partial">Czƒô≈õciowy</option>
            <option value="waived">Zwolniony</option>
          </select>
        </div>

        <div class="ff">
          <label>Metoda p≈Çatno≈õci</label>
          <select id="a-pm">
            <option value="transfer">Przelew</option>
            <option value="cash">Got√≥wka</option>
            <option value="card">Karta</option>
          </select>
        </div>

        <div class="ff"><label>Kwota (z≈Ç)</label><input id="a-am" type="number" step="0.01" value="0"></div>

        <div class="ff full"><label>Notatka admina</label><textarea id="a-nt" placeholder="Opcjonalnie‚Ä¶"></textarea></div>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px">
        <button class="btn btn-secondary" id="a-cancel">Anuluj</button>
        <button class="btn btn-primary" id="a-save">Zapisz kursanta</button>
      </div>
    </div>
  `;

  let locations=[], groups=[], schedules=[], plans=[];
  try{
    const out = await Promise.all([ aF('/locations'), aF('/groups'), aF('/schedules'), aF('/plans') ]);
    locations = arrRows(out[0]);
    groups = arrRows(out[1]);
    schedules = arrRows(out[2]);
    plans = arrRows(out[3]);
  }catch(e){
    c.innerHTML = `<div class="empty"><strong>B≈ÇƒÖd</strong>${e.message}</div>`;
    return;
  }

  const elLoc=document.getElementById('a-loc');
  const elGr=document.getElementById('a-gr');
  const elSc=document.getElementById('a-sc');
  const elPl=document.getElementById('a-pl');

  elLoc.innerHTML = `<option value="">‚Äî wybierz lokalizacjƒô ‚Äî</option>` + locations.map(l =>
    `<option value="${l.id}">${l.city} ‚Äî ${l.name}</option>`
  ).join('');

  elPl.innerHTML = `<option value="">‚Äî brak karnetu ‚Äî</option>` + plans.map(p=>
    `<option value="${p.id}">${p.name} ‚Äî ${p.price} z≈Ç${p.months?` / ${p.months} mies.`:''}</option>`
  ).join('');

  function schedLabel(s){
    const day = DAYS[s.day_of_week] || s.day_name || s.day_of_week;
    const ts = s.time_start ? String(s.time_start).slice(0,5) : '';
    const te = s.time_end ? String(s.time_end).slice(0,5) : '';
    return `${day} ${ts}${te?`‚Äì${te}`:''}${s.address?` ¬∑ ${s.address}`:''}`;
  }

  function rebuildGroups(){
    const locId = parseInt(elLoc.value||'0',10);
    const gList = groups.filter(g => parseInt(g.location_id||0,10) === locId);
    elGr.innerHTML = gList.length
      ? gList.map(g => `<option value="${g.id}">${g.city||''}${g.city?' ‚Äî ':''}${g.name}</option>`).join('')
      : `<option value="">Brak grup dla tej lokalizacji</option>`;
    rebuildSchedules();
  }

  function rebuildSchedules(){
    const gid = parseInt(elGr.value||'0',10);
    const sList = schedules.filter(s => parseInt(s.group_id||0,10) === gid);
    elSc.innerHTML = `<option value="">‚Äî opcjonalnie ‚Äî</option>` + sList.map(s =>
      `<option value="${s.id}">${schedLabel(s)}</option>`
    ).join('');
  }

  elLoc.addEventListener('change', rebuildGroups);
  elGr.addEventListener('change', rebuildSchedules);
  rebuildGroups();

  document.getElementById('a-cancel').addEventListener('click', ()=>navigate('participants'));

  document.getElementById('a-save').addEventListener('click', async ()=>{
    const first_name=document.getElementById('a-fn').value.trim();
    const last_name=document.getElementById('a-ln').value.trim();
    const location_id=parseInt(elLoc.value||'0',10);
    const group_id=parseInt(elGr.value||'0',10);

    if(!first_name || !last_name){ toast('Uzupe≈Çnij: imiƒô i nazwisko','error'); return; }
    if(!location_id || !group_id){ toast('Uzupe≈Çnij: lokalizacja i grupa','error'); return; }

    const b={
      first_name,
      last_name,
      email:document.getElementById('a-em').value.trim()||null,
      phone:document.getElementById('a-ph').value.trim()||null,
      birth_year:parseInt(document.getElementById('a-by').value||'0',10)||null,
      is_new:document.getElementById('a-in').value==='true',
      location_id,
      group_id,
      schedule_id:parseInt(elSc.value||'0',10)||null,
      price_plan_id:parseInt(elPl.value||'0',10)||null,
      start_date:document.getElementById('a-sd').value||null,
      payment_status:document.getElementById('a-ps').value,
      payment_method:document.getElementById('a-pm').value,
      total_amount:parseFloat(document.getElementById('a-am').value||'0')||0,
      status:document.getElementById('a-st').value,
      admin_notes:document.getElementById('a-nt').value||null,
      source:'admin'
    };

    try{
      const d = await aF(`/registrations`, { method:'POST', body: JSON.stringify(b) });
      const newId = d.id || d.registration_id || (d.row && d.row.id);
      toast('Kursant dodany','success');
      if(newId) openKartoteka(newId,'view');
      else navigate('participants');
    }catch(e){
      toast('B≈ÇƒÖd: '+e.message,'error');
    }
  });
}

async function openKartoteka(id, mode='view'){
  let r;
  let locations=[], groups=[], schedules=[], plans=[];
  try{
    const out = await Promise.all([
      aF(`/registrations/${id}?_=${Date.now()}`),
      aF('/locations'),
      aF('/groups'),
      aF('/schedules'),
      aF('/plans'),
    ]);
    r = out[0];
    locations = arrRows(out[1]);
    groups = arrRows(out[2]);
    schedules = arrRows(out[3]);
    plans = arrRows(out[4]);
  }catch(e){
    toast('B≈ÇƒÖd pobierania danych: '+e.message,'error');
    return;
  }

  const locOpts = locations.map(l =>
    `<option value="${l.id}" ${l.id==r.location_id?'selected':''}>${l.city} ‚Äî ${l.name}</option>`
  ).join('');

  function schedLabel(s){
    const day = DAYS[s.day_of_week] || s.day_name || s.day_of_week;
    const ts = s.time_start ? String(s.time_start).slice(0,5) : '';
    const te = s.time_end ? String(s.time_end).slice(0,5) : '';
    return `${day} ${ts}${te?`‚Äì${te}`:''}${s.address?` ¬∑ ${s.address}`:''}`;
  }

  const pO = `<option value="">‚Äî brak karnetu ‚Äî</option>` + plans.map(p=>
    `<option value="${p.id}" ${p.id==r.price_plan_id?'selected':''}>${p.name} ‚Äî ${p.price} z≈Ç${p.months?` / ${p.months} mies.`:''}</option>`
  ).join('');

  const isEdit = mode==='edit';
  const fld=(id,val,type='text')=> isEdit
    ? `<input id="${id}" type="${type}" value="${val||''}">`
    : `<div class="view-val">${val||'‚Äî'}</div>`;
  const txt=(id,val)=> isEdit
    ? `<textarea id="${id}">${val||''}</textarea>`
    : `<div class="view-val" style="white-space:pre-wrap">${val||'‚Äî'}</div>`;

  const payOpts=['paid','unpaid','pending','partial','waived']
    .map(v=>`<option value="${v}" ${r.payment_status===v?'selected':''}>${PS[v]||v}</option>`).join('');
  const statOpts=['new','confirmed','cancelled','completed']
    .map(v=>`<option value="${v}" ${r.status===v?'selected':''}>${RS[v]||v}</option>`).join('');
  const pmOpts=['cash','transfer','card']
    .map(v=>`<option value="${v}" ${r.payment_method===v?'selected':''}>${({cash:'Got√≥wka',transfer:'Przelew',card:'Karta'})[v]||v}</option>`).join('');

  const body = `
    <div class="kart-header">
      <div class="kart-avatar">${initials(r.first_name,r.last_name)}</div>
      <div>
        <div class="kart-name">${r.first_name||''} ${r.last_name||''}</div>
        <div class="kart-meta">${r.email||'brak email'} ¬∑ ${r.phone||'brak tel.'} ¬∑ ${r.city||'brak miasta'}</div>
        <div class="kart-badges">
          ${sb(r.status)} ${pb(r.payment_status)}
          ${r.is_waitlist?'<span class="badge bo">Lista rezerwowa</span>':''}
          <span class="badge ${r.source==='admin'?'bb':'bx'}">${r.source==='admin'?'Admin':'WWW'}</span>
        </div>
      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">Dane osobowe</div>
      <div class="fg">
        <div class="ff"><label>Imiƒô</label>${fld('k-fn',r.first_name)}</div>
        <div class="ff"><label>Nazwisko</label>${fld('k-ln',r.last_name)}</div>
        <div class="ff"><label>Email</label>${fld('k-em',r.email,'email')}</div>
        <div class="ff"><label>Telefon</label>${fld('k-ph',r.phone)}</div>
        <div class="ff"><label>Rok urodzenia</label>${fld('k-by',r.birth_year,'number')}</div>
        <div class="ff"><label>Typ kursanta</label>${
          isEdit
            ? `<select id="k-in"><option value="true" ${r.is_new?'selected':''}>Nowy</option><option value="false" ${!r.is_new?'selected':''}>Kontynuacja</option></select>`
            : `<div class="view-val">${r.is_new?'Nowy kursant':'Kontynuacja'}</div>`
        }</div>
      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">Organizacja treningu</div>
      <div class="fg">
        <div class="ff full">
          <label>Lokalizacja</label>
          ${isEdit ? `<select id="k-loc">${locOpts}</select>` : `<div class="view-val">${r.city ? `${r.city} ‚Äî ${r.location_name||''}` : '‚Äî'}</div>`}
        </div>

        <div class="ff full">
          <label>Grupa</label>
          ${isEdit ? `<select id="k-gr"></select>` : `<div class="view-val">${r.group_name||'‚Äî'}</div>`}
        </div>

        <div class="ff full">
          <label>Dzie≈Ñ i godzina z grafiku</label>
          ${isEdit ? `<select id="k-sc"><option value="">‚Äî wybierz termin ‚Äî</option></select>` : `<div class="view-val">${r.schedule_id ? `${r.schedule_day!=null?DAYS[r.schedule_day]:''} ${String(r.schedule_time_start||'').slice(0,5)}${r.schedule_time_end?`‚Äì${String(r.schedule_time_end).slice(0,5)}`:''}` : '‚Äî'}</div>`}
        </div>

        <div class="ff full">
          <label>Karnet</label>
          ${isEdit ? `<select id="k-pl">${pO}</select>` : `<div class="view-val">${r.plan_name||'‚Äî'}</div>`}
        </div>

        <div class="ff"><label>Data startu</label>${fld('k-sd',r.start_date?String(r.start_date).slice(0,10):'','date')}</div>

        <div class="ff"><label>Lista rezerwowa</label>${
          isEdit
            ? `<select id="k-wl"><option value="false" ${!r.is_waitlist?'selected':''}>Nie</option><option value="true" ${r.is_waitlist?'selected':''}>Tak</option></select>`
            : `<div class="view-val">${r.is_waitlist?'Tak':'Nie'}</div>`
        }</div>
      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">P≈Çatno≈õƒá</div>
      <div class="fg">
        <div class="ff"><label>Status p≈Çatno≈õci</label>${isEdit?`<select id="k-ps">${payOpts}</select>`:`<div class="view-val">${pb(r.payment_status)}</div>`}</div>
        <div class="ff"><label>Metoda</label>${isEdit?`<select id="k-pm">${pmOpts}</select>`:`<div class="view-val">${({cash:'Got√≥wka',transfer:'Przelew',card:'Karta'})[r.payment_method]||r.payment_method||'‚Äî'}</div>`}</div>
        <div class="ff"><label>Kwota (z≈Ç)</label>${fld('k-am',r.total_amount,'number')}</div>
        <div class="ff"><label>Kod ref.</label><div class="view-val" style="font-family:monospace;font-size:12px">${r.payment_ref||'‚Äî'}</div></div>
        <div class="ff"><label>Data op≈Çaty</label><div class="view-val">${fdt(r.paid_at)}</div></div>
        <div class="ff"><label>Status zapisu</label>${isEdit?`<select id="k-st">${statOpts}</select>`:`<div class="view-val">${sb(r.status)}</div>`}</div>
      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">Historia i notatki</div>
      <div class="fg">
        <div class="ff"><label>Data zapisu</label><div class="view-val">${fdt(r.created_at)}</div></div>
        <div class="ff"><label>Preferowany czas</label><div class="view-val">${r.preferred_time||'‚Äî'}</div></div>
        <div class="ff full"><label>Notatki admina</label>${txt('k-nt',r.admin_notes)}</div>
      </div>
    </div>
  `;

  const footer = isEdit
    ? `<button class="btn btn-secondary" onclick="openKartoteka(${id},'view')">Anuluj</button>
       <button class="btn btn-primary" onclick="saveKartoteka(${id})">Zapisz zmiany</button>`
    : `<button class="btn btn-secondary" onclick="closeModal()">Zamknij</button>
       <button class="btn btn-primary" onclick="openKartoteka(${id},'edit')">Edytuj kartotekƒô</button>
       <button class="btn btn-secondary" style="background:var(--red);border-color:var(--red)" onclick="deleteReg(${id})">Usu≈Ñ zapis</button>`;

  showModal(`Kartoteka #${id}`, body, footer);

  if(mode==='edit'){
    const elLoc = document.getElementById('k-loc');
    const elGr  = document.getElementById('k-gr');
    const elSc  = document.getElementById('k-sc');

    function rebuildGroups(){
      const locId = parseInt(elLoc.value||'0',10);
      const gList = groups.filter(g => parseInt(g.location_id||0,10) === locId);
      elGr.innerHTML = gList.map(g => `<option value="${g.id}">${g.city||''}${g.city?' ‚Äî ':''}${g.name}</option>`).join('');
      const wanted = parseInt(r.group_id||0,10);
      if(gList.some(g=>g.id==wanted)) elGr.value = String(wanted);
      rebuildSchedules();
    }

    function rebuildSchedules(){
      const gid = parseInt(elGr.value||'0',10);
      const sList = schedules.filter(s => parseInt(s.group_id||0,10) === gid);
      elSc.innerHTML = `<option value="">‚Äî wybierz termin ‚Äî</option>` + sList.map(s =>
        `<option value="${s.id}">${schedLabel(s)}</option>`
      ).join('');
      if(r.schedule_id && sList.some(s=>s.id==r.schedule_id)) elSc.value = String(r.schedule_id);
    }

    elLoc.addEventListener('change', rebuildGroups);
    elGr.addEventListener('change', rebuildSchedules);
    rebuildGroups();
  }
}

async function saveKartoteka(id){
  const b={
    first_name:document.getElementById('k-fn')?.value||undefined,
    last_name:document.getElementById('k-ln')?.value||undefined,
    email:document.getElementById('k-em')?.value||null,
    phone:document.getElementById('k-ph')?.value||null,
    birth_year:parseInt(document.getElementById('k-by')?.value||'0',10)||null,
    is_new:document.getElementById('k-in')?.value==='true',
    group_id:parseInt(document.getElementById('k-gr')?.value||'0',10)||null,
    schedule_id:parseInt(document.getElementById('k-sc')?.value||'0',10)||null,
    price_plan_id:parseInt(document.getElementById('k-pl')?.value||'0',10)||null,
    start_date:document.getElementById('k-sd')?.value||null,
    is_waitlist:document.getElementById('k-wl')?.value==='true',
    payment_status:document.getElementById('k-ps')?.value,
    payment_method:document.getElementById('k-pm')?.value,
    total_amount:parseFloat(document.getElementById('k-am')?.value||'0')||0,
    status:document.getElementById('k-st')?.value,
    admin_notes:document.getElementById('k-nt')?.value||null,
  };
  Object.keys(b).forEach(k=>{ if(b[k]===undefined) delete b[k]; });

  try{
    await aF(`/registrations/${id}?_=${Date.now()}`,{method:'PATCH',body:JSON.stringify(b)});
    toast('Kartoteka zapisana');
    openKartoteka(id,'view');
    if(CV==='web-registrations') fetchR('web');
    if(CV==='participants') fetchR('admin');
    if(CV==='dashboard') loadDash();
  }catch(e){
    toast('B≈ÇƒÖd: '+e.message,'error');
  }
}

async function loadGroups(){
  const c=document.getElementById('content');
  try{
    const d=await aF('/groups');
    const rows=arrRows(d);
    window.__plans = rows;
    window.__plansMap = Object.fromEntries(rows.map(r=>[String(r.id), r]));
    c.innerHTML = `
      <div class="sh">
        <h3>Grupy</h3>
        <button class="btn btn-primary btn-sm" onclick="openGroupModal()">+ Dodaj grupƒô</button>
      </div>
      <div class="tw"><table>
        <thead><tr><th>ID</th><th>Miasto</th><th>Nazwa</th><th>Kategoria</th><th>Pojemno≈õƒá</th><th>Aktywna</th><th></th></tr></thead>
        <tbody>${rows.map(g=>`
          <tr>
            <td>${g.id}</td>
            <td>${g.city||'‚Äî'}</td>
            <td><strong style="color:var(--bright)">${g.name||'‚Äî'}</strong></td>
            <td>${g.category||'‚Äî'}</td>
            <td>${g.max_capacity ?? '‚Äî'}</td>
            <td>${g.active===false?'<span class="badge br">NIE</span>':'<span class="badge bg">TAK</span>'}</td>
            <td class="tda">
              <button class="bi" onclick="openGroupModal(${g.id})">Edytuj</button>
              <button class="bi del" onclick="deleteGroup(${g.id})">Usu≈Ñ</button>
            </td>
          </tr>
        `).join('')}</tbody>
      </table></div>
    `;
  }catch(e){
    c.innerHTML=`<div class="empty"><strong>B≈ÇƒÖd</strong>${e.message}</div>`;
  }
}
async function loadSchedules(){
  const c=document.getElementById('content');
  try{
    const d=await aF('/schedules');
    const rows=arrRows(d);
    window.__plans = rows;
    window.__plansMap = Object.fromEntries(rows.map(r=>[String(r.id), r]));
    c.innerHTML = `
      <div class="sh">
        <h3>Grafik zajƒôƒá</h3>
        <button class="btn btn-primary btn-sm" onclick="openScheduleModal()">+ Dodaj termin</button>
      </div>
      <div class="tw"><table>
        <thead><tr><th>ID</th><th>Grupa</th><th>Dzie≈Ñ</th><th>Godzina</th><th>Adres</th><th>Aktywny</th><th></th></tr></thead>
        <tbody>${rows.map(s=>`
          <tr>
            <td>${s.id}</td>
            <td>${s.group_name||s.group_id||'‚Äî'}</td>
            <td>${DAYS[s.day_of_week]||s.day_name||s.day_of_week||'‚Äî'}</td>
            <td>${(s.time_start?String(s.time_start).slice(0,5):'')}${s.time_end?`‚Äì${String(s.time_end).slice(0,5)}`:''}</td>
            <td>${s.address||'‚Äî'}</td>
            <td>${s.active===false?'<span class="badge br">NIE</span>':'<span class="badge bg">TAK</span>'}</td>
            <td class="tda">
              <button class="bi" onclick="openScheduleModal(${s.id})">Edytuj</button>
              <button class="bi del" onclick="deleteSchedule(${s.id})">Usu≈Ñ</button>
            </td>
          </tr>
        `).join('')}</tbody>
      </table></div>
    `;
  }catch(e){
    c.innerHTML=`<div class="empty"><strong>B≈ÇƒÖd</strong>${e.message}</div>`;
  }
}
async function loadLocations(){
  const c=document.getElementById('content');
  try{
    const d=await aF('/locations');
    const rows=arrRows(d);
    window.__plans = rows;
    window.__plansMap = Object.fromEntries(rows.map(r=>[String(r.id), r]));
    c.innerHTML = `
      <div class="sh">
        <h3>Lokalizacje</h3>
        <button class="btn btn-primary btn-sm" onclick="openLocationModal()">+ Dodaj lokalizacjƒô</button>
      </div>
      <div class="tw"><table>
        <thead><tr><th>ID</th><th>Miasto</th><th>Nazwa</th><th>Adres</th><th>Kolejno≈õƒá</th><th>Aktywna</th><th></th></tr></thead>
        <tbody>${rows.map(l=>`
          <tr>
            <td>${l.id}</td>
            <td><strong style="color:var(--bright)">${l.city||'‚Äî'}</strong></td>
            <td>${l.name||'‚Äî'}</td>
            <td>${l.address||'‚Äî'}</td>
            <td>${l.sort_order??'‚Äî'}</td>
            <td>${l.active===false?'<span class="badge br">NIE</span>':'<span class="badge bg">TAK</span>'}</td>
            <td class="tda">
              <button class="bi" onclick="openLocationModal(${l.id})">Edytuj</button>
              <button class="bi del" onclick="deleteLocation(${l.id})">Usu≈Ñ</button>
            </td>
          </tr>
        `).join('')}</tbody>
      </table></div>
    `;
  }catch(e){
    c.innerHTML=`<div class="empty"><strong>B≈ÇƒÖd</strong>${e.message}</div>`;
  }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CENNIK (PLANY / US≈ÅUGI)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadPlans(){
  const c=document.getElementById('content');
  try{
    const d=await aF('/plans');
    const rows=arrRows(d);
    window.__plans = rows;
    window.__plansMap = Object.fromEntries(rows.map(r=>[String(r.id), r]));

    const segLabel = (v)=>{
      const m = {adults:'Doro≈õli', kids:'Dzieci', vip:'VIP', other:'Inne'};
      return m[v] || (v||'‚Äî');
    };

    c.innerHTML = `
      <div class="sh">
        <h3>Cennik</h3>
        <button class="btn btn-primary btn-sm" onclick="openPlanModal()">+ Dodaj pozycjƒô</button>
      </div>
      <div class="ib">
        <strong>To jest cennik do zapis√≥w ‚Äûprzez cennik‚Äù.</strong><br>
        Uwaga: ‚ÄûMiesiƒÖce = 0‚Äù oznacza us≈Çugƒô jednorazowƒÖ.
      </div>
      <div class="tw"><table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Segment</th>
            <th>Nazwa</th>
            <th>Cena</th>
            <th>MiesiƒÖce</th>
            <th>Wpisowe (nowi)</th>
            <th>Aktywna</th>
            <th>Opis</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(p=>`
            <tr>
              <td>${p.id}</td>
              <td><span class="badge bb">${segLabel(p.category)}</span></td>
              <td><strong style="color:var(--bright)">${p.name||'‚Äî'}</strong></td>
              <td><strong>${(p.price??'‚Äî')} z≈Ç</strong></td>
              <td>${(p.months??0)}</td>
              <td>${(p.signup_fee==null?'‚Äî':(p.signup_fee+' z≈Ç'))}</td>
              <td>${p.active===false?'<span class="badge br">NIE</span>':'<span class="badge bg">TAK</span>'}</td>
              <td style="color:var(--dim);font-size:12px">${(p.description||p.desc||'‚Äî')}</td>
              <td class="tda">
                <button class="bi" onclick="openPlanModal(${p.id})">Edytuj</button>
                <button class="bi del" onclick="deletePlan(${p.id})">Usu≈Ñ</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table></div>
    `;
  }catch(e){
    c.innerHTML=`<div class="empty"><strong>B≈ÇƒÖd</strong>${e.message}</div>`;
  }
}

async function openPlanModal(id){
  let p = {};
  if(id){
    p = (window.__plansMap && window.__plansMap[String(id)]) ? window.__plansMap[String(id)] : {};
    if(!p || !p.id){ toast('Nie znaleziono pozycji w pamiƒôci ‚Äî od≈õwie≈º listƒô.','error'); return; }
  }

  const body = `
    <div class="fg">
      <div class="ff">
        <label>Segment *</label>
        <select id="p-cat">
          <option value="adults" ${(p.category||'adults')==='adults'?'selected':''}>Doro≈õli</option>
          <option value="kids" ${(p.category||'')==='kids'?'selected':''}>Dzieci</option>
          <option value="vip" ${(p.category||'')==='vip'?'selected':''}>VIP</option>
          <option value="other" ${(p.category||'')==='other'?'selected':''}>Inne</option>
        </select>
      </div>

      <div class="ff">
        <label>Aktywna</label>
        <select id="p-active">
          <option value="true" ${p.active!==false?'selected':''}>TAK</option>
          <option value="false" ${p.active===false?'selected':''}>NIE</option>
        </select>
      </div>

      <div class="ff full">
        <label>Nazwa us≈Çugi *</label>
        <input id="p-name" value="${(p.name||'').replace(/"/g,'&quot;')}">
      </div>

      <div class="ff">
        <label>Cena (z≈Ç) *</label>
        <input id="p-price" type="number" step="0.01" value="${p.price??''}">
      </div>

      <div class="ff">
        <label>MiesiƒÖce (0 = jednorazowe)</label>
        <input id="p-months" type="number" step="1" value="${p.months??0}">
      </div>

      <div class="ff">
        <label>Wpisowe (nowi) (z≈Ç)</label>
        <input id="p-fee" type="number" step="0.01" value="${(p.signup_fee ?? '')}">
      </div>

      <div class="ff full">
        <label>Opis</label>
        <textarea id="p-desc" placeholder="np. Karnet miesiƒôczny dla doros≈Çych‚Ä¶">${(p.description||p.desc||'')}</textarea>
      </div>
    </div>
  `;

  const footer = `
    <button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
    <button class="btn btn-primary" onclick="savePlan(${id||'null'})">Zapisz</button>
  `;

  showModal(id?`Edytuj pozycjƒô #${id}`:'Dodaj pozycjƒô cennika', body, footer);
}

async function savePlan(id){
  const name = document.getElementById('p-name').value.trim();
  const category = document.getElementById('p-cat').value;
  const price = parseFloat(document.getElementById('p-price').value||'');
  const months = parseInt(document.getElementById('p-months').value||'0',10) || 0;
  const feeRaw = document.getElementById('p-fee').value;
  const signup_fee = feeRaw==='' ? null : (parseFloat(feeRaw)||0);
  const description = document.getElementById('p-desc').value || null;
  const active = document.getElementById('p-active').value === 'true';

  if(!name){ toast('Uzupe≈Çnij: nazwa us≈Çugi','error'); return; }
  if(Number.isNaN(price)){ toast('Uzupe≈Çnij: cena','error'); return; }

  // Minimalny, bezpieczny payload (≈ºeby nie wysypaƒá siƒô na kolumnach, kt√≥rych nie ma)
  const payload = { name, category, price, active, description };
  // months: 0 = jednorazowe, >0 = karnet (miesiƒÖce)
  payload.months = months;
  // wpisowe: opcjonalne
  if(signup_fee !== null) payload.signup_fee = signup_fee;

  try{
    if(id){
      await aF(`/plans?id=${id}`, { method:'PATCH', body: JSON.stringify(payload) });
      toast('Pozycja zaktualizowana','success');
    }else{
      await aF('/plans', { method:'POST', body: JSON.stringify(payload) });
      toast('Pozycja dodana','success');
    }
    closeModal();
    loadPlans();
  }catch(e){
    toast('B≈ÇƒÖd: '+e.message,'error');
  }
}

async function deletePlan(id){
  if(!confirm('Na pewno usunƒÖƒá tƒô pozycjƒô cennika?')) return;
  try{
    await aF(`/plans?id=${id}`, { method:'DELETE' });
    toast('Pozycja usuniƒôta','success');
    loadPlans();
  }catch(e){
    toast('B≈ÇƒÖd: '+e.message,'error');
  }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CRUD: GRUPY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openGroupModal(id){
  let g = {}, locations = [];
  try{
    const fetches = id 
      ? [aF(`/resource?type=groups&id=${id}`), aF('/locations')]
      : [Promise.resolve(null), aF('/locations')];
    const [groupData, locsData] = await Promise.all(fetches);
    if(groupData) g = groupData;
    locations = arrRows(locsData);
  }catch(e){
    toast('B≈ÇƒÖd: '+e.message,'error');
    return;
  }

  const locOpts = locations.map(l => 
    `<option value="${l.id}" ${l.id==g.location_id?'selected':''}>${l.city} ‚Äî ${l.name}</option>`
  ).join('');

  const body = `
    <div class="fg">
      <div class="ff full">
        <label>Lokalizacja *</label>
        <select id="g-loc"><option value="">‚Äî wybierz ‚Äî</option>${locOpts}</select>
      </div>
      <div class="ff"><label>Nazwa grupy *</label><input id="g-name" value="${g.name||''}"></div>
      <div class="ff">
        <label>Kategoria</label>
        <select id="g-cat">
          <option value="kids" ${g.category==='kids'?'selected':''}>Dzieci</option>
          <option value="adults" ${g.category==='adults'?'selected':''}>Doro≈õli</option>
          <option value="vip" ${g.category==='vip'?'selected':''}>VIP/Indywidualnie</option>
        </select>
      </div>
      <div class="ff"><label>Przedzia≈Ç wiekowy</label><input id="g-age" value="${g.age_range||''}" placeholder="np. 6-10 lat"></div>
      <div class="ff"><label>Pojemno≈õƒá (max os√≥b)</label><input id="g-cap" type="number" value="${g.max_capacity||20}"></div>
      <div class="ff full"><label>Notatki</label><textarea id="g-notes">${g.notes||''}</textarea></div>
      <div class="ff">
        <label>Aktywna</label>
        <select id="g-active">
          <option value="true" ${g.active!==false?'selected':''}>Tak</option>
          <option value="false" ${g.active===false?'selected':''}>Nie</option>
        </select>
      </div>
    </div>
  `;

  const footer = `
    <button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
    <button class="btn btn-primary" onclick="saveGroup(${id||'null'})">${id?'Zapisz zmiany':'Dodaj grupƒô'}</button>
  `;

  showModal(id ? `Edytuj grupƒô #${id}` : 'Nowa grupa', body, footer);
}

async function saveGroup(id){
  const location_id = parseInt(document.getElementById('g-loc').value||'0');
  const name = document.getElementById('g-name').value.trim();
  
  if(!location_id || !name){
    toast('Uzupe≈Çnij: lokalizacja i nazwa','error');
    return;
  }

  const b = {
    location_id,
    name,
    category: document.getElementById('g-cat').value,
    age_range: document.getElementById('g-age').value.trim()||null,
    max_capacity: parseInt(document.getElementById('g-cap').value)||20,
    notes: document.getElementById('g-notes').value.trim()||null,
    active: document.getElementById('g-active').value==='true'
  };

  try{
    if(id){
      await aF(`/resource?type=groups&id=${id}`,{method:'PATCH',body:JSON.stringify(b)});
      toast('Grupa zaktualizowana');
    }else{
      await aF('/groups',{method:'POST',body:JSON.stringify(b)});
      toast('Grupa dodana');
    }
    closeModal();
    loadGroups();
  }catch(e){
    toast('B≈ÇƒÖd: '+e.message,'error');
  }
}

async function deleteGroup(id){
  if(!confirm('UsunƒÖƒá tƒô grupƒô? ZostanƒÖ utracone powiƒÖzania z zapisami!')) return;
  try{
    await aF(`/resource?type=groups&id=${id}`,{method:'DELETE'});
    toast('Grupa usuniƒôta');
    loadGroups();
  }catch(e){
    toast('B≈ÇƒÖd: '+e.message,'error');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CRUD: GRAFIK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openScheduleModal(id){
  let s = {}, groups = [];
  try{
    const fetches = id 
      ? [aF(`/resource?type=schedules&id=${id}`), aF('/groups')]
      : [Promise.resolve(null), aF('/groups')];
    const [schedData, grpsData] = await Promise.all(fetches);
    if(schedData) s = schedData;
    groups = arrRows(grpsData);
  }catch(e){
    toast('B≈ÇƒÖd: '+e.message,'error');
    return;
  }

  const grpOpts = groups.map(g => 
    `<option value="${g.id}" ${g.id==s.group_id?'selected':''}>${g.city||''} ‚Äî ${g.name}</option>`
  ).join('');

  const body = `
    <div class="fg">
      <div class="ff full">
        <label>Grupa *</label>
        <select id="s-grp"><option value="">‚Äî wybierz ‚Äî</option>${grpOpts}</select>
      </div>
      <div class="ff">
        <label>Dzie≈Ñ tygodnia *</label>
        <select id="s-day">
          ${DAYS.map((d,i)=>`<option value="${i}" ${s.day_of_week==i?'selected':''}>${d}</option>`).join('')}
        </select>
      </div>
      <div class="ff"><label>Godzina rozpoczƒôcia</label><input id="s-start" type="time" value="${s.time_start?String(s.time_start).slice(0,5):''}"></div>
      <div class="ff"><label>Godzina zako≈Ñczenia</label><input id="s-end" type="time" value="${s.time_end?String(s.time_end).slice(0,5):''}"></div>
      <div class="ff full"><label>Adres (opcjonalnie)</label><input id="s-addr" value="${s.address||''}" placeholder="np. ul. Przyk≈Çadowa 1"></div>
      <div class="ff">
        <label>Aktywny</label>
        <select id="s-active">
          <option value="true" ${s.active!==false?'selected':''}>Tak</option>
          <option value="false" ${s.active===false?'selected':''}>Nie</option>
        </select>
      </div>
    </div>
  `;

  const footer = `
    <button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
    <button class="btn btn-primary" onclick="saveSchedule(${id||'null'})">${id?'Zapisz zmiany':'Dodaj termin'}</button>
  `;

  showModal(id ? `Edytuj termin #${id}` : 'Nowy termin', body, footer);
}

async function saveSchedule(id){
  const group_id = parseInt(document.getElementById('s-grp').value||'0');
  const day_of_week = parseInt(document.getElementById('s-day').value);
  
  if(!group_id){
    toast('Wybierz grupƒô','error');
    return;
  }

  const b = {
    group_id,
    day_of_week,
    day_name: DAYS[day_of_week],
    time_start: document.getElementById('s-start').value||null,
    time_end: document.getElementById('s-end').value||null,
    address: document.getElementById('s-addr').value.trim()||null,
    active: document.getElementById('s-active').value==='true'
  };

  // Auto-generate time_label
  if(b.time_start && b.time_end){
    b.time_label = `${b.time_start}‚Äì${b.time_end}`;
  }else if(b.time_start){
    b.time_label = b.time_start;
  }

  try{
    if(id){
      await aF(`/resource?type=schedules&id=${id}`,{method:'PATCH',body:JSON.stringify(b)});
      toast('Termin zaktualizowany');
    }else{
      await aF('/schedules',{method:'POST',body:JSON.stringify(b)});
      toast('Termin dodany');
    }
    closeModal();
    loadSchedules();
  }catch(e){
    toast('B≈ÇƒÖd: '+e.message,'error');
  }
}

async function deleteSchedule(id){
  if(!confirm('UsunƒÖƒá ten termin z grafiku?')) return;
  try{
    await aF(`/resource?type=schedules&id=${id}`,{method:'DELETE'});
    toast('Termin usuniƒôty');
    loadSchedules();
  }catch(e){
    toast('B≈ÇƒÖd: '+e.message,'error');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CRUD: LOKALIZACJE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openLocationModal(id){
  let l = {};
  if(id){
    try{
      l = await aF(`/resource?type=locations&id=${id}`);
    }catch(e){
      toast('B≈ÇƒÖd: '+e.message,'error');
      return;
    }
  }

  const body = `
    <div class="fg">
      <div class="ff"><label>Miasto *</label><input id="l-city" value="${l.city||''}" placeholder="np. Wroc≈Çaw"></div>
      <div class="ff"><label>Nazwa *</label><input id="l-name" value="${l.name||''}" placeholder="np. Krav Maga Wroc≈Çaw"></div>
      <div class="ff full"><label>Adres</label><input id="l-addr" value="${l.address||''}" placeholder="np. ul. Przyk≈Çadowa 1, 50-000 Wroc≈Çaw"></div>
      <div class="ff"><label>Kolejno≈õƒá wy≈õwietlania</label><input id="l-sort" type="number" value="${l.sort_order??99}" placeholder="1, 2, 3..."></div>
      <div class="ff">
        <label>Aktywna</label>
        <select id="l-active">
          <option value="true" ${l.active!==false?'selected':''}>Tak</option>
          <option value="false" ${l.active===false?'selected':''}>Nie</option>
        </select>
      </div>
    </div>
  `;

  const footer = `
    <button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
    <button class="btn btn-primary" onclick="saveLocation(${id||'null'})">${id?'Zapisz zmiany':'Dodaj lokalizacjƒô'}</button>
  `;

  showModal(id ? `Edytuj lokalizacjƒô #${id}` : 'Nowa lokalizacja', body, footer);
}

async function saveLocation(id){
  const city = document.getElementById('l-city').value.trim();
  const name = document.getElementById('l-name').value.trim();
  
  if(!city || !name){
    toast('Uzupe≈Çnij: miasto i nazwa','error');
    return;
  }

  const b = {
    city,
    name,
    slug: city.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-'),
    address: document.getElementById('l-addr').value.trim()||null,
    sort_order: parseInt(document.getElementById('l-sort').value)||99,
    active: document.getElementById('l-active').value==='true'
  };

  try{
    if(id){
      await aF(`/resource?type=locations&id=${id}`,{method:'PATCH',body:JSON.stringify(b)});
      toast('Lokalizacja zaktualizowana');
    }else{
      await aF('/locations',{method:'POST',body:JSON.stringify(b)});
      toast('Lokalizacja dodana');
    }
    closeModal();
    loadLocations();
  }catch(e){
    toast('B≈ÇƒÖd: '+e.message,'error');
  }
}

async function deleteLocation(id){
  if(!confirm('UsunƒÖƒá tƒô lokalizacjƒô? ZostanƒÖ utracone powiƒÖzania z grupami!')) return;
  try{
    await aF(`/resource?type=locations&id=${id}`,{method:'DELETE'});
    toast('Lokalizacja usuniƒôta');
    loadLocations();
  }catch(e){
    toast('B≈ÇƒÖd: '+e.message,'error');
  }
}

// =========================================================================
// ================= NOWE FUNKCJE: HISTORIA, STUDENCI, INSTRUKTORZY ========
// =========================================================================


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BAZA UJEDNOLICONA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let US = { page:1, total:0, limit:60, overdue: false };
let usTimer;

function toggleOverdue() {
  US.overdue = !US.overdue;
  US.page = 1;
  const btn = document.getElementById('us-overdue-btn');
  const bar = document.getElementById('us-overdue-bar');
  if (btn) btn.style.background = US.overdue ? 'rgba(220,50,30,0.35)' : 'rgba(220,50,30,0.15)';
  if (bar) bar.style.display = US.overdue ? 'block' : 'none';
  fetchUS();
}

async function loadUnifiedStudents() {
  const c = document.getElementById('content');
  let groupOpts = '<option value="">Wszystkie grupy</option>';
  let cityOpts  = '<option value="">Wszystkie miasta</option>';
  try {
    const gd = arrRows(await aF('/groups'));
    const activeGd = gd.filter(g => g.active !== false);
    activeGd.forEach(g => { groupOpts += `<option value="${g.id}">${g.name}${g.city?' ('+g.city+')':''}</option>`; });
    const cities = [...new Set(activeGd.map(g=>g.city).filter(Boolean))];
    cities.forEach(c => { cityOpts += `<option value="${c}">${c}</option>`; });
  } catch(e) {}

  c.innerHTML = `
    <div class="sh">
      <h3>Baza kursant√≥w</h3>
      <button class="btn btn-primary btn-sm" onclick="openNewStudentModal()">+ Dodaj kursanta</button>
    </div>
    <div class="fb">
      <input id="us-q" type="text" placeholder="Szukaj: imiƒô, nazwisko, email, telefon‚Ä¶" oninput="usDebounce()">
      <select id="us-grp" onchange="US.page=1;fetchUS()">${groupOpts}</select>
      <select id="us-city" onchange="US.page=1;fetchUS()">${cityOpts}</select>
      <select id="us-pay" onchange="US.page=1;fetchUS()">
        <option value="">Ka≈ºdy status p≈Çatno≈õci</option>
        <option value="paid">Op≈Çacony</option>
        <option value="unpaid">Nieop≈Çacony</option>
        <option value="pending">Oczekuje</option>
      </select>
      <select id="us-season" onchange="US.page=1;fetchUS()">
        <option value="true" selected>Sezon 2025/2026</option>
        <option value="">Wszyscy kursanci</option>
      </select>
      <select id="us-active" onchange="US.page=1;fetchUS()">
        <option value="">Aktywni i nieaktywni</option>
        <option value="true">Tylko aktywni</option>
        <option value="false">Tylko nieaktywni</option>
      </select>
      <select id="us-sort" onchange="US.page=1;fetchUS()">
        <option value="recent">Ostatni trening ‚Üì</option>
        <option value="alpha">Nazwisko A‚ÄìZ</option>
        <option value="payment">Ostatnia wp≈Çata ‚Üì</option>
      </select>
      <button class="btn btn-secondary btn-sm" onclick="US.page=1;usClear()">‚úï Wyczy≈õƒá</button>
      <button id="us-overdue-btn" class="btn btn-sm" style="background:rgba(220,50,30,0.15);border:1px solid rgba(220,50,30,0.4);color:#ff6b5b" onclick="toggleOverdue()">‚ö†Ô∏è Zaleg≈Ço≈õci</button>
      <span id="us-count" style="color:var(--dim);font-size:12px"></span>
    </div>
    <div id="us-overdue-bar" style="display:none;background:rgba(220,50,30,0.1);border:1px solid rgba(220,50,30,0.3);border-radius:6px;padding:10px 14px;margin-bottom:12px;font-size:13px;color:var(--red-l)">
      ‚ö†Ô∏è <strong>Tryb: Zaleg≈Ço≈õci</strong> ‚Äî aktywni kursanci, kt√≥rzy byli na treningu w ostatnich 60 dniach, ale nie zap≈Çacili od ponad 35 dni (lub wcale).
    </div>
    <div class="tw"><table>
      <thead><tr>
        <th>Kursant</th><th>Kontakt</th><th>Grupy</th><th>≈πr√≥d≈Ço</th>
        <th>Treningi</th><th>Ostatni trening</th><th>Ostatnia wp≈Çata</th><th>Status p≈Çatno≈õci</th><th></th>
      </tr></thead>
      <tbody id="us-body">
        <tr><td colspan="9"><div class="loader"><div class="spinner"></div> ≈Åadowanie...</div></td></tr>
      </tbody>
    </table></div>
    <div class="pag" id="us-pag"></div>`;

  US.page = 1;
  await fetchUS();
}

function usDebounce() { clearTimeout(usTimer); usTimer = setTimeout(() => { US.page=1; fetchUS(); }, 380); }

function usClear() {
  ['us-q','us-grp','us-city','us-pay','us-active'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
  const seasonEl = document.getElementById('us-season'); if(seasonEl) seasonEl.value='true';
  fetchUS();
}

async function fetchUS() {
  const tbody = document.getElementById('us-body');
  if (!tbody) return;
  tbody.innerHTML = '<tr><td colspan="9"><div class="loader"><div class="spinner"></div></div></td></tr>';

  const p = new URLSearchParams({ page: US.page, limit: US.limit });
  const q    = document.getElementById('us-q')?.value;      if(q)    p.set('search', q);
  const grp  = document.getElementById('us-grp')?.value;    if(grp)  p.set('group_id', grp);
  const city = document.getElementById('us-city')?.value;   if(city) p.set('city', city);
  const pay  = document.getElementById('us-pay')?.value;    if(pay)  p.set('payment_status', pay);
  const act  = document.getElementById('us-active')?.value; if(act)  p.set('is_active', act);
  const sort   = document.getElementById('us-sort')?.value;   if(sort) p.set('sort', sort);
  const season = document.getElementById('us-season')?.value; if(season) p.set('season_only', season);
  if (US.overdue) p.set('overdue', 'true');

  try {
    const d = await aF('/students?' + p.toString());
    const rows = arrRows(d);
    US.total = d.total || rows.length;
    const countEl = document.getElementById('us-count');
    if (countEl) countEl.textContent = US.total + ' wynik√≥w' + (US.overdue ? ' z zaleg≈Ço≈õciami' : '');

    if (!rows.length) {
      tbody.innerHTML = '<tr><td colspan="9"><div class="empty"><strong>' + (US.overdue ? '‚úÖ Brak zaleg≈Ço≈õci!' : 'Brak wynik√≥w') + '</strong>' + (US.overdue ? 'Wszyscy aktywni kursanci majƒÖ aktualne p≈Çatno≈õci.' : 'Zmie≈Ñ filtry lub dodaj kursanta.') + '</div></td></tr>';
      document.getElementById('us-pag').innerHTML = '';
      return;
    }

    tbody.innerHTML = rows.map(r => {
      const srcBadge = r.source==='legacy' ? '<span class="badge bx">legacy</span>'
                     : r.source==='manual'  ? '<span class="badge bb">rƒôczny</span>'
                                            : '<span class="badge bg">www</span>';
      const groups = Array.isArray(r.groups) && r.groups.length
        ? r.groups.slice(0,2).map(g=>`<span class="badge bx" style="font-size:10px">${g.name}</span>`).join('')
          + (r.groups.length>2 ? `<span style="font-size:10px;color:var(--dim)"> +${r.groups.length-2}</span>` : '')
        : '‚Äî';
      const payBadge = r.payment_status ? pb(r.payment_status)
        : (r.legacy_paid > 0 ? `<span class="badge bg">${Number(r.legacy_paid).toFixed(0)} z≈Ç</span>` : '<span class="badge br">brak</span>');

      // Ostatnia wp≈Çata z kolorowaniem
      let lastPayHtml = '‚Äî';
      if (r.last_payment_date) {
        const days = r.days_since_payment;
        const color = days > 60 ? 'var(--red-l)' : days > 35 ? '#f0a500' : 'var(--green)';
        const icon = days > 60 ? 'üî¥' : days > 35 ? 'üü°' : 'üü¢';
        lastPayHtml = `<span style="font-family:monospace;font-size:11px;color:${color}">${icon} ${fd(r.last_payment_date)}</span><br><span style="font-size:10px;color:var(--dim)">${days} dni temu</span>`;
      } else if (r.legacy_paid == 0 && !r.payment_status) {
        lastPayHtml = '<span style="color:var(--red-l);font-size:11px">üî¥ nigdy</span>';
      }

      const inactive = !r.is_active ? ' <span class="badge br">Nieaktywny</span>' : '';
      // Wyr√≥≈ºnienie wiersza zaleg≈Ço≈õci
      const rowStyle = US.overdue ? 'background:rgba(220,50,30,0.05)' : '';

      return `<tr style="${rowStyle}">
        <td>
          <strong style="color:var(--bright)">${r.first_name} ${r.last_name}</strong>${inactive}
          <br><span style="color:var(--dim);font-size:11px">${r.email||'brak email'}</span>
        </td>
        <td style="color:var(--dim);font-size:12px">${r.phone||'‚Äî'}</td>
        <td>${groups}</td>
        <td>${srcBadge}</td>
        <td>${r.total_present||0}<br><span style="font-size:10px;color:var(--dim)">${r.present_60d||0} / 60 dni</span></td>
        <td style="font-size:12px;color:var(--dim)">${r.last_training ? fd(r.last_training) : '‚Äî'}</td>
        <td>${lastPayHtml}</td>
        <td>${payBadge}</td>
        <td>
          <div class="tda">
            <button class="bi" onclick="openStudentKartoteka(${r.id})">Kartoteka</button>
            <button class="bi del" onclick="confirmDeleteStudent(${r.id},'${(r.first_name+' '+r.last_name).replace(/'/g,"\\'")}')">Usu≈Ñ</button>
          </div>
        </td>
      </tr>`;
    }).join('');

    // Paginacja
    const pages = Math.ceil(US.total / US.limit);
    const pagEl = document.getElementById('us-pag');
    if (pages > 1) {
      pagEl.innerHTML = `
        <button ${US.page<=1?'disabled':''} onclick="US.page--;fetchUS()">Wstecz</button>
        <span class="pi">Strona ${US.page} z ${pages} (${US.total} wynik√≥w)</span>
        <button ${US.page>=pages?'disabled':''} onclick="US.page++;fetchUS()">Dalej</button>`;
    } else {
      pagEl.innerHTML = '';
    }
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="9" style="color:var(--red-l);padding:16px">${e.message}</td></tr>`;
  }
}

// ‚îÄ‚îÄ Kartoteka kursanta (legacy/ujednolicona) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openStudentKartoteka(id) {
  let s, payments, attendance;
  try {
    [s, payments, attendance] = await Promise.all([
      aF(`/students/${id}`),
      aF(`/students/${id}/payments`),
      aF(`/students/${id}/attendance`),
    ]);
  } catch(e) { toast('B≈ÇƒÖd pobierania danych: ' + e.message, 'error'); return; }

  const legacy  = payments.legacy || [];
  const regs    = payments.registrations || [];
  const attRows = attendance.rows || [];
  const present = attRows.filter(a => a.present).length;
  const pct     = attRows.length ? Math.round(present / attRows.length * 100) : 0;

  const body = `
    <div class="kart-header">
      <div class="kart-avatar">${initials(s.first_name, s.last_name)}</div>
      <div>
        <div class="kart-name">${s.first_name||''} ${s.last_name||''}</div>
        <div class="kart-meta">${s.email||'brak email'} ¬∑ ${s.phone||'brak tel.'}</div>
        <div class="kart-badges">
          ${s.is_active ? '<span class="badge bg">Aktywny</span>' : '<span class="badge br">Nieaktywny</span>'}
          ${s.source==='legacy'?'<span class="badge bx">Legacy</span>':s.source==='manual'?'<span class="badge bb">Rƒôczny</span>':'<span class="badge bg">WWW</span>'}
          ${(s.groups||[]).map(g=>`<span class="badge bx">${g.name}</span>`).join('')}
        </div>
      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">Statystyki</div>
      <div class="stats-grid" style="margin-bottom:0;grid-template-columns:repeat(4,1fr)">
        <div class="sc green"><div class="label">Treningi</div><div class="value">${s.total_present||0}</div></div>
        <div class="sc"><div class="label">Frekwencja</div><div class="value">${pct}%</div></div>
        <div class="sc ${s.total_legacy_paid>0?'green':''}"><div class="label">Wp≈Çacono</div><div class="value" style="font-size:24px">${s.total_legacy_paid?Number(s.total_legacy_paid).toFixed(0)+' z≈Ç':'‚Äî'}</div></div>
        <div class="sc"><div class="label">Ostatni trening</div><div class="value" style="font-size:16px;padding-top:4px">${s.last_training?fd(s.last_training):'‚Äî'}</div></div>
      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title" style="display:flex;align-items:center;justify-content:space-between">
        Dane kursanta
        <button class="bi btn-sm" onclick="saveStudentData(${id})">Zapisz zmiany</button>
      </div>
      <div class="fg">
        <div class="ff"><label>Imiƒô</label><input id="sk-fn" value="${s.first_name||''}"></div>
        <div class="ff"><label>Nazwisko</label><input id="sk-ln" value="${s.last_name||''}"></div>
        <div class="ff"><label>Email</label><input id="sk-em" type="email" value="${s.email||''}"></div>
        <div class="ff"><label>Telefon</label><input id="sk-ph" value="${s.phone||''}"></div>
        <div class="ff"><label>Rok urodzenia</label><input id="sk-by" type="number" value="${s.birth_year||''}"></div>
        <div class="ff"><label>Status</label>
          <select id="sk-ac">
            <option value="true" ${s.is_active?'selected':''}>Aktywny</option>
            <option value="false" ${!s.is_active?'selected':''}>Nieaktywny</option>
          </select>
        </div>
      </div>
    </div>

    ${s.registration ? `
    <div class="ksec">
      <div class="ksec-title">Zapis z systemu (WWW)</div>
      <div class="fg">
        <div class="ff"><label>Grupa</label><div class="view-val">${s.registration.group_name||'‚Äî'}</div></div>
        <div class="ff"><label>Karnet</label><div class="view-val">${s.registration.plan_name||'‚Äî'}</div></div>
        <div class="ff"><label>Kwota</label><div class="view-val">${s.registration.total_amount||0} z≈Ç</div></div>
        <div class="ff"><label>Status p≈Çatno≈õci</label>
          <select onchange="changeStudentRegPay(${id},${s.registration.id},this.value)">
            <option value="paid"    ${s.registration.payment_status==='paid'?'selected':''}>Op≈Çacony</option>
            <option value="unpaid"  ${s.registration.payment_status==='unpaid'?'selected':''}>Nieop≈Çacony</option>
            <option value="pending" ${s.registration.payment_status==='pending'?'selected':''}>Oczekuje</option>
            <option value="waived"  ${s.registration.payment_status==='waived'?'selected':''}>Zwolniony</option>
          </select>
        </div>
      </div>
    </div>` : ''}

    <div class="ksec">
      <div class="ksec-title" style="display:flex;align-items:center;justify-content:space-between">
        P≈Çatno≈õci rƒôczne
        <button class="bi btn-sm" onclick="openAddPayModal(${id})">+ Dodaj p≈Çatno≈õƒá</button>
      </div>
      ${legacy.length ? `
        <table width="100%" style="border-collapse:collapse;font-size:12px">
          <thead><tr>
            <th style="text-align:left;padding:6px 8px;color:var(--dim);font-size:10px;text-transform:uppercase;letter-spacing:.08em;border-bottom:1px solid var(--border)">Data</th>
            <th style="text-align:left;padding:6px 8px;color:var(--dim);font-size:10px;text-transform:uppercase;letter-spacing:.08em;border-bottom:1px solid var(--border)">Kwota</th>
            <th style="text-align:left;padding:6px 8px;color:var(--dim);font-size:10px;text-transform:uppercase;letter-spacing:.08em;border-bottom:1px solid var(--border)">Notatka</th>
            <th style="border-bottom:1px solid var(--border)"></th>
          </tr></thead>
          <tbody>${legacy.map(p => `
            <tr style="border-top:1px solid var(--border)">
              <td style="padding:7px 8px;color:var(--dim)">${p.date ? fd(p.date) : '‚Äî'}</td>
              <td style="padding:7px 8px"><strong style="color:var(--bright)">${p.amount} z≈Ç</strong></td>
              <td style="padding:7px 8px;color:var(--dim)">${p.note||'‚Äî'}</td>
              <td style="padding:7px 8px">
                <div class="tda">
                  <button class="bi btn-sm" onclick="openEditPayModal(${id},${p.id},${p.amount},'${p.date?String(p.date).slice(0,10):''}','${(p.note||'').replace(/'/g,"\\'")}')">‚úè</button>
                  <button class="bi del btn-sm" onclick="deleteStudentPayment(${id},${p.id})">‚úï</button>
                </div>
              </td>
            </tr>`).join('')}
          </tbody>
        </table>` : '<p style="color:var(--dim);font-size:12px;padding:8px 0">Brak p≈Çatno≈õci rƒôcznych.</p>'}
      ${regs.length ? `
        <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:10px">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);margin-bottom:8px">Z systemu rejestracji:</div>
          ${regs.map(p => `
            <div style="display:flex;gap:12px;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px;align-items:center">
              <span style="color:var(--dim)">${p.date?fd(p.date):'‚Äî'}</span>
              <strong style="color:var(--bright)">${p.amount} z≈Ç</strong>
              <span style="color:var(--dim)">${p.plan_name||'‚Äî'}</span>
              ${pb(p.status)}
            </div>`).join('')}
        </div>` : ''}
    </div>

    <div class="ksec">
      <div class="ksec-title">Obecno≈õci (ostatnie 100)</div>
      ${attRows.length ? `
        <div style="display:flex;gap:20px;padding:10px;background:var(--surface2);border-radius:6px;margin-bottom:12px">
          <span><strong style="color:var(--green)">${present}</strong> <span style="color:var(--dim);font-size:11px">obecny</span></span>
          <span><strong style="color:var(--red-l)">${attRows.length-present}</strong> <span style="color:var(--dim);font-size:11px">nieobecny</span></span>
          <span><strong>${pct}%</strong> <span style="color:var(--dim);font-size:11px">frekwencja</span></span>
        </div>
        <div style="max-height:220px;overflow-y:auto">
          ${attRows.map(a => `
            <div style="display:flex;align-items:center;gap:10px;padding:5px 0;border-bottom:1px solid var(--border);font-size:12px">
              <span style="width:9px;height:9px;border-radius:50%;flex-shrink:0;display:inline-block;background:${a.present?'var(--green)':'var(--border2)'}"></span>
              <span style="font-family:monospace;color:var(--dim);min-width:85px">${fd(a.session_date)}</span>
              <span style="flex:1;color:var(--dim)">${a.group_name||'‚Äî'}</span>
              <span style="color:${a.present?'var(--green)':'var(--muted)'}">${a.present?'Obecny':'Nieobecny'}</span>
              <button class="bi btn-sm" title="Zmie≈Ñ" onclick="toggleStudentAtt(${id},${a.id},${!a.present})">${a.present?'‚úó':'‚úì'}</button>
            </div>`).join('')}
        </div>` : '<p style="color:var(--dim);font-size:12px;padding:8px 0">Brak danych obecno≈õci.</p>'}
    </div>`;

  showModal(`Kartoteka kursanta #${id}`, body,
    `<button class="btn btn-secondary" onclick="closeModal()">Zamknij</button>
     <button class="btn btn-primary" style="background:var(--red);border-color:var(--red)" onclick="confirmDeleteStudent(${id},'${(s.first_name+' '+s.last_name).replace(/'/g,"\\'")}')">Usu≈Ñ kursanta</button>`);
}

async function saveStudentData(id) {
  const data = {
    first_name: document.getElementById('sk-fn')?.value?.trim(),
    last_name:  document.getElementById('sk-ln')?.value?.trim(),
    email:      document.getElementById('sk-em')?.value?.trim() || null,
    phone:      document.getElementById('sk-ph')?.value?.trim() || null,
    birth_year: parseInt(document.getElementById('sk-by')?.value) || null,
    is_active:  document.getElementById('sk-ac')?.value === 'true',
  };
  try {
    await aF(`/students/${id}`, { method:'PATCH', body: JSON.stringify(data) });
    toast('Dane kursanta zapisane');
    if (CV === 'unified-students') fetchUS();
  } catch(e) { toast('B≈ÇƒÖd: ' + e.message, 'error'); }
}

async function changeStudentRegPay(studentId, regId, status) {
  try {
    await aF(`/students/${studentId}/reg-payment`, { method:'PATCH', body: JSON.stringify({ registration_id: regId, payment_status: status }) });
    toast('Status p≈Çatno≈õci zaktualizowany');
    if (CV === 'unified-students') fetchUS();
  } catch(e) { toast('B≈ÇƒÖd: ' + e.message, 'error'); }
}

async function toggleStudentAtt(studentId, attId, present) {
  try {
    await aF(`/students/${studentId}/attendance/${attId}`, { method:'PATCH', body: JSON.stringify({ present }) });
    toast('Obecno≈õƒá zmieniona');
    openStudentKartoteka(studentId);
  } catch(e) { toast('B≈ÇƒÖd: ' + e.message, 'error'); }
}

function confirmDeleteStudent(id, name) {
  if (!confirm(`UsunƒÖƒá kursanta "${name}"?\nJe≈õli ma historiƒô trening√≥w lub p≈Çatno≈õci ‚Äî zostanie zdezaktywowany (nie usuniƒôty).`)) return;
  deleteStudent(id);
}

async function deleteStudent(id) {
  try {
    const d = await aF(`/students/${id}`, { method:'DELETE' });
    toast(d.soft ? 'Kursant zdezaktywowany (ma historiƒô)' : 'Kursant usuniƒôty');
    closeModal();
    if (CV === 'unified-students') fetchUS();
  } catch(e) { toast('B≈ÇƒÖd: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ Nowy kursant ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openNewStudentModal() {
  let groupOpts = '<option value="">Brak grupy</option>';
  try {
    const gd = arrRows(await aF('/groups'));
    gd.forEach(g => { groupOpts += `<option value="${g.id}">${g.name}${g.city?' ('+g.city+')':''}</option>`; });
  } catch(e) {}

  showModal('Nowy kursant', `
    <div class="fg">
      <div class="ff"><label>Imiƒô *</label><input id="ns-fn" placeholder="Jan"></div>
      <div class="ff"><label>Nazwisko *</label><input id="ns-ln" placeholder="Kowalski"></div>
    </div>
    <div class="fg">
      <div class="ff"><label>Email</label><input id="ns-em" type="email" placeholder="jan@email.pl"></div>
      <div class="ff"><label>Telefon</label><input id="ns-ph" placeholder="600 000 000"></div>
    </div>
    <div class="fg">
      <div class="ff"><label>Rok urodzenia</label><input id="ns-by" type="number" placeholder="1990" min="1950" max="2015"></div>
      <div class="ff"><label>Przypisz do grupy</label><select id="ns-gr">${groupOpts}</select></div>
    </div>
    <div id="ns-err" style="color:var(--red-l);font-size:12px;margin-top:8px;display:none"></div>`,
    `<button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
     <button class="btn btn-primary" onclick="createNewStudent()">Dodaj kursanta</button>`);
}

async function createNewStudent() {
  const fn = document.getElementById('ns-fn')?.value?.trim();
  const ln = document.getElementById('ns-ln')?.value?.trim();
  const errEl = document.getElementById('ns-err');
  if (!fn || !ln) { errEl.textContent='Imiƒô i nazwisko sƒÖ wymagane.'; errEl.style.display='block'; return; }
  try {
    await aF('/students', { method:'POST', body: JSON.stringify({
      first_name: fn, last_name: ln,
      email:      document.getElementById('ns-em')?.value?.trim() || null,
      phone:      document.getElementById('ns-ph')?.value?.trim() || null,
      birth_year: parseInt(document.getElementById('ns-by')?.value) || null,
      group_id:   document.getElementById('ns-gr')?.value ? parseInt(document.getElementById('ns-gr').value) : null,
    })});
    toast('Kursant dodany');
    closeModal();
    fetchUS();
  } catch(e) { errEl.textContent = e.message; errEl.style.display='block'; }
}

// ‚îÄ‚îÄ P≈Çatno≈õci ‚Äî modale ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _payStudentId = null, _payId = null;

function openAddPayModal(studentId) {
  _payStudentId = studentId; _payId = null;
  showModal('Nowa p≈Çatno≈õƒá', `
    <div class="fg">
      <div class="ff"><label>Kwota (z≈Ç) *</label><input id="pm-amt" type="number" step="0.01" placeholder="120.00"></div>
      <div class="ff"><label>Data</label><input id="pm-dt" type="date" value="${new Date().toISOString().slice(0,10)}"></div>
    </div>
    <div class="ff"><label>Notatka</label><input id="pm-note" placeholder="np. przelew, got√≥wka‚Ä¶"></div>
    <div id="pm-err" style="color:var(--red-l);font-size:12px;margin-top:8px;display:none"></div>`,
    `<button class="btn btn-secondary" onclick="openStudentKartoteka(${studentId})">Anuluj</button>
     <button class="btn btn-primary" onclick="submitStudentPayment()">Zapisz p≈Çatno≈õƒá</button>`);
}

function openEditPayModal(studentId, pid, amount, date, note) {
  _payStudentId = studentId; _payId = pid;
  showModal('Edytuj p≈Çatno≈õƒá', `
    <div class="fg">
      <div class="ff"><label>Kwota (z≈Ç) *</label><input id="pm-amt" type="number" step="0.01" value="${amount}"></div>
      <div class="ff"><label>Data</label><input id="pm-dt" type="date" value="${date}"></div>
    </div>
    <div class="ff"><label>Notatka</label><input id="pm-note" value="${note}"></div>
    <div id="pm-err" style="color:var(--red-l);font-size:12px;margin-top:8px;display:none"></div>`,
    `<button class="btn btn-secondary" onclick="openStudentKartoteka(${studentId})">Anuluj</button>
     <button class="btn btn-primary" onclick="submitStudentPayment()">Zapisz zmiany</button>`);
}

async function submitStudentPayment() {
  const amount = parseFloat(document.getElementById('pm-amt')?.value);
  const date   = document.getElementById('pm-dt')?.value;
  const note   = document.getElementById('pm-note')?.value || null;
  const errEl  = document.getElementById('pm-err');
  if (!amount) { errEl.textContent='Podaj kwotƒô.'; errEl.style.display='block'; return; }
  try {
    if (_payId) {
      await aF(`/students/${_payStudentId}/payments/${_payId}`, { method:'PATCH', body: JSON.stringify({ amount, paid_at: date, note }) });
    } else {
      await aF(`/students/${_payStudentId}/payments`, { method:'POST', body: JSON.stringify({ amount, date, note }) });
    }
    toast('P≈Çatno≈õƒá zapisana');
    openStudentKartoteka(_payStudentId);
    if (CV === 'unified-students') fetchUS();
  } catch(e) { errEl.textContent = e.message; errEl.style.display='block'; }
}

async function deleteStudentPayment(studentId, pid) {
  if (!confirm('UsunƒÖƒá tƒô p≈Çatno≈õƒá?')) return;
  try {
    await aF(`/students/${studentId}/payments/${pid}`, { method:'DELETE' });
    toast('P≈Çatno≈õƒá usuniƒôta');
    openStudentKartoteka(studentId);
    if (CV === 'unified-students') fetchUS();
  } catch(e) { toast('B≈ÇƒÖd: ' + e.message, 'error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORIA (ARCHIWUM)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let histTab = 'stats', hsPage = 1, hsTimer;

async function loadHistory() {
  const c = document.getElementById('content');
  c.innerHTML = `
    <div class="sh"><h3>Historia ‚Äî Archiwum CSV</h3></div>
    <div style="display:flex;gap:4px;margin-bottom:20px">
      <button class="bi" id="ht-stats"    onclick="switchHistTab('stats')">Statystyki</button>
      <button class="bi" id="ht-students" onclick="switchHistTab('students')">Kursanci legacy</button>
      <button class="bi" id="ht-payments" onclick="switchHistTab('payments')">P≈Çatno≈õci legacy</button>
    </div>
    <div id="hist-content"></div>`;

  // Dodaj styl aktywnej zak≈Çadki je≈õli nie ma
  if (!document.getElementById('_ht_style')) {
    const s = document.createElement('style');
    s.id = '_ht_style';
    s.textContent = '.bi.ht-active{background:var(--red-bg);border-color:var(--red-bdr);color:var(--red-l)!important}';
    document.head.appendChild(s);
  }
  switchHistTab(histTab);
}

function switchHistTab(tab) {
  histTab = tab;
  ['stats','students','payments'].forEach(t => {
    document.getElementById('ht-'+t)?.classList.toggle('ht-active', t === tab);
  });
  fetchHistTab(tab);
}

async function fetchHistTab(tab) {
  const el = document.getElementById('hist-content');
  if (!el) return;
  el.innerHTML = '<div class="loader"><div class="spinner"></div></div>';

  try {
    if (tab === 'stats') {
      const d = await aF('/history?tab=stats');
      const sum = d.summary || {};
      el.innerHTML = `
        <div class="stats-grid">
          <div class="sc accent"><div class="label">Kursanci legacy</div><div class="value">${sum.legacy_students||0}</div></div>
          <div class="sc orange"><div class="label">Sesje treningowe</div><div class="value">${sum.total_sessions||0}</div></div>
          <div class="sc green"><div class="label">Obecno≈õci</div><div class="value">${sum.total_present||0}</div></div>
          <div class="sc"><div class="label">Wp≈Çaty (szt.)</div><div class="value">${sum.total_payments||0}</div></div>
          <div class="sc green"><div class="label">Przych√≥d legacy</div><div class="value" style="font-size:28px">${sum.total_revenue?Number(sum.total_revenue).toFixed(0)+' z≈Ç':'‚Äî'}</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div>
            <div class="sh"><h3>Przychody wg lat</h3></div>
            <div class="tw"><table>
              <thead><tr><th>Rok</th><th>P≈Çatno≈õci</th><th>Kwota</th></tr></thead>
              <tbody>${(d.byYear||[]).map(y=>`
                <tr><td>${y.year}</td><td>${y.payments}</td><td><strong>${Number(y.revenue).toFixed(0)} z≈Ç</strong></td></tr>
              `).join('')}</tbody>
            </table></div>
          </div>
          <div>
            <div class="sh"><h3>Top 10 ‚Äî frekwencja</h3></div>
            <div class="tw"><table>
              <thead><tr><th>Kursant</th><th>Treningi</th></tr></thead>
              <tbody>${(d.topStudents||[]).map((s,i)=>`
                <tr><td>${i+1}. <strong style="color:var(--bright)">${s.first_name} ${s.last_name}</strong></td><td>${s.trainings}</td></tr>
              `).join('')}</tbody>
            </table></div>
          </div>
        </div>`;
    }

    if (tab === 'students') {
      el.innerHTML = `
        <div class="fb" style="flex-wrap:wrap;gap:8px;margin-bottom:12px">
          <input id="hs-q" type="text" placeholder="Szukaj kursanta legacy‚Ä¶" oninput="hsDebounce()" style="flex:1;min-width:200px">
          <button class="btn btn-secondary btn-sm" onclick="fetchHistStudents()">Szukaj</button>
          <select id="hs-status" onchange="hsPage=1;fetchHistStudents()" style="background:var(--bg2);border:1px solid var(--bdr);color:var(--bright);padding:4px 8px;border-radius:4px;font-size:12px">
            <option value="">Wszyscy</option>
            <option value="active">Aktywni (trening &lt;60 dni)</option>
            <option value="no_payment">Brak wp≈Çat 60+ dni</option>
            <option value="never_paid">Nigdy nie p≈Çacili</option>
          </select>
          <span id="hs-count" style="color:var(--dim);font-size:12px;line-height:32px"></span>
        </div>
        <div class="tw"><table>
          <thead><tr>
            <th>Kursant</th>
            <th>Email / Tel</th>
            <th>Grupy</th>
            <th>Treningi</th>
            <th>Ostatni trening</th>
            <th>Ostatnia wp≈Çata</th>
            <th>Suma wp≈Çat</th>
            <th></th>
          </tr></thead>
          <tbody id="hs-body"><tr><td colspan="8"><div class="loader"><div class="spinner"></div></div></td></tr></tbody>
        </table></div>
        <div class="pag" id="hs-pag"></div>`;
      hsPage = 1;
      fetchHistStudents();
    }

    if (tab === 'payments') {
      const d = await aF('/history?tab=payments&limit=100');
      const rows = arrRows(d);
      el.innerHTML = `
        <div class="sh"><h3>P≈Çatno≈õci legacy (${d.total||rows.length})</h3></div>
        <div class="tw"><table>
          <thead><tr><th>Kursant</th><th>Data</th><th>Kwota</th><th>Notatka</th></tr></thead>
          <tbody>${rows.length ? rows.map(p=>`
            <tr>
              <td><strong style="color:var(--bright)">${p.first_name||'?'} ${p.last_name||''}</strong></td>
              <td style="font-family:monospace;font-size:12px;color:var(--dim)">${p.paid_at?fd(p.paid_at):'‚Äî'}</td>
              <td><strong>${p.amount||0} z≈Ç</strong></td>
              <td style="color:var(--dim)">${p.note||'‚Äî'}</td>
            </tr>`).join('') : '<tr><td colspan="4"><div class="empty">Brak danych ‚Äî uruchom migracjƒô CSV.</div></td></tr>'}
          </tbody>
        </table></div>`;
    }
  } catch(e) {
    el.innerHTML = `<div class="empty"><strong>B≈ÇƒÖd</strong>${e.message}<br><small>Upewnij siƒô ≈ºe migracja CSV zosta≈Ça uruchomiona.</small></div>`;
  }
}

function hsDebounce() { clearTimeout(hsTimer); hsTimer = setTimeout(fetchHistStudents, 380); }

async function fetchHistStudents() {
  const tbody = document.getElementById('hs-body');
  if (!tbody) return;
  tbody.innerHTML = '<tr><td colspan="8"><div class="loader"><div class="spinner"></div></div></td></tr>';
  const q = document.getElementById('hs-q')?.value || '';
  const statusFilter = document.getElementById('hs-status')?.value || '';
  try {
    const d = await aF(`/history?tab=students&search=${encodeURIComponent(q)}&page=${hsPage}&limit=60`);
    let rows = arrRows(d);
    const total = d.total || rows.length;

    // Filtrowanie po stronie klienta (status aktywno≈õci / p≈Çatno≈õci)
    const now = new Date();
    const MS60 = 60 * 24 * 60 * 60 * 1000;
    if (statusFilter === 'active') {
      rows = rows.filter(s => s.last_training && (now - new Date(s.last_training)) < MS60);
    } else if (statusFilter === 'no_payment') {
      rows = rows.filter(s => !s.last_payment || (now - new Date(s.last_payment)) > MS60);
    } else if (statusFilter === 'never_paid') {
      rows = rows.filter(s => !s.total_paid || Number(s.total_paid) === 0);
    }

    const countEl = document.getElementById('hs-count');
    if (countEl) countEl.textContent = (statusFilter ? rows.length + ' / ' : '') + total + ' kursant√≥w';

    function paymentBadge(s) {
      if (!s.last_payment && (!s.total_paid || Number(s.total_paid) === 0)) {
        return '<span class="badge br" title="Brak wp≈Çat w historii">brak wp≈Çat</span>';
      }
      if (!s.last_payment) return '<span style="color:var(--dim);font-size:11px">‚Äî</span>';
      const daysSince = Math.floor((now - new Date(s.last_payment)) / (24*60*60*1000));
      const dateStr = fd(s.last_payment);
      if (daysSince <= 45) {
        return `<span class="badge bg" title="${daysSince} dni temu">${dateStr}</span>`;
      } else if (daysSince <= 90) {
        return `<span class="badge bx" title="${daysSince} dni temu ‚Äî sprawd≈∫ p≈Çatno≈õƒá">${dateStr}</span>`;
      } else {
        return `<span class="badge br" title="${daysSince} dni temu ‚Äî mo≈ºliwa zaleg≈Ço≈õƒá">${dateStr} ‚ö†</span>`;
      }
    }

    function trainingBadge(s) {
      if (!s.last_training) return '<span style="color:var(--dim)">‚Äî</span>';
      const daysSince = Math.floor((now - new Date(s.last_training)) / (24*60*60*1000));
      const dateStr = fd(s.last_training);
      if (daysSince <= 30) return `<span style="color:var(--green);font-size:11px;font-family:monospace">${dateStr}</span>`;
      if (daysSince <= 60) return `<span style="color:var(--orange,#f80);font-size:11px;font-family:monospace">${dateStr}</span>`;
      return `<span style="color:var(--dim);font-size:11px;font-family:monospace">${dateStr}</span>`;
    }

    tbody.innerHTML = rows.length ? rows.map(s => {
      const grpArr = Array.isArray(s.groups) ? s.groups : [];
      // Deduplikacja - mo≈ºe byƒá duplikaty w json_agg
      const uniqGroups = grpArr.filter((g,i,a) => a.findIndex(x=>x.group_id===g.group_id)===i);
      const grpHtml = uniqGroups.length
        ? uniqGroups.slice(0,2).map(g=>`<span class="badge bb" style="font-size:10px;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:inline-block;vertical-align:middle">${g.group_name||'?'}</span>`).join(' ')
          + (uniqGroups.length>2 ? `<span style="font-size:10px;color:var(--dim)"> +${uniqGroups.length-2}</span>` : '')
        : '<span style="color:var(--dim)">‚Äî</span>';

      return `
      <tr>
        <td>
          <strong style="color:var(--bright)">${s.first_name} ${s.last_name}</strong>
          ${!s.is_active ? '<br><span class="badge br" style="font-size:9px">Nieaktywny</span>' : ''}
        </td>
        <td style="font-size:11px;color:var(--dim)">${s.email||'‚Äî'}${s.phone?'<br>'+s.phone:''}</td>
        <td style="max-width:180px">${grpHtml}</td>
        <td style="text-align:center;font-weight:bold">${s.total_attendances||0}</td>
        <td>${trainingBadge(s)}</td>
        <td>${paymentBadge(s)}</td>
        <td><strong style="color:${Number(s.total_paid)>0?'var(--green)':'var(--dim)'}">${s.total_paid?Number(s.total_paid).toFixed(0)+' z≈Ç':'‚Äî'}</strong></td>
        <td><button class="bi" onclick="openStudentKartoteka(${s.id})">Kartoteka</button></td>
      </tr>`;}).join('')
      : '<tr><td colspan="8"><div class="empty">Brak wynik√≥w</div></td></tr>';

    const pages = Math.ceil(total / 60);
    const pagEl = document.getElementById('hs-pag');
    if (pagEl) pagEl.innerHTML = pages > 1 ? `
      <button ${hsPage<=1?'disabled':''} onclick="hsPage--;fetchHistStudents()">Wstecz</button>
      <span class="pi">Strona ${hsPage} z ${pages}</span>
      <button ${hsPage>=pages?'disabled':''} onclick="hsPage++;fetchHistStudents()">Dalej</button>` : '';
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="8" style="color:var(--red-l);padding:16px">${e.message}</td></tr>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INSTRUKTORZY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadInstructors() {
  const c = document.getElementById('content');
  c.innerHTML = `
    <div class="sh">
      <h3>Konta instruktor√≥w</h3>
      <button class="btn btn-primary btn-sm" onclick="openNewInstructorModal()">+ Nowy instruktor</button>
    </div>
    <div id="inst-list"><div class="loader"><div class="spinner"></div></div></div>`;
  fetchInstructors();
}

async function fetchInstructors() {
  const el = document.getElementById('inst-list');
  if (!el) return;
  try {
    const d = await aF('/instructors');
    const rows = arrRows(d);
    if (!rows.length) {
      el.innerHTML = '<div class="empty"><strong>Brak instruktor√≥w</strong>Kliknij przycisk powy≈ºej, ≈ºeby dodaƒá pierwszego.</div>';
      return;
    }
    el.innerHTML = `<div class="tw"><table>
      <thead><tr><th>Instruktor</th><th>Login</th><th>Kontakt</th><th>Grupy</th><th>Status</th><th></th></tr></thead>
      <tbody>${rows.map(i => `
        <tr>
          <td><strong style="color:var(--bright)">${i.first_name} ${i.last_name}</strong></td>
          <td style="font-family:monospace;font-size:12px;color:var(--dim)">${i.username}</td>
          <td style="font-size:12px;color:var(--dim)">${i.email||'‚Äî'}${i.phone?'<br>'+i.phone:''}</td>
          <td>${Array.isArray(i.groups)&&i.groups.length ? i.groups.map(g=>`<span class="badge bb" style="font-size:10px">${g.name}</span>`).join('') : '‚Äî'}</td>
          <td>${i.active?'<span class="badge bg">Aktywny</span>':'<span class="badge br">Nieaktywny</span>'}</td>
          <td><div class="tda">
            <button class="bi" onclick="openInstructorModal(${i.id})">Edytuj</button>
            <button class="bi" onclick="toggleInstructor(${i.id},${!i.active})">${i.active?'Dezaktywuj':'Aktywuj'}</button>
          </div></td>
        </tr>`).join('')}
      </tbody>
    </table></div>`;
  } catch(e) {
    el.innerHTML = `<div class="empty"><strong>B≈ÇƒÖd</strong>${e.message}</div>`;
  }
}

async function openNewInstructorModal() {
  let allGroups = [];
  try { allGroups = arrRows(await aF('/groups')); } catch(e) {}

  showModal('Nowy instruktor', `
    <div class="fg">
      <div class="ff"><label>Imiƒô *</label><input id="ni-fn" placeholder="Anna"></div>
      <div class="ff"><label>Nazwisko *</label><input id="ni-ln" placeholder="Kowalska"></div>
    </div>
    <div class="fg">
      <div class="ff"><label>Login (username) *</label><input id="ni-un" placeholder="anna.kowalska"></div>
      <div class="ff"><label>Has≈Ço * (min. 8 znak√≥w)</label><input id="ni-pw" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
    </div>
    <div class="fg">
      <div class="ff"><label>Email</label><input id="ni-em" type="email"></div>
      <div class="ff"><label>Telefon</label><input id="ni-ph"></div>
    </div>
    <div class="ff"><label>Przypisz do grup</label>
      ${buildGroupCheckboxes(allGroups, [], 'ni')}
    </div>
    <div id="ni-err" style="color:var(--red-l);font-size:12px;margin-top:8px;display:none"></div>`,
    `<button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
     <button class="btn btn-primary" onclick="createInstructor()">Utw√≥rz konto</button>`);
}

async function createInstructor() {
  const fn = document.getElementById('ni-fn')?.value?.trim();
  const ln = document.getElementById('ni-ln')?.value?.trim();
  const un = document.getElementById('ni-un')?.value?.trim();
  const pw = document.getElementById('ni-pw')?.value;
  const errEl = document.getElementById('ni-err');
  if (!fn||!ln||!un||!pw) { errEl.textContent='Imiƒô, nazwisko, login i has≈Ço sƒÖ wymagane.'; errEl.style.display='block'; return; }
  if (pw.length < 8) { errEl.textContent='Has≈Ço musi mieƒá co najmniej 8 znak√≥w.'; errEl.style.display='block'; return; }
  const groupIds = getCheckedGroupIds('ni');
  try {
    await aF('/instructors', { method:'POST', body: JSON.stringify({
      first_name: fn, last_name: ln, username: un, password: pw,
      email: document.getElementById('ni-em')?.value?.trim()||null,
      phone: document.getElementById('ni-ph')?.value?.trim()||null,
      group_ids: groupIds,
    })});
    toast('Konto instruktora utworzone');
    closeModal();
    fetchInstructors();
  } catch(e) { errEl.textContent = e.message; errEl.style.display='block'; }
}

async function openInstructorModal(id) {
  let inst, allGroups = [];
  try {
    const [instData, gd] = await Promise.all([aF(`/instructors/${id}`), aF('/groups')]);
    inst = instData;
    allGroups = arrRows(gd);
  } catch(e) { toast('B≈ÇƒÖd: '+e.message,'error'); return; }

  const instGroupIds = (inst.groups||[]).map(g=>g.id);

  showModal(`Edytuj: ${inst.first_name} ${inst.last_name}`, `
    <div class="fg">
      <div class="ff"><label>Imiƒô</label><input id="ei-fn" value="${inst.first_name||''}"></div>
      <div class="ff"><label>Nazwisko</label><input id="ei-ln" value="${inst.last_name||''}"></div>
    </div>
    <div class="fg">
      <div class="ff"><label>Email</label><input id="ei-em" type="email" value="${inst.email||''}"></div>
      <div class="ff"><label>Telefon</label><input id="ei-ph" value="${inst.phone||''}"></div>
    </div>
    <div class="fg">
      <div class="ff"><label>Nowe has≈Ço (puste = bez zmian)</label><input id="ei-pw" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <div class="ff"><label>Status</label>
        <select id="ei-ac">
          <option value="true" ${inst.active?'selected':''}>Aktywny</option>
          <option value="false" ${!inst.active?'selected':''}>Nieaktywny</option>
        </select>
      </div>
    </div>
    <div class="ff"><label>Przypisane grupy</label>
      ${buildGroupCheckboxes(allGroups, instGroupIds, 'ei')}
    </div>
    <div id="ei-err" style="color:var(--red-l);font-size:12px;margin-top:8px;display:none"></div>`,
    `<button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
     <button class="btn btn-primary" onclick="saveInstructor(${id})">Zapisz zmiany</button>`);
}

async function saveInstructor(id) {
  const errEl = document.getElementById('ei-err');
  const pw = document.getElementById('ei-pw')?.value;
  if (pw && pw.length < 8) { errEl.textContent='Has≈Ço musi mieƒá co najmniej 8 znak√≥w.'; errEl.style.display='block'; return; }
  const data = {
    first_name: document.getElementById('ei-fn')?.value?.trim(),
    last_name:  document.getElementById('ei-ln')?.value?.trim(),
    email:      document.getElementById('ei-em')?.value?.trim()||null,
    phone:      document.getElementById('ei-ph')?.value?.trim()||null,
    active:     document.getElementById('ei-ac')?.value==='true',
    group_ids:  getCheckedGroupIds('ei'),
  };
  if (pw) data.password = pw;
  try {
    await aF(`/instructors/${id}`, { method:'PATCH', body: JSON.stringify(data) });
    toast('Dane instruktora zapisane');
    closeModal();
    fetchInstructors();
  } catch(e) { errEl.textContent = e.message; errEl.style.display='block'; }
}

async function toggleInstructor(id, active) {
  try {
    await aF(`/instructors/${id}`, { method:'PATCH', body: JSON.stringify({ active }) });
    toast(active ? 'Instruktor aktywowany' : 'Instruktor dezaktywowany');
    fetchInstructors();
  } catch(e) { toast('B≈ÇƒÖd: '+e.message,'error'); }
}

checkLogin();

function buildGroupCheckboxes(groups, selectedIds, prefix) {
  const sel = new Set((selectedIds||[]).map(Number));
  // group by city
  const byCityOrder = [];
  const cityMap = {};
  groups.forEach(g => {
    const city = g.city || g.location_city || '';
    if (!cityMap[city]) { cityMap[city] = []; byCityOrder.push(city); }
    cityMap[city].push(g);
  });
  let html = '<div class="grp-chk-list" id="' + prefix + '-grp-list">';
  byCityOrder.forEach(city => {
    cityMap[city].forEach(g => {
      const chk = sel.has(g.id) ? 'checked' : '';
      html += `<label class="grp-chk-item">
        <input type="checkbox" value="${g.id}" ${chk}>
        <span>${g.name||''}</span>
        ${city ? `<span class="grp-chk-city">${city}</span>` : ''}
      </label>`;
    });
  });
  html += '</div>';
  return html;
}

function getCheckedGroupIds(prefix) {
  const list = document.getElementById(prefix + '-grp-list');
  if (!list) return [];
  return [...list.querySelectorAll('input[type=checkbox]:checked')].map(i => parseInt(i.value));
}

// ‚îÄ‚îÄ MOBILE: bottom nav sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchBotNav(view) {
  navigate(view);
  syncBotNav(view);
}
function syncBotNav(view) {
  document.querySelectorAll('#bot-nav-admin .bna[data-view]').forEach(b => {
    b.classList.toggle('active', b.dataset.view === view);
  });
}

// Patch navigate to also sync bottom nav
const _origNavigate = navigate;
window.navigate = function(view) {
  _origNavigate(view);
  syncBotNav(view);
};

// ‚îÄ‚îÄ MOBILE: auto data-label on tables ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Adds data-label attrs to td elements based on column headers
// Called after any table is rendered into #content
function applyTableLabels(root) {
  root = root || document.getElementById('content');
  if (!root) return;
  root.querySelectorAll('.tw table').forEach(table => {
    const ths = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
    table.querySelectorAll('tbody tr').forEach(tr => {
      Array.from(tr.querySelectorAll('td')).forEach((td, i) => {
        if (ths[i]) td.setAttribute('data-label', ths[i]);
      });
    });
  });
}

// Observe #content for DOM changes and apply labels automatically
(function() {
  const content = document.getElementById('content');
  if (!content) return;
  const obs = new MutationObserver(() => applyTableLabels(content));
  obs.observe(content, { childList: true, subtree: true });
})();

</script>
</body>
</html>