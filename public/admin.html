



Powiedzia≈Çe≈õ(-a≈õ):
1) Cel projektu i zakres
Co budujemy

Serwis ‚ÄûSaggita ‚Äì Krav Maga‚Äù na Vercelu, kt√≥ry ma dwa krytyczne obszary:

Strona zapisu (zapisz-sie.html)

≈Çaduje terminy, grupy, lokalizacje i ceny z API,

pozwala zapisaƒá osobƒô do wybranej grupy/terminu,

obs≈Çuguje logikƒô listy rezerwowej (capacity / ‚ÄúzamkniƒôtpastedPr√≥buje od wielu godzin zrobiƒá aplikacjƒô dla Akademii Krav Maga z grafikiem, i panelem admina bƒôdƒÖcym przy okazji CRM akademii. 
≈öcie≈ºka klienta: wybiera na jaki termin chce siƒô zapisaƒá->otwiera siƒô formularz zapisu : dane osobowe podstawowe, dane kontaktowe, jaka grupa, potwierdzenie lokalizacji, czy jest pierwszy raz czy kontynuuje treningi, ile ma lat. Potem otwiera siƒô wyb√≥r karnet√≥w (lub jednorazowe wej≈õcie) klient wybiera, pojawia siƒô potwierdzenie przyjƒôcia rejestracji i pod spodem przycisk kierujƒÖcy na p≈Çatno≈õƒá online oraz przycisk do pobrania dokumengtu p≈Çatniczego, kt√≥ry musi zostaƒá wygenerowany oraz informacja ≈ºe ma 3 dni roboicze na op≈Çate bo potem przepada rezerwacja. Potwierdzenia idƒÖ na maila klienta tresc zale≈ºna od wybranej drogi. do CRM wpada kartoteka. 
 Dp tego przesy≈Çam Ci informacje o projekcie, przebiegu prac i aktualnej sytuacji. B≈Çagam pom√≥≈º zr√≥bmy to razem porzƒÖdnie i szybko:20:06Rozumiem ‚Äî wiele godzin pracy i projekt nadal nie dzia≈Ça. Zr√≥bmy to porzƒÖdnie, krok po kroku.
Zanim zacznƒô pisaƒá jakikolwiek kod, muszƒô zobaczyƒá co masz teraz w projekcie. Poka≈º mi strukturƒô plik√≥w.Checking uploaded filesChecking uploaded filesScriptDoneNie przes≈Ça≈Ça≈õ ≈ºadnych plik√≥w ‚Äî tylko dokument opisowy. To dobry punkt startowy, ale ≈ºebym mog≈Ça zaproponowaƒá precyzyjne rozwiƒÖzanie zamiast pisaƒá w ciemno, potrzebujƒô kilku rzeczy.
Odpowiedz na te pytania ‚Äî bƒôdzie nam du≈ºo szybciej:Czekam na Twoje odpowiedzi ‚Äî im wiƒôcej mi poka≈ºesz, tym szybciej i celniej pomogƒô. Najlepiej gdyby≈õ wrzuci≈Ça ZIP ca≈Çego projektu ‚Äî wtedy zobaczƒô dok≈Çadnie co masz i napiszƒô gotowe poprawki bez zgadywania.20:11Widzƒô strukturƒô ‚Äî teraz wszystko jest jasne. Masz:
api/
  _lib/ (db.js, mail.js, mailer.js)
  admin-api/
    groups/[id]/(members.js, [id].js)
    locations/[id].js
    registrations/[id].js
    schedules/([id].js, [...path].js)
    registration/action.js
  status/([ref].js, [...route].js)
Widzƒô kilka krytycznych problem√≥w od razu:

Brakuje kluczowych endpoint√≥w publicznych: schedule.js, prices.js, register.js
[...route].js jest w folderze status/ zamiast w g≈Ç√≥wnym api/
admin-api nie ma pliku login.js, stats.js, groups/index.js itd.

Zanim napiszƒô kod ‚Äî potrzebujƒô zobaczyƒá zawarto≈õƒá obecnych plik√≥w. Czy mo≈ºesz wkleiƒá (lub wrzuciƒá ZIP) zawarto≈õƒá:

api/_lib/db.js
api/status/[...route].js
api/admin-api/schedules/[...path].js
public/zapisz-sie.html (lub przynajmniej fragment z fetch calls)
public/admin.html (fragment z fetch calls i b≈Çƒôdem mode)
package.json

Najszybciej bƒôdzie je≈õli wrzucisz ZIP z ca≈Çym projektem ‚Äî wtedy za jednym zamachem zobaczƒô wszystko i napiszƒô kompletne, dzia≈ÇajƒÖce pliki gotowe do wklejenia.
Czy masz dostƒôp do GitHub repo? Je≈õli tak, mo≈ºesz pobraƒá ZIP bezpo≈õrednio z GitHuba (Code ‚Üí Download ZIP) i tu wrzuciƒá.api/_lib/db.js‚Ä®
// /api/_lib/db.js
import pg from "pg";

const { Pool } = pg;

let _pool;

export function getPool() {
  if (_pool) return _pool;

  const conn =
    process.env.DATABASE_URL ||
    process.env.POSTGRES_URL ||
    process.env.NEON_DATABASE_URL;

  if (!conn) {
    throw new Error("BrpastedJu≈º przesy≈Çam, ale trzeba te≈º pamiƒôtaƒá ≈ºe vercel w darmowej wersji daje deploy na maksymalnie 12fomularzy
Kody:20:17Teraz mam pe≈Çny obraz. Widzƒô dok≈Çadnie co jest nie tak. Zacznijmy od pe≈Çnej diagnozy, potem generujƒô wszystkie pliki.Diagnoza i plan strukturyDiagnoza i plan strukturyScriptDonePlan gotowy. Teraz piszƒô wszystkie pliki ‚Äî kompletne, gotowe do wklejenia.Created 16 filesShared DB lib - CommonJS ≈ºeby wszystkie handlery mog≈Çy u≈ºywaƒá require()db.jsMail helper - CommonJSmail.jsSQL schema - wszystkie tabeleschema.sqlapi/schedule.js - publiczny endpoint z grafikiemschedule.jsapi/prices.js - publiczny endpoint z cennikiemprices.jsapi/register.js - zapis kursanta z obs≈ÇugƒÖ listy rezerwowej i mailiregister.jsapi/payment-document.js - generowanie dokumentu PDFpayment-document.jsapi/registration/action.js - finalizacja akcji po zapisieaction.jsapi/admin-api/login.js - logowanie admina z JWTlogin.jsapi/_lib/auth.js - middleware weryfikacji JWTauth.jsapi/admin-api/stats.js - statystyki dla dashboardustats.jsapi/admin-api/registrations/[id].js - kartoteka kursanta (GET/PATCH/DELETE)[id].jsapi/admin-api/groups/index.js - zarzƒÖdzanie grupamiindex.jsapi/admin-api/groups/[id].js - edycja/usuwanie grupy + members[id].jsapi/admin-api/schedules/index.js - zarzƒÖdzanie grafikiem + PATCH/DELETE przez id w queryindex.jsapi/admin-api/locations/index.js - lokalizacje + plany + export CSV (funkcja 12)index.jsDoneTeraz potrzebujemy osobnych plik√≥w dla plans i export ‚Äî ale uwaga, to by przekroczy≈Ço limit 12. Zmieniƒô podej≈õcie i obs≈Çu≈ºƒô je przez query param w locations/index.js, ale plans i export to osobne URL-e. Muszƒô sprawdziƒá jak to skonfigurowaƒá przez vercel.json.Created 2 filesapi/admin-api/plans.js - plany cennikowe i export CSVplans.jsapi/admin-api/export.js - eksport CSVexport.jsDoneTeraz kluczowe ‚Äî vercel.json kt√≥ry poprawnie skonfiguruje routing i limit funkcji:Created 2 filesvercel.json - konfiguracja routingu i limitu funkcjivercel.jsonpackage.json - poprawny, bez "type: module" bo u≈ºywamy CommonJSpackage.jsonDoneTeraz skrypt do stworzenia pierwszego admina w bazie:Skrypt do tworzenia konta admina w bazieSkrypt do tworzenia konta admina w baziecreate-admin.jsDoneTeraz sprawdzam ile mamy funkcji i robiƒô finalne zliczenie:Sprawdzenie liczby funkcji i strukturySprawdzenie liczby funkcji i strukturyScriptDone14 funkcji ‚Äî 2 za du≈ºo. Muszƒô po≈ÇƒÖczyƒá export i plans w jednym pliku. Poprawiam vercel.json i ≈ÇƒÖczƒô je:Edited 2 files≈ÅƒÖczƒô plans + export w jeden plik ≈ºeby zmie≈õciƒá siƒô w 12 funkcjachplans.js+13-5Dodajƒô eksport CSV na ko≈Ñcu pliku plans.jsplans.js+55-2DoneTeraz przekierujƒô export do plans.js i usu≈Ñ osobny plik export:Usuwam osobny plik export bo jest wbudowany w plans.jsUsuwam osobny plik export bo jest wbudowany w plans.jsScriptDoneAle teraz potrzebujemy api/admin-api/export.js kt√≥ry bƒôdzie wrapper wywo≈ÇujƒÖcy plans.exportCSV. Zamiast tego ‚Äî lepiej podej≈õcie przez query param w vercel.json:Api/admin-api/export.js - cienki wrapper korzystajƒÖcy z plans.jsapi/admin-api/export.js - cienki wrapper korzystajƒÖcy z plans.jsexport.jsDoneHm, to nadal 14 funkcji. Sprawdzam ograniczenie Vercela dok≈Çadniej:Sprawdzam dok≈Çadnie ile funkcjiSprawdzam dok≈Çadnie ile funkcjiScriptDone14 plik√≥w. Muszƒô zredukowaƒá o 2. Scalƒô: prices + schedule ‚Üí jeden plik, a payment-document + registration/action ‚Üí jeden plik:Ran 4 commands, created 2 filesPlan scalania plik√≥wScriptUsuwam pliki kt√≥re zostanƒÖ scaloneScriptapi/catalog.js - scalony schedule + prices w jednym plikucatalog.jsapi/registration/action.js - scalony action + payment-documentaction.jsNadpisanie pliku action.js z pe≈ÇnƒÖ logikƒÖScriptFinalne sprawdzenie liczby funkcjiScriptDoneDok≈Çadnie 12. Teraz zaktualizuj vercel.json z w≈Ça≈õciwymi rewrite'ami:Created a file, edited a filevercel.json finalny z w≈Ça≈õciwym routingiem dla 12 funkcjivercel.jsonAktualizacja vercel.json z w≈Ça≈õciwymi rewriteamivercel.json+35-30DoneTeraz zipujƒô wszystko i dostarczam do pobrania:Ran a command, read a filePakowanie wszystkich plik√≥w do ZIPScriptPresented fileDoneZIP gotowy. Teraz instrukcja wdro≈ºenia krok po kroku:

Co jest w ZIPie i jak wdro≈ºyƒá
Struktura (dok≈Çadnie 12 funkcji Vercel):
api/
  _lib/db.js        ‚Üê wsp√≥lne po≈ÇƒÖczenie DB (CommonJS)
  _lib/auth.js      ‚Üê weryfikacja JWT
  _lib/mail.js      ‚Üê wysy≈Çka maili przez Resend
  catalog.js        ‚Üê /api/schedule + /api/prices (2w1)
  register.js       ‚Üê POST /api/register
  registration/
    action.js       ‚Üê POST /api/registration/action + GET /api/payment-document (2w1)
  admin-api/
    login.js        ‚Üê POST /login
    stats.js        ‚Üê GET /stats
    registrations/[id].js  ‚Üê lista + kartoteka
    groups/index.js ‚Üê lista + tworzenie grup
    groups/[id].js  ‚Üê edycja + usuwanie + members
    schedules/index.js ‚Üê grafik (CRUD)
    locations/index.js ‚Üê lokalizacje (CRUD)
    plans.js        ‚Üê cennik + export CSV (2w1)
    export.js       ‚Üê wrapper na plans.js

KROK 1 ‚Äî Usu≈Ñ stare pliki API z repo
W GitHub usu≈Ñ ca≈ÇƒÖ zawarto≈õƒá folderu api/ (za wyjƒÖtkiem _lib/ je≈õli chcesz zachowaƒá). Wszystkie stare [...path].js, [...route].js ‚Äî precz.
KROK 2 ‚Äî Wgraj nowe pliki
Skopiuj zawarto≈õƒá ZIPa do repo. Nadpisz te≈º vercel.json i package.json z ZIPa.
KROK 3 ‚Äî Uruchom schemat SQL w bazie
Otw√≥rz sw√≥j panel Postgres (np. Neon, Supabase, Railway) i wykonaj zawarto≈õƒá schema.sql. Je≈õli tabele ju≈º istniejƒÖ ‚Äî nic siƒô nie stanie (IF NOT EXISTS).
KROK 4 ‚Äî Utw√≥rz konto admina
Lokalnie lub przez terminal:
bashDATABASE_URL="twoj-connection-string" node create-admin.js admin TwojeHaslo123!
KROK 5 ‚Äî Sprawd≈∫ zmienne ≈õrodowiskowe w Vercel
W Vercel ‚Üí Settings ‚Üí Environment Variables sprawd≈∫ czy masz:

DATABASE_URL ‚úì
JWT_SECRET ‚úì (dowolny d≈Çugi string)
RESEND_API_KEY ‚úì
MAIL_FROM ‚úì
BANK_ACCOUNT (opcjonalne ‚Äî nr konta do przelew√≥w)
BANK_NAME (opcjonalne)
ADMIN_EMAIL (opcjonalne ‚Äî email do powiadomie≈Ñ)

KROK 6 ‚Äî Deploy i test
Po pushu sprawd≈∫:

https://twoja-domena.vercel.app/api/schedule ‚Üí powinno zwr√≥ciƒá [] lub dane
https://twoja-domena.vercel.app/api/prices ‚Üí powinno zwr√≥ciƒá [] lub dane
POST /api/admin-api/login ‚Üí { "username": "admin", "password": "TwojeHaslo123!" } ‚Üí powinno zwr√≥ciƒá token


Kluczowa poprawka w admin.html: Zmie≈Ñ w JS liniƒô:
javascriptdocument.getElementById('btn-export').addEventListener('click',()=>window.open(API+'/export','_blank'));
To ju≈º dzia≈Ça≈Ço poprawnie ‚Äî API+'/export' = /api/admin-api/export ‚úì
Daj znaƒá jak p√≥jdzie deploy ‚Äî jak bƒôdƒÖ nowe b≈Çƒôdy, pomogƒô dalej!Saggita api completeZIP Downloadnic nie rozumiem musisz do mnie jak do ciƒô≈ºkiego laika m√≥wiƒá20:28Okej, bez ≈ºadnego ≈ºargonu. Zacznijmy od absolutnych podstaw.
Masz na GitHubie folder z plikami. Te pliki trafiajƒÖ na Vercel i tam dzia≈ÇajƒÖ jako strona + backend. Teraz co≈õ jest nie tak i trzeba to naprawiƒá.
Zrobi≈Çam dla Ciebie gotowe pliki w ZIPie. Teraz powiedz mi jedno:Czekam na Twoje odpowiedzi ‚Äî na ich podstawie powiem Ci dok≈Çadnie co klikaƒá, ekran po ekranie, bez ≈ºadnego technicznego ≈ºargonu.Q: Jak wgrywasz pliki na GitHub? (to decyduje jak Ci wyt≈Çumaczƒô kolejne kroki)
A: Przez stronƒô GitHub.com w przeglƒÖdarceQ: Czy masz bazƒô danych Postgres ju≈º za≈Ço≈ºonƒÖ? (np. na Neon.tech, Supabase, Railway)
A: Tak, mam i wiem jak siƒô do niej dostaƒáQ: Gdzie masz konto z bazƒÖ danych?
A: Neon.tech20:28Idealnie. Mam wszystko co potrzebujƒô. Teraz przeprowadzƒô Ciƒô przez to krok po kroku, bardzo powoli.

KROK 1 ‚Äî Pobierz ZIP i go rozpakuj
Pobierz ZIP kt√≥ry wygenerowa≈Çam (przycisk wy≈ºej w naszej rozmowie: saggita-api-COMPLETE).
Po pobraniu kliknij na plik prawym przyciskiem myszy ‚Üí "Wypakuj wszystko" (Windows) lub kliknij dwukrotnie (Mac).
Zobaczysz folder z plikami w ≈õrodku.

KROK 2 ‚Äî Wyczy≈õƒá stary folder API na GitHubie
Wejd≈∫ na github.com ‚Üí Twoje repo saggita-kravmaga.
Teraz musimy usunƒÖƒá stare pliki ≈ºeby nie kolidowa≈Çy z nowymi. Usu≈Ñ te foldery/pliki jeden po drugim (kliknij na plik ‚Üí ikonka kosza):

api/status/ ‚Üê ca≈Çy folder
api/admin-api/schedules/[...path].js ‚Üê tylko ten plik
api/admin-api/registration/ ‚Üê je≈õli jest

Jak usunƒÖƒá folder na GitHubie przez przeglƒÖdarkƒô:

Wejd≈∫ do folderu
Kliknij na plik
Kliknij ikonkƒô o≈Ç√≥wka (edytuj)
Zaznacz wszystko i usu≈Ñ ca≈ÇƒÖ tre≈õƒá
Kliknij "Commit changes"

(Niestety GitHub przez przeglƒÖdarkƒô nie usuwa folder√≥w jednym klikniƒôciem ‚Äî trzeba opr√≥≈ºniƒá pliki)
Powiedz mi czy to zrobi≈Ça≈õ i przejdziemy do kroku 3 ‚Äî wgrywania nowych plik√≥w.

W≈Ça≈õciwie ‚Äî zanim zaczniesz to robiƒá, powiedz mi jednƒÖ rzecz:Q: Czy chcesz ≈ºebym Ci pokaza≈Ça jak zrobiƒá to wszystko szybciej przez GitHub Desktop? To darmowy program, kt√≥ry instalujesz raz i potem wgrywanie plik√≥w to dos≈Çownie przeciƒÖgnij i upu≈õƒá.
A: Tak, chƒôtnie20:29≈öwietnie! GitHub Desktop to bƒôdzie dla Ciebie game changer. Robimy to raz, potem zawsze tak.

KROK 1 ‚Äî Zainstaluj GitHub Desktop
Wejd≈∫ na: desktop.github.com
Kliknij du≈ºy fioletowy przycisk "Download for Windows" (lub Mac je≈õli masz Maca).
Zainstaluj jak ka≈ºdy normalny program (next, next, finish).

KROK 2 ‚Äî Zaloguj siƒô i pobierz repo
Po otwarciu GitHub Desktop:

Kliknij "Sign in to GitHub.com"
Zaloguj siƒô na swoje konto GitHub
Kliknij "Clone a repository"
Znajd≈∫ na li≈õcie saggita-kravmaga
Wybierz gdzie chcesz zapisaƒá folder na komputerze (np. Pulpit)
Kliknij "Clone"

Poczekaj chwilƒô ‚Äî pobierze ca≈Çy projekt na Tw√≥j komputer.

KROK 3 ‚Äî Zamie≈Ñ pliki

Otw√≥rz pobrany ZIP z naszymi nowymi plikami
Otw√≥rz folder projektu na komputerze (w GitHub Desktop kliknij "Show in Explorer" / "Show in Finder")
Z ZIPa skopiuj i wklej (z nadpisaniem) te foldery/pliki do folderu projektu:

folder api/ ‚Üí wklej w ca≈Ço≈õci (nadpisze stare pliki)
plik vercel.json ‚Üí nadpisz
plik package.json ‚Üí nadpisz




KROK 4 ‚Äî Wy≈õlij na GitHub
W GitHub Desktop zobaczysz listƒô zmienionych plik√≥w po lewej stronie.

Na dole wpisz w pole "Summary" cokolwiek np. naprawa API
Kliknij niebieski przycisk "Commit to main"
Kliknij "Push origin" (pojawi siƒô na g√≥rze)

Gotowe ‚Äî pliki sƒÖ na GitHubie, Vercel automatycznie zrobi nowy deploy.

Powiedz mi gdy sko≈Ñczy≈Ça≈õ ten krok ‚Äî to przejdziemy do bazy danych na Neon (to bƒôdzie ≈Çatwe, dos≈Çownie kilka klikniƒôƒá).sko≈Ñczy≈Çam20:40Super! Teraz baza danych. To zajmie 3 minuty.

KROK 5 ‚Äî Utw√≥rz tabele w bazie (Neon.tech)

Wejd≈∫ na neon.tech i zaloguj siƒô
Kliknij na sw√≥j projekt
Po lewej stronie znajd≈∫ "SQL Editor" i kliknij

Zobaczysz bia≈Çe pole do wpisywania. To jest miejsce gdzie mo≈ºemy "rozmawiaƒá" z bazƒÖ danych.

Teraz skopiuj ca≈Çy tekst poni≈ºej i wklej go w to bia≈Çe pole:
sqlCREATE TABLE IF NOT EXISTS locations (
  id SERIAL PRIMARY KEY, city TEXT NOT NULL, name TEXT NOT NULL,
  slug TEXT UNIQUE, address TEXT, active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE TABLE IF NOT EXISTS groups (
  id SERIAL PRIMARY KEY, location_id INTEGER REFERENCES locations(id) ON DELETE SET NULL,
  name TEXT NOT NULL, category TEXT DEFAULT 'adults', age_range TEXT,
  max_capacity INTEGER DEFAULT 20, notes TEXT, active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE TABLE IF NOT EXISTS schedules (
  id SERIAL PRIMARY KEY, group_id INTEGER REFERENCES groups(id) ON DELETE CASCADE,
  day_of_week INTEGER, day_name TEXT, time_start TIME, time_end TIME,
  time_label TEXT, address TEXT, active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE TABLE IF NOT EXISTS price_plans (
  id SERIAL PRIMARY KEY, name TEXT NOT NULL, category TEXT DEFAULT 'adults',
  price NUMERIC(10,2) NOT NULL, signup_fee NUMERIC(10,2) DEFAULT 0,
  months INTEGER, description TEXT, active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE TABLE IF NOT EXISTS registrations (
  id SERIAL PRIMARY KEY, first_name TEXT NOT NULL, last_name TEXT NOT NULL,
  email TEXT, phone TEXT, birth_year INTEGER, is_new BOOLEAN DEFAULT true,
  location_id INTEGER REFERENCES locations(id) ON DELETE SET NULL,
  group_id INTEGER REFERENCES groups(id) ON DELETE SET NULL,
  schedule_id INTEGER REFERENCES schedules(id) ON DELETE SET NULL,
  price_plan_id INTEGER REFERENCES price_plans(id) ON DELETE SET NULL,
  start_date DATE, preferred_time TEXT, is_waitlist BOOLEAN DEFAULT false,
  status TEXT DEFAULT 'new', payment_status TEXT DEFAULT 'unpaid',
  payment_method TEXT DEFAULT 'transfer', payment_ref TEXT UNIQUE,
  total_amount NUMERIC(10,2) DEFAULT 0, paid_at TIMESTAMPTZ,
  source TEXT DEFAULT 'web', admin_notes TEXT,
  consent_data BOOLEAN DEFAULT false, consent_rules BOOLEAN DEFAULT false,
  finalize_action TEXT, finalized_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE TABLE IF NOT EXISTS admin_users (
  id SERIAL PRIMARY KEY, username TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL, created_at TIMESTAMPTZ DEFAULT NOW()
);
Kliknij przycisk "Run" (lub Ctrl+Enter).
Powinna pojawiƒá siƒô zielona informacja ≈ºe siƒô uda≈Ço.

Powiedz mi gdy to zrobisz ‚Äî zostajƒÖ jeszcze 2 kroki (has≈Ço admina + jedna zmienna na Vercelu) i aplikacja bƒôdzie dzia≈Çaƒá!ju≈º20:41≈öwietnie! Teraz utw√≥rz konto admina. To te≈º w Neon, w tym samym SQL Editorze.

KROK 6 ‚Äî Utw√≥rz konto admina
W tym samym bia≈Çym polu w Neon wyczy≈õƒá poprzedni tekst i wklej poni≈ºsze.
WA≈ªNE: Zmie≈Ñ TwojeHaslo123! na swoje w≈Çasne has≈Ço (zapamiƒôtaj je!):
sqlINSERT INTO admin_users (username, password_hash) VALUES (
  'admin',
  '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj/RK.s5uoou'
);
Kliknij "Run".

To has≈Ço do tego hasha to: admin123!
Zaraz po tym jak wszystko zadzia≈Ça ‚Äî zaloguj siƒô i natychmiast zmie≈Ñ has≈Ço na swoje (powiem Ci jak).

Powiedz mi gdy kliknƒô≈Ça≈õ Run ‚Äî zostaje ostatni krok na Vercelu i gotowe!ERROR: duplicate key value violates unique constraint "admin_users_username_key" (SQLSTATE 23505)20:41≈öwietnie ‚Äî ten b≈ÇƒÖd oznacza ≈ºe konto admina ju≈º istnieje w bazie! Nic z≈Çego siƒô nie sta≈Ço.
Sprawd≈∫my jakie masz has≈Ço. Wklej to w SQL Editor i kliknij Run:
sqlSELECT username, created_at FROM admin_users;
Poka≈º mi co wy≈õwietli≈Ço ‚Äî zobaczysz nazwƒô u≈ºytkownika i datƒô kiedy zosta≈Ço utworzone. Dziƒôki temu bƒôdziemy wiedzieƒá czy to konto z poprzednich pr√≥b czy nowe.[{
  "username": "admin",
  "created_at": "2026-02-15 17:22:57.617991+00"
}]20:42Okej, konto admina istnieje od wczoraj.
Problem w tym, ≈ºe nie wiemy jakie ma has≈Ço (zosta≈Ço ustawione wcze≈õniej przez kogo≈õ/co≈õ). Najpro≈õciej ‚Äî nadpiszmy je na nowe, kt√≥re znamy.
Wklej to w SQL Editor i kliknij Run:
sqlUPDATE admin_users 
SET password_hash = '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj/RK.s5uoou'
WHERE username = 'admin';
To ustawi has≈Ço na: admin123!
Kliknij Run i powiedz co siƒô pojawi≈Ço.ale ja znam has≈Ço20:42To jeszcze lepiej! Nie ruszamy has≈Ça.
Teraz ostatni krok ‚Äî Vercel.

KROK 7 ‚Äî Sprawd≈∫ zmienne na Vercelu
Wejd≈∫ na vercel.com ‚Üí Tw√≥j projekt saggita-kravmaga ‚Üí kliknij Settings ‚Üí po lewej Environment Variables.
Powiedz mi co widzisz na li≈õcie ‚Äî jakie zmienne tam sƒÖ? (same nazwy, bez warto≈õci)
Potrzebujƒô ≈ºeby≈õ mia≈Ça te 4:

DATABASE_URL
JWT_SECRET
RESEND_API_KEY
MAIL_FROM
20:43Wszystkie potrzebne zmienne sƒÖ! Masz:

‚úÖ DATABASE_URL
‚úÖ JWT_SECRET
‚úÖ RESEND_API_KEY
‚úÖ MAIL_FROM

Teraz sprawd≈∫my czy deploy ju≈º przeszed≈Ç. Wejd≈∫ na g√≥rze w Deployments i powiedz mi co widzisz ‚Äî czy jest zielony znaczek "Ready" przy ostatnim deploymencie?20:39:38.404 Running build in Washington, D.C., USA (East) ‚Äì iad1
20:39:38.405 Build machine configuration: 2 cores, 8 GB
20:39:38.675 Cloning github.com/nejaskiewicz-eng/saggita-kravmaga (Branch: main, Commit: 2d02d4b)
20:39:38.925 Cloning completed: 249.000ms
20:39:39.129 Skipping build cache since Node.js version changed from "24.x" to ""
20:39:39.404 Error: Found invalid or discontinued Node.js Version: "18.x". Please set "engines": { "node": "24.x" } in your package.json file to use Node.js 24. Learn More: https://vercel.link/node-version
20:39:41.429 Found invalid or discontinued Node.js Version: "18.x". Please set "engines": { "node": "24.x" } in your package.json file to use Node.js 24.20:44≈Åatwa poprawka! W package.json mamy wpisane 18.x a Vercel chce 24.x. Zmieniamy to w 30 sekund.

Wejd≈∫ na github.com ‚Üí Twoje repo ‚Üí znajd≈∫ plik package.json i kliknij na niego.
Kliknij ikonkƒô o≈Ç√≥wka (edytuj) w prawym g√≥rnym rogu pliku.
Znajd≈∫ tƒô liniƒô:
"node": "18.x"
Zmie≈Ñ na:
"node": "24.x"
Potem przewi≈Ñ na d√≥≈Ç i kliknij zielony przycisk "Commit changes".
Vercel automatycznie zacznie nowy deploy. Powiedz mi gdy kliknƒô≈Ça≈õ Commit!hmmm...Vercdel ca≈Çy czas wywala to:
20:45:38.090 Running build in Washington, D.C., USA (East) ‚Äì iad1
20:45:38.091 Build machine configuration: 2 cores, 8 GB
20:45:38.101 Cloning github.com/nejaskiewicz-eng/saggita-kravmaga (Branch: main, Commit: 2d02d4b)
20:45:38.101 Skipping build cache, deployment was triggered without cache.
20:45:38.338 Cloning completed: 236.000ms
20:45:38.721 Error: Found invalid or discontinued Node.js Version: "18.x". Please set "engines": { "node": "24.x" } in your package.json file to use Node.js 24. Learn More: https://vercel.link/node-versiona u mnie jest tak jak na screenie20:47Widzƒô problem! Na screenie masz ju≈º "24.x" ‚Äî dobrze. Ale Vercel nadal u≈ºywa starego commita 2d02d4b sprzed zmiany.
Zauwa≈º w logach: Commit: 2d02d4b ‚Äî to stary commit. Vercel nie pobra≈Ç jeszcze Twojej zmiany.
Zr√≥b tak:

Wejd≈∫ na Vercel ‚Üí Deployments ‚Üí znajd≈∫ najnowszy deployment ‚Üí kliknij na niego ‚Üí znajd≈∫ przycisk "Redeploy" i kliknij.
Albo jeszcze pro≈õciej ‚Äî wejd≈∫ na Vercel ‚Üí g√≥rne menu ‚Üí "Deployments" ‚Üí przy najnowszym kliknij "..." (trzy kropki) ‚Üí "Redeploy".
Powiedz mi co pokazuje w logach po tym!no ca≈Çy czas wrzuca stary deploy20:49Rozumiem! Vercel ma zakeszowany stary deploy. Musimy go zmusiƒá do pobrania nowego.
Zr√≥b tak ‚Äî wejd≈∫ na GitHub, znajd≈∫ package.json i kliknij o≈Ç√≥wek ≈ºeby edytowaƒá. Nie zmieniaj nic ‚Äî po prostu dodaj spacjƒô gdzie≈õ na ko≈Ñcu pustej linii, ≈ºeby GitHub my≈õla≈Ç ≈ºe co≈õ zmieni≈Ça≈õ. Potem kliknij "Commit changes".
To wymusi nowy commit z nowym numerem ‚Äî i Vercel go pobierze.
Ale zanim to zrobisz ‚Äî sprawd≈∫ jednƒÖ rzecz. Na GitHubie po lewej stronie widzƒô na screenie ≈ºe masz folder api ‚Äî kliknij na niego i powiedz mi co jest w ≈õrodku. Czy sƒÖ tam nowe pliki kt√≥re wgra≈Ça≈õ przez GitHub Desktop?20:50Nowe pliki sƒÖ na GitHubie ‚Äî commit "naprawa API" sprzed 10 minut. ≈öwietnie!
Problem jest inny ‚Äî Vercel ma w ustawieniach wpisanƒÖ starƒÖ wersjƒô Node.js. Trzeba to zmieniƒá bezpo≈õrednio w Vercelu, nie w pliku.
Zr√≥b tak:

Na Vercelu wejd≈∫ w Settings ‚Üí po lewej kliknij "General" ‚Üí przewi≈Ñ w d√≥≈Ç a≈º znajdziesz sekcjƒô "Node.js Version".
Tam bƒôdzie rozwijana lista ‚Äî zmie≈Ñ z 18.x na 22.x (lub najwy≈ºsza dostƒôpna).
Kliknij "Save".
Potem wejd≈∫ w Deployments ‚Üí kliknij "..." przy ostatnim ‚Üí "Redeploy".
Powiedz mi co widzisz w logach!dobra z≈Çapa≈Ço. Jesty zielone20:51üéâ Deploy przeszed≈Ç!
Teraz sprawdzamy czy API dzia≈Ça. Wejd≈∫ w przeglƒÖdarkƒô i wpisz ten adres (zamie≈Ñ saggita-kravmaga na swojƒÖ prawdziwƒÖ domenƒô na Vercelu):
https://saggita-kravmaga.vercel.app/api/schedule
Powiedz mi co widzisz ‚Äî czy pokazuje siƒô jaki≈õ tekst (nawet [] czyli puste nawiasy to dobry znak!), czy b≈ÇƒÖd?20:52Dobra wiadomo≈õƒá ‚Äî API dzia≈Ça i ≈ÇƒÖczy siƒô z bazƒÖ! To ogromny postƒôp!
B≈ÇƒÖd m√≥wi ≈ºe w bazie brakuje kolumny day_name w tabeli schedules. To znaczy ≈ºe Twoja baza mia≈Ça ju≈º starƒÖ tabelƒô schedules zanim wgra≈Çy≈õmy nowy schemat.
Naprawka jest prosta ‚Äî wejd≈∫ do Neon ‚Üí SQL Editor i wklej to:
sqlALTER TABLE schedules ADD COLUMN IF NOT EXISTS day_name TEXT;
ALTER TABLE schedules ADD COLUMN IF NOT EXISTS time_label TEXT;
ALTER TABLE schedules ADD COLUMN IF NOT EXISTS address TEXT;
Kliknij Run i powiedz mi co pokazuje!sukces20:52Teraz od≈õwie≈º stronƒô w przeglƒÖdarce:
https://saggita-kravmaga.vercel.app/api/schedule
Powiedz co widzisz!20:53üéâ DZIA≈ÅA!!!
Widzƒô dane ‚Äî Wa≈Çbrzych, Wroc≈Çaw, ≈öwidnica, grupy, terminy ‚Äî wszystko jest! API ≈ºyje!
Teraz sprawd≈∫my pozosta≈Çe dwie rzeczy. Wejd≈∫ na:
https://saggita-kravmaga.vercel.app/api/prices
Powiedz co widzisz![{"id":7,"name":"Kontynuacja ‚Äî miesiƒôczny","category":"adults","price":"220.00","signup_fee":"0.00","months":1,"description":"Dla os√≥b kontynuujƒÖcych treningi"},{"id":3,"name":"Karnet miesiƒôczny","category":"adults","price":"220.00","signup_fee":"40.00","months":1,"description":"Krav Maga dla doros≈Çych, bez umowy"},{"id":8,"name":"Kontynuacja ‚Äî 3-miesiƒôczny","category":"adults","price":"600.00","signup_fee":"0.00","months":3,"description":null},{"id":4,"name":"Karnet 3-miesiƒôczny","category":"adults","price":"600.00","signup_fee":"40.00","months":3,"description":"200 z≈Ç/mc, op≈Çata wpisowa jednorazowo"},{"id":5,"name":"Karnet 6-miesiƒôczny","category":"adults","price":"1080.00","signup_fee":"40.00","months":6,"description":"180 z≈Ç/mc, op≈Çata wpisowa jednorazowo"},{"id":9,"name":"Kontynuacja ‚Äî 6-miesiƒôczny","category":"adults","price":"1080.00","signup_fee":"0.00","months":6,"description":null},{"id":10,"name":"Kontynuacja ‚Äî 10-miesiƒôczny","category":"adults","price":"1800.00","signup_fee":"0.00","months":10,"description":null},{"id":6,"name":"Karnet 10-miesiƒôczny","category":"adults","price":"1800.00","signup_fee":"40.00","months":10,"description":"180 z≈Ç/mc ‚Äî 2 miesiƒÖce wakacyjne GRATIS"},{"id":11,"name":"MSWiA/MON ‚Äî miesiƒôczny","category":"discount","price":"200.00","signup_fee":"40.00","months":1,"description":"Funkcjonariusze MSWiA i MON z dowodem"},{"id":12,"name":"MSWiA/MON ‚Äî 3-miesiƒôczny","category":"discount","price":"560.00","signup_fee":"40.00","months":3,"description":null},{"id":13,"name":"MSWiA/MON ‚Äî 6-miesiƒôczny","category":"discount","price":"1000.00","signup_fee":"40.00","months":6,"description":null},{"id":14,"name":"MSWiA/MON ‚Äî 10-miesiƒôczny","category":"discount","price":"1600.00","signup_fee":"40.00","months":10,"description":null},{"id":2,"name":"Karnet dzieciƒôcy ‚Äî 10 miesiƒôcy","category":"kids","price":"160.00","signup_fee":"40.00","months":10,"description":"Krav Maga dla dzieci z umowƒÖ na rok szkolny"},{"id":1,"name":"Karnet dzieciƒôcy ‚Äî miesiƒôczny","category":"kids","price":"220.00","signup_fee":"40.00","months":1,"description":"Krav Maga dla dzieci, bez umowy"},{"id":15,"name":"Trening jednorazowy","category":"service","price":"40.00","signup_fee":"0.00","months":null,"description":"Jednorazowe wej≈õcie pr√≥bne"}]Show more20:53üéâ WSZYSTKO DZIA≈ÅA!
Masz pe≈Çne dane ‚Äî karnety, ceny, wszystko!
Teraz sprawd≈∫ panel admina. Wejd≈∫ na:
https://saggita-kravmaga.vercel.app/public/admin.html
Spr√≥buj siƒô zalogowaƒá swoim has≈Çem i powiedz co widzisz!20:54Pomy≈Çka w adresie ‚Äî plik admin.html jest w folderze public na GitHubie, ale Vercel serwuje go bez s≈Çowa "public" w adresie.
Spr√≥buj tak:
https://saggita-kravmaga.vercel.app/admin.html


ChatGPT powiedzia≈Ç:
Super, Natalia. To jest ten moment, kiedy projekt wreszcie zaczyna ‚Äûoddychaƒá‚Äù ‚Äì API dzia≈Ça, baza dzia≈Ça, ceny siƒô zwracajƒÖ. Teraz tylko poprawnie wej≈õƒá w panel.

Masz racjƒô: w Vercelu folder public/ to nie jest czƒô≈õƒá adresu URL.
Je≈õli plik jest tutaj: public/admin.html, to w przeglƒÖdarce otwierasz go tak:

https://saggita-kravmaga.vercel.app/admin.html

I teraz dwie mo≈ºliwe sytuacje.

Je≈õli panel siƒô otwiera (widzisz stronƒô logowania)
To po prostu zaloguj siƒô swoim loginem i has≈Çem.
Je≈õli po zalogowaniu bƒôdzie b≈ÇƒÖd typu ‚Äûbrak po≈ÇƒÖczenia / 401 / forbidden‚Äù ‚Äì pode≈õlij mi dok≈Çadnie tre≈õƒá b≈Çƒôdu (albo screen z konsoli) i poprawimy to w 2 minuty.

Je≈õli widzisz 404 / ‚ÄúNot Found‚Äù
To znaczy, ≈ºe Vercel nie widzi pliku jako ‚Äûstatycznej strony‚Äù. Zr√≥b wtedy tƒô kr√≥tkƒÖ check-listƒô:

Na GitHubie sprawd≈∫, czy plik na pewno jest tu:

public/admin.html (dok≈Çadnie tak, ma≈Çymi literami)

Upewnij siƒô, ≈ºe zmiana jest na main i zosta≈Ça wypchniƒôta:

wejd≈∫ w repo na GitHubie i zobacz, czy ostatni commit zawiera public/admin.html

Wejd≈∫ w Vercel ‚Üí Deployments i kliknij ostatni zielony deployment, a potem ‚ÄúView Source‚Äù (albo w podglƒÖdzie plik√≥w, je≈õli masz) ‚Äì sprawd≈∫, czy w buildzie faktycznie jest admin.html.

Je≈õli masz w vercel.json jakie≈õ ‚Äúrewrites‚Äù, kt√≥re ≈ÇapiƒÖ wszystko i kierujƒÖ np. na API albo innƒÖ stronƒô, to one mogƒÖ ‚Äûpo≈ºeraƒá‚Äù ≈õcie≈ºkƒô /admin.html.
Je≈õli po wej≈õciu na /admin.html dostajesz co≈õ, co wyglƒÖda jak odpowied≈∫ z API albo przekierowanie ‚Äì wklej mi tutaj sw√≥j vercel.json (ca≈Çy), od razu powiem co tam trzeba dopiƒÖƒá.

Najpro≈õciej na teraz: wejd≈∫ w ten adres:
https://saggita-kravmaga.vercel.app/admin.html

I napisz mi jedno zdanie: co dok≈Çadnie widzisz na ekranie (strona logowania / 404 / co≈õ innego). Je≈õli co≈õ nie dzia≈Ça po logowaniu, wklej tekst b≈Çƒôdu ‚Äì i domykamy panel do ko≈Ñca.


Powiedzia≈Çe≈õ(-a≈õ):
zalogowa≈Çam siƒô ale ka≈ºda podstrona siƒô krƒôci ko≈Çko i nie otwiera siƒô

ChatGPT powiedzia≈Ç:

My≈õla≈Ç przez 14s
Okej ‚Äî to jest bardzo typowy objaw i na 90% oznacza jednƒÖ rzecz: panel pr√≥buje pobraƒá dane z API pod z≈Çym adresem (albo bez tokenu) i dlatego ‚Äú≈Çaduje siƒô w niesko≈Ñczono≈õƒá‚Äù.

Zrobimy to prosto i bez zgadywania. Ty wykonasz 2 kr√≥tkie testy w przeglƒÖdarce, a ja na ich podstawie powiem Ci dok≈Çadnie co poprawiƒá.

Test: czy panel w og√≥le trafia w API (bez ≈ºadnych narzƒôdzi)
Wejd≈∫ w nowej karcie na ten adres:

https://saggita-kravmaga.vercel.app/api/admin-api/stats

Co widzisz?

je≈õli jaki≈õ b≈ÇƒÖd typu ‚ÄûUnauthorized / Missing token / 401‚Äù ‚Äì to DOBRZE (to znaczy endpoint dzia≈Ça, tylko wymaga zalogowania)

je≈õli ‚ÄûNot Found‚Äù albo wy≈õwietla HTML strony ‚Äì to znaczy, ≈ºe panel wali w z≈Çy URL albo rewrite‚Äôy go zjadajƒÖ

Test: czy panel zapisuje token po logowaniu
Zr√≥b tak:

a) Otw√≥rz panel: https://saggita-kravmaga.vercel.app/admin.html
b) Kliknij prawym ‚Üí ‚ÄûZbadaj‚Äù (albo ‚ÄúInspect‚Äù)
c) Wejd≈∫ w zak≈Çadkƒô ‚ÄúApplication‚Äù (czasem ‚ÄúStorage‚Äù)
d) Po lewej wybierz ‚ÄúLocal Storage‚Äù ‚Üí kliknij domenƒô saggita-kravmaga.vercel.app
e) Powiedz mi, czy widzisz tam co≈õ w stylu:

token

jwt

authToken

Je≈õli tego tam nie ma, to panel ‚Äúudaje zalogowanie‚Äù (bo UI przechodzi), ale ka≈ºde kolejne zapytanie idzie bez uprawnie≈Ñ i krƒôci k√≥≈Çko.

Najczƒôstsza przyczyna i najszybsza poprawka (zrobisz to w 30 sekund)
W 90% takich przypadk√≥w w admin.html jest z≈Ça zmienna z adresem API. Zamiast i≈õƒá na /api/admin-api/... idzie np. na /admin-api/... albo /api/... i dostaje ≈õmieci.

Wejd≈∫ na GitHub ‚Üí otw√≥rz plik public/admin.html ‚Üí wyszukaj (Ctrl+F):

API =
albo

const API
albo

BASE_URL

I ustaw to tak (dok≈Çadnie):

const API = "/api/admin-api";

Potem zapisz (Commit changes). Vercel zrobi deploy.

Dlaczego to dzia≈Ça?
Bo Twoje endpointy admina sƒÖ pod: /api/admin-api/...
A je≈õli panel uderza w co≈õ innego, to dostaje 404/HTML i loader krƒôci siƒô wiecznie.

Napisz mi teraz tylko dwie rzeczy (kr√≥tko):

Co pokazuje link /api/admin-api/stats (401? 404? co≈õ innego?)

Czy w Local Storage po zalogowaniu widzisz token/jwt?

I lecimy dalej ‚Äì to jest naprawdƒô do domkniƒôcia, ju≈º jeste≈õ bardzo blisko.


Powiedzia≈Çe≈õ(-a≈õ):
{"error":"Unauthorized: Brak tokenu"}

ChatGPT powiedzia≈Ç:
Super. To jest dobra odpowied≈∫.

To znaczy: endpoint dzia≈Ça, a panel po prostu nie wysy≈Ça tokenu przy kolejnych zapytaniach. I wtedy wszystko siƒô ‚Äûkrƒôci‚Äù, bo panel czeka na dane, kt√≥rych nigdy nie dostaje.

Najczƒôstsze przyczyny sƒÖ dwie:

token nie jest w og√≥le zapisany po logowaniu,
albo

token jest zapisany, ale kolejne podstrony go nie do≈ÇƒÖczajƒÖ do zapyta≈Ñ.

Zr√≥bmy to tak, ≈ºeby≈õ nie musia≈Ça zgadywaƒá.

Krok 1: sprawd≈∫, czy token jest zapisany (2 klikniƒôcia)

Otw√≥rz admina i zaloguj siƒô (tak jak teraz).

Kliknij prawym na stronie ‚Üí ‚ÄûZbadaj‚Äù / ‚ÄúInspect‚Äù.

Wejd≈∫ w zak≈Çadkƒô ‚ÄúApplication‚Äù (albo ‚ÄúStorage‚Äù).

Po lewej: ‚ÄúLocal Storage‚Äù ‚Üí kliknij https://saggita-kravmaga.vercel.app

Powiedz mi, czy widzisz tam wpis typu: token / jwt / authToken (cokolwiek z tokenem).

Je≈õli NIE ma tokenu ‚Üí od razu m√≥w, bo wtedy poprawka jest w miejscu ‚Äûpo zalogowaniu‚Äù (zapis do localStorage).

Je≈õli token JEST ‚Üí przejd≈∫ do kroku 2.

Krok 2: sprawd≈∫, czy panel wysy≈Ça token w nag≈Ç√≥wku (te≈º proste)

W ‚ÄûZbadaj‚Äù wejd≈∫ w zak≈Çadkƒô ‚ÄúNetwork‚Äù.

Kliknij w panelu dowolnƒÖ podstronƒô, kt√≥ra siƒô krƒôci.

Na li≈õcie w Network kliknij pierwsze ≈ºƒÖdanie do /api/admin-api/... (np. stats, groups, schedules).

Po prawej znajd≈∫ ‚ÄúRequest Headers‚Äù.

Powiedz mi, czy jest tam linijka:
Authorization: Bearer ...

Je≈õli jej nie ma ‚Äì to mamy przyczynƒô na 100%.

Najczƒôstsza poprawka w admin.html (konkret)
Na GitHubie otw√≥rz public/admin.html i znajd≈∫ funkcjƒô od fetchowania (czƒôsto nazywa siƒô apiFetch, request, fetchJSON albo zwyk≈Çe fetch(API + ...)).

Chodzi o to, ≈ºeby KA≈ªDE zapytanie do admin API wyglƒÖda≈Ço mniej wiƒôcej tak:

const token = localStorage.getItem("token"); // albo authToken/jwt ‚Äì zale≈ºy jak masz nazwane

fetch("/api/admin-api/stats", {
  headers: {
    "Authorization": `Bearer ${token}`,
    "Content-Type": "application/json"
  }
});
I tu jest klucz: bardzo czƒôsto token zapisuje siƒô pod jednƒÖ nazwƒÖ, a potem odczytuje pod innƒÖ.
Przyk≈Çad:

logowanie zapisuje localStorage.setItem("token", data.token)

a reszta panelu czyta localStorage.getItem("authToken")
Efekt: token ‚Äújest‚Äù, ale kod go nie widzi ‚Üí Unauthorized ‚Üí k√≥≈Çko.

Co potrzebujƒô od Ciebie teraz (ju≈º bez d≈Çugich rozm√≥w)
Napisz mi tylko:

Jak nazywa siƒô klucz w Local Storage (dok≈Çadnie nazwa po lewej, np. token albo authToken).

Wklej mi fragment z public/admin.html gdzie jest logowanie (tam gdzie robisz fetch('/api/admin-api/login'...)) i fragment gdzie pobierasz dane na podstronach (pierwszy fetch do /api/admin-api/...).

Ja Ci wtedy powiem dok≈Çadnie: ‚Äûzamie≈Ñ tƒô linijkƒô na tƒô‚Äù, i panel przestanie siƒô krƒôciƒá.


Powiedzia≈Çe≈õ(-a≈õ):
Dwie zasady 
1. Pracuje na macu
2. Jedno polecenie/komenda/zadanie na jednƒÖ wiadomo≈õc - to jest najwazniejsza zasada!!!

ChatGPT powiedzia≈Ç:
Jasne. Jedno zadanie.

Otw√≥rz narzƒôdzia deweloperskie na Macu i sprawd≈∫, czy token w og√≥le zapisuje siƒô po logowaniu:

BƒôdƒÖc na https://saggita-kravmaga.vercel.app/admin.html (po zalogowaniu), naci≈õnij ‚å• Option + ‚åò Command + I

Kliknij zak≈Çadkƒô Application (je≈õli jej nie widzisz: w g√≥rnym pasku kliknij >>)

Po lewej wybierz Local Storage ‚Üí kliknij https://saggita-kravmaga.vercel.app

Zr√≥b screen tego widoku albo przepisz mi, jakie sƒÖ tam klucze (same nazwy z lewej kolumny)

W nastƒôpnej wiadomo≈õci powiesz mi tylko to, co widzisz w Local Storage.


Powiedzia≈Çe≈õ(-a≈õ):
Przes≈Çany obraz
Przes≈Çany obraz

ChatGPT powiedzia≈Ç:
Jedno zadanie.

W admin.html brakuje funkcji loadAdd, dlatego ka≈ºda podstrona siƒô zawiesza (masz b≈ÇƒÖd w konsoli: loadAdd is not defined).

Wejd≈∫ na GitHub ‚Üí public/admin.html ‚Üí kliknij o≈Ç√≥wek (edytuj) ‚Üí wyszukaj:

loadAdd(
i powiedz mi, w kt√≥rej linijce to widzisz oraz co jest dok≈Çadnie napisane w tej linijce (skopiuj 1‚Äì2 linie kodu).


Powiedzia≈Çe≈õ(-a≈õ):
function navigate(view){
  CV=view;
  document.querySelectorAll('nav a[data-view]').forEach(a=>a.classList.toggle('active',a.dataset.view===view));
  const titles={dashboard:'Dashboard','web-registrations':'Zapisy ze strony',participants:'Baza kursant√≥w','add-participant':'Dodaj kursanta',groups:'Grupy',schedules:'Grafik zajƒôƒá',locations:'Lokalizacje'};
  document.getElementById('page-title').textContent=titles[view]||view;
  document.getElementById('content').innerHTML='<div class="loader"><div class="spinner"></div> ≈Åadowanie‚Ä¶</div>';
  const fns={dashboard:loadDash,'web-registrations':()=>loadReg('web'),participants:()=>loadReg('admin'),'add-participant':loadAdd,groups:loadGroups,schedules:loadSchedules,locations:loadLocations};
  (fns[view]||(() =>document.getElementById('content').innerHTML=''))();
}

ChatGPT powiedzia≈Ç:
Jedno zadanie.

W tej linijce masz odwo≈Çanie do funkcji, kt√≥rej w og√≥le nie ma:

'add-participant': loadAdd
Dlatego wszystko siƒô sypie i panel siƒô krƒôci.

Wejd≈∫ na GitHub ‚Üí public/admin.html ‚Üí znajd≈∫ tƒô linijkƒô i ZAMIE≈É jƒÖ na:

'add-participant': () => {}
Zapisz (Commit changes) i poczekaj a≈º Vercel zrobi deploy.


Powiedzia≈Çe≈õ(-a≈õ):
masz tu ca≈Çy kod napraw i daj mi do wklejenia:
<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Panel Admina ‚Äî Krav Maga Saggita</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800&family=Barlow:wght@400;500;600&display=swap');
:root{
  --bg:#0f0b0b;--surface:#1c1414;--surface2:#241c1c;--surface3:#2c2222;
  --border:#3a2828;--border2:#4a3232;
  --red:#c42000;--red-l:#e83000;--red-bg:rgba(196,32,0,.12);--red-bdr:rgba(196,32,0,.35);
  --orange:#e8a500;--or-bg:rgba(232,165,0,.12);--or-bdr:rgba(232,165,0,.35);
  --green:#2ecc71;--gr-bg:rgba(46,204,113,.1);--gr-bdr:rgba(46,204,113,.3);
  --blue:#4a9fe8;--bl-bg:rgba(74,159,232,.1);--bl-bdr:rgba(74,159,232,.3);
  --text:#e8dada;--dim:#9a8080;--muted:#6a5555;--bright:#fff;
  --sw:215px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Barlow',sans-serif;font-size:14px;line-height:1.5}
#app{display:flex;height:100vh;overflow:hidden}
#sidebar{width:var(--sw);min-width:var(--sw);background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column}
#sidebar-logo{padding:20px 16px 16px;border-bottom:1px solid var(--border)}
#sidebar-logo h1{font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:19px;letter-spacing:.03em;color:var(--bright);line-height:1.1;text-transform:uppercase}
#sidebar-logo h1 em{color:var(--red-l);font-style:normal}
#sidebar-logo small{color:var(--muted);font-size:10px;text-transform:uppercase;letter-spacing:.1em}
nav{flex:1;padding:8px;overflow-y:auto}
nav a{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:5px;color:var(--dim);font-weight:500;font-size:13px;transition:all .15s;cursor:pointer;margin-bottom:1px;text-decoration:none}
nav a:hover{color:var(--bright);background:var(--surface2)}
nav a.active{color:var(--bright);background:var(--red-bg);border-left:2px solid var(--red-l);padding-left:8px}
.nd{width:4px;height:4px;border-radius:50%;background:var(--border2);flex-shrink:0;transition:background .15s}
nav a:hover .nd{background:var(--dim)}
nav a.active .nd{background:var(--red-l)}
.sl{font-size:10px;font-weight:700;letter-spacing:.12em;color:var(--red);padding:14px 10px 4px;text-transform:uppercase;opacity:.7}
#sf{padding:12px;border-top:1px solid var(--border)}
.ui{font-size:11px;color:var(--muted);margin-bottom:8px}
.ui strong{display:block;color:var(--text);font-size:13px}
#btn-logout{width:100%;padding:7px;background:transparent;border:1px solid var(--border2);border-radius:4px;color:var(--dim);cursor:pointer;font-size:12px;font-family:'Barlow',sans-serif;transition:all .15s}
#btn-logout:hover{border-color:var(--red);color:var(--red);background:var(--red-bg)}
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}
#topbar{height:50px;min-height:50px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;gap:16px}
#topbar h2{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:800;color:var(--bright);text-transform:uppercase;letter-spacing:.05em;flex:1}
#api-status{font-size:11px;padding:4px 12px;border-radius:4px;font-weight:700;text-transform:uppercase;letter-spacing:.06em}
#api-status.ok{background:var(--gr-bg);color:var(--green);border:1px solid var(--gr-bdr)}
#api-status.err{background:var(--red-bg);color:var(--red-l);border:1px solid var(--red-bdr)}
#content{flex:1;overflow-y:auto;padding:24px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:28px}
.sc{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:18px 20px;position:relative;overflow:hidden}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--border2)}
.sc.accent::before{background:var(--red-l)}.sc.green::before{background:var(--green)}.sc.orange::before{background:var(--orange)}
.sc .label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);margin-bottom:8px}
.sc .value{font-family:'Barlow Condensed',sans-serif;font-size:42px;font-weight:800;line-height:1;color:var(--bright)}
.sc.accent .value{color:var(--red-l)}.sc.green .value{color:var(--green)}.sc.orange .value{color:var(--orange)}
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.sh h3{font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:700;color:var(--bright);text-transform:uppercase;letter-spacing:.05em;border-left:3px solid var(--red);padding-left:10px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:5px;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;border:none;font-family:'Barlow',sans-serif;text-transform:uppercase;letter-spacing:.05em;line-height:1}
.btn-primary{background:var(--red);color:#fff}.btn-primary:hover{background:var(--red-l)}
.btn-secondary{background:var(--surface2);border:1px solid var(--border2);color:var(--text)}.btn-secondary:hover{border-color:var(--red);color:var(--bright)}
.btn-sm{padding:5px 10px;font-size:11px}
.bi{padding:5px 10px;background:var(--surface3);border:1px solid var(--border2);border-radius:4px;color:var(--dim);cursor:pointer;transition:all .15s;font-size:11px;font-family:'Barlow',sans-serif;font-weight:600;text-transform:uppercase;letter-spacing:.04em;line-height:1.4}
.bi:hover{color:var(--bright);background:var(--surface2)}.bi.del:hover{border-color:var(--red);color:var(--red);background:var(--red-bg)}
.fb{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:12px}
.fb input,.fb select{background:var(--surface2);border:1px solid var(--border2);border-radius:4px;color:var(--text);padding:7px 10px;font-size:13px;font-family:'Barlow',sans-serif;outline:none;transition:border-color .15s}
.fb input:focus,.fb select:focus{border-color:var(--red)}.fb input[type=text]{min-width:220px}.fb select{min-width:150px}
.tw{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden}
table{width:100%;border-collapse:collapse}
thead th{background:var(--surface2);padding:11px 14px;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);white-space:nowrap;border-bottom:2px solid var(--border2)}
tbody tr{border-top:1px solid var(--border);transition:background .1s}
tbody tr:hover{background:var(--surface2)}
tbody td{padding:11px 14px;font-size:13px;vertical-align:middle;color:var(--text)}
.tda{display:flex;gap:5px;flex-wrap:wrap}
.badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;line-height:1.4}
.bg{background:var(--gr-bg);color:var(--green);border:1px solid var(--gr-bdr)}
.br{background:var(--red-bg);color:#ff6b4a;border:1px solid var(--red-bdr)}
.bo{background:var(--or-bg);color:var(--orange);border:1px solid var(--or-bdr)}
.bx{background:var(--surface3);color:var(--dim);border:1px solid var(--border2)}
.bb{background:var(--bl-bg);color:var(--blue);border:1px solid var(--bl-bdr)}
.cb{width:80px;height:5px;background:var(--surface3);border-radius:3px;display:inline-block;vertical-align:middle;margin-right:7px}
.cf{height:100%;background:var(--green);border-radius:3px}.cf.w{background:var(--orange)}.cf.f{background:var(--red-l)}
.ct{font-size:12px;color:var(--dim)}
.pag{display:flex;align-items:center;gap:10px;margin-top:16px;justify-content:center}
.pag button{background:var(--surface2);border:1px solid var(--border2);color:var(--dim);padding:7px 16px;border-radius:5px;cursor:pointer;font-size:12px;font-family:'Barlow',sans-serif;font-weight:600;text-transform:uppercase;letter-spacing:.05em;transition:all .15s}
.pag button:hover:not(:disabled){border-color:var(--red);color:var(--bright)}.pag button:disabled{opacity:.3;cursor:not-allowed}
.pag .pi{font-size:12px;color:var(--dim)}
.mo{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(3px)}
.md{background:var(--surface);border:1px solid var(--border2);border-radius:10px;width:100%;max-width:720px;max-height:92vh;overflow-y:auto;box-shadow:0 32px 80px rgba(0,0,0,.7)}
.mh{padding:18px 22px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1}
.mh h3{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:var(--bright);text-transform:uppercase;letter-spacing:.05em}
.mb{padding:22px}.mf{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;background:var(--surface2);position:sticky;bottom:0}
/* KARTOTEKA */
.kart-header{background:var(--surface2);border:1px solid var(--border2);border-radius:8px;padding:18px 20px;margin-bottom:20px;display:flex;align-items:center;gap:16px}
.kart-avatar{width:52px;height:52px;border-radius:50%;background:var(--red-bg);border:2px solid var(--red-bdr);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:22px;color:var(--red-l);flex-shrink:0}
.kart-name{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--bright);text-transform:uppercase}
.kart-meta{font-size:12px;color:var(--dim);margin-top:3px}
.kart-badges{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.ksec{border-top:1px solid var(--border);margin-top:18px;padding-top:16px}
.ksec-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--red);margin-bottom:12px}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fg .full{grid-column:1 / -1}
.ff{display:flex;flex-direction:column;gap:6px}
.ff label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--dim)}
.ff input,.ff select,.ff textarea{background:var(--surface2);border:1px solid var(--border2);border-radius:5px;color:var(--bright);padding:9px 11px;font-size:13px;font-family:'Barlow',sans-serif;outline:none;transition:all .15s;width:100%}
.ff input:focus,.ff select:focus,.ff textarea:focus{border-color:var(--red);box-shadow:0 0 0 2px var(--red-bg)}
.ff textarea{resize:vertical;min-height:70px}
select option{background:#1c1414}
/* VIEW mode */
.ff .view-val{font-size:14px;color:var(--bright);font-weight:500;padding:4px 0;border-bottom:1px solid var(--border);min-height:28px}
#login-screen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9000}
.lb{background:var(--surface);border:1px solid var(--border2);border-radius:10px;padding:40px;width:360px;box-shadow:0 40px 100px rgba(0,0,0,.8)}
.lb .logo{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;color:var(--bright);text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px}
.lb .logo em{color:var(--red-l);font-style:normal}
.lb p{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.1em;margin-bottom:28px}
.lb label{display:block;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);margin-bottom:6px}
.lb input{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:5px;color:var(--bright);padding:11px 13px;font-size:14px;font-family:'Barlow',sans-serif;outline:none;transition:all .15s;margin-bottom:14px}
.lb input:focus{border-color:var(--red);box-shadow:0 0 0 2px var(--red-bg)}
#login-btn{width:100%;padding:12px;background:var(--red);border:none;border-radius:5px;color:#fff;font-weight:700;font-size:15px;font-family:'Barlow Condensed',sans-serif;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;margin-top:4px;transition:background .15s}
#login-btn:hover{background:var(--red-l)}
#login-error{color:#ff6b4a;font-size:12px;margin-top:10px;display:none}
#toasts{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 18px;border-radius:6px;font-size:13px;font-weight:600;box-shadow:0 8px 32px rgba(0,0,0,.5);max-width:320px;animation:si .2s ease}
.toast.success{background:var(--green);color:#000}.toast.error{background:var(--red-l);color:#fff}.toast.info{background:var(--surface2);border:1px solid var(--border2);color:var(--text)}
@keyframes si{from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1}}
.loader{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--dim);gap:12px;font-size:13px}
.spinner{width:20px;height:20px;border:2px solid var(--border2);border-top-color:var(--red-l);border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.empty{padding:60px;text-align:center;color:var(--dim)}.empty strong{display:block;font-size:16px;color:var(--text);margin-bottom:8px}
.ib{background:var(--surface2);border-left:3px solid var(--red);border-radius:0 5px 5px 0;padding:10px 14px;font-size:12px;color:var(--dim);margin-bottom:16px;line-height:1.6}
.ib strong{color:var(--bright)}
</style>
</head>
<body>

<div id="login-screen">
  <div class="lb">
    <div class="logo">Krav Maga <em>Saggita</em></div>
    <p>Panel Administratora</p>
    <label>Login</label>
    <input type="text" id="l-user" placeholder="username" autocomplete="username"/>
    <label>Has≈Ço</label>
    <input type="password" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
    <button id="login-btn">Zaloguj siƒô</button>
    <div id="login-error"></div>
  </div>
</div>

<div id="app" style="display:none">
  <aside id="sidebar">
    <div id="sidebar-logo">
      <h1>Krav Maga <em>Saggita</em></h1>
      <small>Panel Admina</small>
    </div>
    <nav>
      <a data-view="dashboard" class="active"><span class="nd"></span> Dashboard</a>
      <div class="sl">Kursanci</div>
      <a data-view="web-registrations"><span class="nd"></span> Zapisy ze strony</a>
      <a data-view="participants"><span class="nd"></span> Baza kursant√≥w</a>
      <a data-view="add-participant"><span class="nd"></span> Dodaj kursanta</a>
      <div class="sl">Organizacja</div>
      <a data-view="groups"><span class="nd"></span> Grupy</a>
      <a data-view="schedules"><span class="nd"></span> Grafik zajƒôƒá</a>
      <a data-view="locations"><span class="nd"></span> Lokalizacje</a>
      <div class="sl">Export</div>
      <a id="btn-export"><span class="nd"></span> Pobierz CSV</a>
    </nav>
    <div id="sf">
      <div class="ui"><small>Zalogowany jako</small><strong id="admin-username">‚Äî</strong></div>
      <button id="btn-logout">Wyloguj</button>
    </div>
  </aside>
  <main id="main">
    <div id="topbar">
      <h2 id="page-title">Dashboard</h2>
      <span id="api-status" class="ok">API OK</span>
    </div>
    <div id="content"></div>
  </main>
</div>
<div id="toasts"></div>

<script>
const API='/api/admin-api'; // BEZ ko≈Ñcowego /
let TOKEN=localStorage.getItem('km_token')||'';
let CV='dashboard',ro=0,rt=0;
const RL=30;
let rf={};
const DAYS=['Niedziela','Poniedzia≈Çek','Wtorek','≈öroda','Czwartek','PiƒÖtek','Sobota'];
const CAT={kids:'Dzieci',youth:'M≈Çodzie≈º',adults:'Doro≈õli',vip:'VIP',women:'Kobiety'};

// ‚úÖ PE≈ÅNE MAPOWANIE
const PS={
  paid:'Op≈Çacony', unpaid:'Nieop≈Çacony', pending:'OczekujƒÖcy',
  partial:'Czƒô≈õciowy', waived:'Zwolniony'
};
const RS={new:'Nowy',confirmed:'Potwierdzony',cancelled:'Anulowany',completed:'Zako≈Ñczony'};

async function aF(path,opts={}){
  const h={'Content-Type':'application/json'};
  if(TOKEN)h['Authorization']=Bearer ${TOKEN};

  const url = API + (path.startsWith('/') ? path : '/' + path);

  try{
    const r=await fetch(url,{headers:h,...opts});
    const d=await r.json().catch(()=>({error:'B≈ÇƒÖd odpowiedzi serwera'}));
    if(!r.ok)throw new Error(d.error||B≈ÇƒÖd HTTP ${r.status});
    setAS(true);return d;
  }catch(e){setAS(false);throw e;}
}
function setAS(ok){const e=document.getElementById('api-status');e.textContent=ok?'API OK':'API ERROR';e.className=ok?'ok':'err';}

async function checkLogin(){if(!TOKEN)return showLogin();try{await aF('/stats');showApp();}catch{showLogin();}}
function showLogin(){document.getElementById('login-screen').style.display='flex';document.getElementById('app').style.display='none';}
function showApp(){
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='flex';
  try{
    const u=JSON.parse(atob(TOKEN.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));
    document.getElementById('admin-username').textContent=u.username||'‚Äî';
  }catch{}
  navigate('dashboard');
}
document.getElementById('login-btn').addEventListener('click',async()=>{
  const u=document.getElementById('l-user').value.trim(),p=document.getElementById('l-pass').value;
  const e=document.getElementById('login-error');e.style.display='none';
  if(!u||!p){e.textContent='Podaj login i has≈Ço.';e.style.display='block';return;}
  try{
    const d=await aF('/login',{method:'POST',body:JSON.stringify({username:u,password:p})});
    TOKEN=d.token;localStorage.setItem('km_token',TOKEN);showApp();
  }catch(err){e.textContent=err.message;e.style.display='block';}
});
document.getElementById('l-pass').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('login-btn').click();});
document.getElementById('btn-logout').addEventListener('click',()=>{TOKEN='';localStorage.removeItem('km_token');showLogin();});

function navigate(view){
  CV=view;
  document.querySelectorAll('nav a[data-view]').forEach(a=>a.classList.toggle('active',a.dataset.view===view));
  const titles={dashboard:'Dashboard','web-registrations':'Zapisy ze strony',participants:'Baza kursant√≥w','add-participant':'Dodaj kursanta',groups:'Grupy',schedules:'Grafik zajƒôƒá',locations:'Lokalizacje'};
  document.getElementById('page-title').textContent=titles[view]||view;
  document.getElementById('content').innerHTML='<div class="loader"><div class="spinner"></div> ≈Åadowanie‚Ä¶</div>';
  const fns={dashboard:loadDash,'web-registrations':()=>loadReg('web'),participants:()=>loadReg('admin'),'add-participant':loadAdd,groups:loadGroups,schedules:loadSchedules,locations:loadLocations};
  (fns[view]||(() =>document.getElementById('content').innerHTML=''))();
}
document.querySelectorAll('nav a[data-view]').forEach(a=>a.addEventListener('click',()=>navigate(a.dataset.view)));
document.getElementById('btn-export').addEventListener('click',()=>window.open(API+'/export','_blank'));

function toast(msg,type='success',ms=3500){const e=document.createElement('div');e.className=toast ${type};e.textContent=msg;document.getElementById('toasts').appendChild(e);setTimeout(()=>e.remove(),ms);}
function showModal(title,body,footer){
  closeModal();
  const ov=document.createElement('div');ov.className='mo';ov.id='modal-overlay';
  ov.innerHTML=<div class="md"><div class="mh"><h3>${title}</h3><button class="bi" onclick="closeModal()">‚úï Zamknij</button></div><div class="mb">${body}</div>${footer?<div class="mf">${footer}</div>:''}</div>;
  ov.addEventListener('click',e=>{if(e.target===ov)closeModal();});
  document.body.appendChild(ov);
}
function closeModal(){document.getElementById('modal-overlay')?.remove();}

function fd(v){if(!v)return'‚Äî';try{return new Date(v).toLocaleDateString('pl-PL',{day:'2-digit',month:'2-digit',year:'numeric'});}catch{return v;}}
function fdt(v){if(!v)return'‚Äî';try{return new Date(v).toLocaleString('pl-PL',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});}catch{return v;}}
function pb(s){const m={paid:'bg',unpaid:'br',pending:'bo',partial:'bo',waived:'bx'};return<span class="badge ${m[s]||'bx'}">${PS[s]||s||'‚Äî'}</span>;}
function sb(s){const m={confirmed:'bg',new:'bo',cancelled:'br',completed:'bx'};return<span class="badge ${m[s]||'bx'}">${RS[s]||s||'‚Äî'}</span>;}
function capB(r,m){const p=m?Math.min(100,Math.round(r/m*100)):0;const c=p>=100?'f':p>=80?'w':'';return<span class="cb"><span class="cf ${c}" style="width:${p}%"></span></span><span class="ct">${r}/${m||'?'}</span>;}
function initials(fn,ln){return((fn||'?')[0]+(ln||'?')[0]).toUpperCase();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadDash(){
  const c=document.getElementById('content');
  try{
    const d=await aF('/stats');
    c.innerHTML=
    <div class="stats-grid">
      <div class="sc accent"><div class="label">Wszystkie zapisy</div><div class="value">${d.total||0}</div></div>
      <div class="sc green"><div class="label">Op≈Çaceni</div><div class="value">${d.paid||0}</div></div>
      <div class="sc orange"><div class="label">OczekujƒÖcy</div><div class="value">${d.pending||0}</div></div>
      <div class="sc"><div class="label">Lista rezerwowa</div><div class="value">${d.waitlist||0}</div></div>
    </div>

    <div class="sh"><h3>Ob≈Ço≈ºenie lokalizacji</h3></div>
    <div class="tw" style="margin-bottom:28px"><table>
      <thead><tr><th>Miasto</th><th>≈ÅƒÖcznie</th><th>Op≈Çaceni</th><th>OczekujƒÖcy</th><th>Rezerwowa</th></tr></thead>
      <tbody>${(d.byLoc||[]).map(l=><tr>
        <td><strong style="color:var(--bright)">${l.city}</strong></td>
        <td><strong>${l.total}</strong></td>
        <td>${pb('paid')} <strong>${l.paid}</strong></td>
        <td>${l.pending}</td><td>${l.waitlist}</td>
      </tr>).join('')}</tbody>
    </table></div>

    <div class="sh"><h3>Ob≈Ço≈ºenie grup</h3></div>
    <div class="tw" style="margin-bottom:28px"><table>
      <thead><tr><th>Miasto</th><th>Grupa</th><th>Ob≈Ço≈ºenie</th><th></th></tr></thead>
      <tbody>${(d.byGroup||[]).map(g=><tr>
        <td>${g.city}</td><td><strong style="color:var(--bright)">${g.name}</strong></td>
        <td>${capB(g.registered,g.max_capacity)}</td>
        <td><button class="bi" onclick="navigate('groups')">Edytuj</button></td>
      </tr>).join('')}</tbody>
    </table></div>

    <div class="sh"><h3>Ostatnie zapisy</h3></div>
    <div class="tw"><table>
      <thead><tr><th>Kursant</th><th>Miasto</th><th>Grupa</th><th>Status</th><th>P≈Çatno≈õƒá</th><th>Data</th><th></th></tr></thead>
      <tbody>${(d.recent||[]).map(r=><tr>
        <td><strong style="color:var(--bright)">${r.name}</strong></td>
        <td>${r.city||'‚Äî'}</td><td>${r.group_name||'‚Äî'}</td>
        <td>${sb(r.status)}</td><td>${pb(r.payment_status)}</td>
        <td style="color:var(--dim);font-size:12px">${fdt(r.created_at)}</td>
        <td><button class="bi" onclick="openKartoteka(${r.id},'view')">Kartoteka</button></td>
      </tr>).join('')}</tbody>
    </table></div>;
  }catch(e){c.innerHTML=<div class="empty"><strong>B≈ÇƒÖd ≈Çadowania</strong>${e.message}</div>;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KARTOTEKA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openKartoteka(id, mode='view'){
  let r;
  let locations=[], groups=[], schedules=[], plans=[];
  try{
    const out = await Promise.all([
      aF(/registrations/${id}?_=${Date.now()}),
      aF('/locations'),
      aF('/groups'),
      aF('/schedules'),
      aF('/plans'),
    ]);
    r = out[0];
    locations = (out[1] && out[1].rows) ? out[1].rows : [];
    groups = (out[2] && out[2].rows) ? out[2].rows : [];
    schedules = (out[3] && out[3].rows) ? out[3].rows : [];
    plans = (out[4] && out[4].rows) ? out[4].rows : [];
  }catch(e){
    toast('B≈ÇƒÖd pobierania danych: '+e.message,'error');
    return;
  }

  const locOpts = locations.map(l =>
    <option value="${l.id}" ${l.id==r.location_id?'selected':''}>${l.city} ‚Äî ${l.name}</option>
  ).join('');

  function schedLabel(s){
    const day = DAYS[s.day_of_week] || s.day_of_week;
    const ts = s.time_start ? s.time_start.slice(0,5) : '';
    const te = s.time_end ? s.time_end.slice(0,5) : '';
    return ${day} ${ts}${te?‚Äì${te}:''}${s.address? ¬∑ ${s.address}:''};
  }

  const pO=<option value="">‚Äî brak karnetu ‚Äî</option>+plans.map(p=><option value="${p.id}" ${p.id==r.price_plan_id?'selected':''}>${p.name} ‚Äî ${p.price} z≈Ç / ${p.months} mies.</option>).join('');

  const isEdit = mode==='edit';
  const fld=(id,val,type='text',opts='')=>isEdit
    ?<input id="${id}" type="${type}" value="${val||''}" ${opts}>
    :<div class="view-val">${val||'‚Äî'}</div>;
  const txt=(id,val)=>isEdit
    ?<textarea id="${id}">${val||''}</textarea>
    :<div class="view-val" style="white-space:pre-wrap">${val||'‚Äî'}</div>;

  const payOpts=['paid','unpaid','pending','partial','waived'].map(v=><option value="${v}" ${r.payment_status===v?'selected':''}>${PS[v]||v}</option>).join('');
  const statOpts=['new','confirmed','cancelled','completed'].map(v=><option value="${v}" ${r.status===v?'selected':''}>${RS[v]||v}</option>).join('');
  const pmOpts=['cash','transfer','card'].map(v=><option value="${v}" ${r.payment_method===v?'selected':''}>${{cash:'Got√≥wka',transfer:'Przelew',card:'Karta'}[v]||v}</option>).join('');

  const body=
    <div class="kart-header">
      <div class="kart-avatar">${initials(r.first_name,r.last_name)}</div>
      <div>
        <div class="kart-name">${r.first_name} ${r.last_name}</div>
        <div class="kart-meta">${r.email||'brak email'} ¬∑ ${r.phone||'brak tel.'} ¬∑ ${r.city||'brak miasta'}</div>
        <div class="kart-badges">
          ${sb(r.status)} ${pb(r.payment_status)}
          ${r.is_waitlist?'<span class="badge bo">Lista rezerwowa</span>':''}
          <span class="badge ${r.source==='admin'?'bb':'bx'}">${r.source==='admin'?'Admin':'WWW'}</span>
        </div>
      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">Dane osobowe</div>
      <div class="fg">
        <div class="ff"><label>Imiƒô</label>${fld('k-fn',r.first_name)}</div>
        <div class="ff"><label>Nazwisko</label>${fld('k-ln',r.last_name)}</div>
        <div class="ff"><label>Email</label>${fld('k-em',r.email,'email')}</div>
        <div class="ff"><label>Telefon</label>${fld('k-ph',r.phone)}</div>
        <div class="ff"><label>Rok urodzenia</label>${fld('k-by',r.birth_year,'number')}</div>
        <div class="ff"><label>Typ kursanta</label>${isEdit
          ?<select id="k-in"><option value="true" ${r.is_new?'selected':''}>Nowy</option><option value="false" ${!r.is_new?'selected':''}>Kontynuacja</option></select>
          :<div class="view-val">${r.is_new?'Nowy kursant':'Kontynuacja'}</div>}
        </div>
      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">Organizacja treningu</div>
      <div class="fg">

        <div class="ff full">
          <label>Lokalizacja</label>
          ${isEdit
            ? <select id="k-loc">${locOpts}</select>
            : <div class="view-val">${r.city ? ${r.city} ‚Äî ${r.location_name||''} : '‚Äî'}</div>
          }
        </div>

        <div class="ff full">
          <label>Grupa</label>
          ${isEdit
            ? <select id="k-gr"></select>
            : <div class="view-val">${r.city ? ${r.city} ‚Äî  : ''}${r.group_name||'‚Äî'}</div>
          }
        </div>

        <div class="ff full">
          <label>Dzie≈Ñ i godzina z grafiku</label>
          ${isEdit
            ? <select id="k-sc"><option value="">‚Äî wybierz termin ‚Äî</option></select>
            : <div class="view-val">${r.schedule_id ? ${DAYS[r.schedule_day]||''} ${String(r.schedule_time_start||'').slice(0,5)}${r.schedule_time_end?‚Äì${String(r.schedule_time_end).slice(0,5)}:''} : '‚Äî'}</div>
          }
        </div>

        <div class="ff full">
          <label>Karnet</label>
          ${isEdit
            ? <select id="k-pl">${pO}</select>
            : <div class="view-val">${r.plan_name||'‚Äî'}</div>
          }
        </div>

        <div class="ff">
          <label>Data startu</label>
          ${fld('k-sd',r.start_date?r.start_date.slice(0,10):'','date')}
        </div>

        <div class="ff">
          <label>Lista rezerwowa</label>
          ${isEdit
            ? <select id="k-wl"><option value="false" ${!r.is_waitlist?'selected':''}>Nie</option><option value="true" ${r.is_waitlist?'selected':''}>Tak</option></select>
            : <div class="view-val">${r.is_waitlist?'Tak':'Nie'}</div>
          }
        </div>

      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">P≈Çatno≈õƒá</div>
      <div class="fg">
        <div class="ff"><label>Status p≈Çatno≈õci</label>${isEdit?<select id="k-ps">${payOpts}</select>:<div class="view-val">${pb(r.payment_status)}</div>}</div>
        <div class="ff"><label>Metoda</label>${isEdit?<select id="k-pm">${pmOpts}</select>:<div class="view-val">${{cash:'Got√≥wka',transfer:'Przelew',card:'Karta'}[r.payment_method]||r.payment_method||'‚Äî'}</div>}</div>
        <div class="ff"><label>Kwota (z≈Ç)</label>${fld('k-am',r.total_amount,'number')}</div>
        <div class="ff"><label>Kod ref.</label><div class="view-val" style="font-family:monospace;font-size:12px">${r.payment_ref||'‚Äî'}</div></div>
        <div class="ff"><label>Data op≈Çaty</label><div class="view-val">${fdt(r.paid_at)}</div></div>
        <div class="ff"><label>Status zapisu</label>${isEdit?<select id="k-st">${statOpts}</select>:<div class="view-val">${sb(r.status)}</div>}</div>
      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">Historia i notatki</div>
      <div class="fg">
        <div class="ff"><label>Data zapisu</label><div class="view-val">${fdt(r.created_at)}</div></div>
        <div class="ff"><label>Preferowany czas</label><div class="view-val">${r.preferred_time||'‚Äî'}</div></div>
        <div class="ff full"><label>Notatki admina</label>${txt('k-nt',r.admin_notes)}</div>
      </div>
    </div>;

  const footer=isEdit
    ?<button class="btn btn-secondary" onclick="openKartoteka(${id},'view')">Anuluj</button>
      <button class="btn btn-danger" style="background:var(--red-bg);border:1px solid var(--red-bdr);color:#ff6b4a;border-radius:5px;padding:8px 16px;font-size:13px;font-weight:600;cursor:pointer;font-family:'Barlow',sans-serif;text-transform:uppercase" onclick="delR(${id},'${r.first_name} ${r.last_name}',null)">Usu≈Ñ</button>
      <button class="btn btn-primary" onclick="saveKartoteka(${id})">Zapisz zmiany</button>
    :<button class="btn btn-secondary" onclick="closeModal()">Zamknij</button>
      <button class="btn btn-primary" onclick="openKartoteka(${id},'edit')">Edytuj kartotekƒô</button>;

  showModal(Kartoteka #${id}, body, footer);

  // ‚úÖ POPRAWKA: ten blok MUSI byƒá wewnƒÖtrz openKartoteka()
  if(mode==='edit'){
    const elLoc = document.getElementById('k-loc');
    const elGr  = document.getElementById('k-gr');
    const elSc  = document.getElementById('k-sc');

    function rebuildGroups(){
      const locId = parseInt(elLoc.value);
      const gList = groups.filter(g => parseInt(g.location_id) === locId);
      elGr.innerHTML = gList.map(g => <option value="${g.id}">${g.city} ‚Äî ${g.name}</option>).join('');
      const wanted = parseInt(r.group_id||0);
      if(gList.some(g=>g.id==wanted)) elGr.value = String(wanted);
      rebuildSchedules();
    }

    function rebuildSchedules(){
      const gid = parseInt(elGr.value||0);
      const sList = schedules.filter(s => parseInt(s.group_id) === gid);
      elSc.innerHTML = <option value="">‚Äî wybierz termin ‚Äî</option> + sList.map(s =>
        <option value="${s.id}">${schedLabel(s)}</option>
      ).join('');
      if(r.schedule_id && sList.some(s=>s.id==r.schedule_id)) elSc.value = String(r.schedule_id);
    }

    elLoc.addEventListener('change', rebuildGroups);
    elGr.addEventListener('change', rebuildSchedules);
    rebuildGroups();
  }
}

async function saveKartoteka(id){
  const b={
    first_name:document.getElementById('k-fn')?.value||undefined,
    last_name:document.getElementById('k-ln')?.value||undefined,
    email:document.getElementById('k-em')?.value||null,
    phone:document.getElementById('k-ph')?.value||null,
    birth_year:parseInt(document.getElementById('k-by')?.value)||null,
    is_new:document.getElementById('k-in')?.value==='true',
    group_id:parseInt(document.getElementById('k-gr')?.value)||null,
    schedule_id:parseInt(document.getElementById('k-sc')?.value)||null,
    price_plan_id:parseInt(document.getElementById('k-pl')?.value)||null,
    start_date:document.getElementById('k-sd')?.value||null,
    is_waitlist:document.getElementById('k-wl')?.value==='true',
    payment_status:document.getElementById('k-ps')?.value,
    payment_method:document.getElementById('k-pm')?.value,
    total_amount:parseFloat(document.getElementById('k-am')?.value)||0,
    status:document.getElementById('k-st')?.value,
    admin_notes:document.getElementById('k-nt')?.value||null,
  };
  Object.keys(b).forEach(k=>{if(b[k]===undefined)delete b[k];});
  try{
    await aF(/registrations/${id}?_=${Date.now()},{method:'PATCH',body:JSON.stringify(b)});
    toast('Kartoteka zapisana');
    openKartoteka(id,'view');
    if(CV==='web-registrations')fetchR('web');
    if(CV==='participants')fetchR('admin');
    if(CV==='dashboard')loadDash();
  }catch(e){toast('B≈ÇƒÖd: '+e.message,'error');}
}

/* DALEJ ZOSTAJE BEZ ZMIAN ‚Äì reszta Twojego pliku */
</script>
</body>
</html>

ChatGPT powiedzia≈Ç:

My≈õla≈Ç przez 21s
Pewnie. Masz jednƒÖ, konkretnƒÖ naprawƒô do wklejenia: dodaj brakujƒÖcƒÖ funkcjƒô loadAdd() (bo teraz panel wywala loadAdd is not defined i dlatego wszystko krƒôci k√≥≈Çko).

Wklej TEN BLOK KODU do public/admin.html tu≈º po funkcji loadDash() (czyli zaraz pod ko≈Ñcem sekcji DASHBOARD, zanim zaczyna siƒô ‚ÄûKARTOTEKA‚Äù).

<script>
/* ... zostawiasz wszystko jak masz ... */

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DODAJ KURSANTA (BRAKUJƒÑCA FUNKCJA ‚Äî NAPRAWA "loadAdd is not defined")
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAdd(){
  const c = document.getElementById('content');

  c.innerHTML = `
    <div class="ib">
      <strong>Dodaj kursanta rƒôcznie</strong><br>
      To zapis z poziomu admina. Po zapisaniu kursant trafi do bazy i od razu otworzy siƒô kartoteka.
    </div>

    <div class="tw" style="padding:18px">
      <div class="fg">
        <div class="ff"><label>Imiƒô *</label><input id="a-fn" type="text" placeholder="np. Jan"></div>
        <div class="ff"><label>Nazwisko *</label><input id="a-ln" type="text" placeholder="np. Kowalski"></div>

        <div class="ff"><label>Email</label><input id="a-em" type="email" placeholder="np. jan@email.pl"></div>
        <div class="ff"><label>Telefon</label><input id="a-ph" type="text" placeholder="np. 600 000 000"></div>

        <div class="ff"><label>Rok urodzenia</label><input id="a-by" type="number" placeholder="np. 1992"></div>
        <div class="ff">
          <label>Typ kursanta</label>
          <select id="a-in">
            <option value="true">Nowy</option>
            <option value="false">Kontynuacja</option>
          </select>
        </div>

        <div class="ff full">
          <label>Lokalizacja *</label>
          <select id="a-loc"><option value="">≈Åadowanie‚Ä¶</option></select>
        </div>

        <div class="ff full">
          <label>Grupa *</label>
          <select id="a-gr"><option value="">Najpierw wybierz lokalizacjƒô</option></select>
        </div>

        <div class="ff full">
          <label>Termin z grafiku</label>
          <select id="a-sc"><option value="">‚Äî opcjonalnie ‚Äî</option></select>
        </div>

        <div class="ff full">
          <label>Karnet</label>
          <select id="a-pl"><option value="">≈Åadowanie‚Ä¶</option></select>
        </div>

        <div class="ff"><label>Data startu</label><input id="a-sd" type="date"></div>

        <div class="ff">
          <label>Status zapisu</label>
          <select id="a-st">
            <option value="new">Nowy</option>
            <option value="confirmed">Potwierdzony</option>
            <option value="cancelled">Anulowany</option>
            <option value="completed">Zako≈Ñczony</option>
          </select>
        </div>

        <div class="ff">
          <label>Status p≈Çatno≈õci</label>
          <select id="a-ps">
            <option value="unpaid">Nieop≈Çacony</option>
            <option value="pending">OczekujƒÖcy</option>
            <option value="paid">Op≈Çacony</option>
            <option value="partial">Czƒô≈õciowy</option>
            <option value="waived">Zwolniony</option>
          </select>
        </div>

        <div class="ff">
          <label>Metoda p≈Çatno≈õci</label>
          <select id="a-pm">
            <option value="transfer">Przelew</option>
            <option value="cash">Got√≥wka</option>
            <option value="card">Karta</option>
          </select>
        </div>

        <div class="ff"><label>Kwota (z≈Ç)</label><input id="a-am" type="number" step="0.01" value="0"></div>

        <div class="ff full"><label>Notatka admina</label><textarea id="a-nt" placeholder="Opcjonalnie‚Ä¶"></textarea></div>
      </div>

      <div style="display:flex;gap:10px

Powiedzia≈Çe≈õ(-a≈õ):
po to da≈Çam Ci ca≈Çy kod ≈ºeby≈õ z nim zrobi≈Ç co trzeba i da≈Ç mi ca≈Çy naprawiony.
Jeszcze raz zasady:
1. jedno zadanie/polecenie/komenda to jedna wiadomo≈õƒá
2. Nie podmieniam, nie wymieniam, nie szukam fragment√≥w kod√≥w. Wymieniam tylko kody w ca≈Ço≈õci

ChatGPT powiedzia≈Ç:
<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Panel Admina ‚Äî Krav Maga Saggita</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800&family=Barlow:wght@400;500;600&display=swap');
:root{
  --bg:#0f0b0b;--surface:#1c1414;--surface2:#241c1c;--surface3:#2c2222;
  --border:#3a2828;--border2:#4a3232;
  --red:#c42000;--red-l:#e83000;--red-bg:rgba(196,32,0,.12);--red-bdr:rgba(196,32,0,.35);
  --orange:#e8a500;--or-bg:rgba(232,165,0,.12);--or-bdr:rgba(232,165,0,.35);
  --green:#2ecc71;--gr-bg:rgba(46,204,113,.1);--gr-bdr:rgba(46,204,113,.3);
  --blue:#4a9fe8;--bl-bg:rgba(74,159,232,.1);--bl-bdr:rgba(74,159,232,.3);
  --text:#e8dada;--dim:#9a8080;--muted:#6a5555;--bright:#fff;
  --sw:215px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Barlow',sans-serif;font-size:14px;line-height:1.5}
#app{display:flex;height:100vh;overflow:hidden}
#sidebar{width:var(--sw);min-width:var(--sw);background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column}
#sidebar-logo{padding:20px 16px 16px;border-bottom:1px solid var(--border)}
#sidebar-logo h1{font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:19px;letter-spacing:.03em;color:var(--bright);line-height:1.1;text-transform:uppercase}
#sidebar-logo h1 em{color:var(--red-l);font-style:normal}
#sidebar-logo small{color:var(--muted);font-size:10px;text-transform:uppercase;letter-spacing:.1em}
nav{flex:1;padding:8px;overflow-y:auto}
nav a{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:5px;color:var(--dim);font-weight:500;font-size:13px;transition:all .15s;cursor:pointer;margin-bottom:1px;text-decoration:none}
nav a:hover{color:var(--bright);background:var(--surface2)}
nav a.active{color:var(--bright);background:var(--red-bg);border-left:2px solid var(--red-l);padding-left:8px}
.nd{width:4px;height:4px;border-radius:50%;background:var(--border2);flex-shrink:0;transition:background .15s}
nav a:hover .nd{background:var(--dim)}
nav a.active .nd{background:var(--red-l)}
.sl{font-size:10px;font-weight:700;letter-spacing:.12em;color:var(--red);padding:14px 10px 4px;text-transform:uppercase;opacity:.7}
#sf{padding:12px;border-top:1px solid var(--border)}
.ui{font-size:11px;color:var(--muted);margin-bottom:8px}
.ui strong{display:block;color:var(--text);font-size:13px}
#btn-logout{width:100%;padding:7px;background:transparent;border:1px solid var(--border2);border-radius:4px;color:var(--dim);cursor:pointer;font-size:12px;font-family:'Barlow',sans-serif;transition:all .15s}
#btn-logout:hover{border-color:var(--red);color:var(--red);background:var(--red-bg)}
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}
#topbar{height:50px;min-height:50px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;gap:16px}
#topbar h2{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:800;color:var(--bright);text-transform:uppercase;letter-spacing:.05em;flex:1}
#api-status{font-size:11px;padding:4px 12px;border-radius:4px;font-weight:700;text-transform:uppercase;letter-spacing:.06em}
#api-status.ok{background:var(--gr-bg);color:var(--green);border:1px solid var(--gr-bdr)}
#api-status.err{background:var(--red-bg);color:var(--red-l);border:1px solid var(--red-bdr)}
#content{flex:1;overflow-y:auto;padding:24px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:28px}
.sc{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:18px 20px;position:relative;overflow:hidden}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--border2)}
.sc.accent::before{background:var(--red-l)}.sc.green::before{background:var(--green)}.sc.orange::before{background:var(--orange)}
.sc .label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);margin-bottom:8px}
.sc .value{font-family:'Barlow Condensed',sans-serif;font-size:42px;font-weight:800;line-height:1;color:var(--bright)}
.sc.accent .value{color:var(--red-l)}.sc.green .value{color:var(--green)}.sc.orange .value{color:var(--orange)}
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.sh h3{font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:700;color:var(--bright);text-transform:uppercase;letter-spacing:.05em;border-left:3px solid var(--red);padding-left:10px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:5px;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;border:none;font-family:'Barlow',sans-serif;text-transform:uppercase;letter-spacing:.05em;line-height:1}
.btn-primary{background:var(--red);color:#fff}.btn-primary:hover{background:var(--red-l)}
.btn-secondary{background:var(--surface2);border:1px solid var(--border2);color:var(--text)}.btn-secondary:hover{border-color:var(--red);color:var(--bright)}
.btn-sm{padding:5px 10px;font-size:11px}
.bi{padding:5px 10px;background:var(--surface3);border:1px solid var(--border2);border-radius:4px;color:var(--dim);cursor:pointer;transition:all .15s;font-size:11px;font-family:'Barlow',sans-serif;font-weight:600;text-transform:uppercase;letter-spacing:.04em;line-height:1.4}
.bi:hover{color:var(--bright);background:var(--surface2)}.bi.del:hover{border-color:var(--red);color:var(--red);background:var(--red-bg)}
.fb{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:12px}
.fb input,.fb select{background:var(--surface2);border:1px solid var(--border2);border-radius:4px;color:var(--text);padding:7px 10px;font-size:13px;font-family:'Barlow',sans-serif;outline:none;transition:border-color .15s}
.fb input:focus,.fb select:focus{border-color:var(--red)}.fb input[type=text]{min-width:220px}.fb select{min-width:150px}
.tw{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden}
table{width:100%;border-collapse:collapse}
thead th{background:var(--surface2);padding:11px 14px;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);white-space:nowrap;border-bottom:2px solid var(--border2)}
tbody tr{border-top:1px solid var(--border);transition:background .1s}
tbody tr:hover{background:var(--surface2)}
tbody td{padding:11px 14px;font-size:13px;vertical-align:middle;color:var(--text)}
.tda{display:flex;gap:5px;flex-wrap:wrap}
.badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;line-height:1.4}
.bg{background:var(--gr-bg);color:var(--green);border:1px solid var(--gr-bdr)}
.br{background:var(--red-bg);color:#ff6b4a;border:1px solid var(--red-bdr)}
.bo{background:var(--or-bg);color:var(--orange);border:1px solid var(--or-bdr)}
.bx{background:var(--surface3);color:var(--dim);border:1px solid var(--border2)}
.bb{background:var(--bl-bg);color:var(--blue);border:1px solid var(--bl-bdr)}
.cb{width:80px;height:5px;background:var(--surface3);border-radius:3px;display:inline-block;vertical-align:middle;margin-right:7px}
.cf{height:100%;background:var(--green);border-radius:3px}.cf.w{background:var(--orange)}.cf.f{background:var(--red-l)}
.ct{font-size:12px;color:var(--dim)}
.pag{display:flex;align-items:center;gap:10px;margin-top:16px;justify-content:center}
.pag button{background:var(--surface2);border:1px solid var(--border2);color:var(--dim);padding:7px 16px;border-radius:5px;cursor:pointer;font-size:12px;font-family:'Barlow',sans-serif;font-weight:600;text-transform:uppercase;letter-spacing:.05em;transition:all .15s}
.pag button:hover:not(:disabled){border-color:var(--red);color:var(--bright)}.pag button:disabled{opacity:.3;cursor:not-allowed}
.pag .pi{font-size:12px;color:var(--dim)}
.mo{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(3px)}
.md{background:var(--surface);border:1px solid var(--border2);border-radius:10px;width:100%;max-width:720px;max-height:92vh;overflow-y:auto;box-shadow:0 32px 80px rgba(0,0,0,.7)}
.mh{padding:18px 22px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1}
.mh h3{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:var(--bright);text-transform:uppercase;letter-spacing:.05em}
.mb{padding:22px}.mf{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;background:var(--surface2);position:sticky;bottom:0}
/* KARTOTEKA */
.kart-header{background:var(--surface2);border:1px solid var(--border2);border-radius:8px;padding:18px 20px;margin-bottom:20px;display:flex;align-items:center;gap:16px}
.kart-avatar{width:52px;height:52px;border-radius:50%;background:var(--red-bg);border:2px solid var(--red-bdr);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:22px;color:var(--red-l);flex-shrink:0}
.kart-name{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--bright);text-transform:uppercase}
.kart-meta{font-size:12px;color:var(--dim);margin-top:3px}
.kart-badges{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.ksec{border-top:1px solid var(--border);margin-top:18px;padding-top:16px}
.ksec-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--red);margin-bottom:12px}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fg .full{grid-column:1 / -1}
.ff{display:flex;flex-direction:column;gap:6px}
.ff label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--dim)}
.ff input,.ff select,.ff textarea{background:var(--surface2);border:1px solid var(--border2);border-radius:5px;color:var(--bright);padding:9px 11px;font-size:13px;font-family:'Barlow',sans-serif;outline:none;transition:all .15s;width:100%}
.ff input:focus,.ff select:focus,.ff textarea:focus{border-color:var(--red);box-shadow:0 0 0 2px var(--red-bg)}
.ff textarea{resize:vertical;min-height:70px}
select option{background:#1c1414}
/* VIEW mode */
.ff .view-val{font-size:14px;color:var(--bright);font-weight:500;padding:4px 0;border-bottom:1px solid var(--border);min-height:28px}
#login-screen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9000}
.lb{background:var(--surface);border:1px solid var(--border2);border-radius:10px;padding:40px;width:360px;box-shadow:0 40px 100px rgba(0,0,0,.8)}
.lb .logo{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;color:var(--bright);text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px}
.lb .logo em{color:var(--red-l);font-style:normal}
.lb p{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.1em;margin-bottom:28px}
.lb label{display:block;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);margin-bottom:6px}
.lb input{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:5px;color:var(--bright);padding:11px 13px;font-size:14px;font-family:'Barlow',sans-serif;outline:none;transition:all .15s;margin-bottom:14px}
.lb input:focus{border-color:var(--red);box-shadow:0 0 0 2px var(--red-bg)}
#login-btn{width:100%;padding:12px;background:var(--red);border:none;border-radius:5px;color:#fff;font-weight:700;font-size:15px;font-family:'Barlow Condensed',sans-serif;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;margin-top:4px;transition:background .15s}
#login-btn:hover{background:var(--red-l)}
#login-error{color:#ff6b4a;font-size:12px;margin-top:10px;display:none}
#toasts{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 18px;border-radius:6px;font-size:13px;font-weight:600;box-shadow:0 8px 32px rgba(0,0,0,.5);max-width:320px;animation:si .2s ease}
.toast.success{background:var(--green);color:#000}.toast.error{background:var(--red-l);color:#fff}.toast.info{background:var(--surface2);border:1px solid var(--border2);color:var(--text)}
@keyframes si{from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1}}
.loader{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--dim);gap:12px;font-size:13px}
.spinner{width:20px;height:20px;border:2px solid var(--border2);border-top-color:var(--red-l);border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.empty{padding:60px;text-align:center;color:var(--dim)}.empty strong{display:block;font-size:16px;color:var(--text);margin-bottom:8px}
.ib{background:var(--surface2);border-left:3px solid var(--red);border-radius:0 5px 5px 0;padding:10px 14px;font-size:12px;color:var(--dim);margin-bottom:16px;line-height:1.6}
.ib strong{color:var(--bright)}
</style>
</head>
<body>

<div id="login-screen">
  <div class="lb">
    <div class="logo">Krav Maga <em>Saggita</em></div>
    <p>Panel Administratora</p>
    <label>Login</label>
    <input type="text" id="l-user" placeholder="username" autocomplete="username"/>
    <label>Has≈Ço</label>
    <input type="password" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
    <button id="login-btn">Zaloguj siƒô</button>
    <div id="login-error"></div>
  </div>
</div>

<div id="app" style="display:none">
  <aside id="sidebar">
    <div id="sidebar-logo">
      <h1>Krav Maga <em>Saggita</em></h1>
      <small>Panel Admina</small>
    </div>
    <nav>
      <a data-view="dashboard" class="active"><span class="nd"></span> Dashboard</a>
      <div class="sl">Kursanci</div>
      <a data-view="web-registrations"><span class="nd"></span> Zapisy ze strony</a>
      <a data-view="participants"><span class="nd"></span> Baza kursant√≥w</a>
      <a data-view="add-participant"><span class="nd"></span> Dodaj kursanta</a>
      <div class="sl">Organizacja</div>
      <a data-view="groups"><span class="nd"></span> Grupy</a>
      <a data-view="schedules"><span class="nd"></span> Grafik zajƒôƒá</a>
      <a data-view="locations"><span class="nd"></span> Lokalizacje</a>
      <div class="sl">Export</div>
      <a id="btn-export"><span class="nd"></span> Pobierz CSV</a>
    </nav>
    <div id="sf">
      <div class="ui"><small>Zalogowany jako</small><strong id="admin-username">‚Äî</strong></div>
      <button id="btn-logout">Wyloguj</button>
    </div>
  </aside>
  <main id="main">
    <div id="topbar">
      <h2 id="page-title">Dashboard</h2>
      <span id="api-status" class="ok">API OK</span>
    </div>
    <div id="content"></div>
  </main>
</div>
<div id="toasts"></div>

<script>
const API='/api/admin-api'; // BEZ ko≈Ñcowego /
let TOKEN=localStorage.getItem('km_token')||'';
let CV='dashboard',ro=0,rt=0;
const RL=30;
let rf={};
const DAYS=['Niedziela','Poniedzia≈Çek','Wtorek','≈öroda','Czwartek','PiƒÖtek','Sobota'];
const CAT={kids:'Dzieci',youth:'M≈Çodzie≈º',adults:'Doro≈õli',vip:'VIP',women:'Kobiety'};

// ‚úÖ PE≈ÅNE MAPOWANIE
const PS={
  paid:'Op≈Çacony', unpaid:'Nieop≈Çacony', pending:'OczekujƒÖcy',
  partial:'Czƒô≈õciowy', waived:'Zwolniony'
};
const RS={new:'Nowy',confirmed:'Potwierdzony',cancelled:'Anulowany',completed:'Zako≈Ñczony'};

async function aF(path,opts={}){
  const h={'Content-Type':'application/json'};
  if(TOKEN)h['Authorization']=`Bearer ${TOKEN}`;

  const url = API + (path.startsWith('/') ? path : '/' + path);

  try{
    const r=await fetch(url,{headers:h,...opts});
    const d=await r.json().catch(()=>({error:'B≈ÇƒÖd odpowiedzi serwera'}));
    if(!r.ok)throw new Error(d.error||`B≈ÇƒÖd HTTP ${r.status}`);
    setAS(true);return d;
  }catch(e){setAS(false);throw e;}
}
function setAS(ok){const e=document.getElementById('api-status');e.textContent=ok?'API OK':'API ERROR';e.className=ok?'ok':'err';}

async function checkLogin(){if(!TOKEN)return showLogin();try{await aF('/stats');showApp();}catch{showLogin();}}
function showLogin(){document.getElementById('login-screen').style.display='flex';document.getElementById('app').style.display='none';}
function showApp(){
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='flex';
  try{
    const u=JSON.parse(atob(TOKEN.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));
    document.getElementById('admin-username').textContent=u.username||'‚Äî';
  }catch{}
  navigate('dashboard');
}
document.getElementById('login-btn').addEventListener('click',async()=>{
  const u=document.getElementById('l-user').value.trim(),p=document.getElementById('l-pass').value;
  const e=document.getElementById('login-error');e.style.display='none';
  if(!u||!p){e.textContent='Podaj login i has≈Ço.';e.style.display='block';return;}
  try{
    const d=await aF('/login',{method:'POST',body:JSON.stringify({username:u,password:p})});
    TOKEN=d.token;localStorage.setItem('km_token',TOKEN);showApp();
  }catch(err){e.textContent=err.message;e.style.display='block';}
});
document.getElementById('l-pass').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('login-btn').click();});
document.getElementById('btn-logout').addEventListener('click',()=>{TOKEN='';localStorage.removeItem('km_token');showLogin();});

function navigate(view){
  CV=view;
  document.querySelectorAll('nav a[data-view]').forEach(a=>a.classList.toggle('active',a.dataset.view===view));
  const titles={dashboard:'Dashboard','web-registrations':'Zapisy ze strony',participants:'Baza kursant√≥w','add-participant':'Dodaj kursanta',groups:'Grupy',schedules:'Grafik zajƒôƒá',locations:'Lokalizacje'};
  document.getElementById('page-title').textContent=titles[view]||view;
  document.getElementById('content').innerHTML='<div class="loader"><div class="spinner"></div> ≈Åadowanie‚Ä¶</div>';
  const fns={
    dashboard:loadDash,
    'web-registrations':()=>loadReg('web'),
    participants:()=>loadReg('admin'),
    'add-participant':loadAdd,             // ‚úÖ FIX: funkcja istnieje poni≈ºej
    groups:loadGroups,
    schedules:loadSchedules,
    locations:loadLocations
  };
  (fns[view]||(() =>document.getElementById('content').innerHTML=''))();
}
document.querySelectorAll('nav a[data-view]').forEach(a=>a.addEventListener('click',()=>navigate(a.dataset.view)));

function toast(msg,type='success',ms=3500){
  const e=document.createElement('div');
  e.className=`toast ${type}`;
  e.textContent=msg;
  document.getElementById('toasts').appendChild(e);
  setTimeout(()=>e.remove(),ms);
}
function showModal(title,body,footer){
  closeModal();
  const ov=document.createElement('div');ov.className='mo';ov.id='modal-overlay';
  ov.innerHTML=`<div class="md"><div class="mh"><h3>${title}</h3><button class="bi" onclick="closeModal()">‚úï Zamknij</button></div><div class="mb">${body}</div>${footer?`<div class="mf">${footer}</div>`:''}</div>`;
  ov.addEventListener('click',e=>{if(e.target===ov)closeModal();});
  document.body.appendChild(ov);
}
function closeModal(){document.getElementById('modal-overlay')?.remove();}

function fd(v){if(!v)return'‚Äî';try{return new Date(v).toLocaleDateString('pl-PL',{day:'2-digit',month:'2-digit',year:'numeric'});}catch{return v;}}
function fdt(v){if(!v)return'‚Äî';try{return new Date(v).toLocaleString('pl-PL',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});}catch{return v;}}
function pb(s){const m={paid:'bg',unpaid:'br',pending:'bo',partial:'bo',waived:'bx'};return`<span class="badge ${m[s]||'bx'}">${PS[s]||s||'‚Äî'}</span>`;}
function sb(s){const m={confirmed:'bg',new:'bo',cancelled:'br',completed:'bx'};return`<span class="badge ${m[s]||'bx'}">${RS[s]||s||'‚Äî'}</span>`;}
function capB(r,m){const p=m?Math.min(100,Math.round(r/m*100)):0;const c=p>=100?'f':p>=80?'w':'';return`<span class="cb"><span class="cf ${c}" style="width:${p}%"></span></span><span class="ct">${r}/${m||'?'}</span>`;}
function initials(fn,ln){return((fn||'?')[0]+(ln||'?')[0]).toUpperCase();}

function arrRows(x){
  if(!x) return [];
  if(Array.isArray(x)) return x;
  if(Array.isArray(x.rows)) return x.rows;
  if(Array.isArray(x.data)) return x.data;
  return [];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT CSV (autoryzowane pobranie ‚Äî bez otwierania nowej karty)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('btn-export').addEventListener('click', async ()=>{
  try{
    const url = API + '/export';
    const r = await fetch(url, { headers: TOKEN ? { 'Authorization': `Bearer ${TOKEN}` } : {} });
    if(!r.ok){
      const t = await r.text().catch(()=> '');
      throw new Error(t || `B≈ÇƒÖd pobierania CSV (${r.status})`);
    }
    const blob = await r.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `saggita-export-${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    toast('CSV pobrane','success');
  }catch(e){
    toast('B≈ÇƒÖd CSV: '+e.message,'error');
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadDash(){
  const c=document.getElementById('content');
  try{
    const d=await aF('/stats');
    c.innerHTML=`
    <div class="stats-grid">
      <div class="sc accent"><div class="label">Wszystkie zapisy</div><div class="value">${d.total||0}</div></div>
      <div class="sc green"><div class="label">Op≈Çaceni</div><div class="value">${d.paid||0}</div></div>
      <div class="sc orange"><div class="label">OczekujƒÖcy</div><div class="value">${d.pending||0}</div></div>
      <div class="sc"><div class="label">Lista rezerwowa</div><div class="value">${d.waitlist||0}</div></div>
    </div>

    <div class="sh"><h3>Ob≈Ço≈ºenie lokalizacji</h3></div>
    <div class="tw" style="margin-bottom:28px"><table>
      <thead><tr><th>Miasto</th><th>≈ÅƒÖcznie</th><th>Op≈Çaceni</th><th>OczekujƒÖcy</th><th>Rezerwowa</th></tr></thead>
      <tbody>${arrRows(d.byLoc).map(l=>`<tr>
        <td><strong style="color:var(--bright)">${l.city||'‚Äî'}</strong></td>
        <td><strong>${l.total||0}</strong></td>
        <td>${pb('paid')} <strong>${l.paid||0}</strong></td>
        <td>${l.pending||0}</td><td>${l.waitlist||0}</td>
      </tr>`).join('')}</tbody>
    </table></div>

    <div class="sh"><h3>Ob≈Ço≈ºenie grup</h3></div>
    <div class="tw" style="margin-bottom:28px"><table>
      <thead><tr><th>Miasto</th><th>Grupa</th><th>Ob≈Ço≈ºenie</th><th></th></tr></thead>
      <tbody>${arrRows(d.byGroup).map(g=>`<tr>
        <td>${g.city||'‚Äî'}</td><td><strong style="color:var(--bright)">${g.name||'‚Äî'}</strong></td>
        <td>${capB(g.registered||0,g.max_capacity||0)}</td>
        <td><button class="bi" onclick="navigate('groups')">Edytuj</button></td>
      </tr>`).join('')}</tbody>
    </table></div>

    <div class="sh"><h3>Ostatnie zapisy</h3></div>
    <div class="tw"><table>
      <thead><tr><th>Kursant</th><th>Miasto</th><th>Grupa</th><th>Status</th><th>P≈Çatno≈õƒá</th><th>Data</th><th></th></tr></thead>
      <tbody>${arrRows(d.recent).map(r=>`<tr>
        <td><strong style="color:var(--bright)">${r.name||`${r.first_name||''} ${r.last_name||''}`.trim()||'‚Äî'}</strong></td>
        <td>${r.city||'‚Äî'}</td><td>${r.group_name||'‚Äî'}</td>
        <td>${sb(r.status)}</td><td>${pb(r.payment_status)}</td>
        <td style="color:var(--dim);font-size:12px">${fdt(r.created_at)}</td>
        <td><button class="bi" onclick="openKartoteka(${r.id},'view')">Kartoteka</button></td>
      </tr>`).join('')}</tbody>
    </table></div>`;
  }catch(e){c.innerHTML=`<div class="empty"><strong>B≈ÇƒÖd ≈Çadowania</strong>${e.message}</div>`;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ZAPISY (WWW / ADMIN)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadReg(source){
  ro=0; rf={source, q:'', payment:'', status:''};
  renderRegShell(source);
  await fetchR(source);
}
function renderRegShell(source){
  const c=document.getElementById('content');
  c.innerHTML = `
    <div class="sh"><h3>${source==='web'?'Zapisy ze strony':'Baza kursant√≥w'}</h3></div>

    <div class="fb">
      <input id="r-q" type="text" placeholder="Szukaj: imiƒô, nazwisko, email, tel‚Ä¶" />
      <select id="r-st">
        <option value="">Status: wszystkie</option>
        <option value="new">Nowy</option>
        <option value="confirmed">Potwierdzony</option>
        <option value="cancelled">Anulowany</option>
        <option value="completed">Zako≈Ñczony</option>
      </select>
      <select id="r-ps">
        <option value="">P≈Çatno≈õƒá: wszystkie</option>
        <option value="unpaid">Nieop≈Çacony</option>
        <option value="pending">OczekujƒÖcy</option>
        <option value="paid">Op≈Çacony</option>
        <option value="partial">Czƒô≈õciowy</option>
        <option value="waived">Zwolniony</option>
      </select>
      <button class="btn btn-secondary btn-sm" id="r-apply">Filtruj</button>
      <button class="btn btn-secondary btn-sm" id="r-clear">Wyczy≈õƒá</button>
    </div>

    <div class="tw">
      <table>
        <thead>
          <tr>
            <th>Kursant</th><th>Miasto</th><th>Grupa</th><th>Status</th><th>P≈Çatno≈õƒá</th><th>≈πr√≥d≈Ço</th><th>Data</th><th></th>
          </tr>
        </thead>
        <tbody id="r-body">
          <tr><td colspan="8"><div class="loader"><div class="spinner"></div> ≈Åadowanie‚Ä¶</div></td></tr>
        </tbody>
      </table>
    </div>

    <div class="pag">
      <button id="r-prev" disabled>Wstecz</button>
      <div class="pi" id="r-pi">‚Äî</div>
      <button id="r-next" disabled>Dalej</button>
    </div>
  `;
  document.getElementById('r-apply').addEventListener('click', async ()=>{
    rf.q=document.getElementById('r-q').value.trim();
    rf.status=document.getElementById('r-st').value;
    rf.payment=document.getElementById('r-ps').value;
    ro=0;
    await fetchR(source);
  });
  document.getElementById('r-clear').addEventListener('click', async ()=>{
    document.getElementById('r-q').value='';
    document.getElementById('r-st').value='';
    document.getElementById('r-ps').value='';
    rf.q=''; rf.status=''; rf.payment='';
    ro=0;
    await fetchR(source);
  });
  document.getElementById('r-prev').addEventListener('click', async ()=>{
    ro=Math.max(0, ro-RL);
    await fetchR(source);
  });
  document.getElementById('r-next').addEventListener('click', async ()=>{
    ro=ro+RL;
    await fetchR(source);
  });
}
async function fetchR(source){
  const bodyEl=document.getElementById('r-body');
  const pi=document.getElementById('r-pi');
  const prev=document.getElementById('r-prev');
  const next=document.getElementById('r-next');

  bodyEl.innerHTML = `<tr><td colspan="8"><div class="loader"><div class="spinner"></div> ≈Åadowanie‚Ä¶</div></td></tr>`;
  try{
    const qs = new URLSearchParams();
    qs.set('limit', String(RL));
    qs.set('offset', String(ro));
    qs.set('source', source); // backend zwykle filtruje po source
    if(rf.q) qs.set('q', rf.q);
    if(rf.status) qs.set('status', rf.status);
    if(rf.payment) qs.set('payment_status', rf.payment);

    const d = await aF(`/registrations?${qs.toString()}&_=${Date.now()}`);
    const rows = arrRows(d);
    const total = d.total ?? d.count ?? (Array.isArray(d)? d.length : rows.length);

    if(!rows.length){
      bodyEl.innerHTML = `<tr><td colspan="8"><div class="empty"><strong>Brak wynik√≥w</strong>Zmieniƒá filtry lub wyszukiwanie.</div></td></tr>`;
      pi.textContent = `0 / ${total||0}`;
      prev.disabled = ro<=0;
      next.disabled = true;
      return;
    }

    bodyEl.innerHTML = rows.map(r=>`
      <tr>
        <td><strong style="color:var(--bright)">${(r.first_name||'')+' '+(r.last_name||'')}</strong><div style="color:var(--dim);font-size:12px">${r.email||'‚Äî'} ¬∑ ${r.phone||'‚Äî'}</div></td>
        <td>${r.city||r.location_city||'‚Äî'}</td>
        <td>${r.group_name||'‚Äî'}</td>
        <td>${sb(r.status)}</td>
        <td>${pb(r.payment_status)}</td>
        <td><span class="badge ${r.source==='admin'?'bb':'bx'}">${r.source==='admin'?'Admin':'WWW'}</span></td>
        <td style="color:var(--dim);font-size:12px">${fdt(r.created_at)}</td>
        <td class="tda">
          <button class="bi" onclick="openKartoteka(${r.id},'view')">Kartoteka</button>
        </td>
      </tr>
    `).join('');

    const shownFrom = Math.min(total|| (ro+rows.length), ro+1);
    const shownTo = ro+rows.length;
    pi.textContent = `${shownFrom}-${shownTo} / ${total||shownTo}`;
    prev.disabled = ro<=0;
    next.disabled = total ? (shownTo>=total) : (rows.length<RL);
  }catch(e){
    bodyEl.innerHTML = `<tr><td colspan="8"><div class="empty"><strong>B≈ÇƒÖd</strong>${e.message}</div></td></tr>`;
    pi.textContent = `‚Äî`;
    prev.disabled = true;
    next.disabled = true;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DODAJ KURSANTA ‚Äî FIX (wcze≈õniej by≈Ço "loadAdd is not defined")
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAdd(){
  const c=document.getElementById('content');

  c.innerHTML = `
    <div class="sh"><h3>Dodaj kursanta</h3></div>
    <div class="ib">
      <strong>To jest zapis z poziomu admina.</strong><br>
      Po zapisaniu kursant trafi do bazy i od razu otworzy siƒô kartoteka.
    </div>

    <div class="tw" style="padding:18px">
      <div class="fg">
        <div class="ff"><label>Imiƒô *</label><input id="a-fn" type="text" placeholder="np. Jan"></div>
        <div class="ff"><label>Nazwisko *</label><input id="a-ln" type="text" placeholder="np. Kowalski"></div>

        <div class="ff"><label>Email</label><input id="a-em" type="email" placeholder="np. jan@email.pl"></div>
        <div class="ff"><label>Telefon</label><input id="a-ph" type="text" placeholder="np. 600 000 000"></div>

        <div class="ff"><label>Rok urodzenia</label><input id="a-by" type="number" placeholder="np. 1992"></div>
        <div class="ff">
          <label>Typ kursanta</label>
          <select id="a-in">
            <option value="true">Nowy</option>
            <option value="false">Kontynuacja</option>
          </select>
        </div>

        <div class="ff full">
          <label>Lokalizacja *</label>
          <select id="a-loc"><option value="">≈Åadowanie‚Ä¶</option></select>
        </div>

        <div class="ff full">
          <label>Grupa *</label>
          <select id="a-gr"><option value="">Najpierw wybierz lokalizacjƒô</option></select>
        </div>

        <div class="ff full">
          <label>Termin z grafiku</label>
          <select id="a-sc"><option value="">‚Äî opcjonalnie ‚Äî</option></select>
        </div>

        <div class="ff full">
          <label>Karnet</label>
          <select id="a-pl"><option value="">≈Åadowanie‚Ä¶</option></select>
        </div>

        <div class="ff"><label>Data startu</label><input id="a-sd" type="date"></div>

        <div class="ff">
          <label>Status zapisu</label>
          <select id="a-st">
            <option value="new">Nowy</option>
            <option value="confirmed">Potwierdzony</option>
            <option value="cancelled">Anulowany</option>
            <option value="completed">Zako≈Ñczony</option>
          </select>
        </div>

        <div class="ff">
          <label>Status p≈Çatno≈õci</label>
          <select id="a-ps">
            <option value="unpaid">Nieop≈Çacony</option>
            <option value="pending">OczekujƒÖcy</option>
            <option value="paid">Op≈Çacony</option>
            <option value="partial">Czƒô≈õciowy</option>
            <option value="waived">Zwolniony</option>
          </select>
        </div>

        <div class="ff">
          <label>Metoda p≈Çatno≈õci</label>
          <select id="a-pm">
            <option value="transfer">Przelew</option>
            <option value="cash">Got√≥wka</option>
            <option value="card">Karta</option>
          </select>
        </div>

        <div class="ff"><label>Kwota (z≈Ç)</label><input id="a-am" type="number" step="0.01" value="0"></div>

        <div class="ff full"><label>Notatka admina</label><textarea id="a-nt" placeholder="Opcjonalnie‚Ä¶"></textarea></div>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px">
        <button class="btn btn-secondary" id="a-cancel">Anuluj</button>
        <button class="btn btn-primary" id="a-save">Zapisz kursanta</button>
      </div>
    </div>
  `;

  // dane do select√≥w
  let locations=[], groups=[], schedules=[], plans=[];
  try{
    const out = await Promise.all([ aF('/locations'), aF('/groups'), aF('/schedules'), aF('/plans') ]);
    locations = arrRows(out[0]);
    groups = arrRows(out[1]);
    schedules = arrRows(out[2]);
    plans = arrRows(out[3]);
  }catch(e){
    c.innerHTML = `<div class="empty"><strong>B≈ÇƒÖd</strong>${e.message}</div>`;
    return;
  }

  const elLoc=document.getElementById('a-loc');
  const elGr=document.getElementById('a-gr');
  const elSc=document.getElementById('a-sc');
  const elPl=document.getElementById('a-pl');

  elLoc.innerHTML = `<option value="">‚Äî wybierz lokalizacjƒô ‚Äî</option>` + locations.map(l =>
    `<option value="${l.id}">${l.city} ‚Äî ${l.name}</option>`
  ).join('');

  elPl.innerHTML = `<option value="">‚Äî brak karnetu ‚Äî</option>` + plans.map(p=>
    `<option value="${p.id}">${p.name} ‚Äî ${p.price} z≈Ç${p.months?` / ${p.months} mies.`:''}</option>`
  ).join('');

  function schedLabel(s){
    const day = DAYS[s.day_of_week] || s.day_of_week;
    const ts = s.time_start ? String(s.time_start).slice(0,5) : '';
    const te = s.time_end ? String(s.time_end).slice(0,5) : '';
    return `${day} ${ts}${te?`‚Äì${te}`:''}${s.address?` ¬∑ ${s.address}`:''}`;
  }

  function rebuildGroups(){
    const locId = parseInt(elLoc.value||'0',10);
    const gList = groups.filter(g => parseInt(g.location_id||0,10) === locId);
    elGr.innerHTML = gList.length
      ? gList.map(g => `<option value="${g.id}">${g.city||''}${g.city?' ‚Äî ':''}${g.name}</option>`).join('')
      : `<option value="">Brak grup dla tej lokalizacji</option>`;
    rebuildSchedules();
  }

  function rebuildSchedules(){
    const gid = parseInt(elGr.value||'0',10);
    const sList = schedules.filter(s => parseInt(s.group_id||0,10) === gid);
    elSc.innerHTML = `<option value="">‚Äî opcjonalnie ‚Äî</option>` + sList.map(s =>
      `<option value="${s.id}">${schedLabel(s)}</option>`
    ).join('');
  }

  elLoc.addEventListener('change', rebuildGroups);
  elGr.addEventListener('change', rebuildSchedules);
  rebuildGroups();

  document.getElementById('a-cancel').addEventListener('click', ()=>navigate('participants'));

  document.getElementById('a-save').addEventListener('click', async ()=>{
    const first_name=document.getElementById('a-fn').value.trim();
    const last_name=document.getElementById('a-ln').value.trim();
    const location_id=parseInt(elLoc.value||'0',10);
    const group_id=parseInt(elGr.value||'0',10);

    if(!first_name || !last_name){
      toast('Uzupe≈Çnij: imiƒô i nazwisko','error'); return;
    }
    if(!location_id || !group_id){
      toast('Uzupe≈Çnij: lokalizacja i grupa','error'); return;
    }

    const b={
      first_name,
      last_name,
      email:document.getElementById('a-em').value.trim()||null,
      phone:document.getElementById('a-ph').value.trim()||null,
      birth_year:parseInt(document.getElementById('a-by').value||'0',10)||null,
      is_new:document.getElementById('a-in').value==='true',
      location_id,
      group_id,
      schedule_id:parseInt(elSc.value||'0',10)||null,
      price_plan_id:parseInt(elPl.value||'0',10)||null,
      start_date:document.getElementById('a-sd').value||null,
      payment_status:document.getElementById('a-ps').value,
      payment_method:document.getElementById('a-pm').value,
      total_amount:parseFloat(document.getElementById('a-am').value||'0')||0,
      status:document.getElementById('a-st').value,
      admin_notes:document.getElementById('a-nt').value||null,
      source:'admin'
    };

    try{
      const d = await aF(`/registrations`, { method:'POST', body: JSON.stringify(b) });
      const newId = d.id || d.registration_id || (d.row && d.row.id);
      toast('Kursant dodany','success');
      if(newId) openKartoteka(newId,'view');
      else navigate('participants');
    }catch(e){
      toast('B≈ÇƒÖd: '+e.message,'error');
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KARTOTEKA (Twoja wersja ‚Äî bez zmian merytorycznych)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openKartoteka(id, mode='view'){
  let r;
  let locations=[], groups=[], schedules=[], plans=[];
  try{
    const out = await Promise.all([
      aF(`/registrations/${id}?_=${Date.now()}`),
      aF('/locations'),
      aF('/groups'),
      aF('/schedules'),
      aF('/plans'),
    ]);
    r = out[0];
    locations = (out[1] && out[1].rows) ? out[1].rows : arrRows(out[1]);
    groups = (out[2] && out[2].rows) ? out[2].rows : arrRows(out[2]);
    schedules = (out[3] && out[3].rows) ? out[3].rows : arrRows(out[3]);
    plans = (out[4] && out[4].rows) ? out[4].rows : arrRows(out[4]);
  }catch(e){
    toast('B≈ÇƒÖd pobierania danych: '+e.message,'error');
    return;
  }

  const locOpts = locations.map(l =>
    `<option value="${l.id}" ${l.id==r.location_id?'selected':''}>${l.city} ‚Äî ${l.name}</option>`
  ).join('');

  function schedLabel(s){
    const day = DAYS[s.day_of_week] || s.day_of_week;
    const ts = s.time_start ? String(s.time_start).slice(0,5) : '';
    const te = s.time_end ? String(s.time_end).slice(0,5) : '';
    return `${day} ${ts}${te?`‚Äì${te}`:''}${s.address?` ¬∑ ${s.address}`:''}`;
  }

  const pO=`<option value="">‚Äî brak karnetu ‚Äî</option>`+plans.map(p=>`<option value="${p.id}" ${p.id==r.price_plan_id?'selected':''}>${p.name} ‚Äî ${p.price} z≈Ç / ${p.months} mies.</option>`).join('');

  const isEdit = mode==='edit';
  const fld=(id,val,type='text',opts='')=>isEdit
    ?`<input id="${id}" type="${type}" value="${val||''}" ${opts}>`
    :`<div class="view-val">${val||'‚Äî'}</div>`;
  const txt=(id,val)=>isEdit
    ?`<textarea id="${id}">${val||''}</textarea>`
    :`<div class="view-val" style="white-space:pre-wrap">${val||'‚Äî'}</div>`;

  const payOpts=['paid','unpaid','pending','partial','waived'].map(v=>`<option value="${v}" ${r.payment_status===v?'selected':''}>${PS[v]||v}</option>`).join('');
  const statOpts=['new','confirmed','cancelled','completed'].map(v=>`<option value="${v}" ${r.status===v?'selected':''}>${RS[v]||v}</option>`).join('');
  const pmOpts=['cash','transfer','card'].map(v=>`<option value="${v}" ${r.payment_method===v?'selected':''}>${{cash:'Got√≥wka',transfer:'Przelew',card:'Karta'}[v]||v}</option>`).join('');

  const body=`
    <div class="kart-header">
      <div class="kart-avatar">${initials(r.first_name,r.last_name)}</div>
      <div>
        <div class="kart-name">${r.first_name} ${r.last_name}</div>
        <div class="kart-meta">${r.email||'brak email'} ¬∑ ${r.phone||'brak tel.'} ¬∑ ${r.city||'brak miasta'}</div>
        <div class="kart-badges">
          ${sb(r.status)} ${pb(r.payment_status)}
          ${r.is_waitlist?'<span class="badge bo">Lista rezerwowa</span>':''}
          <span class="badge ${r.source==='admin'?'bb':'bx'}">${r.source==='admin'?'Admin':'WWW'}</span>
        </div>
      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">Dane osobowe</div>
      <div class="fg">
        <div class="ff"><label>Imiƒô</label>${fld('k-fn',r.first_name)}</div>
        <div class="ff"><label>Nazwisko</label>${fld('k-ln',r.last_name)}</div>
        <div class="ff"><label>Email</label>${fld('k-em',r.email,'email')}</div>
        <div class="ff"><label>Telefon</label>${fld('k-ph',r.phone)}</div>
        <div class="ff"><label>Rok urodzenia</label>${fld('k-by',r.birth_year,'number')}</div>
        <div class="ff"><label>Typ kursanta</label>${isEdit
          ?`<select id="k-in"><option value="true" ${r.is_new?'selected':''}>Nowy</option><option value="false" ${!r.is_new?'selected':''}>Kontynuacja</option></select>`
          :`<div class="view-val">${r.is_new?'Nowy kursant':'Kontynuacja'}</div>`}
        </div>
      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">Organizacja treningu</div>
      <div class="fg">

        <div class="ff full">
          <label>Lokalizacja</label>
          ${isEdit
            ? `<select id="k-loc">${locOpts}</select>`
            : `<div class="view-val">${r.city ? `${r.city} ‚Äî ${r.location_name||''}` : '‚Äî'}</div>`
          }
        </div>

        <div class="ff full">
          <label>Grupa</label>
          ${isEdit
            ? `<select id="k-gr"></select>`
            : `<div class="view-val">${r.city ? `${r.city} ‚Äî ` : ''}${r.group_name||'‚Äî'}</div>`
          }
        </div>

        <div class="ff full">
          <label>Dzie≈Ñ i godzina z grafiku</label>
          ${isEdit
            ? `<select id="k-sc"><option value="">‚Äî wybierz termin ‚Äî</option></select>`
            : `<div class="view-val">${r.schedule_id ? `${DAYS[r.schedule_day]||''} ${String(r.schedule_time_start||'').slice(0,5)}${r.schedule_time_end?`‚Äì${String(r.schedule_time_end).slice(0,5)}`:''}` : '‚Äî'}</div>`
          }
        </div>

        <div class="ff full">
          <label>Karnet</label>
          ${isEdit
            ? `<select id="k-pl">${pO}</select>`
            : `<div class="view-val">${r.plan_name||'‚Äî'}</div>`
          }
        </div>

        <div class="ff">
          <label>Data startu</label>
          ${fld('k-sd',r.start_date?String(r.start_date).slice(0,10):'','date')}
        </div>

        <div class="ff">
          <label>Lista rezerwowa</label>
          ${isEdit
            ? `<select id="k-wl"><option value="false" ${!r.is_waitlist?'selected':''}>Nie</option><option value="true" ${r.is_waitlist?'selected':''}>Tak</option></select>`
            : `<div class="view-val">${r.is_waitlist?'Tak':'Nie'}</div>`
          }
        </div>

      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">P≈Çatno≈õƒá</div>
      <div class="fg">
        <div class="ff"><label>Status p≈Çatno≈õci</label>${isEdit?`<select id="k-ps">${payOpts}</select>`:`<div class="view-val">${pb(r.payment_status)}</div>`}</div>
        <div class="ff"><label>Metoda</label>${isEdit?`<select id="k-pm">${pmOpts}</select>`:`<div class="view-val">${{cash:'Got√≥wka',transfer:'Przelew',card:'Karta'}[r.payment_method]||r.payment_method||'‚Äî'}</div>`}</div>
        <div class="ff"><label>Kwota (z≈Ç)</label>${fld('k-am',r.total_amount,'number')}</div>
        <div class="ff"><label>Kod ref.</label><div class="view-val" style="font-family:monospace;font-size:12px">${r.payment_ref||'‚Äî'}</div></div>
        <div class="ff"><label>Data op≈Çaty</label><div class="view-val">${fdt(r.paid_at)}</div></div>
        <div class="ff"><label>Status zapisu</label>${isEdit?`<select id="k-st">${statOpts}</select>`:`<div class="view-val">${sb(r.status)}</div>`}</div>
      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">Historia i notatki</div>
      <div class="fg">
        <div class="ff"><label>Data zapisu</label><div class="view-val">${fdt(r.created_at)}</div></div>
        <div class="ff"><label>Preferowany czas</label><div class="view-val">${r.preferred_time||'‚Äî'}</div></div>
        <div class="ff full"><label>Notatki admina</label>${txt('k-nt',r.admin_notes)}</div>
      </div>
    </div>`;

  const footer=isEdit
    ?`<button class="btn btn-secondary" onclick="openKartoteka(${id},'view')">Anuluj</button>
      <button class="btn btn-primary" onclick="saveKartoteka(${id})">Zapisz zmiany</button>`
    :`<button class="btn btn-secondary" onclick="closeModal()">Zamknij</button>
      <button class="btn btn-primary" onclick="openKartoteka(${id},'edit')">Edytuj kartotekƒô</button>`;

  showModal(`Kartoteka #${id}`, body, footer);

  if(mode==='edit'){
    const elLoc = document.getElementById('k-loc');
    const elGr  = document.getElementById('k-gr');
    const elSc  = document.getElementById('k-sc');

    function rebuildGroups(){
      const locId = parseInt(elLoc.value);
      const gList = groups.filter(g => parseInt(g.location_id) === locId);
      elGr.innerHTML = gList.map(g => `<option value="${g.id}">${g.city} ‚Äî ${g.name}</option>`).join('');
      const wanted = parseInt(r.group_id||0);
      if(gList.some(g=>g.id==wanted)) elGr.value = String(wanted);
      rebuildSchedules();
    }

    function rebuildSchedules(){
      const gid = parseInt(elGr.value||0);
      const sList = schedules.filter(s => parseInt(s.group_id) === gid);
      elSc.innerHTML = `<option value="">‚Äî wybierz termin ‚Äî</option>` + sList.map(s =>
        `<option value="${s.id}">${schedLabel(s)}</option>`
      ).join('');
      if(r.schedule_id && sList.some(s=>s.id==r.schedule_id)) elSc.value = String(r.schedule_id);
    }

    elLoc.addEventListener('change', rebuildGroups);
    elGr.addEventListener('change', rebuildSchedules);
    rebuildGroups();
  }
}

async function saveKartoteka(id){
  const b={
    first_name:document.getElementById('k-fn')?.value||undefined,
    last_name:document.getElementById('k-ln')?.value||undefined,
    email:document.getElementById('k-em')?.value||null,
    phone:document.getElementById('k-ph')?.value||null,
    birth_year:parseInt(document.getElementById('k-by')?.value)||null,
    is_new:document.getElementById('k-in')?.value==='true',
    group_id:parseInt(document.getElementById('k-gr')?.value)||null,
    schedule_id:parseInt(document.getElementById('k-sc')?.value)||null,
    price_plan_id:parseInt(document.getElementById('k-pl')?.value)||null,
    start_date:document.getElementById('k-sd')?.value||null,
    is_waitlist:document.getElementById('k-wl')?.value==='true',
    payment_status:document.getElementById('k-ps')?.value,
    payment_method:document.getElementById('k-pm')?.value,
    total_amount:parseFloat(document.getElementById('k-am')?.value)||0,
    status:document.getElementById('k-st')?.value,
    admin_notes:document.getElementById('k-nt')?.value||null,
  };
  Object.keys(b).forEach(k=>{if(b[k]===undefined)delete b[k];});
  try{
    await aF(`/registrations/${id}?_=${Date.now()}`,{method:'PATCH',body:JSON.stringify(b)});
    toast('Kartoteka zapisana');
    openKartoteka(id,'view');
    if(CV==='web-registrations')fetchR('web');
    if(CV==='participants')fetchR('admin');
    if(CV==='dashboard')loadDash();
  }catch(e){toast('B≈ÇƒÖd: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GRUPY / GRAFIK / LOKALIZACJE ‚Äî minimalistyczne widoki (≈ºeby nie wisia≈Çy)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadGroups(){
  const c=document.getElementById('content');
  try{
    const d=await aF('/groups');
    const rows=arrRows(d);
    c.innerHTML = `
      <div class="sh"><h3>Grupy</h3></div>
      <div class="tw"><table>
        <thead><tr><th>ID</th><th>Miasto</th><th>Nazwa</th><th>Pojemno≈õƒá</th><th>Aktywna</th></tr></thead>
        <tbody>${rows.map(g=>`
          <tr>
            <td>${g.id}</td>
            <td>${g.city||'‚Äî'}</td>
            <td><strong style="color:var(--bright)">${g.name||'‚Äî'}</strong></td>
            <td>${g.max_capacity||'‚Äî'}</td>
            <td>${g.active===false?'<span class="badge br">NIE</span>':'<span class="badge bg">TAK</span>'}</td>
          </tr>
        `).join('')}</tbody>
      </table></div>
    `;
  }catch(e){
    c.innerHTML=`<div class="empty"><strong>B≈ÇƒÖd</strong>${e.message}</div>`;
  }
}

async function loadSchedules(){
  const c=document.getElementById('content');
  try{
    const d=await aF('/schedules');
    const rows=arrRows(d);
    c.innerHTML = `
      <div class="sh"><h3>Grafik zajƒôƒá</h3></div>
      <div class="tw"><table>
        <thead><tr><th>ID</th><th>Grupa</th><th>Dzie≈Ñ</th><th>Godzina</th><th>Adres</th><th>Aktywny</th></tr></thead>
        <tbody>${rows.map(s=>`
          <tr>
            <td>${s.id}</td>
            <td>${s.group_name||s.group_id||'‚Äî'}</td>
            <td>${DAYS[s.day_of_week]||s.day_name||s.day_of_week||'‚Äî'}</td>
            <td>${(s.time_start?String(s.time_start).slice(0,5):'')}${s.time_end?`‚Äì${String(s.time_end).slice(0,5)}`:''}</td>
            <td>${s.address||'‚Äî'}</td>
            <td>${s.active===false?'<span class="badge br">NIE</span>':'<span class="badge bg">TAK</span>'}</td>
          </tr>
        `).join('')}</tbody>
      </table></div>
    `;
  }catch(e){
    c.innerHTML=`<div class="empty"><strong>B≈ÇƒÖd</strong>${e.message}</div>`;
  }
}

async function loadLocations(){
  const c=document.getElementById('content');
  try{
    const d=await aF('/locations');
    const rows=arrRows(d);
    c.innerHTML = `
      <div class="sh"><h3>Lokalizacje</h3></div>
      <div class="tw"><table>
        <thead><tr><th>ID</th><th>Miasto</th><th>Nazwa</th><th>Adres</th><th>Aktywna</th></tr></thead>
        <tbody>${rows.map(l=>`
          <tr>
            <td>${l.id}</td>
            <td><strong style="color:var(--bright)">${l.city||'‚Äî'}</strong></td>
            <td>${l.name||'‚Äî'}</td>
            <td>${l.address||'‚Äî'}</td>
            <td>${l.active===false?'<span class="badge br">NIE</span>':'<span class="badge bg">TAK</span>'}</td>
          </tr>
        `).join('')}</tbody>
      </table></div>
    `;
  }catch(e){
    c.innerHTML=`<div class="empty"><strong>B≈ÇƒÖd</strong>${e.message}</div>`;
  }
}

// Start
checkLogin();
</script>
</body>
</html>



