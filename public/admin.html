<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin — Krav Maga Saggita</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#0f0202;color:#fff;overflow-x:hidden}
a{text-decoration:none;color:inherit}
:root{
  --red:#B21900;--red-d:#7a1100;--red-rgb:178,25,0;
  --bg:#0f0202;--bg2:#1a0303;--bg3:#230404;
  --border:rgba(255,255,255,0.10);--border-r:rgba(178,25,0,0.35);
  --muted:rgba(255,255,255,0.45);--text:rgba(255,255,255,0.88);
  --green:#22c55e;--orange:#f59e0b;--blue:#3b82f6;
}

/* ── LOGIN ── */
#loginScreen{
  display:flex;align-items:center;justify-content:center;
  min-height:100vh;padding:20px;
  background:radial-gradient(ellipse at 30% 40%, rgba(178,25,0,0.14) 0%, transparent 65%);
}
.login-box{
  width:100%;max-width:380px;
  border:1px solid var(--border-r);
  background:rgba(255,255,255,0.03);
  padding:40px 36px;
}
.login-box__logo{
  font-family:'Montserrat',sans-serif;font-weight:900;
  font-size:1.1rem;text-transform:uppercase;letter-spacing:.06em;
  color:var(--red);margin-bottom:4px;
}
.login-box__sub{font-size:.78rem;color:var(--muted);margin-bottom:32px;}
.lbl{display:block;font-weight:700;font-size:.65rem;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.inp{
  width:100%;background:rgba(255,255,255,0.05);border:1px solid var(--border);
  color:#fff;font-size:.88rem;padding:10px 13px;outline:none;
  transition:border-color 200ms;font-family:inherit;
}
.inp:focus{border-color:rgba(178,25,0,0.60);}
.inp-wrap{margin-bottom:16px;}
.btn-red{
  width:100%;background:var(--red);color:#fff;border:none;
  font-family:inherit;font-weight:800;font-size:.80rem;
  letter-spacing:.08em;text-transform:uppercase;
  padding:12px;cursor:pointer;
  transition:filter 200ms;margin-top:8px;
}
.btn-red:hover{filter:brightness(1.15);}
.btn-red:disabled{opacity:.50;cursor:not-allowed;filter:none;}
.login-err{color:#ff8a8a;font-size:.78rem;margin-top:10px;min-height:18px;}

/* ── APP SHELL ── */
#app{display:none;height:100vh;overflow:hidden;}
.shell{display:flex;height:100%;}

/* Sidebar */
.sidebar{
  width:220px;flex-shrink:0;
  background:var(--bg2);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  overflow-y:auto;
}
.sidebar__brand{
  padding:20px 18px 14px;
  border-bottom:1px solid var(--border);
}
.sidebar__brand-name{
  font-weight:900;font-size:.88rem;text-transform:uppercase;
  letter-spacing:.06em;color:var(--red);
}
.sidebar__brand-sub{font-size:.68rem;color:var(--muted);margin-top:2px;}
.sidebar__nav{padding:12px 0;flex:1;}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:10px 18px;
  font-weight:700;font-size:.80rem;
  color:var(--muted);cursor:pointer;
  transition:color 200ms,background 200ms;
  border-left:2px solid transparent;
}
.nav-item:hover{color:#fff;background:rgba(255,255,255,0.04);}
.nav-item.active{color:#fff;background:rgba(178,25,0,0.12);border-left-color:var(--red);}
.nav-item__icon{width:16px;text-align:center;flex-shrink:0;}
.sidebar__footer{padding:14px 18px;border-top:1px solid var(--border);}
.sidebar__user{font-size:.72rem;color:var(--muted);}
.sidebar__logout{
  font-size:.68rem;font-weight:700;letter-spacing:.10em;text-transform:uppercase;
  color:var(--red);cursor:pointer;margin-top:4px;
  background:none;border:none;padding:0;font-family:inherit;
}

/* Main */
.main{flex:1;overflow-y:auto;background:var(--bg);}
.page{display:none;padding:28px 28px 40px;}
.page.active{display:block;}

/* ── STATS ── */
.stats-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:12px;margin-bottom:28px;
}
.stat-card{
  background:var(--bg2);border:1px solid var(--border);
  padding:18px 20px;
}
.stat-card__num{
  font-weight:900;font-size:2rem;line-height:1;
  color:var(--red);margin-bottom:4px;
}
.stat-card__num.green{color:var(--green);}
.stat-card__num.orange{color:var(--orange);}
.stat-card__lbl{font-size:.70rem;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);}

/* ── TABLE ── */
.toolbar{
  display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center;
}
.toolbar-title{font-weight:900;font-size:1.1rem;flex:1;}
.search-inp{
  background:rgba(255,255,255,0.05);border:1px solid var(--border);
  color:#fff;font-size:.80rem;padding:8px 12px;outline:none;
  min-width:200px;font-family:inherit;
}
.search-inp:focus{border-color:rgba(178,25,0,0.50);}
.filter-sel{
  background:rgba(255,255,255,0.05);border:1px solid var(--border);
  color:#fff;font-size:.78rem;padding:8px 10px;outline:none;font-family:inherit;cursor:pointer;
}
.filter-sel option{background:#1a0000;}
.btn-sm{
  background:rgba(255,255,255,0.06);border:1px solid var(--border);
  color:rgba(255,255,255,0.75);font-size:.72rem;font-weight:700;
  letter-spacing:.10em;text-transform:uppercase;
  padding:8px 14px;cursor:pointer;transition:background 200ms,color 200ms;
  font-family:inherit;
}
.btn-sm:hover{background:rgba(178,25,0,0.20);color:#fff;border-color:var(--border-r);}
.btn-sm.red{background:rgba(178,25,0,0.80);color:#fff;border-color:var(--red);}

.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:.78rem;}
thead tr{background:rgba(255,255,255,0.04);border-bottom:1px solid var(--border-r);}
th{padding:10px 12px;font-weight:800;text-transform:uppercase;letter-spacing:.10em;font-size:.64rem;color:var(--muted);white-space:nowrap;text-align:left;}
td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.05);vertical-align:middle;}
tr:hover td{background:rgba(255,255,255,0.03);}
tr.selected td{background:rgba(178,25,0,0.08);}
.td-name{font-weight:700;color:#fff;}
.td-ref{font-weight:800;font-size:.70rem;letter-spacing:.06em;color:var(--red);}
.td-loc{font-size:.72rem;color:var(--muted);}
.td-amount{font-weight:800;color:#fff;}

/* Badges */
.tag{display:inline-block;padding:3px 8px;font-size:.60rem;font-weight:800;letter-spacing:.10em;text-transform:uppercase;}
.tag-new{background:rgba(59,130,246,0.18);color:#60a5fa;}
.tag-confirmed{background:rgba(34,197,94,0.18);color:#4ade80;}
.tag-waitlist{background:rgba(245,158,11,0.18);color:#fcd34d;}
.tag-cancelled{background:rgba(255,255,255,0.08);color:var(--muted);}
.tag-paid{background:rgba(34,197,94,0.15);color:#4ade80;}
.tag-pending{background:rgba(245,158,11,0.15);color:#fcd34d;}
.tag-transfer{background:rgba(255,255,255,0.07);color:var(--muted);}

/* Row action */
.row-btn{
  background:none;border:1px solid var(--border);color:var(--muted);
  font-size:.64rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;
  padding:5px 10px;cursor:pointer;font-family:inherit;
  transition:border-color 200ms,color 200ms;
}
.row-btn:hover{border-color:var(--red);color:#fff;}

/* Pagination */
.pagination{display:flex;gap:6px;align-items:center;margin-top:16px;font-size:.78rem;color:var(--muted);}
.pg-btn{
  background:rgba(255,255,255,0.04);border:1px solid var(--border);
  color:var(--muted);font-size:.72rem;padding:6px 12px;
  cursor:pointer;font-family:inherit;
}
.pg-btn:hover{background:rgba(255,255,255,0.10);color:#fff;}
.pg-btn:disabled{opacity:.35;cursor:not-allowed;}

/* ── DETAIL DRAWER ── */
.drawer-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.65);z-index:100;
  display:none;
}
.drawer-overlay.open{display:block;}
.drawer{
  position:fixed;right:0;top:0;bottom:0;
  width:min(520px,100vw);
  background:var(--bg2);border-left:1px solid var(--border-r);
  overflow-y:auto;z-index:101;
  transform:translateX(100%);transition:transform 280ms ease;
  padding:28px 28px 40px;
}
.drawer.open{transform:translateX(0);}
.drawer__close{
  position:absolute;top:18px;right:18px;
  background:none;border:1px solid var(--border);color:var(--muted);
  font-size:1.1rem;width:36px;height:36px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
.drawer__close:hover{border-color:var(--red);color:#fff;}
.drawer__title{font-weight:900;font-size:1.2rem;margin-bottom:4px;}
.drawer__ref{font-weight:800;font-size:.80rem;color:var(--red);letter-spacing:.06em;margin-bottom:20px;}
.detail-row{display:flex;gap:12px;margin-bottom:14px;font-size:.84rem;align-items:flex-start;}
.detail-row .key{min-width:160px;font-weight:700;color:var(--muted);font-size:.70rem;letter-spacing:.10em;text-transform:uppercase;padding-top:2px;}
.detail-row .val{color:#fff;font-weight:600;word-break:break-word;}
.drawer__divider{border:none;border-top:1px solid var(--border);margin:20px 0;}
.drawer__actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:20px;}
.action-group{display:flex;flex-direction:column;gap:6px;min-width:160px;}
.action-label{font-size:.64rem;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-bottom:2px;}
.action-sel{
  background:rgba(255,255,255,0.06);border:1px solid var(--border);
  color:#fff;font-size:.80rem;padding:8px 10px;font-family:inherit;outline:none;cursor:pointer;
}
.action-sel option{background:#1a0000;}
.notes-textarea{
  width:100%;background:rgba(255,255,255,0.04);border:1px solid var(--border);
  color:#fff;font-size:.80rem;padding:8px 10px;
  font-family:inherit;resize:vertical;min-height:70px;outline:none;
  margin-top:4px;
}
.notes-textarea:focus{border-color:rgba(178,25,0,0.50);}
.btn-save{
  background:var(--red);color:#fff;border:none;
  font-family:inherit;font-weight:800;font-size:.72rem;
  letter-spacing:.10em;text-transform:uppercase;
  padding:10px 20px;cursor:pointer;margin-top:12px;
  transition:filter 200ms;
}
.btn-save:hover{filter:brightness(1.15);}
.drawer__msg{font-size:.76rem;margin-top:10px;color:#4ade80;min-height:18px;}

/* ── CAPACITY TABLE (O NAS) ── */
.cap-table{width:100%;border-collapse:collapse;font-size:.80rem;margin-top:12px;}
.cap-table th{text-align:left;padding:8px 12px;font-size:.64rem;font-weight:800;text-transform:uppercase;letter-spacing:.10em;color:var(--muted);border-bottom:1px solid var(--border);}
.cap-table td{padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.04);}
.cap-bar{height:6px;background:rgba(255,255,255,0.10);margin-top:4px;position:relative;}
.cap-bar-fill{height:100%;background:var(--red);transition:width 400ms;}
.cap-bar-fill.warn{background:var(--orange);}
.cap-bar-fill.full{background:var(--green);}

/* ── SETUP SCREEN ── */
#setupScreen{
  display:none;align-items:center;justify-content:center;
  min-height:100vh;padding:20px;
}

/* ── LOADING ── */
.spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.20);border-top-color:#fff;border-radius:50%;animation:spin 600ms linear infinite;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-msg{color:var(--muted);font-size:.82rem;padding:32px 0;text-align:center;}

@media(max-width:720px){
  .sidebar{width:54px;}
  .nav-item span:not(.nav-item__icon){display:none;}
  .sidebar__brand-name,.sidebar__brand-sub,.sidebar__user{display:none;}
  .page{padding:16px;}
}
</style>
</head>
<body>

<!-- ══ LOGIN ══ -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-box__logo">Krav Maga Saggita</div>
    <div class="login-box__sub">Panel administratora</div>
    <div class="inp-wrap">
      <label class="lbl" for="l_user">Login</label>
      <input class="inp" type="text" id="l_user" autocomplete="username">
    </div>
    <div class="inp-wrap">
      <label class="lbl" for="l_pass">Hasło</label>
      <input class="inp" type="password" id="l_pass" autocomplete="current-password">
    </div>
    <button class="btn-red" id="loginBtn">Zaloguj się</button>
    <div class="login-err" id="loginErr"></div>
  </div>
</div>

<!-- ══ SETUP (first-time) ══ -->
<div id="setupScreen" style="display:flex;display:none">
  <div class="login-box">
    <div class="login-box__logo">Pierwsze uruchomienie</div>
    <div class="login-box__sub" style="margin-bottom:20px">Utwórz konto administratora</div>
    <div class="inp-wrap">
      <label class="lbl" for="s_user">Login</label>
      <input class="inp" type="text" id="s_user">
    </div>
    <div class="inp-wrap">
      <label class="lbl" for="s_pass">Hasło (min. 8 znaków)</label>
      <input class="inp" type="password" id="s_pass">
    </div>
    <button class="btn-red" id="setupBtn">Utwórz konto</button>
    <div class="login-err" id="setupErr"></div>
  </div>
</div>

<!-- ══ APP ══ -->
<div id="app">
  <div class="shell">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar__brand">
        <div class="sidebar__brand-name">KM Saggita</div>
        <div class="sidebar__brand-sub">Admin</div>
      </div>
      <nav class="sidebar__nav">
        <div class="nav-item active" data-page="dashboard">
          <span class="nav-item__icon">◈</span><span>Dashboard</span>
        </div>
        <div class="nav-item" data-page="registrations">
          <span class="nav-item__icon">≡</span><span>Zapisy</span>
        </div>
        <div class="nav-item" data-page="capacity">
          <span class="nav-item__icon">⊞</span><span>Grupy</span>
        </div>
      </nav>
      <div class="sidebar__footer">
        <div class="sidebar__user" id="sidebarUser"></div>
        <button class="sidebar__logout" id="logoutBtn">Wyloguj</button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">

      <!-- DASHBOARD -->
      <div class="page active" id="page-dashboard">
        <h2 style="font-weight:900;font-size:1.3rem;margin-bottom:20px">Dashboard</h2>
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card"><div class="stat-card__num"><span class="spinner"></span></div><div class="stat-card__lbl">Ładowanie…</div></div>
        </div>
        <h3 style="font-weight:800;font-size:.80rem;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-bottom:12px">Ostatnie zapisy</h3>
        <table id="recentTable" style="width:100%;border-collapse:collapse;font-size:.78rem">
          <thead><tr><th>Imię i nazwisko</th><th>Lokalizacja</th><th>Status</th><th>Płatność</th><th>Data</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- REGISTRATIONS -->
      <div class="page" id="page-registrations">
        <div class="toolbar">
          <span class="toolbar-title">Zapisy</span>
          <input class="search-inp" type="search" id="searchInp" placeholder="Szukaj: imię, e-mail, kod…">
          <select class="filter-sel" id="filterStatus">
            <option value="">Wszystkie statusy</option>
            <option value="new">Nowe</option>
            <option value="confirmed">Potwierdzone</option>
            <option value="waitlist">Lista rezerwowa</option>
            <option value="cancelled">Anulowane</option>
          </select>
          <select class="filter-sel" id="filterPayment">
            <option value="">Płatność: wszystkie</option>
            <option value="pending">Oczekuje</option>
            <option value="paid">Opłacone</option>
          </select>
          <select class="filter-sel" id="filterLocation">
            <option value="">Wszystkie lokalizacje</option>
            <option value="wroclaw">Wrocław</option>
            <option value="swidnica">Świdnica</option>
            <option value="walbrzych">Wałbrzych</option>
          </select>
          <button class="btn-sm" id="exportBtn">↓ CSV</button>
        </div>

        <div class="table-wrap">
          <table id="regTable">
            <thead>
              <tr>
                <th>#</th><th>Imię i nazwisko</th><th>E-mail / Tel.</th>
                <th>Lokalizacja</th><th>Grupa</th><th>Karnet</th>
                <th>Kwota</th><th>Status</th><th>Płatność</th><th>Kod</th><th></th>
              </tr>
            </thead>
            <tbody id="regTbody">
              <tr><td colspan="11" class="empty-msg"><span class="spinner"></span> Ładowanie…</td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="regPagination"></div>
      </div>

      <!-- CAPACITY -->
      <div class="page" id="page-capacity">
        <h2 style="font-weight:900;font-size:1.3rem;margin-bottom:20px">Grupy i zapełnienie</h2>
        <table class="cap-table" id="capTable">
          <thead><tr><th>Lokalizacja</th><th>Grupa</th><th>Kategoria</th><th>Zapisanych</th><th>Limit</th><th>Zapełnienie</th></tr></thead>
          <tbody><tr><td colspan="6" class="empty-msg"><span class="spinner"></span></td></tr></tbody>
        </table>
      </div>

    </main>
  </div>
</div>

<!-- DRAWER -->
<div class="drawer-overlay" id="drawerOverlay">
  <div class="drawer" id="drawer">
    <button class="drawer__close" id="drawerClose">✕</button>
    <div class="drawer__title" id="drawerName"></div>
    <div class="drawer__ref" id="drawerRef"></div>
    <div id="drawerBody"></div>
  </div>
</div>

<script>
const ADMIN_API = '/.netlify/functions/admin';
let token = sessionStorage.getItem('km_admin_token');
let currentUser = sessionStorage.getItem('km_admin_user');

// ── pagination state
let regOffset = 0;
const REG_LIMIT = 50;
let regTotal = 0;
let regFilters = {};
let searchTimer;

// ── Init ──────────────────────────────────────────────────────────
async function checkSetup() {
  // Check if admin exists by trying setup endpoint
  try {
    const r = await fetch(`${ADMIN_API}/setup`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
    const d = await r.json();
    if (r.status === 403) return false; // admin exists
    if (r.status === 400) return true;  // no admin, needs setup
    return true;
  } catch { return false; }
}

window.addEventListener('DOMContentLoaded', async () => {
  if (token) {
    showApp();
  } else {
    // Check if needs setup
    const needsSetup = await checkSetup();
    if (needsSetup) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('setupScreen').style.display = 'flex';
    }
  }

  // Nav
  document.querySelectorAll('.nav-item[data-page]').forEach(item => {
    item.addEventListener('click', () => {
      const pg = item.dataset.page;
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(`page-${pg}`).classList.add('active');
      if (pg === 'registrations') loadRegistrations();
      if (pg === 'capacity') loadCapacity();
    });
  });

  // Login
  document.getElementById('loginBtn').addEventListener('click', doLogin);
  document.getElementById('l_pass').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });

  // Setup
  document.getElementById('setupBtn').addEventListener('click', doSetup);

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', () => {
    sessionStorage.clear();
    location.reload();
  });

  // Filters
  ['searchInp','filterStatus','filterPayment','filterLocation'].forEach(id => {
    const el = document.getElementById(id);
    const isSearch = id === 'searchInp';
    el.addEventListener(isSearch ? 'input' : 'change', () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => { regOffset = 0; loadRegistrations(); }, isSearch ? 400 : 0);
    });
  });

  // Export
  document.getElementById('exportBtn').addEventListener('click', exportCSV);

  // Drawer
  document.getElementById('drawerClose').addEventListener('click', closeDrawer);
  document.getElementById('drawerOverlay').addEventListener('click', e => {
    if (e.target === document.getElementById('drawerOverlay')) closeDrawer();
  });
});

// ── Auth ──────────────────────────────────────────────────────────
async function doLogin() {
  const btn = document.getElementById('loginBtn');
  const err = document.getElementById('loginErr');
  err.textContent = '';
  btn.disabled = true;
  btn.textContent = 'Logowanie…';

  try {
    const r = await fetch(`${ADMIN_API}/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username: document.getElementById('l_user').value.trim(),
        password: document.getElementById('l_pass').value,
      }),
    });
    const d = await r.json();
    if (!r.ok) { err.textContent = d.error || 'Błąd logowania'; return; }
    token = d.token;
    currentUser = d.username;
    sessionStorage.setItem('km_admin_token', token);
    sessionStorage.setItem('km_admin_user', currentUser);
    showApp();
  } catch { err.textContent = 'Błąd połączenia.'; }
  finally { btn.disabled = false; btn.textContent = 'Zaloguj się'; }
}

async function doSetup() {
  const btn = document.getElementById('setupBtn');
  const err = document.getElementById('setupErr');
  err.textContent = '';
  btn.disabled = true;

  try {
    const r = await fetch(`${ADMIN_API}/setup`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username: document.getElementById('s_user').value.trim(),
        password: document.getElementById('s_pass').value,
      }),
    });
    const d = await r.json();
    if (!r.ok) { err.textContent = d.error || 'Błąd'; return; }
    // Auto-login
    document.getElementById('l_user').value = document.getElementById('s_user').value;
    document.getElementById('l_pass').value = document.getElementById('s_pass').value;
    document.getElementById('setupScreen').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    doLogin();
  } catch { err.textContent = 'Błąd połączenia.'; }
  finally { btn.disabled = false; }
}

function showApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  if (currentUser) document.getElementById('sidebarUser').textContent = currentUser;
  loadDashboard();
}

function authHeaders() {
  return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
}

async function apiFetch(path, opts = {}) {
  const r = await fetch(`${ADMIN_API}${path}`, { ...opts, headers: { ...authHeaders(), ...opts.headers } });
  if (r.status === 401) { sessionStorage.clear(); location.reload(); }
  return r;
}

// ── Dashboard ─────────────────────────────────────────────────────
async function loadDashboard() {
  const grid = document.getElementById('statsGrid');
  try {
    const r = await apiFetch('/stats');
    const d = await r.json();

    grid.innerHTML = `
      <div class="stat-card"><div class="stat-card__num">${d.new_count || 0}</div><div class="stat-card__lbl">Nowych zapisów</div></div>
      <div class="stat-card"><div class="stat-card__num">${d.confirmed_count || 0}</div><div class="stat-card__lbl">Potwierdzonych</div></div>
      <div class="stat-card"><div class="stat-card__num green">${d.paid_count || 0}</div><div class="stat-card__lbl">Opłaconych</div></div>
      <div class="stat-card"><div class="stat-card__num orange">${d.pending_payment || 0}</div><div class="stat-card__lbl">Oczekuje płatności</div></div>
      <div class="stat-card"><div class="stat-card__num orange">${d.waitlist_count || 0}</div><div class="stat-card__lbl">Lista rezerwowa</div></div>
      <div class="stat-card"><div class="stat-card__num">${fmtMoney(d.total_revenue)} zł</div><div class="stat-card__lbl">Wpłynęło</div></div>
      <div class="stat-card"><div class="stat-card__num orange">${fmtMoney(d.pending_revenue)} zł</div><div class="stat-card__lbl">Oczekuje wpłaty</div></div>
    `;

    // Lokalizacje
    if (d.byLoc?.length) {
      const extra = d.byLoc.map(l =>
        `<div class="stat-card"><div class="stat-card__num" style="font-size:1.4rem">${l.total||0}</div><div class="stat-card__lbl">${l.city || 'Nieznana lokalizacja'}</div></div>`
      ).join('');
      grid.innerHTML += extra;
    }

    // Recent table
    const tbody = document.querySelector('#recentTable tbody');
    if (d.recent?.length) {
      tbody.innerHTML = d.recent.map(r => `
        <tr>
          <td class="td-name">${esc(r.name)}</td>
          <td class="td-loc">${r.city || '—'}</td>
          <td>${statusTag(r.status)}</td>
          <td>${payTag(r.payment_status)}</td>
          <td style="color:var(--muted);font-size:.72rem">${fmtDate(r.created_at)}</td>
        </tr>
      `).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="5" class="empty-msg">Brak zapisów</td></tr>';
    }
  } catch(e) {
    grid.innerHTML = '<div style="color:#ff8a8a;font-size:.80rem">Błąd ładowania statystyk.</div>';
  }
}

// ── Registrations ─────────────────────────────────────────────────
async function loadRegistrations() {
  const tbody = document.getElementById('regTbody');
  tbody.innerHTML = '<tr><td colspan="11" class="empty-msg"><span class="spinner"></span></td></tr>';

  const params = new URLSearchParams({
    limit: REG_LIMIT,
    offset: regOffset,
    ...(document.getElementById('searchInp').value.trim() ? { search: document.getElementById('searchInp').value.trim() } : {}),
    ...(document.getElementById('filterStatus').value ? { status: document.getElementById('filterStatus').value } : {}),
    ...(document.getElementById('filterPayment').value ? { payment_status: document.getElementById('filterPayment').value } : {}),
    ...(document.getElementById('filterLocation').value ? { location: document.getElementById('filterLocation').value } : {}),
  });

  try {
    const r = await apiFetch(`/registrations?${params}`);
    const d = await r.json();
    regTotal = d.total || 0;

    if (!d.rows?.length) {
      tbody.innerHTML = '<tr><td colspan="11" class="empty-msg">Brak wyników</td></tr>';
      buildPagination();
      return;
    }

    tbody.innerHTML = d.rows.map(reg => `
      <tr>
        <td style="color:var(--muted);font-size:.70rem">${reg.id}</td>
        <td class="td-name">${esc(reg.first_name)} ${esc(reg.last_name)}<br><span class="td-loc">${fmtDate(reg.created_at)}</span></td>
        <td style="font-size:.72rem">${esc(reg.email)}<br><span style="color:var(--muted)">${esc(reg.phone || '')}</span></td>
        <td class="td-loc">${reg.city || '—'}</td>
        <td style="font-size:.72rem;max-width:130px">${esc(reg.group_name || '—')}</td>
        <td style="font-size:.70rem;color:var(--muted);max-width:100px">${esc(reg.plan_name || '—')}</td>
        <td class="td-amount">${reg.total_amount ? reg.total_amount + ' zł' : '—'}</td>
        <td>${statusTag(reg.status)}</td>
        <td>${payTag(reg.payment_status)}</td>
        <td class="td-ref">${reg.payment_ref || '—'}</td>
        <td><button class="row-btn" onclick="openDrawer(${reg.id})">Szczegóły</button></td>
      </tr>
    `).join('');

    buildPagination();
  } catch(e) {
    tbody.innerHTML = '<tr><td colspan="11" style="color:#ff8a8a;font-size:.78rem;padding:16px">Błąd ładowania danych.</td></tr>';
  }
}

function buildPagination() {
  const el = document.getElementById('regPagination');
  const pages = Math.ceil(regTotal / REG_LIMIT);
  const current = Math.floor(regOffset / REG_LIMIT) + 1;
  el.innerHTML = `
    <button class="pg-btn" ${regOffset === 0 ? 'disabled' : ''} onclick="regOffset=Math.max(0,regOffset-${REG_LIMIT});loadRegistrations()">←</button>
    <span>Strona ${current} z ${pages || 1} (${regTotal} wyników)</span>
    <button class="pg-btn" ${regOffset + REG_LIMIT >= regTotal ? 'disabled' : ''} onclick="regOffset=regOffset+${REG_LIMIT};loadRegistrations()">→</button>
  `;
}

// ── Capacity ──────────────────────────────────────────────────────
async function loadCapacity() {
  const tbody = document.querySelector('#capTable tbody');
  try {
    const r = await apiFetch('/stats');
    const d = await r.json();

    if (!d.byGroup?.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="empty-msg">Brak grup</td></tr>';
      return;
    }

    tbody.innerHTML = d.byGroup.map(g => {
      const reg = parseInt(g.registered) || 0;
      const cap = parseInt(g.max_capacity) || 1;
      const pct = Math.min(100, Math.round(reg / cap * 100));
      const cls = pct >= 100 ? 'full' : pct >= 75 ? 'warn' : '';
      return `
        <tr>
          <td>${esc(g.city || '—')}</td>
          <td style="font-weight:700">${esc(g.name)}</td>
          <td style="color:var(--muted);font-size:.72rem">${esc(g.category || '')}</td>
          <td style="font-weight:800;color:${pct>=100?'var(--green)':pct>=75?'var(--orange)':'#fff'}">${reg}</td>
          <td style="color:var(--muted)">${cap}</td>
          <td style="min-width:120px">
            <div style="font-size:.70rem;margin-bottom:4px">${pct}%</div>
            <div class="cap-bar"><div class="cap-bar-fill ${cls}" style="width:${pct}%"></div></div>
          </td>
        </tr>
      `;
    }).join('');
  } catch {
    tbody.innerHTML = '<tr><td colspan="6" style="color:#ff8a8a">Błąd ładowania.</td></tr>';
  }
}

// ── Drawer ────────────────────────────────────────────────────────
async function openDrawer(id) {
  const overlay = document.getElementById('drawerOverlay');
  const drawer  = document.getElementById('drawer');
  const body    = document.getElementById('drawerBody');

  overlay.classList.add('open');
  drawer.classList.add('open');
  body.innerHTML = '<div class="empty-msg"><span class="spinner"></span></div>';
  document.getElementById('drawerName').textContent = '';
  document.getElementById('drawerRef').textContent = '';

  try {
    const r = await apiFetch(`/registration/${id}`);
    const d = await r.json();
    if (!r.ok) { body.innerHTML = `<p style="color:#ff8a8a">${d.error}</p>`; return; }

    document.getElementById('drawerName').textContent = `${d.first_name || ''} ${d.last_name || ''}`.trim();
    document.getElementById('drawerRef').textContent = d.payment_ref || '';

    body.innerHTML = `
      <div class="detail-row"><div class="key">E-mail</div><div class="val"><a href="mailto:${esc(d.email)}" style="color:var(--red)">${esc(d.email)}</a></div></div>
      <div class="detail-row"><div class="key">Telefon</div><div class="val">${esc(d.phone || '—')}</div></div>
      <div class="detail-row"><div class="key">Rok urodzenia</div><div class="val">${d.birth_year || '—'}</div></div>
      <div class="detail-row"><div class="key">Typ uczestnika</div><div class="val">${d.is_new ? 'Nowy' : 'Kontynuacja'}</div></div>
      <hr class="drawer__divider">
      <div class="detail-row"><div class="key">Lokalizacja</div><div class="val">${esc(d.location || '—')}</div></div>
      <div class="detail-row"><div class="key">Grupa</div><div class="val">${esc(d.group_name || '—')}</div></div>
      <div class="detail-row"><div class="key">Dzień / godz.</div><div class="val">${d.day_name ? `${d.day_name} ${d.time_start || ''}–${d.time_end || ''}` : '—'}</div></div>
      <div class="detail-row"><div class="key">Adres treningu</div><div class="val">${esc(d.training_address || '—')}</div></div>
      <div class="detail-row"><div class="key">Karnet</div><div class="val">${esc(d.plan_name || '—')}</div></div>
      <div class="detail-row"><div class="key">Kwota</div><div class="val" style="font-weight:900;color:var(--red)">${d.total_amount ? d.total_amount + ' zł' : '—'}</div></div>
      <div class="detail-row"><div class="key">Metoda płatności</div><div class="val">${esc(d.payment_method || '—')}</div></div>
      <div class="detail-row"><div class="key">Data startu</div><div class="val">${d.start_date ? fmtDate(d.start_date) : '—'}</div></div>
      ${d.is_waitlist ? '<div class="detail-row"><div class="key" style="color:var(--orange)">Lista rezerwowa</div><div class="val" style="color:var(--orange)">TAK</div></div>' : ''}
      <div class="detail-row"><div class="key">Data zapisu</div><div class="val">${fmtDate(d.created_at)}</div></div>
      ${d.paid_at ? `<div class="detail-row"><div class="key">Data płatności</div><div class="val" style="color:var(--green)">${fmtDate(d.paid_at)}</div></div>` : ''}

      <hr class="drawer__divider">

      <div class="drawer__actions">
        <div class="action-group">
          <div class="action-label">Status zapisu</div>
          <select class="action-sel" id="da_status">
            <option value="new" ${d.status==='new'?'selected':''}>Nowy</option>
            <option value="confirmed" ${d.status==='confirmed'?'selected':''}>Potwierdzony</option>
            <option value="waitlist" ${d.status==='waitlist'?'selected':''}>Lista rez.</option>
            <option value="cancelled" ${d.status==='cancelled'?'selected':''}>Anulowany</option>
          </select>
        </div>
        <div class="action-group">
          <div class="action-label">Status płatności</div>
          <select class="action-sel" id="da_payment">
            <option value="pending" ${d.payment_status==='pending'?'selected':''}>Oczekuje</option>
            <option value="paid" ${d.payment_status==='paid'?'selected':''}>Opłacone ✓</option>
            <option value="cancelled" ${d.payment_status==='cancelled'?'selected':''}>Anulowane</option>
          </select>
        </div>
      </div>

      <div>
        <div class="action-label" style="margin-top:16px">Notatki admina</div>
        <textarea class="notes-textarea" id="da_notes">${esc(d.admin_notes || '')}</textarea>
      </div>

      <button class="btn-save" onclick="saveDrawer(${id})">Zapisz zmiany</button>
      <div class="drawer__msg" id="drawerMsg"></div>
    `;
  } catch {
    body.innerHTML = '<p style="color:#ff8a8a">Błąd ładowania szczegółów.</p>';
  }
}

async function saveDrawer(id) {
  const msgEl = document.getElementById('drawerMsg');
  msgEl.textContent = '';
  try {
    const r = await apiFetch(`/registration/${id}`, {
      method: 'PATCH',
      body: JSON.stringify({
        status:         document.getElementById('da_status')?.value,
        payment_status: document.getElementById('da_payment')?.value,
        admin_notes:    document.getElementById('da_notes')?.value,
      }),
    });
    const d = await r.json();
    if (!r.ok) { msgEl.style.color='#ff8a8a'; msgEl.textContent = d.error; return; }
    msgEl.style.color = 'var(--green)';
    msgEl.textContent = '✓ Zapisano';
    setTimeout(() => { msgEl.textContent = ''; }, 3000);
    // Refresh list if visible
    if (document.getElementById('page-registrations').classList.contains('active')) loadRegistrations();
    if (document.getElementById('page-dashboard').classList.contains('active')) loadDashboard();
  } catch { msgEl.style.color='#ff8a8a'; msgEl.textContent = 'Błąd zapisu'; }
}

function closeDrawer() {
  document.getElementById('drawerOverlay').classList.remove('open');
  document.getElementById('drawer').classList.remove('open');
}

// ── Export ────────────────────────────────────────────────────────
async function exportCSV() {
  const btn = document.getElementById('exportBtn');
  btn.textContent = '…';
  try {
    const r = await fetch(`${ADMIN_API}/export`, { headers: { Authorization: `Bearer ${token}` } });
    if (r.status === 401) { sessionStorage.clear(); location.reload(); return; }
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `km-zapisy-${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  } catch { alert('Błąd eksportu'); }
  finally { btn.textContent = '↓ CSV'; }
}

// ── Helpers ───────────────────────────────────────────────────────
function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function fmtDate(d) {
  if (!d) return '—';
  try { return new Date(d).toLocaleDateString('pl-PL', { day:'2-digit', month:'2-digit', year:'numeric' }); }
  catch { return d; }
}
function fmtMoney(v) {
  const n = parseFloat(v) || 0;
  return n.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}
function statusTag(s) {
  const map = { new:'tag-new', confirmed:'tag-confirmed', waitlist:'tag-waitlist', cancelled:'tag-cancelled' };
  const lbl = { new:'Nowy', confirmed:'Potwierdz.', waitlist:'Lista rez.', cancelled:'Anulowany' };
  return `<span class="tag ${map[s]||'tag-new'}">${lbl[s]||s}</span>`;
}
function payTag(s) {
  const map = { pending:'tag-pending', paid:'tag-paid', cancelled:'tag-cancelled' };
  const lbl = { pending:'Oczekuje', paid:'Opłacone ✓', cancelled:'Anulowane' };
  return `<span class="tag ${map[s]||'tag-pending'}">${lbl[s]||s}</span>`;
}
</script>
</body>
</html>
