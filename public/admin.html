<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Admina ‚Äî Krav Maga Saggita</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --red:#c42000; --red-dark:#9a1800; --red-soft:rgba(196,32,0,.12);
  --bg:#f5f4f0; --surface:#ffffff; --surface2:#f9f8f5; --surface3:#f0efe9;
  --border:#e8e6df; --border2:#d4d1c8;
  --text:#1a1917; --muted:#7a786f; --muted2:#b0aea6;
  --green:#16a34a; --green-soft:rgba(22,163,74,.1);
  --yellow:#d97706; --yellow-soft:rgba(217,119,6,.1);
  --blue:#2563eb; --blue-soft:rgba(37,99,235,.1);
  --font:'Outfit',sans-serif; --mono:'DM Mono',monospace;
  --radius:8px; --shadow:0 1px 3px rgba(0,0,0,.08),0 4px 16px rgba(0,0,0,.06);
  --shadow-lg:0 4px 24px rgba(0,0,0,.12);
}

*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;}

/* TOPBAR */
.topbar{background:var(--text);color:#fff;height:52px;display:flex;align-items:center;padding:0 24px;gap:16px;position:sticky;top:0;z-index:200;}
.topbar-brand{font-size:15px;font-weight:800;letter-spacing:.08em;display:flex;align-items:center;gap:8px;}
.topbar-brand .slash{color:var(--red);font-weight:300;}
.topbar-nav{display:flex;gap:2px;margin-left:24px;}
.topbar-nav-item{padding:6px 14px;border-radius:5px;cursor:pointer;font-size:13px;font-weight:500;color:rgba(255,255,255,.6);transition:all .15s;}
.topbar-nav-item:hover{background:rgba(255,255,255,.08);color:#fff;}
.topbar-nav-item.active{background:var(--red);color:#fff;}
.topbar-sep{flex:1;}
.topbar-user{display:flex;align-items:center;gap:10px;font-size:13px;color:rgba(255,255,255,.7);}
.avatar-sm{width:30px;height:30px;background:var(--red);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#fff;}
.btn-logout{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.7);padding:4px 11px;border-radius:4px;font-size:12px;cursor:pointer;font-family:var(--font);transition:all .15s;}
.btn-logout:hover{background:rgba(255,255,255,.2);color:#fff;}

/* LAYOUT */
.layout{display:flex;min-height:calc(100vh - 52px);}
.sidebar{width:220px;background:var(--surface);border-right:1px solid var(--border);padding:16px 0;display:flex;flex-direction:column;gap:2px;position:sticky;top:52px;height:calc(100vh - 52px);overflow-y:auto;}
.sidebar-label{padding:14px 16px 6px;font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--muted2);}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 16px;cursor:pointer;font-size:13px;font-weight:500;color:var(--muted);border-right:3px solid transparent;transition:all .12s;margin:0 4px;border-radius:6px 0 0 6px;}
.nav-item:hover{background:var(--surface2);color:var(--text);}
.nav-item.active{background:var(--red-soft);color:var(--red);font-weight:600;}
.nav-icon{font-size:15px;width:18px;text-align:center;}
.nav-count{margin-left:auto;background:var(--surface3);color:var(--muted);font-size:11px;padding:1px 7px;border-radius:10px;font-weight:600;}
.nav-item.active .nav-count{background:var(--red);color:#fff;}
.main{flex:1;overflow-y:auto;min-width:0;}

/* VIEWS */
.view{display:none;animation:fadeIn .2s ease;}
.view.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* PAGE HEADER */
.page-head{padding:24px 28px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);}
.page-title{font-size:22px;font-weight:800;color:var(--text);}
.page-sub{font-size:13px;color:var(--muted);margin-top:2px;}
.page-actions{margin-left:auto;display:flex;gap:8px;align-items:center;}

/* STATS ROW */
.stats-row{display:flex;gap:1px;background:var(--border);border-bottom:1px solid var(--border);}
.stat-box{flex:1;background:var(--surface);padding:16px 20px;}
.stat-label{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted2);margin-bottom:4px;}
.stat-num{font-size:28px;font-weight:900;color:var(--text);line-height:1;}
.stat-num.red{color:var(--red);}
.stat-num.green{color:var(--green);}
.stat-num.blue{color:var(--blue);}
.stat-sub{font-size:11px;color:var(--muted);margin-top:3px;}

/* FILTERS BAR */
.filters{padding:14px 28px;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.search-wrap{position:relative;flex:1;min-width:200px;max-width:320px;}
.search-wrap input{width:100%;padding:8px 12px 8px 34px;border:1px solid var(--border2);border-radius:6px;background:var(--surface);font-family:var(--font);font-size:13px;outline:none;transition:border-color .15s;color:var(--text);}
.search-wrap input:focus{border-color:var(--red);}
.search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted2);font-size:14px;}
.filter-select{padding:8px 10px;border:1px solid var(--border2);border-radius:6px;background:var(--surface);font-family:var(--font);font-size:13px;color:var(--text);outline:none;cursor:pointer;min-width:130px;}
.filter-select:focus{border-color:var(--red);}
.filter-clear{padding:7px 12px;border:1px solid var(--border2);border-radius:6px;background:none;font-size:12px;color:var(--muted);cursor:pointer;font-family:var(--font);}
.filter-clear:hover{border-color:var(--red);color:var(--red);}
.filters-right{margin-left:auto;display:flex;gap:8px;align-items:center;}

/* TABLE */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
thead th{text-align:left;padding:10px 14px;font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);border-bottom:2px solid var(--border);white-space:nowrap;background:var(--surface2);cursor:pointer;user-select:none;}
thead th:hover{color:var(--text);}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s;}
tbody tr:hover{background:#faf9f6;}
tbody td{padding:11px 14px;vertical-align:middle;}
td.primary{font-weight:600;color:var(--text);}
td.mono{font-family:var(--mono);font-size:12px;}
td.muted{color:var(--muted);font-size:13px;}
.row-actions{display:flex;gap:4px;opacity:0;transition:opacity .15s;}
tbody tr:hover .row-actions{opacity:1;}
.row-btn{padding:4px 9px;border-radius:4px;font-size:11px;font-weight:600;cursor:pointer;font-family:var(--font);border:1px solid transparent;transition:all .15s;}
.row-btn-edit{background:var(--surface3);color:var(--muted);border-color:var(--border2);}
.row-btn-edit:hover{background:var(--blue-soft);color:var(--blue);border-color:var(--blue);}
.row-btn-del{background:var(--surface3);color:var(--muted);border-color:var(--border2);}
.row-btn-del:hover{background:var(--red-soft);color:var(--red);border-color:var(--red);}

/* TAGS */
.tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;letter-spacing:.04em;}
.tag-green{background:var(--green-soft);color:var(--green);}
.tag-red{background:var(--red-soft);color:var(--red);}
.tag-yellow{background:var(--yellow-soft);color:var(--yellow);}
.tag-blue{background:var(--blue-soft);color:var(--blue);}
.tag-gray{background:var(--surface3);color:var(--muted);}

/* PAGINATION */
.pagination{display:flex;align-items:center;justify-content:space-between;padding:12px 28px;border-top:1px solid var(--border);font-size:13px;color:var(--muted);}
.pag-btns{display:flex;gap:4px;}
.pag-btn{padding:5px 11px;border:1px solid var(--border2);border-radius:5px;cursor:pointer;font-size:13px;background:var(--surface);font-family:var(--font);color:var(--text);transition:all .15s;}
.pag-btn:hover{border-color:var(--red);color:var(--red);}
.pag-btn.active{background:var(--red);border-color:var(--red);color:#fff;}
.pag-btn:disabled{opacity:.4;cursor:default;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;font-family:var(--font);border:none;transition:all .15s;text-decoration:none;}
.btn-primary{background:var(--red);color:#fff;}
.btn-primary:hover{background:var(--red-dark);}
.btn-secondary{background:var(--surface3);color:var(--text);border:1px solid var(--border2);}
.btn-secondary:hover{border-color:var(--red);color:var(--red);}
.btn-ghost{background:transparent;color:var(--muted);border:1px solid var(--border2);}
.btn-ghost:hover{color:var(--text);border-color:var(--border2);}
.btn-danger{background:var(--red-soft);color:var(--red);border:1px solid rgba(196,32,0,.2);}
.btn-danger:hover{background:var(--red);color:#fff;}
.btn-sm{padding:5px 11px;font-size:12px;}
.btn-icon{width:32px;height:32px;padding:0;display:inline-flex;align-items:center;justify-content:center;border-radius:5px;border:1px solid var(--border2);background:var(--surface);cursor:pointer;font-size:14px;transition:all .15s;color:var(--muted);}
.btn-icon:hover{border-color:var(--red);color:var(--red);}

/* DRAWER (side panel) */
.drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;display:none;backdrop-filter:blur(2px);}
.drawer-overlay.open{display:block;}
.drawer{position:fixed;top:0;right:0;width:520px;max-width:95vw;height:100vh;background:var(--surface);box-shadow:var(--shadow-lg);z-index:501;transform:translateX(100%);transition:transform .25s ease;display:flex;flex-direction:column;}
.drawer.open{transform:translateX(0);}
.drawer-head{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.drawer-title{font-size:18px;font-weight:800;}
.drawer-close{background:none;border:none;cursor:pointer;font-size:20px;color:var(--muted);width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:4px;}
.drawer-close:hover{background:var(--surface3);color:var(--text);}
.drawer-body{flex:1;overflow-y:auto;padding:0;}
.drawer-section{padding:20px 24px;border-bottom:1px solid var(--border);}
.drawer-section-title{font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted2);margin-bottom:14px;}
.drawer-foot{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;flex-shrink:0;}

/* FORM */
.field{margin-bottom:14px;}
.field label{display:block;font-size:11px;font-weight:700;color:var(--muted);margin-bottom:5px;letter-spacing:.05em;text-transform:uppercase;}
.field input,.field select,.field textarea{width:100%;padding:9px 12px;border:1px solid var(--border2);border-radius:6px;background:var(--surface);font-family:var(--font);font-size:13px;color:var(--text);outline:none;transition:border-color .15s;}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--red);}
.field textarea{resize:vertical;min-height:72px;}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.field-note{font-size:11px;color:var(--muted);margin-top:4px;}

/* MINI TABLE in drawer */
.mini-table{width:100%;border-collapse:collapse;font-size:12px;}
.mini-table th{text-align:left;padding:7px 10px;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted2);border-bottom:1px solid var(--border);}
.mini-table td{padding:8px 10px;border-bottom:1px solid var(--border);}
.mini-table tr:last-child td{border-bottom:none;}
.mini-table tr:hover td{background:var(--surface2);}

/* PROFILE CARD */
.profile-card{background:var(--surface2);border-bottom:1px solid var(--border);padding:20px 24px;display:flex;gap:16px;align-items:flex-start;}
.profile-avatar{width:52px;height:52px;border-radius:10px;background:var(--red);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:#fff;flex-shrink:0;letter-spacing:-.02em;}
.profile-name{font-size:18px;font-weight:800;}
.profile-meta{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}
.profile-tag{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:4px;}
.profile-stats{display:flex;gap:1px;background:var(--border);}
.profile-stat{flex:1;background:var(--surface);padding:12px 14px;text-align:center;}
.profile-stat-val{font-size:20px;font-weight:800;}
.profile-stat-val.green{color:var(--green);}
.profile-stat-label{font-size:10px;color:var(--muted2);text-transform:uppercase;letter-spacing:.08em;margin-top:2px;}

/* TABS in drawer */
.drawer-tabs{display:flex;padding:0 24px;border-bottom:1px solid var(--border);gap:0;background:var(--surface);}
.drawer-tab{padding:12px 16px;font-size:13px;font-weight:500;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .15s;white-space:nowrap;}
.drawer-tab.active{color:var(--red);border-bottom-color:var(--red);font-weight:600;}
.drawer-tab:hover{color:var(--text);}

/* ATTENDANCE TOGGLE */
.att-row{display:flex;align-items:center;padding:8px 10px;border-radius:6px;transition:background .1s;}
.att-row:hover{background:var(--surface2);}
.att-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.att-dot.present{background:var(--green);}
.att-dot.absent{background:var(--border2);}
.att-date{font-family:var(--mono);font-size:12px;color:var(--muted);min-width:90px;}
.att-group{flex:1;font-size:12px;color:var(--muted);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:600;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border-radius:10px;width:100%;max-width:440px;margin:16px;box-shadow:var(--shadow-lg);}
.modal-head{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.modal-title{font-size:16px;font-weight:800;}
.modal-close{background:none;border:none;cursor:pointer;font-size:18px;color:var(--muted);}
.modal-body{padding:22px;}
.modal-foot{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;}

/* EMPTY */
.empty{text-align:center;padding:60px 24px;color:var(--muted);}
.empty-icon{font-size:40px;margin-bottom:10px;opacity:.5;}
.empty-title{font-size:16px;font-weight:700;color:var(--text);margin-bottom:6px;}

/* LOADING */
.loading{display:flex;align-items:center;justify-content:center;padding:48px;gap:10px;color:var(--muted);}
.spin{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--red);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* TOAST */
#toast{position:fixed;bottom:24px;right:24px;padding:12px 18px;border-radius:7px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;}

/* LOGIN */
#loginScreen{position:fixed;inset:0;background:var(--text);display:flex;align-items:center;justify-content:center;z-index:9999;}
.login-box{width:100%;max-width:360px;padding:0 20px;}
.login-logo{font-size:11px;font-weight:700;letter-spacing:.16em;text-transform:uppercase;color:var(--red);text-align:center;margin-bottom:6px;}
.login-title{font-size:36px;font-weight:900;color:#fff;text-align:center;margin-bottom:32px;line-height:1.1;}
.login-card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:28px;}
.login-card .field label{color:rgba(255,255,255,.5);}
.login-card .field input{background:rgba(255,255,255,.07);border-color:rgba(255,255,255,.15);color:#fff;}
.login-card .field input::placeholder{color:rgba(255,255,255,.3);}
.login-card .field input:focus{border-color:var(--red);}
.login-btn{width:100%;background:var(--red);color:#fff;border:none;padding:12px;border-radius:6px;font-size:14px;font-weight:700;cursor:pointer;font-family:var(--font);margin-top:4px;transition:background .15s;}
.login-btn:hover{background:var(--red-dark);}
.login-err{background:rgba(196,32,0,.2);border:1px solid rgba(196,32,0,.4);color:#ff9999;padding:9px 12px;border-radius:5px;font-size:13px;margin-bottom:14px;display:none;}

/* SCROLLBAR */
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">Krav Maga Saggita</div>
    <div class="login-title">Panel<br>Admina</div>
    <div class="login-card">
      <div class="login-err" id="loginErr"></div>
      <div class="field"><label>Login</label><input id="lu" type="text" placeholder="login" autocomplete="username"></div>
      <div class="field"><label>Has≈Ço</label><input id="lp" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
      <button class="login-btn" onclick="doLogin()">Zaloguj siƒô ‚Üí</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none;">
  <div class="topbar">
    <div class="topbar-brand">SAGGITA <span class="slash">/</span> ADMIN</div>
    <nav class="topbar-nav">
      <div class="topbar-nav-item active" onclick="goto('students')" data-nav="students">Kursanci</div>
      <div class="topbar-nav-item" onclick="goto('registrations')" data-nav="registrations">Zapisy</div>
      <div class="topbar-nav-item" onclick="goto('history')" data-nav="history">Historia</div>
      <div class="topbar-nav-item" onclick="goto('groups')" data-nav="groups">Grupy</div>
    </nav>
    <div class="topbar-sep"></div>
    <div class="topbar-user">
      <div class="avatar-sm" id="uAvatar">A</div>
      <span id="uName">Admin</span>
      <button class="btn-logout" onclick="logout()">Wyloguj</button>
    </div>
  </div>

  <div class="layout">
    <nav class="sidebar">
      <div class="sidebar-label">Kursanci</div>
      <div class="nav-item active" onclick="setStudentFilter('all')" id="snav-all">
        <span class="nav-icon">üë•</span> Wszyscy <span class="nav-count" id="sc-all">‚Äî</span>
      </div>
      <div class="nav-item" onclick="setStudentFilter('active')" id="snav-active">
        <span class="nav-icon">‚úÖ</span> Aktywni <span class="nav-count" id="sc-active">‚Äî</span>
      </div>
      <div class="nav-item" onclick="setStudentFilter('inactive')" id="snav-inactive">
        <span class="nav-icon">‚õî</span> Nieaktywni <span class="nav-count" id="sc-inactive">‚Äî</span>
      </div>
      <div class="nav-item" onclick="setStudentFilter('unpaid')" id="snav-unpaid">
        <span class="nav-icon">üí∞</span> Nieop≈Çaceni <span class="nav-count" id="sc-unpaid">‚Äî</span>
      </div>
      <div class="sidebar-label">Akcje</div>
      <div class="nav-item" onclick="openNewStudentDrawer()">
        <span class="nav-icon">‚ûï</span> Nowy kursant
      </div>
    </nav>

    <main class="main">
      <!-- ‚ïê‚ïê‚ïê VIEW: STUDENTS ‚ïê‚ïê‚ïê -->
      <div class="view active" id="view-students">
        <div class="page-head">
          <div>
            <div class="page-title" id="studentsTitle">Wszyscy kursanci</div>
            <div class="page-sub" id="studentsSubtitle">≈Åadowanie...</div>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="openNewStudentDrawer()">+ Dodaj kursanta</button>
          </div>
        </div>

        <div class="stats-row" id="studentsStats">
          <div class="stat-box"><div class="stat-label">≈ÅƒÖcznie</div><div class="stat-num" id="st-total">‚Äî</div></div>
          <div class="stat-box"><div class="stat-label">Aktywni</div><div class="stat-num green" id="st-active">‚Äî</div></div>
          <div class="stat-box"><div class="stat-label">Legacy</div><div class="stat-num blue" id="st-legacy">‚Äî</div></div>
          <div class="stat-box"><div class="stat-label">Nowe zapisy</div><div class="stat-num" id="st-new">‚Äî</div></div>
          <div class="stat-box"><div class="stat-label">Nieop≈Çaceni</div><div class="stat-num red" id="st-unpaid">‚Äî</div></div>
        </div>

        <div class="filters">
          <div class="search-wrap">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInput" placeholder="Szukaj po nazwisku, emailu, telefonie..." oninput="debounceSearch()">
          </div>
          <select class="filter-select" id="filterGroup" onchange="loadStudents()">
            <option value="">Wszystkie grupy</option>
          </select>
          <select class="filter-select" id="filterCity" onchange="loadStudents()">
            <option value="">Wszystkie miasta</option>
          </select>
          <select class="filter-select" id="filterPayment" onchange="loadStudents()">
            <option value="">Ka≈ºdy status p≈Çatno≈õci</option>
            <option value="paid">Op≈Çaceni</option>
            <option value="unpaid">Nieop≈Çaceni</option>
            <option value="pending">OczekujƒÖcy</option>
          </select>
          <button class="filter-clear" onclick="clearFilters()">‚úï Wyczy≈õƒá</button>
          <div class="filters-right">
            <span id="resultsCount" style="font-size:12px;color:var(--muted)"></span>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th onclick="sortBy('last_name')">Kursant ‚Üï</th>
                <th>Kontakt</th>
                <th>Grupy</th>
                <th>≈πr√≥d≈Ço</th>
                <th onclick="sortBy('total_present')">Treningi ‚Üï</th>
                <th>Ostatni trening</th>
                <th>Status p≈Çatno≈õci</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="studentsTbody">
              <tr><td colspan="8"><div class="loading"><div class="spin"></div>≈Åadowanie...</div></td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="studentsPag"></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê VIEW: REGISTRATIONS ‚ïê‚ïê‚ïê -->
      <div class="view" id="view-registrations">
        <div class="page-head">
          <div><div class="page-title">Nowe zapisy</div><div class="page-sub">Zapisy ze strony rejestracji</div></div>
          <div class="page-actions"></div>
        </div>
        <div class="stats-row" id="regStats"></div>
        <div class="filters">
          <div class="search-wrap">
            <span class="search-icon">üîç</span>
            <input type="text" id="regSearch" placeholder="Szukaj..." oninput="debounceRegSearch()">
          </div>
          <select class="filter-select" id="regFilterStatus" onchange="loadRegistrations()">
            <option value="">Ka≈ºdy status</option>
            <option value="new">Nowy</option>
            <option value="active">Aktywny</option>
            <option value="cancelled">Anulowany</option>
          </select>
          <select class="filter-select" id="regFilterPayment" onchange="loadRegistrations()">
            <option value="">Ka≈ºda p≈Çatno≈õƒá</option>
            <option value="paid">Op≈Çacony</option>
            <option value="unpaid">Nieop≈Çacony</option>
            <option value="pending">Oczekuje</option>
          </select>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr>
              <th>Kursant</th><th>Kontakt</th><th>Grupa</th><th>Karnet</th>
              <th>Kwota</th><th>Status</th><th>P≈Çatno≈õƒá</th><th>Data zapisu</th><th></th>
            </tr></thead>
            <tbody id="regTbody"><tr><td colspan="9"><div class="loading"><div class="spin"></div>≈Åadowanie...</div></td></tr></tbody>
          </table>
        </div>
        <div class="pagination" id="regPag"></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê VIEW: HISTORY ‚ïê‚ïê‚ïê -->
      <div class="view" id="view-history">
        <div class="page-head">
          <div><div class="page-title">Historia (stary system)</div><div class="page-sub">Dane zmigrowane z poprzedniej aplikacji</div></div>
        </div>
        <div style="display:flex;gap:2px;padding:0 28px;border-bottom:1px solid var(--border);">
          <button class="drawer-tab active" onclick="switchHistTab('students')" id="htab-students">Kursanci legacy</button>
          <button class="drawer-tab" onclick="switchHistTab('payments')" id="htab-payments">P≈Çatno≈õci legacy</button>
          <button class="drawer-tab" onclick="switchHistTab('stats')" id="htab-stats">Statystyki</button>
        </div>
        <div id="histContent"><div class="loading"><div class="spin"></div>≈Åadowanie...</div></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê VIEW: GROUPS ‚ïê‚ïê‚ïê -->
      <div class="view" id="view-groups">
        <div class="page-head">
          <div><div class="page-title">Grupy treningowe</div><div class="page-sub">ZarzƒÖdzanie grupami i harmonogramami</div></div>
        </div>
        <div id="groupsContent"><div class="loading"><div class="spin"></div>≈Åadowanie...</div></div>
      </div>

    </main>
  </div>
</div>

<!-- DRAWER: Kartoteka kursanta -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="drawer" id="studentDrawer">
  <div class="drawer-head">
    <div class="drawer-title" id="drawerTitle">Kartoteka kursanta</div>
    <button class="drawer-close" onclick="closeDrawer()">‚úï</button>
  </div>
  <div class="drawer-body" id="drawerBody">
    <div class="loading"><div class="spin"></div>≈Åadowanie...</div>
  </div>
</div>

<!-- MODAL: Nowy kursant -->
<div class="modal-overlay" id="modalNewStudent">
  <div class="modal">
    <div class="modal-head"><div class="modal-title">Nowy kursant</div><button class="modal-close" onclick="closeModal('modalNewStudent')">‚úï</button></div>
    <div class="modal-body">
      <div class="field-row">
        <div class="field"><label>Imiƒô *</label><input id="ns-first" type="text" placeholder="Imiƒô"></div>
        <div class="field"><label>Nazwisko *</label><input id="ns-last" type="text" placeholder="Nazwisko"></div>
      </div>
      <div class="field-row">
        <div class="field"><label>Email</label><input id="ns-email" type="email" placeholder="email@example.com"></div>
        <div class="field"><label>Telefon</label><input id="ns-phone" type="tel" placeholder="600 000 000"></div>
      </div>
      <div class="field-row">
        <div class="field"><label>Rok urodzenia</label><input id="ns-birth" type="number" placeholder="1990" min="1950" max="2015"></div>
        <div class="field"><label>Grupa</label>
          <select id="ns-group"><option value="">Brak grupy</option></select>
        </div>
      </div>
      <div id="nsErr" style="color:var(--red);font-size:13px;display:none;margin-top:4px;"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('modalNewStudent')">Anuluj</button>
      <button class="btn btn-primary" onclick="createStudent()">Dodaj kursanta</button>
    </div>
  </div>
</div>

<!-- MODAL: Potwierdzenie usuniƒôcia -->
<div class="modal-overlay" id="modalConfirm">
  <div class="modal">
    <div class="modal-head"><div class="modal-title" id="confirmTitle">Potwierd≈∫</div><button class="modal-close" onclick="closeModal('modalConfirm')">‚úï</button></div>
    <div class="modal-body"><p id="confirmMsg" style="color:var(--muted);line-height:1.6;"></p></div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('modalConfirm')">Anuluj</button>
      <button class="btn btn-danger" id="confirmBtn">Usu≈Ñ</button>
    </div>
  </div>
</div>

<!-- MODAL: P≈Çatno≈õƒá -->
<div class="modal-overlay" id="modalPayment">
  <div class="modal">
    <div class="modal-head"><div class="modal-title" id="payModalTitle">P≈Çatno≈õƒá</div><button class="modal-close" onclick="closeModal('modalPayment')">‚úï</button></div>
    <div class="modal-body">
      <div class="field-row">
        <div class="field"><label>Kwota (z≈Ç) *</label><input id="pay-amount" type="number" step="0.01" placeholder="120.00"></div>
        <div class="field"><label>Data</label><input id="pay-date" type="date"></div>
      </div>
      <div class="field"><label>Notatka</label><input id="pay-note" type="text" placeholder="np. przelew, got√≥wka..."></div>
      <div id="payErr" style="color:var(--red);font-size:13px;display:none;margin-top:4px;"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('modalPayment')">Anuluj</button>
      <button class="btn btn-primary" id="payModalBtn" onclick="submitPayment()">Zapisz</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const API='';
let TOKEN=localStorage.getItem('admin_token')||'';
let currentView='students';
let studentsPage=1,studentSort='last_name',studentSortDir='asc';
let studentFilter='all';
let currentStudentId=null,currentDrawerTab='info';
let editingPaymentId=null;
let searchTimer=null,regSearchTimer=null;
let regPage=1;
let groups=[],locations=[];

// ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function api(path,opts={}){
  const res=await fetch(API+path,{
    headers:{'Content-Type':'application/json','Authorization':TOKEN?`Bearer ${TOKEN}`:''},
    ...opts, body:opts.body?JSON.stringify(opts.body):undefined
  });
  const data=await res.json().catch(()=>({}));
  if(!res.ok) throw new Error(data.error||`HTTP ${res.status}`);
  return data;
}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doLogin(){
  const u=document.getElementById('lu').value.trim();
  const p=document.getElementById('lp').value;
  const err=document.getElementById('loginErr');
  if(!u||!p){err.textContent='Podaj login i has≈Ço.';err.style.display='block';return;}
  try{
    const d=await api('/api/admin-api/login',{method:'POST',body:{username:u,password:p}});
    TOKEN=d.token; localStorage.setItem('admin_token',TOKEN);
    initApp(d.username);
  }catch(e){err.textContent=e.message;err.style.display='block';}
}
document.getElementById('lp').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
function logout(){TOKEN='';localStorage.removeItem('admin_token');location.reload();}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initApp(username){
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('uName').textContent=username||'Admin';
  document.getElementById('uAvatar').textContent=(username||'A')[0].toUpperCase();
  await loadMeta();
  loadStudents();
  loadStudentCounts();
}

async function loadMeta(){
  try{
    const [grpData,locData]=await Promise.all([
      api('/api/admin-api/groups'),
      api('/api/admin-api/locations')
    ]);
    groups=(grpData.rows||grpData)||[];
    // locations from groups
    const cities=[...new Set(groups.map(g=>g.city).filter(Boolean))];
    
    const gSel=document.getElementById('filterGroup');
    const nsSel=document.getElementById('ns-group');
    groups.forEach(g=>{
      gSel.innerHTML+=`<option value="${g.id}">${g.name}</option>`;
      nsSel.innerHTML+=`<option value="${g.id}">${g.name}</option>`;
    });
    
    const cSel=document.getElementById('filterCity');
    cities.forEach(c=>{ cSel.innerHTML+=`<option value="${c}">${c}</option>`; });
  }catch(e){console.error('meta',e);}
}

if(TOKEN){
  api('/api/admin-api/stats').then(()=>initApp(localStorage.getItem('admin_username')||'Admin'))
    .catch(()=>{TOKEN='';localStorage.removeItem('admin_token');});
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goto(view){
  currentView=view;
  document.querySelectorAll('[data-nav]').forEach(n=>n.classList.toggle('active',n.dataset.nav===view));
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(`view-${view}`)?.classList.add('active');
  // Update sidebar visibility
  document.querySelector('.sidebar').style.display=view==='students'?'flex':'none';
  if(view==='students') loadStudents();
  else if(view==='registrations') loadRegistrations();
  else if(view==='history'){loadHistory('students');}
  else if(view==='groups') loadGroupsView();
}

// ‚îÄ‚îÄ STUDENT SIDEBAR FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setStudentFilter(f){
  studentFilter=f;
  document.querySelectorAll('[id^="snav-"]').forEach(n=>n.classList.remove('active'));
  document.getElementById(`snav-${f}`)?.classList.add('active');
  // Sync filters
  const actSel=document.getElementById('filterPayment');
  if(f==='unpaid'){actSel.value='unpaid';}
  else{actSel.value='';}
  document.getElementById('filterGroup').value='';
  document.getElementById('filterCity').value='';
  document.getElementById('searchInput').value='';
  
  studentsPage=1;
  loadStudents();
}

async function loadStudentCounts(){
  try{
    const d=await api('/api/admin-api/stats');
    document.getElementById('sc-all').textContent=d.total||'0';
    // approximate counts
    document.getElementById('st-total').textContent=d.total||'‚Äî';
    document.getElementById('st-unpaid').textContent=d.pending||'‚Äî';
    document.getElementById('sc-unpaid').textContent=d.pending||'0';
  }catch(e){}
}

// ‚îÄ‚îÄ STUDENTS LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadStudents(){
  const tbody=document.getElementById('studentsTbody');
  tbody.innerHTML=`<tr><td colspan="8"><div class="loading"><div class="spin"></div>≈Åadowanie...</div></td></tr>`;
  
  const search=document.getElementById('searchInput')?.value||'';
  const group=document.getElementById('filterGroup')?.value||'';
  const city=document.getElementById('filterCity')?.value||'';
  let payment=document.getElementById('filterPayment')?.value||'';
  let is_active='';
  
  if(studentFilter==='active') is_active='true';
  else if(studentFilter==='inactive') is_active='false';
  else if(studentFilter==='unpaid') payment='unpaid';
  
  const params=new URLSearchParams({page:studentsPage,limit:60});
  if(search) params.set('search',search);
  if(group) params.set('group_id',group);
  if(city) params.set('city',city);
  if(payment) params.set('payment_status',payment);
  if(is_active!=='') params.set('is_active',is_active);
  
  try{
    const d=await api(`/api/admin-api/students?${params}`);
    const rows=d.rows||[];
    
    document.getElementById('resultsCount').textContent=`${d.total} wynik√≥w`;
    document.getElementById('studentsSubtitle').textContent=`${d.total} kursant√≥w`;
    document.getElementById('st-total').textContent=d.total||'‚Äî';
    
    // Count active/legacy
    const active=rows.filter(r=>r.is_active).length;
    const legacy=rows.filter(r=>r.source==='legacy').length;
    const newR=rows.filter(r=>r.source!=='legacy').length;
    const unpaid=rows.filter(r=>r.payment_status==='unpaid').length;
    document.getElementById('st-active').textContent=active;
    document.getElementById('st-legacy').textContent=legacy;
    document.getElementById('st-new').textContent=newR;
    document.getElementById('st-unpaid').textContent=unpaid;
    document.getElementById('sc-active').textContent=active;
    document.getElementById('sc-inactive').textContent=rows.filter(r=>!r.is_active).length;
    
    if(!rows.length){
      tbody.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">üë•</div><div class="empty-title">Brak wynik√≥w</div><p>Zmie≈Ñ filtry lub dodaj nowego kursanta.</p></div></td></tr>`;
      document.getElementById('studentsPag').innerHTML='';
      return;
    }
    
    tbody.innerHTML=rows.map(s=>`
      <tr onclick="openStudent(${s.id})" style="cursor:pointer">
        <td class="primary">
          ${s.first_name} ${s.last_name}
          ${!s.is_active?'<span class="tag tag-gray" style="margin-left:4px">Nieaktywny</span>':''}
        </td>
        <td class="muted">${s.email||''}${s.phone?`<br><span style="font-size:11px">${s.phone}</span>`:''}</td>
        <td>${groupTags(s.groups)}</td>
        <td>${sourceTag(s.source)}</td>
        <td>${s.total_present||0}<span style="color:var(--muted2)"> trening√≥w</span></td>
        <td class="muted mono">${s.last_training?fmtDate(s.last_training):'‚Äî'}</td>
        <td>${payTag(s.payment_status)}</td>
        <td onclick="event.stopPropagation()">
          <div class="row-actions">
            <button class="row-btn row-btn-edit" onclick="openStudent(${s.id})">Edytuj</button>
            <button class="row-btn row-btn-del" onclick="confirmDelete(${s.id},'${s.first_name} ${s.last_name}')">Usu≈Ñ</button>
          </div>
        </td>
      </tr>`).join('');
    
    renderPagination('studentsPag',studentsPage,d.total,60,(p)=>{studentsPage=p;loadStudents();});
  }catch(e){
    tbody.innerHTML=`<tr><td colspan="8" style="padding:24px;color:var(--red)">${e.message}</td></tr>`;
  }
}

function debounceSearch(){
  clearTimeout(searchTimer);
  searchTimer=setTimeout(()=>{studentsPage=1;loadStudents();},400);
}
function clearFilters(){
  document.getElementById('searchInput').value='';
  document.getElementById('filterGroup').value='';
  document.getElementById('filterCity').value='';
  document.getElementById('filterPayment').value='';
  studentFilter='all';
  document.querySelectorAll('[id^="snav-"]').forEach(n=>n.classList.remove('active'));
  document.getElementById('snav-all').classList.add('active');
  studentsPage=1;
  loadStudents();
}
function sortBy(field){
  if(studentSort===field) studentSortDir=studentSortDir==='asc'?'desc':'asc';
  else{studentSort=field;studentSortDir='asc';}
  loadStudents();
}

// ‚îÄ‚îÄ STUDENT DRAWER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openStudent(id){
  currentStudentId=id;
  currentDrawerTab='info';
  document.getElementById('drawerTitle').textContent='Kartoteka kursanta';
  document.getElementById('drawerBody').innerHTML='<div class="loading"><div class="spin"></div>≈Åadowanie...</div>';
  document.getElementById('drawerOverlay').classList.add('open');
  document.getElementById('studentDrawer').classList.add('open');
  await loadStudentDrawer(id,'info');
}
function closeDrawer(){
  document.getElementById('drawerOverlay').classList.remove('open');
  document.getElementById('studentDrawer').classList.remove('open');
  currentStudentId=null;
}

async function loadStudentDrawer(id,tab){
  currentDrawerTab=tab;
  const body=document.getElementById('drawerBody');
  body.innerHTML='<div class="loading"><div class="spin"></div>≈Åadowanie...</div>';
  
  try{
    const s=await api(`/api/admin-api/students?id=${id}`);
    const initials=(s.first_name?.[0]||'')+(s.last_name?.[0]||'');
    
    let content=`
      <div class="profile-card">
        <div class="profile-avatar">${initials}</div>
        <div style="flex:1">
          <div class="profile-name">${s.first_name} ${s.last_name}</div>
          <div class="profile-meta">
            ${s.email?`<span class="profile-tag">‚úâ ${s.email}</span>`:''}
            ${s.phone?`<span class="profile-tag">üìû ${s.phone}</span>`:''}
            ${s.birth_year?`<span class="profile-tag">üéÇ ${s.birth_year}</span>`:''}
            ${sourceTag(s.source)}
          </div>
        </div>
        <div>
          ${s.is_active?'<span class="tag tag-green">Aktywny</span>':'<span class="tag tag-red">Nieaktywny</span>'}
        </div>
      </div>
      <div class="profile-stats">
        <div class="profile-stat"><div class="profile-stat-val green">${s.total_present||0}</div><div class="profile-stat-label">Treningi</div></div>
        <div class="profile-stat"><div class="profile-stat-val">${s.attendance_pct||0}%</div><div class="profile-stat-label">Frekwencja</div></div>
        <div class="profile-stat"><div class="profile-stat-val">${s.total_legacy_paid?Number(s.total_legacy_paid).toFixed(0)+'z≈Ç':'‚Äî'}</div><div class="profile-stat-label">Wp≈Çacono</div></div>
        <div class="profile-stat"><div class="profile-stat-val">${s.last_training?fmtDate(s.last_training):'‚Äî'}</div><div class="profile-stat-label">Ostatni trening</div></div>
      </div>
      <div class="drawer-tabs">
        <div class="drawer-tab ${tab==='info'?'active':''}" onclick="loadStudentDrawer(${id},'info')">Dane</div>
        <div class="drawer-tab ${tab==='payments'?'active':''}" onclick="loadStudentDrawer(${id},'payments')">P≈Çatno≈õci</div>
        <div class="drawer-tab ${tab==='attendance'?'active':''}" onclick="loadStudentDrawer(${id},'attendance')">Obecno≈õci</div>
      </div>`;
    
    if(tab==='info'){
      content+=`
        <div class="drawer-section">
          <div class="drawer-section-title">Edytuj dane</div>
          <div class="field-row">
            <div class="field"><label>Imiƒô</label><input id="ed-first" value="${s.first_name||''}"></div>
            <div class="field"><label>Nazwisko</label><input id="ed-last" value="${s.last_name||''}"></div>
          </div>
          <div class="field-row">
            <div class="field"><label>Email</label><input id="ed-email" type="email" value="${s.email||''}"></div>
            <div class="field"><label>Telefon</label><input id="ed-phone" value="${s.phone||''}"></div>
          </div>
          <div class="field-row">
            <div class="field"><label>Rok urodzenia</label><input id="ed-birth" type="number" value="${s.birth_year||''}"></div>
            <div class="field"><label>Status</label>
              <select id="ed-active">
                <option value="true" ${s.is_active?'selected':''}>Aktywny</option>
                <option value="false" ${!s.is_active?'selected':''}>Nieaktywny</option>
              </select>
            </div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="saveStudent(${id})">Zapisz zmiany</button>
        </div>
        
        ${s.registration?`
        <div class="drawer-section">
          <div class="drawer-section-title">Zapis (nowy system)</div>
          <table class="mini-table">
            <tr><td style="color:var(--muted);width:120px">Grupa</td><td>${s.registration.group_name||'‚Äî'}</td></tr>
            <tr><td style="color:var(--muted)">Karnet</td><td>${s.registration.plan_name||'‚Äî'}</td></tr>
            <tr><td style="color:var(--muted)">Kwota</td><td><strong>${s.registration.total_amount||0} z≈Ç</strong></td></tr>
            <tr><td style="color:var(--muted)">Status p≈Çatno≈õci</td><td>
              <select onchange="changeRegPayStatus(${id},${s.registration.id},this.value)" style="border:1px solid var(--border2);border-radius:4px;padding:4px 8px;font-size:12px;background:var(--surface);font-family:var(--font)">
                <option value="paid" ${s.registration.payment_status==='paid'?'selected':''}>Op≈Çacony</option>
                <option value="unpaid" ${s.registration.payment_status==='unpaid'?'selected':''}>Nieop≈Çacony</option>
                <option value="pending" ${s.registration.payment_status==='pending'?'selected':''}>Oczekuje</option>
                <option value="waived" ${s.registration.payment_status==='waived'?'selected':''}>Zwolniony</option>
              </select>
            </td></tr>
            <tr><td style="color:var(--muted)">Ref.</td><td class="mono" style="font-size:11px">${s.registration.payment_ref||'‚Äî'}</td></tr>
          </table>
        </div>` : ''}
        
        <div class="drawer-section">
          <div class="drawer-section-title">Grupy treningowe</div>
          ${(s.groups||[]).map(g=>`
            <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);">
              <span style="font-size:13px">${g.name}</span>
              <button class="btn btn-ghost btn-sm" onclick="removeFromGroup(${id},${g.id})">Usu≈Ñ z grupy</button>
            </div>`).join('')}
          <div style="margin-top:10px;display:flex;gap:8px">
            <select id="addGroupSel" class="filter-select" style="flex:1">
              <option value="">Dodaj do grupy...</option>
              ${groups.map(g=>`<option value="${g.id}">${g.name}</option>`).join('')}
            </select>
            <button class="btn btn-secondary btn-sm" onclick="addToGroup(${id})">Dodaj</button>
          </div>
        </div>`;
    }
    
    if(tab==='payments'){
      const pdata=await api(`/api/admin-api/students?id=${id}&_route=payments`);
      const legacy=pdata.legacy||[];
      const regs=pdata.registrations||[];
      
      content+=`
        <div class="drawer-section">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <div class="drawer-section-title" style="margin:0">P≈Çatno≈õci rƒôczne (legacy)</div>
            <button class="btn btn-primary btn-sm" onclick="openPayModal(${id})">+ Dodaj p≈Çatno≈õƒá</button>
          </div>
          ${legacy.length?`
          <table class="mini-table">
            <thead><tr><th>Data</th><th>Kwota</th><th>Notatka</th><th></th></tr></thead>
            <tbody>${legacy.map(p=>`
              <tr>
                <td class="mono">${p.date?fmtDate(p.date):'‚Äî'}</td>
                <td><strong>${p.amount} z≈Ç</strong></td>
                <td style="color:var(--muted)">${p.note||'‚Äî'}</td>
                <td>
                  <button class="btn-icon" onclick="editPayment(${id},${p.id},${p.amount},'${p.date||''}','${(p.note||'').replace(/'/g,"\\'")}')" title="Edytuj">‚úèÔ∏è</button>
                  <button class="btn-icon" onclick="deletePayment(${id},${p.id})" title="Usu≈Ñ">üóëÔ∏è</button>
                </td>
              </tr>`).join('')}
            </tbody>
          </table>` : '<p style="color:var(--muted);font-size:13px">Brak p≈Çatno≈õci rƒôcznych.</p>'}
        </div>
        ${regs.length?`
        <div class="drawer-section">
          <div class="drawer-section-title">P≈Çatno≈õci z rejestracji</div>
          <table class="mini-table">
            <thead><tr><th>Data</th><th>Kwota</th><th>Karnet</th><th>Status</th></tr></thead>
            <tbody>${regs.map(p=>`
              <tr>
                <td class="mono">${p.date?fmtDate(p.date):'‚Äî'}</td>
                <td><strong>${p.amount} z≈Ç</strong></td>
                <td style="color:var(--muted)">${p.plan_name||'‚Äî'}</td>
                <td>${payTag(p.status)}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>` : ''}`;
    }
    
    if(tab==='attendance'){
      const adata=await api(`/api/admin-api/students?id=${id}&_route=attendance`);
      const rows=adata.rows||[];
      const present=rows.filter(r=>r.present).length;
      const pct=rows.length?Math.round(present/rows.length*100):0;
      
      content+=`
        <div class="drawer-section">
          <div class="drawer-section-title">Historia obecno≈õci</div>
          <div style="display:flex;gap:16px;margin-bottom:16px;padding:12px;background:var(--surface2);border-radius:6px;">
            <div style="text-align:center"><div style="font-size:24px;font-weight:800;color:var(--green)">${present}</div><div style="font-size:11px;color:var(--muted2)">OBECNY</div></div>
            <div style="text-align:center"><div style="font-size:24px;font-weight:800;color:var(--red)">${rows.length-present}</div><div style="font-size:11px;color:var(--muted2)">NIEOBECNY</div></div>
            <div style="text-align:center"><div style="font-size:24px;font-weight:800">${pct}%</div><div style="font-size:11px;color:var(--muted2)">FREKWENCJA</div></div>
            <div style="text-align:center"><div style="font-size:24px;font-weight:800">${rows.length}</div><div style="font-size:11px;color:var(--muted2)">≈ÅƒÑCZNIE</div></div>
          </div>
          ${rows.length?rows.map(a=>`
            <div class="att-row">
              <div class="att-dot ${a.present?'present':'absent'}"></div>
              <span class="att-date">${fmtDate(a.session_date)}</span>
              <span class="att-group">${a.group_name||'‚Äî'}</span>
              <span style="font-size:11px;color:${a.present?'var(--green)':'var(--muted2)'}">
                ${a.present?'‚úì Obecny':'‚úó Nieobecny'}
              </span>
              <button class="btn-icon" style="margin-left:8px" onclick="toggleAtt(${id},${a.id},${!a.present})" title="Zmie≈Ñ">${a.present?'‚úó':'‚úì'}</button>
            </div>`).join('') : '<p style="color:var(--muted);font-size:13px">Brak danych obecno≈õci.</p>'}
        </div>`;
    }
    
    body.innerHTML=content;
  }catch(e){
    body.innerHTML=`<div style="padding:24px;color:var(--red)">${e.message}</div>`;
  }
}

async function saveStudent(id){
  const data={
    first_name:document.getElementById('ed-first').value.trim(),
    last_name:document.getElementById('ed-last').value.trim(),
    email:document.getElementById('ed-email').value.trim()||null,
    phone:document.getElementById('ed-phone').value.trim()||null,
    birth_year:parseInt(document.getElementById('ed-birth').value)||null,
    is_active:document.getElementById('ed-active').value==='true',
  };
  try{
    await api(`/api/admin-api/students?id=${id}`,{method:'PATCH',body:data});
    toast('‚úÖ Dane kursanta zapisane');
    loadStudents();
  }catch(e){ toast('‚ùå '+e.message,'red'); }
}

async function changeRegPayStatus(studentId,regId,status){
  try{
    await api(`/api/admin-api/students?id=${studentId}&_route=reg-payment`,{
      method:'PATCH',body:{registration_id:regId,payment_status:status}
    });
    toast('‚úÖ Status p≈Çatno≈õci zaktualizowany');
    loadStudents();
  }catch(e){ toast('‚ùå '+e.message,'red'); }
}

async function removeFromGroup(studentId,groupId){
  try{
    await api(`/api/admin-api/students?id=${studentId}&_route=groups&group_id=${groupId}`,{method:'DELETE'});
    toast('‚úÖ Usuniƒôto z grupy');
    loadStudentDrawer(studentId,'info');
  }catch(e){ toast('‚ùå '+e.message,'red'); }
}

async function addToGroup(studentId){
  const gid=document.getElementById('addGroupSel').value;
  if(!gid) return;
  try{
    await api(`/api/admin-api/students?id=${studentId}&_route=groups`,{method:'POST',body:{group_id:parseInt(gid)}});
    toast('‚úÖ Dodano do grupy');
    loadStudentDrawer(studentId,'info');
  }catch(e){ toast('‚ùå '+e.message,'red'); }
}

async function toggleAtt(studentId,attId,present){
  try{
    await api(`/api/admin-api/students?id=${studentId}&_route=attendance&aid=${attId}`,{method:'PATCH',body:{present}});
    toast('‚úÖ Obecno≈õƒá zaktualizowana');
    loadStudentDrawer(studentId,'attendance');
  }catch(e){ toast('‚ùå '+e.message,'red'); }
}

// ‚îÄ‚îÄ PAYMENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openPayModal(studentId,pid=null,amount='',date='',note=''){
  editingPaymentId=pid;
  document.getElementById('payModalTitle').textContent=pid?'Edytuj p≈Çatno≈õƒá':'Nowa p≈Çatno≈õƒá';
  document.getElementById('pay-amount').value=amount;
  document.getElementById('pay-date').value=date||new Date().toISOString().slice(0,10);
  document.getElementById('pay-note').value=note;
  document.getElementById('payErr').style.display='none';
  document.getElementById('modalPayment').classList.add('open');
  document.getElementById('modalPayment')._studentId=studentId;
}
function editPayment(studentId,pid,amount,date,note){
  openPayModal(studentId,pid,amount,date.slice(0,10),note);
}
async function submitPayment(){
  const studentId=document.getElementById('modalPayment')._studentId;
  const amount=parseFloat(document.getElementById('pay-amount').value);
  const date=document.getElementById('pay-date').value;
  const note=document.getElementById('pay-note').value;
  const err=document.getElementById('payErr');
  if(!amount){ err.textContent='Podaj kwotƒô.'; err.style.display='block'; return; }
  try{
    if(editingPaymentId){
      await api(`/api/admin-api/students?id=${studentId}&_route=payments&pid=${editingPaymentId}`,
        {method:'PATCH',body:{amount,paid_at:date,note:note||null}});
    } else {
      await api(`/api/admin-api/students?id=${studentId}&_route=payments`,
        {method:'POST',body:{amount,date,note:note||null}});
    }
    closeModal('modalPayment');
    toast('‚úÖ P≈Çatno≈õƒá zapisana');
    loadStudentDrawer(studentId,'payments');
    loadStudents();
  }catch(e){ err.textContent=e.message; err.style.display='block'; }
}
async function deletePayment(studentId,pid){
  if(!confirm('UsunƒÖƒá tƒô p≈Çatno≈õƒá?')) return;
  try{
    await api(`/api/admin-api/students?id=${studentId}&_route=payments&pid=${pid}`,{method:'DELETE'});
    toast('‚úÖ P≈Çatno≈õƒá usuniƒôta');
    loadStudentDrawer(studentId,'payments');
    loadStudents();
  }catch(e){ toast('‚ùå '+e.message,'red'); }
}

// ‚îÄ‚îÄ NEW STUDENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openNewStudentDrawer(){
  document.getElementById('ns-first').value='';
  document.getElementById('ns-last').value='';
  document.getElementById('ns-email').value='';
  document.getElementById('ns-phone').value='';
  document.getElementById('ns-birth').value='';
  document.getElementById('ns-group').value='';
  document.getElementById('nsErr').style.display='none';
  document.getElementById('modalNewStudent').classList.add('open');
}
async function createStudent(){
  const first=document.getElementById('ns-first').value.trim();
  const last=document.getElementById('ns-last').value.trim();
  const err=document.getElementById('nsErr');
  if(!first||!last){ err.textContent='Imiƒô i nazwisko sƒÖ wymagane.'; err.style.display='block'; return; }
  try{
    await api('/api/admin-api/students',{method:'POST',body:{
      first_name:first,last_name:last,
      email:document.getElementById('ns-email').value.trim()||null,
      phone:document.getElementById('ns-phone').value.trim()||null,
      birth_year:parseInt(document.getElementById('ns-birth').value)||null,
      group_id:document.getElementById('ns-group').value?parseInt(document.getElementById('ns-group').value):null,
    }});
    closeModal('modalNewStudent');
    toast('‚úÖ Kursant dodany');
    loadStudents();
  }catch(e){ err.textContent=e.message; err.style.display='block'; }
}

// ‚îÄ‚îÄ DELETE STUDENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function confirmDelete(id,name){
  document.getElementById('confirmTitle').textContent='Usu≈Ñ kursanta';
  document.getElementById('confirmMsg').textContent=`Czy na pewno chcesz usunƒÖƒá kursanta "${name}"? Je≈õli ma historiƒô trening√≥w lub p≈Çatno≈õci, zostanie zdezaktywowany.`;
  document.getElementById('confirmBtn').onclick=()=>deleteStudent(id,name);
  document.getElementById('modalConfirm').classList.add('open');
}
async function deleteStudent(id){
  try{
    const d=await api(`/api/admin-api/students?id=${id}`,{method:'DELETE'});
    closeModal('modalConfirm');
    toast(d.soft?'‚ö†Ô∏è Kursant zdezaktywowany (ma historiƒô)':'‚úÖ Kursant usuniƒôty');
    closeDrawer();
    loadStudents();
  }catch(e){ toast('‚ùå '+e.message,'red'); }
}

// ‚îÄ‚îÄ REGISTRATIONS VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadRegistrations(){
  const tbody=document.getElementById('regTbody');
  tbody.innerHTML=`<tr><td colspan="9"><div class="loading"><div class="spin"></div>≈Åadowanie...</div></td></tr>`;
  
  const params=new URLSearchParams({page:regPage,limit:50});
  const s=document.getElementById('regSearch')?.value; if(s) params.set('search',s);
  const st=document.getElementById('regFilterStatus')?.value; if(st) params.set('status',st);
  const ps=document.getElementById('regFilterPayment')?.value; if(ps) params.set('payment_status',ps);
  
  try{
    const d=await api(`/api/admin-api/registrations?${params}`);
    const rows=d.rows||[];
    
    // Stats
    const paid=rows.filter(r=>r.payment_status==='paid').length;
    const unpaid=rows.filter(r=>r.payment_status==='unpaid').length;
    const wait=rows.filter(r=>r.is_waitlist).length;
    document.getElementById('regStats').innerHTML=`
      <div class="stat-box"><div class="stat-label">≈ÅƒÖcznie</div><div class="stat-num">${d.total}</div></div>
      <div class="stat-box"><div class="stat-label">Op≈Çaceni</div><div class="stat-num green">${paid}</div></div>
      <div class="stat-box"><div class="stat-label">Nieop≈Çaceni</div><div class="stat-num red">${unpaid}</div></div>
      <div class="stat-box"><div class="stat-label">Lista rez.</div><div class="stat-num blue">${wait}</div></div>`;
    
    if(!rows.length){
      tbody.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">üìã</div><div class="empty-title">Brak wynik√≥w</div></div></td></tr>`;
      return;
    }
    
    tbody.innerHTML=rows.map(r=>`
      <tr>
        <td class="primary">${r.first_name} ${r.last_name}${r.is_waitlist?' <span class="tag tag-blue">Rez.</span>':''}</td>
        <td class="muted">${r.email||''}${r.phone?`<br>${r.phone}`:''}</td>
        <td>${r.group_name||'‚Äî'}<br><span style="font-size:11px;color:var(--muted)">${r.city||''}</span></td>
        <td style="font-size:12px">${r.plan_name||'‚Äî'}</td>
        <td class="mono"><strong>${r.total_amount?Number(r.total_amount).toFixed(2)+' z≈Ç':'‚Äî'}</strong></td>
        <td>${statusTag(r.status)}</td>
        <td>
          <select onchange="changeRegPay(${r.id},this.value)" style="border:1px solid var(--border2);border-radius:4px;padding:3px 7px;font-size:11px;background:var(--surface);font-family:var(--font)">
            <option value="paid" ${r.payment_status==='paid'?'selected':''}>Op≈Çacony</option>
            <option value="unpaid" ${r.payment_status==='unpaid'?'selected':''}>Nieop≈Çacony</option>
            <option value="pending" ${r.payment_status==='pending'?'selected':''}>Oczekuje</option>
            <option value="waived" ${r.payment_status==='waived'?'selected':''}>Zwolniony</option>
          </select>
        </td>
        <td class="muted mono">${r.created_at?fmtDate(r.created_at):'‚Äî'}</td>
        <td><button class="row-btn row-btn-edit" onclick="changeRegStatus(${r.id})">Edytuj</button></td>
      </tr>`).join('');
    
    renderPagination('regPag',regPage,d.total,50,(p)=>{regPage=p;loadRegistrations();});
  }catch(e){
    tbody.innerHTML=`<tr><td colspan="9" style="padding:24px;color:var(--red)">${e.message}</td></tr>`;
  }
}

async function changeRegPay(id,status){
  try{
    await api(`/api/admin-api/registrations?id=${id}`,{method:'PATCH',body:{payment_status:status}});
    toast('‚úÖ Status zaktualizowany');
  }catch(e){ toast('‚ùå '+e.message,'red'); }
}

function debounceRegSearch(){
  clearTimeout(regSearchTimer);
  regSearchTimer=setTimeout(()=>{regPage=1;loadRegistrations();},400);
}

// ‚îÄ‚îÄ HISTORY VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let histTab='students';
function switchHistTab(t){
  histTab=t;
  ['students','payments','stats'].forEach(x=>{
    document.getElementById(`htab-${x}`)?.classList.toggle('active',x===t);
  });
  loadHistory(t);
}

async function loadHistory(tab){
  const el=document.getElementById('histContent');
  el.innerHTML='<div class="loading"><div class="spin"></div>≈Åadowanie...</div>';
  try{
    const d=await api(`/api/admin-api/history?tab=${tab}&limit=60`);
    
    if(tab==='students'){
      const rows=d.rows||[];
      el.innerHTML=`
        <div class="filters" style="border-top:none">
          <div class="search-wrap"><span class="search-icon">üîç</span><input placeholder="Szukaj..." oninput="histSearch(this.value)" style="width:100%;padding:8px 12px 8px 34px;border:1px solid var(--border2);border-radius:6px;font-family:var(--font);font-size:13px;outline:none"></div>
          <span style="font-size:12px;color:var(--muted)">${d.total} kursant√≥w legacy</span>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Kursant</th><th>Email</th><th>Telefon</th><th>Grupy</th><th>Treningi</th><th>Ostatni trening</th><th>Wp≈Çacono</th></tr></thead>
            <tbody>${rows.map(s=>`
              <tr onclick="openStudent(${s.id})" style="cursor:pointer">
                <td class="primary">${s.first_name} ${s.last_name}${!s.is_active?' <span class="tag tag-gray">Nieaktywny</span>':''}</td>
                <td class="muted">${s.email||'‚Äî'}</td>
                <td class="muted">${s.phone||'‚Äî'}</td>
                <td>${groupTags(s.groups)}</td>
                <td>${s.total_attendances||0}</td>
                <td class="mono muted">${s.last_training?fmtDate(s.last_training):'‚Äî'}</td>
                <td><strong>${s.total_paid?Number(s.total_paid).toFixed(0)+' z≈Ç':'‚Äî'}</strong></td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>`;
    }
    
    if(tab==='payments'){
      const rows=d.rows||[];
      el.innerHTML=`
        <div class="filters" style="border-top:none">
          <span style="font-size:12px;color:var(--muted)">${d.total} p≈Çatno≈õci legacy</span>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Kursant</th><th>Data</th><th>Kwota</th><th>Notatka</th></tr></thead>
            <tbody>${rows.map(p=>`
              <tr>
                <td class="primary">${p.first_name||'?'} ${p.last_name||''}</td>
                <td class="mono muted">${p.paid_at?fmtDate(p.paid_at):'‚Äî'}</td>
                <td><strong>${p.amount||0} z≈Ç</strong></td>
                <td class="muted">${p.note||'‚Äî'}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>`;
    }
    
    if(tab==='stats'){
      const {summary:sum,byYear,topStudents}=d;
      el.innerHTML=`
        <div style="padding:24px 28px">
          <div class="stats-row" style="margin:0 0 24px;border:1px solid var(--border);border-radius:8px;overflow:hidden">
            <div class="stat-box"><div class="stat-label">Kursanci legacy</div><div class="stat-num">${sum?.legacy_students||0}</div></div>
            <div class="stat-box"><div class="stat-label">Sesje treningowe</div><div class="stat-num blue">${sum?.total_sessions||0}</div></div>
            <div class="stat-box"><div class="stat-label">≈ÅƒÖcznie obecno≈õci</div><div class="stat-num green">${sum?.total_present||0}</div></div>
            <div class="stat-box"><div class="stat-label">Przych√≥d legacy</div><div class="stat-num">${sum?.total_revenue?Number(sum.total_revenue).toFixed(0)+' z≈Ç':'‚Äî'}</div></div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
            <div>
              <div style="font-size:12px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted2);margin-bottom:12px">PRZYCHODY WG LAT</div>
              <table class="mini-table">
                <thead><tr><th>Rok</th><th>P≈Çatno≈õci</th><th>Kwota</th></tr></thead>
                <tbody>${(byYear||[]).map(y=>`
                  <tr><td>${y.year}</td><td>${y.payments}</td><td><strong>${Number(y.revenue).toFixed(0)} z≈Ç</strong></td></tr>`).join('')}
                </tbody>
              </table>
            </div>
            <div>
              <div style="font-size:12px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted2);margin-bottom:12px">TOP 10 KURSANT√ìW</div>
              <table class="mini-table">
                <thead><tr><th>Kursant</th><th>Treningi</th></tr></thead>
                <tbody>${(topStudents||[]).map((s,i)=>`
                  <tr><td>${i+1}. ${s.first_name} ${s.last_name}</td><td><strong>${s.trainings}</strong></td></tr>`).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>`;
    }
  }catch(e){
    el.innerHTML=`<div style="padding:24px;color:var(--red)">${e.message}</div>`;
  }
}

async function histSearch(val){
  clearTimeout(searchTimer);
  searchTimer=setTimeout(async()=>{
    try{
      const d=await api(`/api/admin-api/history?tab=students&search=${encodeURIComponent(val)}&limit=60`);
      // just update tbody
      const tbody=document.querySelector('#histContent tbody');
      if(tbody) tbody.innerHTML=d.rows.map(s=>`
        <tr onclick="openStudent(${s.id})" style="cursor:pointer">
          <td class="primary">${s.first_name} ${s.last_name}</td>
          <td class="muted">${s.email||'‚Äî'}</td><td class="muted">${s.phone||'‚Äî'}</td>
          <td>${groupTags(s.groups)}</td><td>${s.total_attendances||0}</td>
          <td class="mono muted">${s.last_training?fmtDate(s.last_training):'‚Äî'}</td>
          <td><strong>${s.total_paid?Number(s.total_paid).toFixed(0)+' z≈Ç':'‚Äî'}</strong></td>
        </tr>`).join('');
    }catch(e){}
  },400);
}

// ‚îÄ‚îÄ GROUPS VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadGroupsView(){
  const el=document.getElementById('groupsContent');
  try{
    const d=await api('/api/admin-api/groups');
    const rows=d.rows||[];
    el.innerHTML=`
      <div class="filters" style="border-top:none">
        <span style="font-size:12px;color:var(--muted)">${rows.length} grup</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Nazwa grupy</th><th>Miasto</th><th>Kategoria</th><th>Pojemno≈õƒá</th><th>Zapisani</th><th>Harmonogram</th><th>Status</th></tr></thead>
          <tbody>${rows.map(g=>`
            <tr>
              <td class="primary">${g.name}</td>
              <td class="muted">${g.city||'‚Äî'}</td>
              <td><span class="tag tag-blue">${g.category||'adults'}</span></td>
              <td>${g.max_capacity||'‚àû'}</td>
              <td>${g.registered||0}</td>
              <td style="font-size:11px;color:var(--muted)">${(g.schedules||[]).map(s=>`${s.day_name} ${String(s.time_start||'').slice(0,5)}`).join(', ')||'‚Äî'}</td>
              <td>${g.active?'<span class="tag tag-green">Aktywna</span>':'<span class="tag tag-gray">Nieaktywna</span>'}</td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>`;
  }catch(e){
    el.innerHTML=`<div style="padding:24px;color:var(--red)">${e.message}</div>`;
  }
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtDate(d){
  if(!d) return '‚Äî';
  return new Date(d).toLocaleDateString('pl-PL',{day:'numeric',month:'short',year:'numeric'});
}
function payTag(s){
  if(!s) return '<span class="tag tag-gray">‚Äî</span>';
  const m={paid:'tag-green',unpaid:'tag-red',pending:'tag-yellow',waived:'tag-blue'};
  const l={paid:'Op≈Çacony',unpaid:'Nieop≈Çacony',pending:'Oczekuje',waived:'Zwolniony'};
  return `<span class="tag ${m[s]||'tag-gray'}">${l[s]||s}</span>`;
}
function statusTag(s){
  const m={new:'tag-blue',active:'tag-green',cancelled:'tag-red'};
  const l={new:'Nowy',active:'Aktywny',cancelled:'Anulowany'};
  return `<span class="tag ${m[s]||'tag-gray'}">${l[s]||s||'‚Äî'}</span>`;
}
function sourceTag(s){
  if(s==='legacy') return '<span class="tag tag-gray">Legacy</span>';
  if(s==='manual') return '<span class="tag tag-blue">Rƒôcznie</span>';
  if(s==='registration') return '<span class="tag tag-green">Zapis</span>';
  return `<span class="tag tag-gray">${s||'‚Äî'}</span>`;
}
function groupTags(groups){
  if(!groups||!groups.length) return '<span style="color:var(--muted2);font-size:12px">‚Äî</span>';
  return groups.slice(0,2).map(g=>`<span class="tag tag-blue" style="font-size:10px;margin:1px">${g.name.split(' ')[0]}</span>`).join('') +
    (groups.length>2?`<span style="font-size:11px;color:var(--muted)"> +${groups.length-2}</span>`:'');
}

function renderPagination(elId,current,total,limit,cb){
  const pages=Math.ceil(total/limit);
  if(pages<=1){document.getElementById(elId).innerHTML='';return;}
  let html=`<span>${(current-1)*limit+1}‚Äì${Math.min(current*limit,total)} z ${total}</span><div class="pag-btns">`;
  html+=`<button class="pag-btn" onclick="(${cb})(${current-1})" ${current===1?'disabled':''}>‚Üê</button>`;
  for(let i=1;i<=pages;i++){
    if(pages>7&&Math.abs(i-current)>2&&i!==1&&i!==pages){
      if(i===current-3||i===current+3) html+='<span style="padding:0 4px;color:var(--muted)">‚Ä¶</span>';
      continue;
    }
    html+=`<button class="pag-btn ${i===current?'active':''}" onclick="(${cb})(${i})">${i}</button>`;
  }
  html+=`<button class="pag-btn" onclick="(${cb})(${current+1})" ${current===pages?'disabled':''}>‚Üí</button></div>`;
  document.getElementById(elId).innerHTML=html;
}

function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');}));

let toastT;
function toast(msg,color='green'){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.style.background=color==='red'?'var(--red)':color==='orange'?'var(--yellow)':'var(--green)';
  t.style.color='#fff'; t.style.opacity='1';
  clearTimeout(toastT);
  toastT=setTimeout(()=>t.style.opacity='0',3500);
}
</script>
</body>
</html>
