<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Panel Admina — Krav Maga Saggita</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800&family=Barlow:wght@400;500;600&display=swap');
:root{
  --bg:#0f0b0b;--surface:#1c1414;--surface2:#241c1c;--surface3:#2c2222;
  --border:#3a2828;--border2:#4a3232;
  --red:#c42000;--red-l:#e83000;--red-bg:rgba(196,32,0,.12);--red-bdr:rgba(196,32,0,.35);
  --orange:#e8a500;--or-bg:rgba(232,165,0,.12);--or-bdr:rgba(232,165,0,.35);
  --green:#2ecc71;--gr-bg:rgba(46,204,113,.1);--gr-bdr:rgba(46,204,113,.3);
  --blue:#4a9fe8;--bl-bg:rgba(74,159,232,.1);--bl-bdr:rgba(74,159,232,.3);
  --text:#e8dada;--dim:#9a8080;--muted:#6a5555;--bright:#fff;
  --sw:215px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Barlow',sans-serif;font-size:14px;line-height:1.5}
#app{display:flex;height:100vh;overflow:hidden}
#sidebar{width:var(--sw);min-width:var(--sw);background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column}
#sidebar-logo{padding:20px 16px 16px;border-bottom:1px solid var(--border)}
#sidebar-logo h1{font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:19px;letter-spacing:.03em;color:var(--bright);line-height:1.1;text-transform:uppercase}
#sidebar-logo h1 em{color:var(--red-l);font-style:normal}
#sidebar-logo small{color:var(--muted);font-size:10px;text-transform:uppercase;letter-spacing:.1em}
nav{flex:1;padding:8px;overflow-y:auto}
nav a{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:5px;color:var(--dim);font-weight:500;font-size:13px;transition:all .15s;cursor:pointer;margin-bottom:1px;text-decoration:none}
nav a:hover{color:var(--bright);background:var(--surface2)}
nav a.active{color:var(--bright);background:var(--red-bg);border-left:2px solid var(--red-l);padding-left:8px}
.nd{width:4px;height:4px;border-radius:50%;background:var(--border2);flex-shrink:0;transition:background .15s}
nav a:hover .nd{background:var(--dim)}
nav a.active .nd{background:var(--red-l)}
.sl{font-size:10px;font-weight:700;letter-spacing:.12em;color:var(--red);padding:14px 10px 4px;text-transform:uppercase;opacity:.7}
#sf{padding:12px;border-top:1px solid var(--border)}
.ui{font-size:11px;color:var(--muted);margin-bottom:8px}
.ui strong{display:block;color:var(--text);font-size:13px}
#btn-logout{width:100%;padding:7px;background:transparent;border:1px solid var(--border2);border-radius:4px;color:var(--dim);cursor:pointer;font-size:12px;font-family:'Barlow',sans-serif;transition:all .15s}
#btn-logout:hover{border-color:var(--red);color:var(--red);background:var(--red-bg)}
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}
#topbar{height:50px;min-height:50px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;gap:16px}
#topbar h2{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:800;color:var(--bright);text-transform:uppercase;letter-spacing:.05em;flex:1}
#api-status{font-size:11px;padding:4px 12px;border-radius:4px;font-weight:700;text-transform:uppercase;letter-spacing:.06em}
#api-status.ok{background:var(--gr-bg);color:var(--green);border:1px solid var(--gr-bdr)}
#api-status.err{background:var(--red-bg);color:var(--red-l);border:1px solid var(--red-bdr)}
#content{flex:1;overflow-y:auto;padding:24px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:28px}
.sc{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:18px 20px;position:relative;overflow:hidden}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--border2)}
.sc.accent::before{background:var(--red-l)}.sc.green::before{background:var(--green)}.sc.orange::before{background:var(--orange)}
.sc .label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);margin-bottom:8px}
.sc .value{font-family:'Barlow Condensed',sans-serif;font-size:42px;font-weight:800;line-height:1;color:var(--bright)}
.sc.accent .value{color:var(--red-l)}.sc.green .value{color:var(--green)}.sc.orange .value{color:var(--orange)}
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.sh h3{font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:700;color:var(--bright);text-transform:uppercase;letter-spacing:.05em;border-left:3px solid var(--red);padding-left:10px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:5px;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;border:none;font-family:'Barlow',sans-serif;text-transform:uppercase;letter-spacing:.05em;line-height:1}
.btn-primary{background:var(--red);color:#fff}.btn-primary:hover{background:var(--red-l)}
.btn-secondary{background:var(--surface2);border:1px solid var(--border2);color:var(--text)}.btn-secondary:hover{border-color:var(--red);color:var(--bright)}
.btn-sm{padding:5px 10px;font-size:11px}
.bi{padding:5px 10px;background:var(--surface3);border:1px solid var(--border2);border-radius:4px;color:var(--dim);cursor:pointer;transition:all .15s;font-size:11px;font-family:'Barlow',sans-serif;font-weight:600;text-transform:uppercase;letter-spacing:.04em;line-height:1.4}
.bi:hover{color:var(--bright);background:var(--surface2)}.bi.del:hover{border-color:var(--red);color:var(--red);background:var(--red-bg)}
.fb{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:12px}
.fb input,.fb select{background:var(--surface2);border:1px solid var(--border2);border-radius:4px;color:var(--text);padding:7px 10px;font-size:13px;font-family:'Barlow',sans-serif;outline:none;transition:border-color .15s}
.fb input:focus,.fb select:focus{border-color:var(--red)}.fb input[type=text]{min-width:220px}.fb select{min-width:150px}
.tw{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden}
table{width:100%;border-collapse:collapse}
thead th{background:var(--surface2);padding:11px 14px;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);white-space:nowrap;border-bottom:2px solid var(--border2)}
tbody tr{border-top:1px solid var(--border);transition:background .1s}
tbody tr:hover{background:var(--surface2)}
tbody td{padding:11px 14px;font-size:13px;vertical-align:middle;color:var(--text)}
.tda{display:flex;gap:5px;flex-wrap:wrap}
.badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;line-height:1.4}
.bg{background:var(--gr-bg);color:var(--green);border:1px solid var(--gr-bdr)}
.br{background:var(--red-bg);color:#ff6b4a;border:1px solid var(--red-bdr)}
.bo{background:var(--or-bg);color:var(--orange);border:1px solid var(--or-bdr)}
.bx{background:var(--surface3);color:var(--dim);border:1px solid var(--border2)}
.bb{background:var(--bl-bg);color:var(--blue);border:1px solid var(--bl-bdr)}
.cb{width:80px;height:5px;background:var(--surface3);border-radius:3px;display:inline-block;vertical-align:middle;margin-right:7px}
.cf{height:100%;background:var(--green);border-radius:3px}.cf.w{background:var(--orange)}.cf.f{background:var(--red-l)}
.ct{font-size:12px;color:var(--dim)}
.pag{display:flex;align-items:center;gap:10px;margin-top:16px;justify-content:center}
.pag button{background:var(--surface2);border:1px solid var(--border2);color:var(--dim);padding:7px 16px;border-radius:5px;cursor:pointer;font-size:12px;font-family:'Barlow',sans-serif;font-weight:600;text-transform:uppercase;letter-spacing:.05em;transition:all .15s}
.pag button:hover:not(:disabled){border-color:var(--red);color:var(--bright)}.pag button:disabled{opacity:.3;cursor:not-allowed}
.pag .pi{font-size:12px;color:var(--dim)}
.mo{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(3px)}
.md{background:var(--surface);border:1px solid var(--border2);border-radius:10px;width:100%;max-width:720px;max-height:92vh;overflow-y:auto;box-shadow:0 32px 80px rgba(0,0,0,.7)}
.mh{padding:18px 22px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1}
.mh h3{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:var(--bright);text-transform:uppercase;letter-spacing:.05em}
.mb{padding:22px}.mf{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;background:var(--surface2);position:sticky;bottom:0}
/* KARTOTEKA */
.kart-header{background:var(--surface2);border:1px solid var(--border2);border-radius:8px;padding:18px 20px;margin-bottom:20px;display:flex;align-items:center;gap:16px}
.kart-avatar{width:52px;height:52px;border-radius:50%;background:var(--red-bg);border:2px solid var(--red-bdr);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:22px;color:var(--red-l);flex-shrink:0}
.kart-name{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--bright);text-transform:uppercase}
.kart-meta{font-size:12px;color:var(--dim);margin-top:3px}
.kart-badges{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.ksec{border-top:1px solid var(--border);margin-top:18px;padding-top:16px}
.ksec-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--red);margin-bottom:12px}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fg .full{grid-column:1 / -1}
.ff{display:flex;flex-direction:column;gap:6px}
.ff label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--dim)}
.ff input,.ff select,.ff textarea{background:var(--surface2);border:1px solid var(--border2);border-radius:5px;color:var(--bright);padding:9px 11px;font-size:13px;font-family:'Barlow',sans-serif;outline:none;transition:all .15s;width:100%}
.ff input:focus,.ff select:focus,.ff textarea:focus{border-color:var(--red);box-shadow:0 0 0 2px var(--red-bg)}
.ff textarea{resize:vertical;min-height:70px}
select option{background:#1c1414}
/* VIEW mode */
.ff .view-val{font-size:14px;color:var(--bright);font-weight:500;padding:4px 0;border-bottom:1px solid var(--border);min-height:28px}
#login-screen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9000}
.lb{background:var(--surface);border:1px solid var(--border2);border-radius:10px;padding:40px;width:360px;box-shadow:0 40px 100px rgba(0,0,0,.8)}
.lb .logo{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;color:var(--bright);text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px}
.lb .logo em{color:var(--red-l);font-style:normal}
.lb p{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.1em;margin-bottom:28px}
.lb label{display:block;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);margin-bottom:6px}
.lb input{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:5px;color:var(--bright);padding:11px 13px;font-size:14px;font-family:'Barlow',sans-serif;outline:none;transition:all .15s;margin-bottom:14px}
.lb input:focus{border-color:var(--red);box-shadow:0 0 0 2px var(--red-bg)}
#login-btn{width:100%;padding:12px;background:var(--red);border:none;border-radius:5px;color:#fff;font-weight:700;font-size:15px;font-family:'Barlow Condensed',sans-serif;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;margin-top:4px;transition:background .15s}
#login-btn:hover{background:var(--red-l)}
#login-error{color:#ff6b4a;font-size:12px;margin-top:10px;display:none}
#toasts{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 18px;border-radius:6px;font-size:13px;font-weight:600;box-shadow:0 8px 32px rgba(0,0,0,.5);max-width:320px;animation:si .2s ease}
.toast.success{background:var(--green);color:#000}.toast.error{background:var(--red-l);color:#fff}.toast.info{background:var(--surface2);border:1px solid var(--border2);color:var(--text)}
@keyframes si{from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1}}
.loader{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--dim);gap:12px;font-size:13px}
.spinner{width:20px;height:20px;border:2px solid var(--border2);border-top-color:var(--red-l);border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.empty{padding:60px;text-align:center;color:var(--dim)}.empty strong{display:block;font-size:16px;color:var(--text);margin-bottom:8px}
.ib{background:var(--surface2);border-left:3px solid var(--red);border-radius:0 5px 5px 0;padding:10px 14px;font-size:12px;color:var(--dim);margin-bottom:16px;line-height:1.6}
.ib strong{color:var(--bright)}
</style>
</head>
<body>

<div id="login-screen">
  <div class="lb">
    <div class="logo">Krav Maga <em>Saggita</em></div>
    <p>Panel Administratora</p>
    <label>Login</label>
    <input type="text" id="l-user" placeholder="username" autocomplete="username"/>
    <label>Hasło</label>
    <input type="password" id="l-pass" placeholder="••••••••" autocomplete="current-password"/>
    <button id="login-btn">Zaloguj się</button>
    <div id="login-error"></div>
  </div>
</div>

<div id="app" style="display:none">
  <aside id="sidebar">
    <div id="sidebar-logo">
      <h1>Krav Maga <em>Saggita</em></h1>
      <small>Panel Admina</small>
    </div>
    <nav>
      <a data-view="dashboard" class="active"><span class="nd"></span> Dashboard</a>
      <div class="sl">Kursanci</div>
      <a data-view="web-registrations"><span class="nd"></span> Zapisy ze strony</a>
      <a data-view="participants"><span class="nd"></span> Baza kursantów</a>
      <a data-view="add-participant"><span class="nd"></span> Dodaj kursanta</a>
      <div class="sl">Organizacja</div>
      <a data-view="groups"><span class="nd"></span> Grupy</a>
      <a data-view="schedules"><span class="nd"></span> Grafik zajęć</a>
      <a data-view="locations"><span class="nd"></span> Lokalizacje</a>
      <div class="sl">Export</div>
      <a id="btn-export"><span class="nd"></span> Pobierz CSV</a>
    </nav>
    <div id="sf">
      <div class="ui"><small>Zalogowany jako</small><strong id="admin-username">—</strong></div>
      <button id="btn-logout">Wyloguj</button>
    </div>
  </aside>
  <main id="main">
    <div id="topbar">
      <h2 id="page-title">Dashboard</h2>
      <span id="api-status" class="ok">API OK</span>
    </div>
    <div id="content"></div>
  </main>
</div>
<div id="toasts"></div>

<script>
const API='/api/admin-api'; // BEZ końcowego /
let TOKEN=localStorage.getItem('km_token')||'';
let CV='dashboard',ro=0,rt=0;
const RL=30;
let rf={};
const DAYS=['Niedziela','Poniedziałek','Wtorek','Środa','Czwartek','Piątek','Sobota'];
const CAT={kids:'Dzieci',youth:'Młodzież',adults:'Dorośli',vip:'VIP',women:'Kobiety'};

// ✅ PEŁNE MAPOWANIE
const PS={
  paid:'Opłacony', unpaid:'Nieopłacony', pending:'Oczekujący',
  partial:'Częściowy', waived:'Zwolniony'
};
const RS={new:'Nowy',confirmed:'Potwierdzony',cancelled:'Anulowany',completed:'Zakończony'};

async function aF(path,opts={}){
  const h={'Content-Type':'application/json'};
  if(TOKEN)h['Authorization']=`Bearer ${TOKEN}`;

  const url = API + (path.startsWith('/') ? path : '/' + path);

  try{
    const r=await fetch(url,{headers:h,...opts});
    const d=await r.json().catch(()=>({error:'Błąd odpowiedzi serwera'}));
    if(!r.ok)throw new Error(d.error||`Błąd HTTP ${r.status}`);
    setAS(true);return d;
  }catch(e){setAS(false);throw e;}
}
function setAS(ok){const e=document.getElementById('api-status');e.textContent=ok?'API OK':'API ERROR';e.className=ok?'ok':'err';}

async function checkLogin(){if(!TOKEN)return showLogin();try{await aF('/stats');showApp();}catch{showLogin();}}
function showLogin(){document.getElementById('login-screen').style.display='flex';document.getElementById('app').style.display='none';}
function showApp(){
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='flex';
  try{
    const u=JSON.parse(atob(TOKEN.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));
    document.getElementById('admin-username').textContent=u.username||'—';
  }catch{}
  navigate('dashboard');
}
document.getElementById('login-btn').addEventListener('click',async()=>{
  const u=document.getElementById('l-user').value.trim(),p=document.getElementById('l-pass').value;
  const e=document.getElementById('login-error');e.style.display='none';
  if(!u||!p){e.textContent='Podaj login i hasło.';e.style.display='block';return;}
  try{
    const d=await aF('/login',{method:'POST',body:JSON.stringify({username:u,password:p})});
    TOKEN=d.token;localStorage.setItem('km_token',TOKEN);showApp();
  }catch(err){e.textContent=err.message;e.style.display='block';}
});
document.getElementById('l-pass').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('login-btn').click();});
document.getElementById('btn-logout').addEventListener('click',()=>{TOKEN='';localStorage.removeItem('km_token');showLogin();});

function navigate(view){
  CV=view;
  document.querySelectorAll('nav a[data-view]').forEach(a=>a.classList.toggle('active',a.dataset.view===view));
  const titles={dashboard:'Dashboard','web-registrations':'Zapisy ze strony',participants:'Baza kursantów','add-participant':'Dodaj kursanta',groups:'Grupy',schedules:'Grafik zajęć',locations:'Lokalizacje'};
  document.getElementById('page-title').textContent=titles[view]||view;
  document.getElementById('content').innerHTML='<div class="loader"><div class="spinner"></div> Ładowanie…</div>';
  const fns={dashboard:loadDash,'web-registrations':()=>loadReg('web'),participants:()=>loadReg('admin'),'add-participant':loadAdd,groups:loadGroups,schedules:loadSchedules,locations:loadLocations};
  (fns[view]||(() =>document.getElementById('content').innerHTML=''))();
}
document.querySelectorAll('nav a[data-view]').forEach(a=>a.addEventListener('click',()=>navigate(a.dataset.view)));
document.getElementById('btn-export').addEventListener('click',()=>window.open(API+'/export','_blank'));

function toast(msg,type='success',ms=3500){const e=document.createElement('div');e.className=`toast ${type}`;e.textContent=msg;document.getElementById('toasts').appendChild(e);setTimeout(()=>e.remove(),ms);}
function showModal(title,body,footer){
  closeModal();
  const ov=document.createElement('div');ov.className='mo';ov.id='modal-overlay';
  ov.innerHTML=`<div class="md"><div class="mh"><h3>${title}</h3><button class="bi" onclick="closeModal()">✕ Zamknij</button></div><div class="mb">${body}</div>${footer?`<div class="mf">${footer}</div>`:''}</div>`;
  ov.addEventListener('click',e=>{if(e.target===ov)closeModal();});
  document.body.appendChild(ov);
}
function closeModal(){document.getElementById('modal-overlay')?.remove();}

function fd(v){if(!v)return'—';try{return new Date(v).toLocaleDateString('pl-PL',{day:'2-digit',month:'2-digit',year:'numeric'});}catch{return v;}}
function fdt(v){if(!v)return'—';try{return new Date(v).toLocaleString('pl-PL',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});}catch{return v;}}
function pb(s){const m={paid:'bg',unpaid:'br',pending:'bo',partial:'bo',waived:'bx'};return`<span class="badge ${m[s]||'bx'}">${PS[s]||s||'—'}</span>`;}
function sb(s){const m={confirmed:'bg',new:'bo',cancelled:'br',completed:'bx'};return`<span class="badge ${m[s]||'bx'}">${RS[s]||s||'—'}</span>`;}
function capB(r,m){const p=m?Math.min(100,Math.round(r/m*100)):0;const c=p>=100?'f':p>=80?'w':'';return`<span class="cb"><span class="cf ${c}" style="width:${p}%"></span></span><span class="ct">${r}/${m||'?'}</span>`;}
function initials(fn,ln){return((fn||'?')[0]+(ln||'?')[0]).toUpperCase();}

// ═══════════════════════════════════════════════════════
// DASHBOARD
// ═══════════════════════════════════════════════════════
async function loadDash(){
  const c=document.getElementById('content');
  try{
    const d=await aF('/stats');
    c.innerHTML=`
    <div class="stats-grid">
      <div class="sc accent"><div class="label">Wszystkie zapisy</div><div class="value">${d.total||0}</div></div>
      <div class="sc green"><div class="label">Opłaceni</div><div class="value">${d.paid||0}</div></div>
      <div class="sc orange"><div class="label">Oczekujący</div><div class="value">${d.pending||0}</div></div>
      <div class="sc"><div class="label">Lista rezerwowa</div><div class="value">${d.waitlist||0}</div></div>
    </div>

    <div class="sh"><h3>Obłożenie lokalizacji</h3></div>
    <div class="tw" style="margin-bottom:28px"><table>
      <thead><tr><th>Miasto</th><th>Łącznie</th><th>Opłaceni</th><th>Oczekujący</th><th>Rezerwowa</th></tr></thead>
      <tbody>${(d.byLoc||[]).map(l=>`<tr>
        <td><strong style="color:var(--bright)">${l.city}</strong></td>
        <td><strong>${l.total}</strong></td>
        <td>${pb('paid')} <strong>${l.paid}</strong></td>
        <td>${l.pending}</td><td>${l.waitlist}</td>
      </tr>`).join('')}</tbody>
    </table></div>

    <div class="sh"><h3>Obłożenie grup</h3></div>
    <div class="tw" style="margin-bottom:28px"><table>
      <thead><tr><th>Miasto</th><th>Grupa</th><th>Obłożenie</th><th></th></tr></thead>
      <tbody>${(d.byGroup||[]).map(g=>`<tr>
        <td>${g.city}</td><td><strong style="color:var(--bright)">${g.name}</strong></td>
        <td>${capB(g.registered,g.max_capacity)}</td>
        <td><button class="bi" onclick="navigate('groups')">Edytuj</button></td>
      </tr>`).join('')}</tbody>
    </table></div>

    <div class="sh"><h3>Ostatnie zapisy</h3></div>
    <div class="tw"><table>
      <thead><tr><th>Kursant</th><th>Miasto</th><th>Grupa</th><th>Status</th><th>Płatność</th><th>Data</th><th></th></tr></thead>
      <tbody>${(d.recent||[]).map(r=>`<tr>
        <td><strong style="color:var(--bright)">${r.name}</strong></td>
        <td>${r.city||'—'}</td><td>${r.group_name||'—'}</td>
        <td>${sb(r.status)}</td><td>${pb(r.payment_status)}</td>
        <td style="color:var(--dim);font-size:12px">${fdt(r.created_at)}</td>
        <td><button class="bi" onclick="openKartoteka(${r.id},'view')">Kartoteka</button></td>
      </tr>`).join('')}</tbody>
    </table></div>`;
  }catch(e){c.innerHTML=`<div class="empty"><strong>Błąd ładowania</strong>${e.message}</div>`;}
}

// ═══════════════════════════════════════════════════════
// KARTOTEKA
// ═══════════════════════════════════════════════════════
async function openKartoteka(id, mode='view'){
  let r;
  let locations=[], groups=[], schedules=[], plans=[];
  try{
    const out = await Promise.all([
      aF(`/registrations/${id}?_=${Date.now()}`),
      aF('/locations'),
      aF('/groups'),
      aF('/schedules'),
      aF('/plans'),
    ]);
    r = out[0];
    locations = (out[1] && out[1].rows) ? out[1].rows : [];
    groups = (out[2] && out[2].rows) ? out[2].rows : [];
    schedules = (out[3] && out[3].rows) ? out[3].rows : [];
    plans = (out[4] && out[4].rows) ? out[4].rows : [];
  }catch(e){
    toast('Błąd pobierania danych: '+e.message,'error');
    return;
  }

  const locOpts = locations.map(l =>
    `<option value="${l.id}" ${l.id==r.location_id?'selected':''}>${l.city} — ${l.name}</option>`
  ).join('');

  function schedLabel(s){
    const day = DAYS[s.day_of_week] || s.day_of_week;
    const ts = s.time_start ? s.time_start.slice(0,5) : '';
    const te = s.time_end ? s.time_end.slice(0,5) : '';
    return `${day} ${ts}${te?`–${te}`:''}${s.address?` · ${s.address}`:''}`;
  }

  const pO=`<option value="">— brak karnetu —</option>`+plans.map(p=>`<option value="${p.id}" ${p.id==r.price_plan_id?'selected':''}>${p.name} — ${p.price} zł / ${p.months} mies.</option>`).join('');

  const isEdit = mode==='edit';
  const fld=(id,val,type='text',opts='')=>isEdit
    ?`<input id="${id}" type="${type}" value="${val||''}" ${opts}>`
    :`<div class="view-val">${val||'—'}</div>`;
  const txt=(id,val)=>isEdit
    ?`<textarea id="${id}">${val||''}</textarea>`
    :`<div class="view-val" style="white-space:pre-wrap">${val||'—'}</div>`;

  const payOpts=['paid','unpaid','pending','partial','waived'].map(v=>`<option value="${v}" ${r.payment_status===v?'selected':''}>${PS[v]||v}</option>`).join('');
  const statOpts=['new','confirmed','cancelled','completed'].map(v=>`<option value="${v}" ${r.status===v?'selected':''}>${RS[v]||v}</option>`).join('');
  const pmOpts=['cash','transfer','card'].map(v=>`<option value="${v}" ${r.payment_method===v?'selected':''}>${{cash:'Gotówka',transfer:'Przelew',card:'Karta'}[v]||v}</option>`).join('');

  const body=`
    <div class="kart-header">
      <div class="kart-avatar">${initials(r.first_name,r.last_name)}</div>
      <div>
        <div class="kart-name">${r.first_name} ${r.last_name}</div>
        <div class="kart-meta">${r.email||'brak email'} · ${r.phone||'brak tel.'} · ${r.city||'brak miasta'}</div>
        <div class="kart-badges">
          ${sb(r.status)} ${pb(r.payment_status)}
          ${r.is_waitlist?'<span class="badge bo">Lista rezerwowa</span>':''}
          <span class="badge ${r.source==='admin'?'bb':'bx'}">${r.source==='admin'?'Admin':'WWW'}</span>
        </div>
      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">Dane osobowe</div>
      <div class="fg">
        <div class="ff"><label>Imię</label>${fld('k-fn',r.first_name)}</div>
        <div class="ff"><label>Nazwisko</label>${fld('k-ln',r.last_name)}</div>
        <div class="ff"><label>Email</label>${fld('k-em',r.email,'email')}</div>
        <div class="ff"><label>Telefon</label>${fld('k-ph',r.phone)}</div>
        <div class="ff"><label>Rok urodzenia</label>${fld('k-by',r.birth_year,'number')}</div>
        <div class="ff"><label>Typ kursanta</label>${isEdit
          ?`<select id="k-in"><option value="true" ${r.is_new?'selected':''}>Nowy</option><option value="false" ${!r.is_new?'selected':''}>Kontynuacja</option></select>`
          :`<div class="view-val">${r.is_new?'Nowy kursant':'Kontynuacja'}</div>`}
        </div>
      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">Organizacja treningu</div>
      <div class="fg">

        <div class="ff full">
          <label>Lokalizacja</label>
          ${isEdit
            ? `<select id="k-loc">${locOpts}</select>`
            : `<div class="view-val">${r.city ? `${r.city} — ${r.location_name||''}` : '—'}</div>`
          }
        </div>

        <div class="ff full">
          <label>Grupa</label>
          ${isEdit
            ? `<select id="k-gr"></select>`
            : `<div class="view-val">${r.city ? `${r.city} — ` : ''}${r.group_name||'—'}</div>`
          }
        </div>

        <div class="ff full">
          <label>Dzień i godzina z grafiku</label>
          ${isEdit
            ? `<select id="k-sc"><option value="">— wybierz termin —</option></select>`
            : `<div class="view-val">${r.schedule_id ? `${DAYS[r.schedule_day]||''} ${String(r.schedule_time_start||'').slice(0,5)}${r.schedule_time_end?`–${String(r.schedule_time_end).slice(0,5)}`:''}` : '—'}</div>`
          }
        </div>

        <div class="ff full">
          <label>Karnet</label>
          ${isEdit
            ? `<select id="k-pl">${pO}</select>`
            : `<div class="view-val">${r.plan_name||'—'}</div>`
          }
        </div>

        <div class="ff">
          <label>Data startu</label>
          ${fld('k-sd',r.start_date?r.start_date.slice(0,10):'','date')}
        </div>

        <div class="ff">
          <label>Lista rezerwowa</label>
          ${isEdit
            ? `<select id="k-wl"><option value="false" ${!r.is_waitlist?'selected':''}>Nie</option><option value="true" ${r.is_waitlist?'selected':''}>Tak</option></select>`
            : `<div class="view-val">${r.is_waitlist?'Tak':'Nie'}</div>`
          }
        </div>

      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">Płatność</div>
      <div class="fg">
        <div class="ff"><label>Status płatności</label>${isEdit?`<select id="k-ps">${payOpts}</select>`:`<div class="view-val">${pb(r.payment_status)}</div>`}</div>
        <div class="ff"><label>Metoda</label>${isEdit?`<select id="k-pm">${pmOpts}</select>`:`<div class="view-val">${{cash:'Gotówka',transfer:'Przelew',card:'Karta'}[r.payment_method]||r.payment_method||'—'}</div>`}</div>
        <div class="ff"><label>Kwota (zł)</label>${fld('k-am',r.total_amount,'number')}</div>
        <div class="ff"><label>Kod ref.</label><div class="view-val" style="font-family:monospace;font-size:12px">${r.payment_ref||'—'}</div></div>
        <div class="ff"><label>Data opłaty</label><div class="view-val">${fdt(r.paid_at)}</div></div>
        <div class="ff"><label>Status zapisu</label>${isEdit?`<select id="k-st">${statOpts}</select>`:`<div class="view-val">${sb(r.status)}</div>`}</div>
      </div>
    </div>

    <div class="ksec">
      <div class="ksec-title">Historia i notatki</div>
      <div class="fg">
        <div class="ff"><label>Data zapisu</label><div class="view-val">${fdt(r.created_at)}</div></div>
        <div class="ff"><label>Preferowany czas</label><div class="view-val">${r.preferred_time||'—'}</div></div>
        <div class="ff full"><label>Notatki admina</label>${txt('k-nt',r.admin_notes)}</div>
      </div>
    </div>`;

  const footer=isEdit
    ?`<button class="btn btn-secondary" onclick="openKartoteka(${id},'view')">Anuluj</button>
      <button class="btn btn-danger" style="background:var(--red-bg);border:1px solid var(--red-bdr);color:#ff6b4a;border-radius:5px;padding:8px 16px;font-size:13px;font-weight:600;cursor:pointer;font-family:'Barlow',sans-serif;text-transform:uppercase" onclick="delR(${id},'${r.first_name} ${r.last_name}',null)">Usuń</button>
      <button class="btn btn-primary" onclick="saveKartoteka(${id})">Zapisz zmiany</button>`
    :`<button class="btn btn-secondary" onclick="closeModal()">Zamknij</button>
      <button class="btn btn-primary" onclick="openKartoteka(${id},'edit')">Edytuj kartotekę</button>`;

  showModal(`Kartoteka #${id}`, body, footer);

  // ✅ POPRAWKA: ten blok MUSI być wewnątrz openKartoteka()
  if(mode==='edit'){
    const elLoc = document.getElementById('k-loc');
    const elGr  = document.getElementById('k-gr');
    const elSc  = document.getElementById('k-sc');

    function rebuildGroups(){
      const locId = parseInt(elLoc.value);
      const gList = groups.filter(g => parseInt(g.location_id) === locId);
      elGr.innerHTML = gList.map(g => `<option value="${g.id}">${g.city} — ${g.name}</option>`).join('');
      const wanted = parseInt(r.group_id||0);
      if(gList.some(g=>g.id==wanted)) elGr.value = String(wanted);
      rebuildSchedules();
    }

    function rebuildSchedules(){
      const gid = parseInt(elGr.value||0);
      const sList = schedules.filter(s => parseInt(s.group_id) === gid);
      elSc.innerHTML = `<option value="">— wybierz termin —</option>` + sList.map(s =>
        `<option value="${s.id}">${schedLabel(s)}</option>`
      ).join('');
      if(r.schedule_id && sList.some(s=>s.id==r.schedule_id)) elSc.value = String(r.schedule_id);
    }

    elLoc.addEventListener('change', rebuildGroups);
    elGr.addEventListener('change', rebuildSchedules);
    rebuildGroups();
  }
}

async function saveKartoteka(id){
  const b={
    first_name:document.getElementById('k-fn')?.value||undefined,
    last_name:document.getElementById('k-ln')?.value||undefined,
    email:document.getElementById('k-em')?.value||null,
    phone:document.getElementById('k-ph')?.value||null,
    birth_year:parseInt(document.getElementById('k-by')?.value)||null,
    is_new:document.getElementById('k-in')?.value==='true',
    group_id:parseInt(document.getElementById('k-gr')?.value)||null,
    schedule_id:parseInt(document.getElementById('k-sc')?.value)||null,
    price_plan_id:parseInt(document.getElementById('k-pl')?.value)||null,
    start_date:document.getElementById('k-sd')?.value||null,
    is_waitlist:document.getElementById('k-wl')?.value==='true',
    payment_status:document.getElementById('k-ps')?.value,
    payment_method:document.getElementById('k-pm')?.value,
    total_amount:parseFloat(document.getElementById('k-am')?.value)||0,
    status:document.getElementById('k-st')?.value,
    admin_notes:document.getElementById('k-nt')?.value||null,
  };
  Object.keys(b).forEach(k=>{if(b[k]===undefined)delete b[k];});
  try{
    await aF(`/registrations/${id}?_=${Date.now()}`,{method:'PATCH',body:JSON.stringify(b)});
    toast('Kartoteka zapisana');
    openKartoteka(id,'view');
    if(CV==='web-registrations')fetchR('web');
    if(CV==='participants')fetchR('admin');
    if(CV==='dashboard')loadDash();
  }catch(e){toast('Błąd: '+e.message,'error');}
}

/* DALEJ ZOSTAJE BEZ ZMIAN – reszta Twojego pliku */
</script>
</body>
</html>
