<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Panel Admina â€” KM Saggita</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;500;600&display=swap');

  :root {
    --bg: #0d0f14;
    --surface: #161a22;
    --surface2: #1e2430;
    --border: #2a303d;
    --accent: #e8a020;
    --accent2: #f5c060;
    --red: #e05050;
    --green: #3db87a;
    --blue: #4a90e2;
    --text: #d4d8e2;
    --text-dim: #7a8090;
    --text-bright: #f0f2f5;
    --sidebar-w: 220px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; font-size: 14px; }
  a { color: var(--accent); text-decoration: none; }

  /* â•â•â• LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #app { display: flex; height: 100vh; overflow: hidden; }

  /* â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #sidebar {
    width: var(--sidebar-w); min-width: var(--sidebar-w);
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    overflow-y: auto;
  }
  #sidebar-logo {
    padding: 20px 18px 16px;
    border-bottom: 1px solid var(--border);
  }
  #sidebar-logo h1 {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700; font-size: 22px;
    color: var(--accent);
    line-height: 1;
  }
  #sidebar-logo small { color: var(--text-dim); font-size: 11px; }
  nav { flex: 1; padding: 12px 8px; }
  nav a {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 12px; border-radius: 8px;
    color: var(--text-dim); font-weight: 500;
    transition: all .15s; cursor: pointer;
    margin-bottom: 2px; text-decoration: none;
  }
  nav a:hover { color: var(--text-bright); background: var(--surface2); }
  nav a.active { color: var(--accent); background: rgba(232,160,32,.12); }
  nav a .ico { width: 18px; text-align: center; font-size: 16px; flex-shrink: 0; }
  nav .section-label { font-size: 10px; font-weight: 600; letter-spacing: .08em; color: var(--text-dim); padding: 12px 12px 4px; text-transform: uppercase; }
  #sidebar-footer { padding: 12px 16px; border-top: 1px solid var(--border); }
  #sidebar-footer .user-info { font-size: 12px; color: var(--text-dim); margin-bottom: 8px; }
  #sidebar-footer .user-info strong { display: block; color: var(--text); font-size: 13px; }
  #btn-logout { width: 100%; padding: 7px; background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--text-dim); cursor: pointer; font-size: 12px; transition: all .15s; }
  #btn-logout:hover { border-color: var(--red); color: var(--red); }

  /* â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  #topbar {
    height: 52px; min-height: 52px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center;
    padding: 0 24px; gap: 16px;
  }
  #topbar h2 { font-family: 'Rajdhani', sans-serif; font-size: 20px; font-weight: 600; color: var(--text-bright); flex: 1; }
  #topbar .topbar-actions { display: flex; gap: 10px; align-items: center; }
  #api-status { font-size: 11px; padding: 4px 10px; border-radius: 20px; font-weight: 600; }
  #api-status.ok { background: rgba(61,184,122,.15); color: var(--green); }
  #api-status.err { background: rgba(224,80,80,.15); color: var(--red); }

  #content { flex: 1; overflow-y: auto; padding: 24px; }

  /* â•â•â• CARDS & STATS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 18px 20px;
  }
  .stat-card .label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .06em; color: var(--text-dim); margin-bottom: 8px; }
  .stat-card .value { font-family: 'Rajdhani', sans-serif; font-size: 36px; font-weight: 700; line-height: 1; color: var(--text-bright); }
  .stat-card .sub { font-size: 11px; color: var(--text-dim); margin-top: 4px; }
  .stat-card.accent .value { color: var(--accent); }
  .stat-card.green .value  { color: var(--green); }
  .stat-card.red .value    { color: var(--red); }
  .stat-card.blue .value   { color: var(--blue); }

  /* â•â•â• SECTION HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  .section-header h3 { font-family: 'Rajdhani', sans-serif; font-size: 18px; font-weight: 600; color: var(--text-bright); }

  /* â•â•â• BUTTONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 7px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all .15s; border: none; font-family: 'Inter', sans-serif; }
  .btn-primary { background: var(--accent); color: #000; }
  .btn-primary:hover { background: var(--accent2); }
  .btn-secondary { background: var(--surface2); border: 1px solid var(--border); color: var(--text); }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: rgba(224,80,80,.15); border: 1px solid rgba(224,80,80,.3); color: var(--red); }
  .btn-danger:hover { background: rgba(224,80,80,.25); }
  .btn-sm { padding: 5px 10px; font-size: 12px; }
  .btn-icon { padding: 6px 8px; font-size: 14px; background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--text-dim); cursor: pointer; transition: all .15s; }
  .btn-icon:hover { border-color: var(--accent); color: var(--accent); }
  .btn-icon.del:hover { border-color: var(--red); color: var(--red); }

  /* â•â•â• FILTERS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .filters-bar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px; align-items: center; }
  .filters-bar input, .filters-bar select {
    background: var(--surface); border: 1px solid var(--border); border-radius: 7px;
    color: var(--text); padding: 7px 12px; font-size: 13px; font-family: 'Inter', sans-serif;
    outline: none; transition: border-color .15s;
  }
  .filters-bar input:focus, .filters-bar select:focus { border-color: var(--accent); }
  .filters-bar input[type=text] { min-width: 220px; }
  .filters-bar select { min-width: 140px; }
  .filter-count { font-size: 12px; color: var(--text-dim); margin-left: auto; }

  /* â•â•â• TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  table { width: 100%; border-collapse: collapse; }
  thead th { background: var(--surface2); padding: 11px 14px; text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .06em; color: var(--text-dim); white-space: nowrap; }
  tbody tr { border-top: 1px solid var(--border); transition: background .1s; }
  tbody tr:hover { background: var(--surface2); }
  tbody td { padding: 11px 14px; font-size: 13px; vertical-align: middle; }
  .td-actions { display: flex; gap: 6px; }

  /* â•â•â• BADGES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
  .badge-green  { background: rgba(61,184,122,.15); color: var(--green); }
  .badge-yellow { background: rgba(232,160,32,.15); color: var(--accent); }
  .badge-red    { background: rgba(224,80,80,.15); color: var(--red); }
  .badge-blue   { background: rgba(74,144,226,.15); color: var(--blue); }
  .badge-gray   { background: rgba(122,128,144,.15); color: var(--text-dim); }

  /* â•â•â• CAPACITY BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .cap-bar { width: 80px; height: 6px; background: var(--surface2); border-radius: 4px; overflow: hidden; display: inline-block; vertical-align: middle; margin-right: 6px; }
  .cap-fill { height: 100%; background: var(--green); border-radius: 4px; transition: width .3s; }
  .cap-fill.warn { background: var(--accent); }
  .cap-fill.full { background: var(--red); }
  .cap-text { font-size: 12px; color: var(--text-dim); }

  /* â•â•â• PAGINATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .pagination { display: flex; align-items: center; gap: 8px; margin-top: 16px; justify-content: center; }
  .pagination button { background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all .15s; }
  .pagination button:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
  .pagination button:disabled { opacity: .35; cursor: not-allowed; }
  .pagination .page-info { font-size: 12px; color: var(--text-dim); }

  /* â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,.7); backdrop-filter: blur(4px);
    z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;
  }
  .modal {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    width: 100%; max-width: 560px; max-height: 90vh; overflow-y: auto;
    box-shadow: 0 32px 80px rgba(0,0,0,.6);
  }
  .modal-header { padding: 20px 24px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .modal-header h3 { font-family: 'Rajdhani', sans-serif; font-size: 20px; font-weight: 600; color: var(--text-bright); }
  .modal-body { padding: 20px 24px; }
  .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }

  /* â•â•â• FORM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .form-grid .full { grid-column: 1 / -1; }
  .form-field { display: flex; flex-direction: column; gap: 5px; }
  .form-field label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .06em; color: var(--text-dim); }
  .form-field input, .form-field select, .form-field textarea {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 7px;
    color: var(--text); padding: 8px 12px; font-size: 13px; font-family: 'Inter', sans-serif;
    outline: none; transition: border-color .15s; width: 100%;
  }
  .form-field input:focus, .form-field select:focus, .form-field textarea:focus { border-color: var(--accent); }
  .form-field textarea { resize: vertical; min-height: 70px; }

  /* â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #login-screen {
    position: fixed; inset: 0; background: var(--bg);
    display: flex; align-items: center; justify-content: center; z-index: 9000;
  }
  .login-box {
    background: var(--surface); border: 1px solid var(--border); border-radius: 20px;
    padding: 40px; width: 360px;
    box-shadow: 0 40px 100px rgba(0,0,0,.5);
  }
  .login-box h1 { font-family: 'Rajdhani', sans-serif; font-size: 30px; font-weight: 700; color: var(--accent); margin-bottom: 4px; }
  .login-box p { color: var(--text-dim); font-size: 13px; margin-bottom: 28px; }
  .login-box .form-field { margin-bottom: 14px; }
  .login-box label { display: block; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .06em; color: var(--text-dim); margin-bottom: 6px; }
  .login-box input { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); padding: 10px 14px; font-size: 14px; outline: none; transition: border-color .15s; }
  .login-box input:focus { border-color: var(--accent); }
  #login-btn { width: 100%; padding: 11px; background: var(--accent); border: none; border-radius: 8px; color: #000; font-weight: 700; font-size: 15px; cursor: pointer; margin-top: 8px; transition: background .15s; }
  #login-btn:hover { background: var(--accent2); }
  #login-error { color: var(--red); font-size: 12px; margin-top: 10px; display: none; }

  /* â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #toasts { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
  .toast { padding: 12px 18px; border-radius: 10px; font-size: 13px; font-weight: 500; box-shadow: 0 8px 24px rgba(0,0,0,.4); max-width: 340px; animation: slideIn .2s ease; }
  .toast.success { background: var(--green); color: #000; }
  .toast.error   { background: var(--red); color: #fff; }
  .toast.info    { background: var(--surface2); border: 1px solid var(--border); color: var(--text); }
  @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  /* â•â•â• LOADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .loader { display: flex; align-items: center; justify-content: center; padding: 48px; color: var(--text-dim); gap: 10px; }
  .spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â•â•â• DETAIL VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .detail-item label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: .06em; color: var(--text-dim); display: block; margin-bottom: 3px; }
  .detail-item .val { font-size: 14px; color: var(--text-bright); }
  .detail-item.full { grid-column: 1 / -1; }

  /* â•â•â• EMPTY STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .empty { padding: 48px; text-align: center; color: var(--text-dim); }
  .empty .ico { font-size: 36px; margin-bottom: 12px; display: block; }

  /* â•â•â• SCHEDULE DAY GRID â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .day-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .06em; color: var(--text-dim); padding: 10px 0 6px; }

  /* RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 768px) {
    #sidebar { position: fixed; left: -220px; top: 0; height: 100%; z-index: 200; transition: left .2s; }
    #sidebar.open { left: 0; }
    .form-grid { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-box">
    <h1>âš” KM Saggita</h1>
    <p>Panel Administratora</p>
    <div class="form-field">
      <label>Login</label>
      <input type="text" id="l-user" placeholder="username" autocomplete="username" />
    </div>
    <div class="form-field">
      <label>HasÅ‚o</label>
      <input type="password" id="l-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
    </div>
    <button id="login-btn">Zaloguj siÄ™</button>
    <div id="login-error"></div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none">
  <!-- Sidebar -->
  <aside id="sidebar">
    <div id="sidebar-logo">
      <h1>âš” KM Saggita</h1>
      <small>Panel Administratora</small>
    </div>
    <nav>
      <a class="active" data-view="dashboard"><span class="ico">ğŸ“Š</span> Dashboard</a>
      <div class="section-label">Kursanci</div>
      <a data-view="registrations"><span class="ico">ğŸ“‹</span> Lista zapisÃ³w</a>
      <a data-view="add-participant"><span class="ico">â•</span> Dodaj kursanta</a>
      <div class="section-label">Organizacja</div>
      <a data-view="groups"><span class="ico">ğŸ¥‹</span> Grupy</a>
      <a data-view="schedules"><span class="ico">ğŸ—“</span> Grafik</a>
      <a data-view="locations"><span class="ico">ğŸ“</span> Lokalizacje</a>
      <div class="section-label">Export</div>
      <a id="btn-export"><span class="ico">ğŸ“¥</span> Pobierz CSV</a>
    </nav>
    <div id="sidebar-footer">
      <div class="user-info"><small>Zalogowany jako</small><strong id="admin-username">â€”</strong></div>
      <button id="btn-logout">Wyloguj</button>
    </div>
  </aside>

  <!-- Main -->
  <main id="main">
    <div id="topbar">
      <h2 id="page-title">Dashboard</h2>
      <div class="topbar-actions">
        <span id="api-status" class="ok">â— API OK</span>
      </div>
    </div>
    <div id="content"></div>
  </main>
</div>

<!-- TOASTS -->
<div id="toasts"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = '/api/admin-api';
let TOKEN = localStorage.getItem('km_token') || '';
let CURRENT_VIEW = 'dashboard';
let regOffset = 0, regTotal = 0;
const REG_LIMIT = 30;
let regFilters = {};

const DAYS = ['Niedziela','PoniedziaÅ‚ek','Wtorek','Åšroda','Czwartek','PiÄ…tek','Sobota'];
const CATEGORIES = { kids: 'Dzieci', youth: 'MÅ‚odzieÅ¼', adults: 'DoroÅ›li', vip: 'VIP', women: 'Kobiety' };
const PAYMENT_STATUS = { paid: 'OpÅ‚acony', unpaid: 'NieopÅ‚acony', partial: 'CzÄ™Å›ciowo', waived: 'Zwolniony' };
const STATUS = { new: 'Nowy', confirmed: 'Potwierdzony', cancelled: 'Anulowany', completed: 'ZakoÅ„czony' };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function apiFetch(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json' };
  if (TOKEN) headers['Authorization'] = `Bearer ${TOKEN}`;
  try {
    const res = await fetch(API + path, { headers, ...opts });
    const data = await res.json().catch(() => ({ error: 'BÅ‚Ä…d odpowiedzi' }));
    if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
    setApiStatus(true);
    return data;
  } catch(e) {
    setApiStatus(false);
    throw e;
  }
}

function setApiStatus(ok) {
  const el = document.getElementById('api-status');
  el.textContent = ok ? 'â— API OK' : 'â— API ERROR';
  el.className = ok ? 'ok' : 'err';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkLogin() {
  if (!TOKEN) return showLogin();
  try {
    await apiFetch('/stats');
    showApp();
  } catch { showLogin(); }
}

function showLogin() {
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
}

function showApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  const user = parseToken(TOKEN);
  if (user) document.getElementById('admin-username').textContent = user.username || 'â€”';
  navigate('dashboard');
}

function parseToken(t) {
  try { return JSON.parse(atob(t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/'))); } catch { return null; }
}

document.getElementById('login-btn').addEventListener('click', async () => {
  const u = document.getElementById('l-user').value.trim();
  const p = document.getElementById('l-pass').value;
  const errEl = document.getElementById('login-error');
  errEl.style.display = 'none';
  if (!u || !p) { errEl.textContent = 'Podaj login i hasÅ‚o'; errEl.style.display = 'block'; return; }
  try {
    const data = await apiFetch('/login', { method: 'POST', body: JSON.stringify({ username: u, password: p }) });
    TOKEN = data.token;
    localStorage.setItem('km_token', TOKEN);
    showApp();
  } catch(e) { errEl.textContent = e.message; errEl.style.display = 'block'; }
});

document.getElementById('l-pass').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('login-btn').click(); });

document.getElementById('btn-logout').addEventListener('click', () => {
  TOKEN = ''; localStorage.removeItem('km_token'); showLogin();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navigate(view) {
  CURRENT_VIEW = view;
  document.querySelectorAll('nav a[data-view]').forEach(a => a.classList.toggle('active', a.dataset.view === view));
  const titles = { dashboard:'Dashboard', registrations:'Lista zapisÃ³w', 'add-participant':'Dodaj kursanta', groups:'Grupy', schedules:'Grafik zajÄ™Ä‡', locations:'Lokalizacje' };
  document.getElementById('page-title').textContent = titles[view] || view;
  const c = document.getElementById('content');
  c.innerHTML = '<div class="loader"><div class="spinner"></div> Åadowanieâ€¦</div>';
  const fns = { dashboard: loadDashboard, registrations: loadRegistrations, 'add-participant': loadAddParticipant, groups: loadGroups, schedules: loadSchedules, locations: loadLocations };
  (fns[view] || (() => c.innerHTML = '<p>Widok nie znaleziony</p>'))();
}

document.querySelectorAll('nav a[data-view]').forEach(a => a.addEventListener('click', () => navigate(a.dataset.view)));
document.getElementById('btn-export').addEventListener('click', () => { window.open(API + '/export', '_blank'); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOASTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type = 'success', ms = 3000) {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(() => el.remove(), ms);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showModal(title, bodyHtml, footerHtml) {
  closeModal();
  const ov = document.createElement('div');
  ov.className = 'modal-overlay';
  ov.id = 'modal-overlay';
  ov.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h3>${title}</h3>
        <button class="btn-icon" onclick="closeModal()">âœ•</button>
      </div>
      <div class="modal-body">${bodyHtml}</div>
      ${footerHtml ? `<div class="modal-footer">${footerHtml}</div>` : ''}
    </div>`;
  ov.addEventListener('click', e => { if (e.target === ov) closeModal(); });
  document.body.appendChild(ov);
}

function closeModal() { document.getElementById('modal-overlay')?.remove(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(v) { if (!v) return 'â€”'; if (v instanceof Date) return v.toLocaleDateString('pl-PL'); return v; }
function fmtDate(v) { if (!v) return 'â€”'; return new Date(v).toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' }); }
function fmtDateTime(v) { if (!v) return 'â€”'; return new Date(v).toLocaleString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }
function payBadge(s) { const m = { paid:'badge-green', unpaid:'badge-red', partial:'badge-yellow', waived:'badge-gray' }; return `<span class="badge ${m[s]||'badge-gray'}">${PAYMENT_STATUS[s]||s}</span>`; }
function statBadge(s) { const m = { confirmed:'badge-green', new:'badge-yellow', cancelled:'badge-red', completed:'badge-gray' }; return `<span class="badge ${m[s]||'badge-gray'}">${STATUS[s]||s}</span>`; }
function srcBadge(s) { return s === 'admin' ? '<span class="badge badge-blue">Admin</span>' : '<span class="badge badge-gray">Web</span>'; }
function capBar(reg, max) {
  const pct = max ? Math.min(100, Math.round(reg / max * 100)) : 0;
  const cls = pct >= 100 ? 'full' : pct >= 80 ? 'warn' : '';
  return `<span class="cap-bar"><span class="cap-fill ${cls}" style="width:${pct}%"></span></span><span class="cap-text">${reg}/${max||'?'}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW: DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard() {
  const c = document.getElementById('content');
  try {
    const d = await apiFetch('/stats');
    c.innerHTML = `
      <div class="stats-grid">
        <div class="stat-card accent"><div class="label">Wszystkie zapisy</div><div class="value">${d.total||0}</div></div>
        <div class="stat-card green"><div class="label">OpÅ‚aceni</div><div class="value">${d.paid||0}</div></div>
        <div class="stat-card blue"><div class="label">Do potwierdzenia</div><div class="value">${d.pending||0}</div></div>
        <div class="stat-card red"><div class="label">Lista rezerwowa</div><div class="value">${d.waitlist||0}</div></div>
      </div>

      <div class="section-header"><h3>ğŸ“ ObÅ‚oÅ¼enie lokalizacji</h3></div>
      <div class="table-wrap" style="margin-bottom:24px">
        <table><thead><tr><th>Miasto</th><th>ÅÄ…cznie</th><th>OpÅ‚aceni</th><th>OczekujÄ…cy</th><th>Rezerwowa</th></tr></thead>
        <tbody>${(d.byLoc||[]).map(l => `
          <tr>
            <td><strong>${l.city}</strong></td>
            <td>${l.total}</td>
            <td>${payBadge('paid')} ${l.paid}</td>
            <td>${l.pending}</td>
            <td>${l.waitlist}</td>
          </tr>`).join('')}</tbody></table>
      </div>

      <div class="section-header"><h3>ğŸ¥‹ ObÅ‚oÅ¼enie grup</h3></div>
      <div class="table-wrap" style="margin-bottom:24px">
        <table><thead><tr><th>Miasto</th><th>Grupa</th><th>ObÅ‚oÅ¼enie</th><th>Akcja</th></tr></thead>
        <tbody>${(d.byGroup||[]).map(g => `
          <tr>
            <td>${g.city}</td>
            <td>${g.name}</td>
            <td>${capBar(g.registered, g.max_capacity)}</td>
            <td><button class="btn btn-sm btn-secondary" onclick="navigate('groups')">Edytuj</button></td>
          </tr>`).join('')}</tbody></table>
      </div>

      <div class="section-header"><h3>ğŸ• Ostatnie zapisy</h3></div>
      <div class="table-wrap">
        <table><thead><tr><th>Kursant</th><th>Miasto</th><th>Grupa</th><th>Status</th><th>PÅ‚atnoÅ›Ä‡</th><th>Data</th><th></th></tr></thead>
        <tbody>${(d.recent||[]).map(r => `
          <tr>
            <td>${r.name}</td>
            <td>${r.city||'â€”'}</td>
            <td>${r.group_name||'â€”'}</td>
            <td>${statBadge(r.status)}</td>
            <td>${payBadge(r.payment_status)}</td>
            <td>${fmtDateTime(r.created_at)}</td>
            <td><button class="btn-icon" onclick="viewRegistration(${r.id})">ğŸ‘</button></td>
          </tr>`).join('')}</tbody></table>
      </div>`;
  } catch(e) { c.innerHTML = `<div class="empty"><span class="ico">âš ï¸</span>${e.message}</div>`; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW: REGISTRATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadRegistrations() {
  const c = document.getElementById('content');
  c.innerHTML = `
    <div class="section-header">
      <h3>Lista zapisÃ³w</h3>
      <button class="btn btn-primary" onclick="navigate('add-participant')">â• Dodaj kursanta</button>
    </div>
    <div class="filters-bar">
      <input type="text" id="f-search" placeholder="ğŸ” Szukaj: imiÄ™, email, tel, refâ€¦" />
      <select id="f-source">
        <option value="">Å¹rÃ³dÅ‚o: wszystkie</option>
        <option value="web">Strona WWW</option>
        <option value="admin">Dodani przez admina</option>
      </select>
      <select id="f-status">
        <option value="">Status: wszystkie</option>
        <option value="new">Nowy</option>
        <option value="confirmed">Potwierdzony</option>
        <option value="cancelled">Anulowany</option>
        <option value="completed">ZakoÅ„czony</option>
      </select>
      <select id="f-payment">
        <option value="">PÅ‚atnoÅ›Ä‡: wszystkie</option>
        <option value="paid">OpÅ‚acony</option>
        <option value="unpaid">NieopÅ‚acony</option>
        <option value="partial">CzÄ™Å›ciowo</option>
      </select>
      <select id="f-waitlist">
        <option value="">Lista: wszystkie</option>
        <option value="false">Aktywni</option>
        <option value="true">Rezerwowa</option>
      </select>
      <button class="btn btn-secondary" onclick="applyFilters()">Filtruj</button>
      <button class="btn btn-secondary" onclick="resetFilters()">âœ• Reset</button>
    </div>
    <div id="reg-table-wrap"><div class="loader"><div class="spinner"></div> Åadowanieâ€¦</div></div>`;

  document.getElementById('f-search').addEventListener('keydown', e => { if (e.key === 'Enter') applyFilters(); });
  regOffset = 0; regFilters = {};
  await fetchRegistrations();
}

function applyFilters() {
  regFilters = {
    search: document.getElementById('f-search')?.value || '',
    source: document.getElementById('f-source')?.value || '',
    status: document.getElementById('f-status')?.value || '',
    payment_status: document.getElementById('f-payment')?.value || '',
    waitlist: document.getElementById('f-waitlist')?.value || '',
  };
  Object.keys(regFilters).forEach(k => { if (!regFilters[k]) delete regFilters[k]; });
  regOffset = 0;
  fetchRegistrations();
}

function resetFilters() {
  regFilters = {}; regOffset = 0;
  ['f-search','f-source','f-status','f-payment','f-waitlist'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
  fetchRegistrations();
}

async function fetchRegistrations() {
  const wrap = document.getElementById('reg-table-wrap');
  if (!wrap) return;
  wrap.innerHTML = '<div class="loader"><div class="spinner"></div> Åadowanieâ€¦</div>';
  const qs = new URLSearchParams({ ...regFilters, limit: REG_LIMIT, offset: regOffset }).toString();
  try {
    const data = await apiFetch('/registrations?' + qs);
    regTotal = data.total;
    const rows = data.rows || [];
    if (!rows.length) { wrap.innerHTML = '<div class="empty"><span class="ico">ğŸ“‹</span>Brak wynikÃ³w</div>'; return; }
    wrap.innerHTML = `
      <div class="filter-count" style="margin-bottom:10px">ÅÄ…cznie: <strong>${regTotal}</strong> zapisÃ³w</div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>ID</th><th>Kursant</th><th>Kontakt</th>
            <th>Lokalizacja</th><th>Grupa</th>
            <th>Å¹rÃ³dÅ‚o</th><th>Status</th><th>PÅ‚atnoÅ›Ä‡</th>
            <th>Data</th><th>Akcje</th>
          </tr></thead>
          <tbody>
            ${rows.map(r => `<tr>
              <td style="color:var(--text-dim)">#${r.id}</td>
              <td><strong>${r.first_name} ${r.last_name}</strong>${r.is_waitlist ? ' <span class="badge badge-yellow">Rez.</span>' : ''}</td>
              <td style="font-size:12px">${r.email||'â€”'}<br>${r.phone||''}</td>
              <td>${r.city||'â€”'}</td>
              <td>${r.group_name||'â€”'}</td>
              <td>${srcBadge(r.source)}</td>
              <td>${statBadge(r.status)}</td>
              <td>${payBadge(r.payment_status)}</td>
              <td style="font-size:11px;color:var(--text-dim)">${fmtDate(r.created_at)}</td>
              <td><div class="td-actions">
                <button class="btn-icon" onclick="viewRegistration(${r.id})" title="PodglÄ…d">ğŸ‘</button>
                <button class="btn-icon" onclick="editRegistration(${r.id})" title="Edytuj">âœï¸</button>
                <button class="btn-icon del" onclick="deleteRegistration(${r.id}, '${r.first_name} ${r.last_name}')" title="UsuÅ„">ğŸ—‘</button>
              </div></td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>
      <div class="pagination">
        <button onclick="changePage(-1)" ${regOffset === 0 ? 'disabled' : ''}>â† Poprzednia</button>
        <span class="page-info">Strona ${Math.floor(regOffset/REG_LIMIT)+1} z ${Math.max(1,Math.ceil(regTotal/REG_LIMIT))}</span>
        <button onclick="changePage(1)" ${regOffset + REG_LIMIT >= regTotal ? 'disabled' : ''}>NastÄ™pna â†’</button>
      </div>`;
  } catch(e) { wrap.innerHTML = `<div class="empty"><span class="ico">âš ï¸</span>${e.message}</div>`; }
}

function changePage(dir) {
  regOffset = Math.max(0, regOffset + dir * REG_LIMIT);
  fetchRegistrations();
}

async function viewRegistration(id) {
  try {
    const r = await apiFetch(`/registration/${id}`);
    showModal(`Zapis #${id} â€” ${r.first_name} ${r.last_name}`, `
      <div class="detail-grid">
        <div class="detail-item"><label>ImiÄ™ i nazwisko</label><div class="val">${r.first_name} ${r.last_name}</div></div>
        <div class="detail-item"><label>Email</label><div class="val">${r.email||'â€”'}</div></div>
        <div class="detail-item"><label>Telefon</label><div class="val">${r.phone||'â€”'}</div></div>
        <div class="detail-item"><label>Rok urodzenia</label><div class="val">${r.birth_year||'â€”'}</div></div>
        <div class="detail-item"><label>Miasto</label><div class="val">${r.city||'â€”'}</div></div>
        <div class="detail-item"><label>Grupa</label><div class="val">${r.group_name||'â€”'}</div></div>
        <div class="detail-item"><label>Karnet</label><div class="val">${r.plan_name||'â€”'}</div></div>
        <div class="detail-item"><label>Kwota</label><div class="val">${r.total_amount ? r.total_amount + ' zÅ‚' : 'â€”'}</div></div>
        <div class="detail-item"><label>Metoda pÅ‚atnoÅ›ci</label><div class="val">${r.payment_method||'â€”'}</div></div>
        <div class="detail-item"><label>Kod ref.</label><div class="val" style="font-family:monospace">${r.payment_ref||'â€”'}</div></div>
        <div class="detail-item"><label>Status zapisu</label><div class="val">${statBadge(r.status)}</div></div>
        <div class="detail-item"><label>Status pÅ‚atnoÅ›ci</label><div class="val">${payBadge(r.payment_status)}</div></div>
        <div class="detail-item"><label>Å¹rÃ³dÅ‚o</label><div class="val">${srcBadge(r.source)}</div></div>
        <div class="detail-item"><label>Data startu</label><div class="val">${fmtDate(r.start_date)}</div></div>
        <div class="detail-item"><label>Data zapisu</label><div class="val">${fmtDateTime(r.created_at)}</div></div>
        <div class="detail-item"><label>Data opÅ‚aty</label><div class="val">${fmtDateTime(r.paid_at)}</div></div>
        <div class="detail-item full"><label>Notatki admina</label><div class="val">${r.admin_notes||'â€”'}</div></div>
      </div>`,
      `<button class="btn btn-secondary" onclick="closeModal()">Zamknij</button>
       <button class="btn btn-primary" onclick="closeModal();editRegistration(${id})">âœï¸ Edytuj</button>`
    );
  } catch(e) { toast(e.message, 'error'); }
}

async function editRegistration(id) {
  let r, groups = [], plans = [];
  try {
    [r, { rows: groups }, { rows: plans }] = await Promise.all([
      apiFetch(`/registration/${id}`),
      apiFetch('/groups'),
      apiFetch('/plans'),
    ]);
  } catch(e) { toast(e.message, 'error'); return; }

  const gOpts = groups.map(g => `<option value="${g.id}" ${g.id == r.group_id ? 'selected' : ''}>${g.city} â€” ${g.name}</option>`).join('');
  const pOpts = `<option value="">â€” brak â€”</option>` + plans.map(p => `<option value="${p.id}" ${p.id == r.price_plan_id ? 'selected' : ''}>${p.name} (${p.months}m)</option>`).join('');

  showModal(`âœï¸ Edycja zapisu #${id}`, `
    <div class="form-grid">
      <div class="form-field"><label>ImiÄ™</label><input id="e-first" value="${r.first_name||''}"></div>
      <div class="form-field"><label>Nazwisko</label><input id="e-last" value="${r.last_name||''}"></div>
      <div class="form-field"><label>Email</label><input id="e-email" type="email" value="${r.email||''}"></div>
      <div class="form-field"><label>Telefon</label><input id="e-phone" value="${r.phone||''}"></div>
      <div class="form-field"><label>Rok urodzenia</label><input id="e-birth" type="number" value="${r.birth_year||''}"></div>
      <div class="form-field"><label>Data startu</label><input id="e-start" type="date" value="${r.start_date ? r.start_date.slice(0,10) : ''}"></div>
      <div class="form-field full"><label>Grupa</label><select id="e-group">${gOpts}</select></div>
      <div class="form-field full"><label>Karnet</label><select id="e-plan">${pOpts}</select></div>
      <div class="form-field"><label>Metoda pÅ‚atnoÅ›ci</label>
        <select id="e-pay-method">
          <option value="cash" ${r.payment_method==='cash'?'selected':''}>GotÃ³wka</option>
          <option value="transfer" ${r.payment_method==='transfer'?'selected':''}>Przelew</option>
          <option value="card" ${r.payment_method==='card'?'selected':''}>Karta</option>
        </select>
      </div>
      <div class="form-field"><label>Kwota (zÅ‚)</label><input id="e-amount" type="number" value="${r.total_amount||''}"></div>
      <div class="form-field"><label>Status zapisu</label>
        <select id="e-status">
          <option value="new" ${r.status==='new'?'selected':''}>Nowy</option>
          <option value="confirmed" ${r.status==='confirmed'?'selected':''}>Potwierdzony</option>
          <option value="cancelled" ${r.status==='cancelled'?'selected':''}>Anulowany</option>
          <option value="completed" ${r.status==='completed'?'selected':''}>ZakoÅ„czony</option>
        </select>
      </div>
      <div class="form-field"><label>Status pÅ‚atnoÅ›ci</label>
        <select id="e-paystatus">
          <option value="unpaid" ${r.payment_status==='unpaid'?'selected':''}>NieopÅ‚acony</option>
          <option value="paid" ${r.payment_status==='paid'?'selected':''}>OpÅ‚acony</option>
          <option value="partial" ${r.payment_status==='partial'?'selected':''}>CzÄ™Å›ciowo</option>
          <option value="waived" ${r.payment_status==='waived'?'selected':''}>Zwolniony</option>
        </select>
      </div>
      <div class="form-field"><label>Lista rezerwowa</label>
        <select id="e-waitlist">
          <option value="false" ${!r.is_waitlist?'selected':''}>Nie</option>
          <option value="true" ${r.is_waitlist?'selected':''}>Tak</option>
        </select>
      </div>
      <div class="form-field full"><label>Notatki admina</label><textarea id="e-notes">${r.admin_notes||''}</textarea></div>
    </div>`,
    `<button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
     <button class="btn btn-primary" onclick="saveRegistration(${id})">ğŸ’¾ Zapisz</button>`
  );
}

async function saveRegistration(id) {
  const body = {
    first_name: document.getElementById('e-first').value,
    last_name: document.getElementById('e-last').value,
    email: document.getElementById('e-email').value,
    phone: document.getElementById('e-phone').value,
    birth_year: parseInt(document.getElementById('e-birth').value) || null,
    start_date: document.getElementById('e-start').value || null,
    group_id: parseInt(document.getElementById('e-group').value) || null,
    price_plan_id: parseInt(document.getElementById('e-plan').value) || null,
    payment_method: document.getElementById('e-pay-method').value,
    total_amount: parseFloat(document.getElementById('e-amount').value) || 0,
    status: document.getElementById('e-status').value,
    payment_status: document.getElementById('e-paystatus').value,
    is_waitlist: document.getElementById('e-waitlist').value === 'true',
    admin_notes: document.getElementById('e-notes').value || null,
  };
  try {
    await apiFetch(`/registration/${id}`, { method: 'PATCH', body: JSON.stringify(body) });
    toast('Zapis zaktualizowany âœ“');
    closeModal();
    if (CURRENT_VIEW === 'registrations') fetchRegistrations();
    if (CURRENT_VIEW === 'dashboard') loadDashboard();
  } catch(e) { toast(e.message, 'error'); }
}

async function deleteRegistration(id, name) {
  if (!confirm(`UsunÄ…Ä‡ zapis: ${name}?\n\nTej operacji nie moÅ¼na cofnÄ…Ä‡.`)) return;
  try {
    await apiFetch(`/registration/${id}`, { method: 'DELETE' });
    toast('Zapis usuniÄ™ty');
    fetchRegistrations();
  } catch(e) { toast(e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW: ADD PARTICIPANT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAddParticipant() {
  const c = document.getElementById('content');
  let groups = [], plans = [];
  try {
    [{ rows: groups }, { rows: plans }] = await Promise.all([apiFetch('/groups'), apiFetch('/plans')]);
  } catch(e) { c.innerHTML = `<div class="empty"><span class="ico">âš ï¸</span>${e.message}</div>`; return; }

  const gOpts = groups.map(g => `<option value="${g.id}">${g.city} â€” ${g.name} (${g.registered_count||0}/${g.max_capacity})</option>`).join('');
  const pOpts = `<option value="">â€” brak karnetu â€”</option>` + plans.map(p => `<option value="${p.id}">${p.name} â€” ${p.price} zÅ‚ (${p.months} mies.)</option>`).join('');

  c.innerHTML = `
    <div class="section-header"><h3>â• Dodaj kursanta</h3></div>
    <div class="table-wrap" style="max-width:700px">
      <div style="padding:24px">
        <div class="form-grid">
          <div class="form-field"><label>ImiÄ™ *</label><input id="np-first" placeholder="Jan"></div>
          <div class="form-field"><label>Nazwisko *</label><input id="np-last" placeholder="Kowalski"></div>
          <div class="form-field"><label>Email</label><input id="np-email" type="email" placeholder="jan@example.com"></div>
          <div class="form-field"><label>Telefon</label><input id="np-phone" type="tel" placeholder="500 000 000"></div>
          <div class="form-field"><label>Rok urodzenia</label><input id="np-birth" type="number" placeholder="1990" min="1940" max="2020"></div>
          <div class="form-field"><label>Data startu</label><input id="np-start" type="date"></div>
          <div class="form-field full"><label>Grupa *</label><select id="np-group"><option value="">â€” wybierz grupÄ™ â€”</option>${gOpts}</select></div>
          <div class="form-field full"><label>Karnet</label><select id="np-plan">${pOpts}</select></div>
          <div class="form-field"><label>Metoda pÅ‚atnoÅ›ci</label>
            <select id="np-paymethod">
              <option value="cash">GotÃ³wka</option>
              <option value="transfer">Przelew</option>
              <option value="card">Karta</option>
            </select>
          </div>
          <div class="form-field"><label>Kwota (zÅ‚)</label><input id="np-amount" type="number" placeholder="0" min="0"></div>
          <div class="form-field"><label>Status pÅ‚atnoÅ›ci</label>
            <select id="np-paystatus">
              <option value="unpaid">NieopÅ‚acony</option>
              <option value="paid">OpÅ‚acony</option>
              <option value="waived">Zwolniony</option>
            </select>
          </div>
          <div class="form-field"><label>Typ kursanta</label>
            <select id="np-isnew">
              <option value="true">Nowy</option>
              <option value="false">Kontynuacja</option>
            </select>
          </div>
          <div class="form-field full"><label>Notatki</label><textarea id="np-notes" placeholder="Opcjonalne notatkiâ€¦"></textarea></div>
        </div>
        <div style="margin-top:20px;display:flex;gap:12px">
          <button class="btn btn-primary" onclick="submitNewParticipant()">â• Dodaj kursanta</button>
          <button class="btn btn-secondary" onclick="navigate('registrations')">Anuluj</button>
        </div>
      </div>
    </div>`;
}

async function submitNewParticipant() {
  const fn = document.getElementById('np-first').value.trim();
  const ln = document.getElementById('np-last').value.trim();
  const gid = document.getElementById('np-group').value;
  if (!fn || !ln || !gid) { toast('ImiÄ™, nazwisko i grupa sÄ… wymagane', 'error'); return; }

  const body = {
    first_name: fn, last_name: ln,
    email: document.getElementById('np-email').value || null,
    phone: document.getElementById('np-phone').value || null,
    birth_year: parseInt(document.getElementById('np-birth').value) || null,
    start_date: document.getElementById('np-start').value || null,
    group_id: parseInt(gid),
    price_plan_id: parseInt(document.getElementById('np-plan').value) || null,
    payment_method: document.getElementById('np-paymethod').value,
    total_amount: parseFloat(document.getElementById('np-amount').value) || 0,
    payment_status: document.getElementById('np-paystatus').value,
    is_new: document.getElementById('np-isnew').value === 'true',
    admin_notes: document.getElementById('np-notes').value || null,
    status: 'confirmed',
  };
  try {
    const data = await apiFetch('/participant', { method: 'POST', body: JSON.stringify(body) });
    toast(`Dodano kursanta: ${data.name} âœ“`);
    navigate('registrations');
  } catch(e) { toast(e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW: GROUPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadGroups() {
  const c = document.getElementById('content');
  try {
    const { rows } = await apiFetch('/groups');
    c.innerHTML = `
      <div class="section-header">
        <h3>Grupy</h3>
        <button class="btn btn-primary" onclick="showAddGroup()">â• Nowa grupa</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Miasto</th><th>Nazwa</th><th>Kategoria</th><th>Wiek</th><th>ObÅ‚oÅ¼enie</th><th>Status</th><th>Akcje</th></tr></thead>
          <tbody>
            ${rows.length ? rows.map(g => `<tr>
              <td>${g.city||'â€”'}</td>
              <td><strong>${g.name}</strong>${g.notes ? `<br><small style="color:var(--text-dim)">${g.notes}</small>` : ''}</td>
              <td>${CATEGORIES[g.category]||g.category}</td>
              <td>${g.age_range||'â€”'}</td>
              <td>${capBar(g.registered_count||0, g.max_capacity)}</td>
              <td>${g.active ? '<span class="badge badge-green">Aktywna</span>' : '<span class="badge badge-gray">Nieaktywna</span>'}</td>
              <td><div class="td-actions">
                <button class="btn-icon" onclick="showEditGroup(${JSON.stringify(g).replace(/"/g,'&quot;')})" title="Edytuj">âœï¸</button>
                <button class="btn-icon del" onclick="deleteGroup(${g.id},'${g.name}')" title="UsuÅ„">ğŸ—‘</button>
              </div></td>
            </tr>`).join('') : `<tr><td colspan="7"><div class="empty">Brak grup</div></td></tr>`}
          </tbody>
        </table>
      </div>`;
  } catch(e) { c.innerHTML = `<div class="empty"><span class="ico">âš ï¸</span>${e.message}</div>`; }
}

async function showAddGroup() {
  let locs = [];
  try { ({ rows: locs } = await apiFetch('/locations')); } catch {}
  const lOpts = locs.map(l => `<option value="${l.id}">${l.city} â€” ${l.name}</option>`).join('');
  showModal('â• Nowa grupa', `
    <div class="form-grid">
      <div class="form-field full"><label>Lokalizacja *</label><select id="ng-loc">${lOpts}</select></div>
      <div class="form-field full"><label>Nazwa grupy *</label><input id="ng-name" placeholder="np. Krav Maga DoroÅ›li A"></div>
      <div class="form-field"><label>Kategoria</label>
        <select id="ng-cat">
          <option value="adults">DoroÅ›li</option>
          <option value="kids">Dzieci</option>
          <option value="youth">MÅ‚odzieÅ¼</option>
          <option value="women">Kobiety</option>
          <option value="vip">VIP</option>
        </select>
      </div>
      <div class="form-field"><label>PrzedziaÅ‚ wiekowy</label><input id="ng-age" placeholder="np. 16-99"></div>
      <div class="form-field"><label>Maks. pojemnoÅ›Ä‡</label><input id="ng-cap" type="number" value="20" min="1"></div>
      <div class="form-field"><label>Aktywna</label>
        <select id="ng-active"><option value="true">Tak</option><option value="false">Nie</option></select>
      </div>
      <div class="form-field full"><label>Notatki</label><textarea id="ng-notes" placeholder="Opcjonalnieâ€¦"></textarea></div>
    </div>`,
    `<button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
     <button class="btn btn-primary" onclick="submitNewGroup()">Dodaj grupÄ™</button>`
  );
}

async function submitNewGroup() {
  const name = document.getElementById('ng-name').value.trim();
  const loc = document.getElementById('ng-loc').value;
  if (!name || !loc) { toast('Nazwa i lokalizacja sÄ… wymagane', 'error'); return; }
  try {
    await apiFetch('/groups', { method: 'POST', body: JSON.stringify({
      name, location_id: parseInt(loc),
      category: document.getElementById('ng-cat').value,
      age_range: document.getElementById('ng-age').value || null,
      max_capacity: parseInt(document.getElementById('ng-cap').value) || 20,
      active: document.getElementById('ng-active').value === 'true',
      notes: document.getElementById('ng-notes').value || null,
    }) });
    toast('Grupa dodana âœ“'); closeModal(); loadGroups();
  } catch(e) { toast(e.message, 'error'); }
}

async function showEditGroup(g) {
  let locs = [];
  try { ({ rows: locs } = await apiFetch('/locations')); } catch {}
  const lOpts = locs.map(l => `<option value="${l.id}" ${l.id == g.location_id ? 'selected' : ''}>${l.city} â€” ${l.name}</option>`).join('');
  showModal(`âœï¸ Edycja grupy: ${g.name}`, `
    <div class="form-grid">
      <div class="form-field full"><label>Lokalizacja</label><select id="eg-loc">${lOpts}</select></div>
      <div class="form-field full"><label>Nazwa *</label><input id="eg-name" value="${g.name}"></div>
      <div class="form-field"><label>Kategoria</label>
        <select id="eg-cat">
          ${['adults','kids','youth','women','vip'].map(v => `<option value="${v}" ${g.category===v?'selected':''}>${CATEGORIES[v]}</option>`).join('')}
        </select>
      </div>
      <div class="form-field"><label>PrzedziaÅ‚ wiekowy</label><input id="eg-age" value="${g.age_range||''}"></div>
      <div class="form-field"><label>Maks. pojemnoÅ›Ä‡</label><input id="eg-cap" type="number" value="${g.max_capacity||20}" min="1"></div>
      <div class="form-field"><label>Aktywna</label>
        <select id="eg-active"><option value="true" ${g.active?'selected':''}>Tak</option><option value="false" ${!g.active?'selected':''}>Nie</option></select>
      </div>
      <div class="form-field full"><label>Notatki</label><textarea id="eg-notes">${g.notes||''}</textarea></div>
    </div>`,
    `<button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
     <button class="btn btn-primary" onclick="submitEditGroup(${g.id})">ğŸ’¾ Zapisz</button>`
  );
}

async function submitEditGroup(id) {
  const name = document.getElementById('eg-name').value.trim();
  if (!name) { toast('Nazwa jest wymagana', 'error'); return; }
  try {
    await apiFetch(`/groups/${id}`, { method: 'PATCH', body: JSON.stringify({
      name,
      location_id: parseInt(document.getElementById('eg-loc').value),
      category: document.getElementById('eg-cat').value,
      age_range: document.getElementById('eg-age').value || null,
      max_capacity: parseInt(document.getElementById('eg-cap').value) || 20,
      active: document.getElementById('eg-active').value === 'true',
      notes: document.getElementById('eg-notes').value || null,
    }) });
    toast('Grupa zaktualizowana âœ“'); closeModal(); loadGroups();
  } catch(e) { toast(e.message, 'error'); }
}

async function deleteGroup(id, name) {
  if (!confirm(`UsunÄ…Ä‡ grupÄ™ "${name}"?\n\nGrupa musi byÄ‡ pusta (brak aktywnych zapisÃ³w).`)) return;
  try {
    await apiFetch(`/groups/${id}`, { method: 'DELETE' });
    toast('Grupa usuniÄ™ta'); loadGroups();
  } catch(e) { toast(e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW: SCHEDULES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSchedules() {
  const c = document.getElementById('content');
  try {
    const [{ rows }, { rows: groups }] = await Promise.all([apiFetch('/schedules'), apiFetch('/groups')]);
    // Group by day
    const byDay = {};
    rows.forEach(s => { if (!byDay[s.day_of_week]) byDay[s.day_of_week] = []; byDay[s.day_of_week].push(s); });

    c.innerHTML = `
      <div class="section-header">
        <h3>Grafik zajÄ™Ä‡</h3>
        <button class="btn btn-primary" onclick="showAddSchedule(${JSON.stringify(groups).replace(/"/g,'&quot;')})">â• Nowy termin</button>
      </div>
      ${rows.length ? [1,2,3,4,5,6,0].filter(d => byDay[d]).map(d => `
        <div class="day-label">${DAYS[d]}</div>
        <div class="table-wrap" style="margin-bottom:16px">
          <table>
            <thead><tr><th>Godzina</th><th>Miasto</th><th>Grupa</th><th>Adres</th><th>Status</th><th>Akcje</th></tr></thead>
            <tbody>
              ${byDay[d].map(s => `<tr>
                <td><strong>${s.time_start ? s.time_start.slice(0,5) : 'â€”'}${s.time_end ? ' â€“ ' + s.time_end.slice(0,5) : ''}</strong></td>
                <td>${s.city||'â€”'}</td>
                <td>${s.group_name||'â€”'} <span class="badge badge-gray">${CATEGORIES[s.category]||s.category||''}</span></td>
                <td style="font-size:12px;color:var(--text-dim)">${s.address||'â€”'}</td>
                <td>${s.active ? '<span class="badge badge-green">Aktywny</span>' : '<span class="badge badge-gray">Nieaktywny</span>'}</td>
                <td><div class="td-actions">
                  <button class="btn-icon" onclick="showEditSchedule(${JSON.stringify(s).replace(/"/g,'&quot;')}, ${JSON.stringify(groups).replace(/"/g,'&quot;')})" title="Edytuj">âœï¸</button>
                  <button class="btn-icon del" onclick="deleteSchedule(${s.id})" title="UsuÅ„">ğŸ—‘</button>
                </div></td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>`).join('') : '<div class="empty"><span class="ico">ğŸ—“</span>Brak terminÃ³w</div>'
      }`;
  } catch(e) { c.innerHTML = `<div class="empty"><span class="ico">âš ï¸</span>${e.message}</div>`; }
}

function scheduleForm(s, groups) {
  const gOpts = groups.map(g => `<option value="${g.id}" ${s && g.id == s.group_id ? 'selected' : ''}>${g.city} â€” ${g.name}</option>`).join('');
  const dayOpts = DAYS.map((d,i) => `<option value="${i}" ${s && i == s.day_of_week ? 'selected' : ''}>${d}</option>`).join('');
  return `
    <div class="form-grid">
      <div class="form-field full"><label>Grupa *</label><select id="sf-group">${gOpts}</select></div>
      <div class="form-field full"><label>DzieÅ„ tygodnia *</label><select id="sf-day">${dayOpts}</select></div>
      <div class="form-field"><label>Godzina start</label><input id="sf-start" type="time" value="${s?.time_start?.slice(0,5)||''}"></div>
      <div class="form-field"><label>Godzina koniec</label><input id="sf-end" type="time" value="${s?.time_end?.slice(0,5)||''}"></div>
      <div class="form-field full"><label>Adres sali</label><input id="sf-addr" value="${s?.address||''}" placeholder="np. ul. GÅ‚Ã³wna 1, WrocÅ‚aw"></div>
      <div class="form-field"><label>Aktywny</label>
        <select id="sf-active">
          <option value="true" ${!s || s.active ? 'selected' : ''}>Tak</option>
          <option value="false" ${s && !s.active ? 'selected' : ''}>Nie</option>
        </select>
      </div>
    </div>`;
}

async function showAddSchedule(groups) {
  showModal('â• Nowy termin', scheduleForm(null, groups),
    `<button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
     <button class="btn btn-primary" onclick="submitNewSchedule()">Dodaj termin</button>`);
}

async function submitNewSchedule() {
  const gid = document.getElementById('sf-group').value;
  const day = document.getElementById('sf-day').value;
  if (!gid) { toast('Wybierz grupÄ™', 'error'); return; }
  try {
    await apiFetch('/schedules', { method: 'POST', body: JSON.stringify({
      group_id: parseInt(gid), day_of_week: parseInt(day),
      time_start: document.getElementById('sf-start').value || null,
      time_end: document.getElementById('sf-end').value || null,
      address: document.getElementById('sf-addr').value || null,
      active: document.getElementById('sf-active').value === 'true',
    }) });
    toast('Termin dodany âœ“'); closeModal(); loadSchedules();
  } catch(e) { toast(e.message, 'error'); }
}

async function showEditSchedule(s, groups) {
  showModal(`âœï¸ Edycja terminu`, scheduleForm(s, groups),
    `<button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
     <button class="btn btn-primary" onclick="submitEditSchedule(${s.id})">ğŸ’¾ Zapisz</button>`);
}

async function submitEditSchedule(id) {
  try {
    await apiFetch(`/schedules/${id}`, { method: 'PATCH', body: JSON.stringify({
      group_id: parseInt(document.getElementById('sf-group').value),
      day_of_week: parseInt(document.getElementById('sf-day').value),
      time_start: document.getElementById('sf-start').value || null,
      time_end: document.getElementById('sf-end').value || null,
      address: document.getElementById('sf-addr').value || null,
      active: document.getElementById('sf-active').value === 'true',
    }) });
    toast('Termin zaktualizowany âœ“'); closeModal(); loadSchedules();
  } catch(e) { toast(e.message, 'error'); }
}

async function deleteSchedule(id) {
  if (!confirm('UsunÄ…Ä‡ ten termin?')) return;
  try { await apiFetch(`/schedules/${id}`, { method: 'DELETE' }); toast('Termin usuniÄ™ty'); loadSchedules(); }
  catch(e) { toast(e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW: LOCATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadLocations() {
  const c = document.getElementById('content');
  try {
    const { rows } = await apiFetch('/locations');
    c.innerHTML = `
      <div class="section-header">
        <h3>Lokalizacje</h3>
        <button class="btn btn-primary" onclick="showAddLocation()">â• Nowa lokalizacja</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Miasto</th><th>Nazwa</th><th>Slug</th><th>Adres</th><th>Sala</th><th>Grupy</th><th>Zapisy</th><th>Status</th><th>Akcje</th></tr></thead>
          <tbody>
            ${rows.length ? rows.map(l => `<tr>
              <td><strong>${l.city}</strong></td>
              <td>${l.name}</td>
              <td style="font-family:monospace;font-size:12px;color:var(--text-dim)">${l.slug}</td>
              <td style="font-size:12px">${l.address||'â€”'}</td>
              <td style="font-size:12px">${l.venue||'â€”'}</td>
              <td><span class="badge badge-blue">${l.groups_count}</span></td>
              <td>${l.registrations_count}</td>
              <td>${l.active ? '<span class="badge badge-green">Aktywna</span>' : '<span class="badge badge-gray">Nieaktywna</span>'}</td>
              <td><div class="td-actions">
                <button class="btn-icon" onclick="showEditLocation(${JSON.stringify(l).replace(/"/g,'&quot;')})" title="Edytuj">âœï¸</button>
              </div></td>
            </tr>`).join('') : `<tr><td colspan="9"><div class="empty">Brak lokalizacji</div></td></tr>`}
          </tbody>
        </table>
      </div>`;
  } catch(e) { c.innerHTML = `<div class="empty"><span class="ico">âš ï¸</span>${e.message}</div>`; }
}

function locationForm(l) {
  return `
    <div class="form-grid">
      <div class="form-field"><label>Miasto *</label><input id="lf-city" value="${l?.city||''}" placeholder="WrocÅ‚aw"></div>
      <div class="form-field"><label>Slug *</label><input id="lf-slug" value="${l?.slug||''}" placeholder="wroclaw"></div>
      <div class="form-field full"><label>PeÅ‚na nazwa *</label><input id="lf-name" value="${l?.name||''}" placeholder="Krav Maga WrocÅ‚aw"></div>
      <div class="form-field full"><label>Adres</label><input id="lf-addr" value="${l?.address||''}" placeholder="ul. GÅ‚Ã³wna 1, 50-001 WrocÅ‚aw"></div>
      <div class="form-field full"><label>Nazwa sali</label><input id="lf-venue" value="${l?.venue||''}" placeholder="Hala sportowa X"></div>
      <div class="form-field"><label>Aktywna</label>
        <select id="lf-active">
          <option value="true" ${!l || l.active ? 'selected' : ''}>Tak</option>
          <option value="false" ${l && !l.active ? 'selected' : ''}>Nie</option>
        </select>
      </div>
    </div>`;
}

function showAddLocation() {
  showModal('â• Nowa lokalizacja', locationForm(null),
    `<button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
     <button class="btn btn-primary" onclick="submitNewLocation()">Dodaj</button>`);
}

async function submitNewLocation() {
  const city = document.getElementById('lf-city').value.trim();
  const slug = document.getElementById('lf-slug').value.trim();
  const name = document.getElementById('lf-name').value.trim();
  if (!city || !slug || !name) { toast('Miasto, slug i nazwa sÄ… wymagane', 'error'); return; }
  try {
    await apiFetch('/locations', { method: 'POST', body: JSON.stringify({
      city, slug, name,
      address: document.getElementById('lf-addr').value || null,
      venue: document.getElementById('lf-venue').value || null,
      active: document.getElementById('lf-active').value === 'true',
    }) });
    toast('Lokalizacja dodana âœ“'); closeModal(); loadLocations();
  } catch(e) { toast(e.message, 'error'); }
}

function showEditLocation(l) {
  showModal(`âœï¸ Edycja: ${l.city}`, locationForm(l),
    `<button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
     <button class="btn btn-primary" onclick="submitEditLocation(${l.id})">ğŸ’¾ Zapisz</button>`);
}

async function submitEditLocation(id) {
  const city = document.getElementById('lf-city').value.trim();
  const slug = document.getElementById('lf-slug').value.trim();
  const name = document.getElementById('lf-name').value.trim();
  if (!city || !slug || !name) { toast('Miasto, slug i nazwa sÄ… wymagane', 'error'); return; }
  try {
    await apiFetch(`/locations/${id}`, { method: 'PATCH', body: JSON.stringify({
      city, slug, name,
      address: document.getElementById('lf-addr').value || null,
      venue: document.getElementById('lf-venue').value || null,
      active: document.getElementById('lf-active').value === 'true',
    }) });
    toast('Lokalizacja zaktualizowana âœ“'); closeModal(); loadLocations();
  } catch(e) { toast(e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
checkLogin();
</script>
</body>
</html>
